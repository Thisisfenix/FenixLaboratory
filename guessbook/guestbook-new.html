<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¨ Guestbook - FenixLaboratory</title>
  <meta name="description" content="Sistema interactivo de dibujo y comentarios en tiempo real. Crea arte, comparte con la comunidad y participa en rankings. 50+ herramientas de dibujo, sistema de likes y galerÃ­a pÃºblica.">
  <meta name="keywords" content="guestbook, dibujo online, arte digital, comunidad, FenixLaboratory, canvas, pintura digital, galerÃ­a">
  <meta name="author" content="ThisIsFenix">
  
  <!-- Discord/Social Media Embeds -->
  <meta property="og:title" content="ğŸ¨ Guestbook - FenixLaboratory">
  <meta property="og:description" content="Sistema interactivo de dibujo con 50+ herramientas, rankings en tiempo real, sistema de likes y comentarios. Â¡Deja tu huella artÃ­stica en el laboratorio!">
  <meta property="og:image" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/Preview-GuestBook.png">
  <meta property="og:url" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/guestbook-new.html">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="FenixLaboratory Guestbook">
  
  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ğŸ¨ Guestbook - FenixLaboratory">
  <meta name="twitter:description" content="Sistema de dibujo interactivo con herramientas avanzadas, rankings y comunidad activa. Â¡Crea arte digital y compÃ¡rtelo!">
  <meta name="twitter:image" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/Preview-GuestBook.png">
  <meta name="twitter:creator" content="@AntiAnkush">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="Preview-GuestBook.png">
  <link rel="apple-touch-icon" href="Preview-GuestBook.png">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>
  
  <style>
    :root {
      --primary: #ff6b35;
      --bg-dark: #1a1a1a;
      --bg-light: #2d2d2d;
      --text-primary: #f0f0f0;
      --text-secondary: #b0b0b0;
    }
    
    [data-theme="neon"] {
      --primary: #00ff88;
      --bg-dark: #0a0a0a;
      --bg-light: #1a1a1a;
    }
    [data-theme="retro"] {
      --primary: #ff6b9d;
      --bg-dark: #2d1b69;
      --bg-light: #3e2a7a;
    }
    [data-theme="hacker"] {
      --primary: #00ff00;
      --bg-dark: #000000;
      --bg-light: #0d1117;
    }
    
    .color-btn.active {
      border-color: var(--primary) !important;
      box-shadow: 0 0 10px var(--primary);
    }
    
    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Space Grotesk', sans-serif;
      touch-action: manipulation;
    }
    
    .canvas-container {
      border: 3px solid var(--primary);
      border-radius: 12px;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      margin: 20px auto;
      display: block;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(255, 107, 53, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .canvas-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--primary), #ff8c42, var(--primary));
      border-radius: 12px;
      z-index: -1;
      animation: borderGlow 3s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    #drawCanvas {
      border-radius: 8px;
      cursor: crosshair;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    #drawCanvas:hover {
      transform: scale(1.01);
    }
    
    .drawing-card {
      background: var(--bg-light);
      border: 1px solid rgba(255, 107, 53, 0.2);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .drawing-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
    }
    
    .top-drawing {
      position: relative;
      z-index: 10;
    }
    
    .top-drawing.rank-1 {
      border: 3px solid #FFD700 !important;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.4) !important;
      animation: goldAura 2s ease-in-out infinite alternate;
    }
    
    .top-drawing.rank-2 {
      border: 3px solid #C0C0C0 !important;
      box-shadow: 0 0 25px rgba(192, 192, 192, 0.7), 0 0 50px rgba(192, 192, 192, 0.3) !important;
      animation: silverAura 2s ease-in-out infinite alternate;
    }
    
    .top-drawing.rank-3 {
      border: 3px solid #CD7F32 !important;
      box-shadow: 0 0 20px rgba(205, 127, 50, 0.6), 0 0 40px rgba(205, 127, 50, 0.2) !important;
      animation: bronzeAura 2s ease-in-out infinite alternate;
    }
    
    @keyframes goldAura {
      0% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.4); }
      100% { box-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 80px rgba(255, 215, 0, 0.6); }
    }
    
    @keyframes silverAura {
      0% { box-shadow: 0 0 25px rgba(192, 192, 192, 0.7), 0 0 50px rgba(192, 192, 192, 0.3); }
      100% { box-shadow: 0 0 35px rgba(192, 192, 192, 0.9), 0 0 70px rgba(192, 192, 192, 0.5); }
    }
    
    @keyframes bronzeAura {
      0% { box-shadow: 0 0 20px rgba(205, 127, 50, 0.6), 0 0 40px rgba(205, 127, 50, 0.2); }
      100% { box-shadow: 0 0 30px rgba(205, 127, 50, 0.8), 0 0 60px rgba(205, 127, 50, 0.4); }
    }
    
    .rank-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
      z-index: 20;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    .rank-badge.rank-1 {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #000;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
    }
    
    .rank-badge.rank-2 {
      background: linear-gradient(45deg, #C0C0C0, #A0A0A0);
      color: #000;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.8);
    }
    
    .rank-badge.rank-3 {
      background: linear-gradient(45deg, #CD7F32, #B8860B);
      color: #fff;
      box-shadow: 0 0 15px rgba(205, 127, 50, 0.8);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .drawing-img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: white;
      border-radius: 4px;
      transition: transform 0.3s ease;
    }
    
    .drawing-card:hover .drawing-img {
      transform: scale(1.02);
    }
    
    /* Estilos para modal de comentarios */
    .comments-container {
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
    }
    
    .comments-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .comments-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .comments-container::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }
    
    .comment-item {
      transition: background-color 0.2s ease;
    }
    
    .comment-item:hover {
      background: rgba(255,255,255,0.08) !important;
    }
    
    .btn-neon {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
      transition: all 0.3s ease;
    }
    
    .btn-neon:hover {
      background: var(--primary);
      color: var(--bg-dark);
    }
    
    .control-section {
      margin-bottom: 1rem;
    }
    
    .control-section:last-child {
      margin-bottom: 0;
    }
    
    .btn-group-custom {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      justify-content: center;
    }
    
    .btn-group-custom .btn {
      flex: 0 0 auto;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    @media (max-width: 991px) {
      .col-lg-4 {
        margin-top: 1rem;
      }
    }
    
    @media (max-width: 768px) {
      #drawCanvas {
        touch-action: none;
        max-width: 100%;
        height: auto;
      }
      .canvas-container {
        margin: 10px auto;
        touch-action: none;
        max-width: 95vw;
        padding: 10px;
        text-align: center;
      }
      .btn-group-custom .btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }
      
      /* Modal responsive */
      .image-modal > div {
        flex-direction: column !important;
        height: 100vh !important;
        max-height: 100vh !important;
      }
      
      .image-modal > div > div:first-child {
        flex: 0 0 auto !important;
        max-height: 50vh !important;
        padding: 10px !important;
      }
      
      .image-modal > div > div:last-child {
        flex: 1 !important;
        min-height: 0 !important;
        border-left: none !important;
        border-top: 1px solid var(--primary) !important;
        padding: 10px !important;
      }
      
      .image-modal img {
        max-height: 40vh !important;
      }
      
      .image-modal textarea {
        font-size: 16px !important; /* Evita zoom en iOS */
      }
    }
    
    /* Estilos para panel de administraciÃ³n */
    #adminToggle.btn-success {
      animation: adminGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes adminGlow {
      0% { box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); }
      100% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.8); }
    }
    
    /* BotÃ³n de actualizaciÃ³n para mÃ³viles */
    .mobile-refresh {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 1000;
      background: rgba(255, 107, 53, 0.8);
      color: white;
      border: none;
      border-radius: 25px;
      width: 50px;
      height: 50px;
      font-size: 1.2em;
      box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
      transition: all 0.3s ease;
      display: none;
      backdrop-filter: blur(10px);
    }
    
    .mobile-refresh:hover {
      background: rgba(255, 140, 66, 0.9);
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.5);
    }
    
    .mobile-refresh:active {
      transform: scale(0.95);
    }
    
    @media (max-width: 768px) {
      .mobile-refresh {
        display: block;
      }
    }
  </style>
</head>
<body>
  <!-- BotÃ³n de actualizaciÃ³n para mÃ³viles -->
  <button class="mobile-refresh" onclick="refreshPage()" title="Actualizar Guestbook - Limpia cache y recarga la pÃ¡gina">
    â†»
  </button>
  
  <div class="container py-4">
    <div class="version-toggle" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
      <a href="guestbook-old.html" class="btn btn-outline-warning btn-sm">
        ğŸ“œ OLD Version
      </a>
      <button id="updatesToggle" class="btn btn-outline-info btn-sm ms-2" onclick="toggleUpdatesPanel()">
        ğŸš€ v2.0.9
      </button>
      <button id="adminToggle" class="btn btn-outline-danger btn-sm ms-2" onclick="toggleAdminPanel()">
        ğŸ” Admin
      </button>
      <button id="modToggle" class="btn btn-outline-warning btn-sm ms-2" onclick="toggleModPanel()">
        ğŸ›¡ï¸ Mod
      </button>
    </div>
    
    <!-- Panel de AdministraciÃ³n -->
    <div id="adminPanel" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
          <div class="modal-header" style="border-bottom: 1px solid var(--primary);">
            <h5 class="modal-title" style="color: var(--primary);">ğŸ” Panel de AdministraciÃ³n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
          </div>
          <div class="modal-body">
            <div id="adminLogin" class="text-center">
              <div class="mb-3">
                <label class="form-label text-light">Acceso al Panel</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="ContraseÃ±a de acceso">
                <small class="text-muted">Admin: ContraseÃ±a especial | Moderador: ContraseÃ±a especial</small>
              </div>
              <button onclick="loginAdmin()" class="btn btn-primary">ğŸ”“ Acceder</button>
            </div>
            
            <div id="moderatorLogin" style="display: none;">
              <div class="text-center mb-3">
                <h6 class="text-success">ğŸ›¡ï¸ Acceso de Moderador</h6>
                <p class="small text-muted">Inicia sesiÃ³n con tu cuenta de moderador</p>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-primary">Iniciar SesiÃ³n</h6>
                  <div class="mb-2">
                    <input type="text" id="modLoginUsername" class="form-control form-control-sm" placeholder="Usuario">
                  </div>
                  <div class="mb-2">
                    <input type="password" id="modLoginPassword" class="form-control form-control-sm" placeholder="ContraseÃ±a">
                  </div>
                  <button onclick="loginModerator()" class="btn btn-success btn-sm w-100">ğŸ”‘ Entrar</button>
                </div>
                <div class="col-md-6">
                  <h6 class="text-warning">Crear Cuenta</h6>
                  <div class="mb-2">
                    <input type="password" id="modCreateAuth" class="form-control form-control-sm" placeholder="ContraseÃ±a de moderador">
                    <small class="text-muted">Solicita la contraseÃ±a al administrador</small>
                  </div>
                  <div class="mb-2">
                    <input type="text" id="modCreateName" class="form-control form-control-sm" placeholder="Nombre completo">
                  </div>
                  <div class="mb-2">
                    <input type="text" id="modCreateUsername" class="form-control form-control-sm" placeholder="Usuario">
                  </div>
                  <div class="mb-2">
                    <input type="password" id="modCreatePassword" class="form-control form-control-sm" placeholder="Tu contraseÃ±a">
                  </div>
                  <button onclick="createModerator()" class="btn btn-warning btn-sm w-100">â• Crear</button>
                </div>
              </div>
              <div class="text-center mt-3">
                <button onclick="backToMainLogin()" class="btn btn-outline-secondary btn-sm">â† Volver</button>
              </div>
            </div>
            
            <div id="adminContent" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-success mb-0">âœ… SesiÃ³n Activa</h6>
                <div>
                  <span id="userInfo" class="badge bg-info me-2">Usuario</span>
                  <button onclick="logoutAdmin()" class="btn btn-outline-danger btn-sm">ğŸšª Cerrar SesiÃ³n</button>
                </div>
              </div>
              
              <!-- Tabs de navegaciÃ³n -->
              <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="suggestions-tab" data-bs-toggle="tab" data-bs-target="#suggestions" type="button" role="tab">
                    ğŸ“ Sugerencias
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="drawings-tab" data-bs-toggle="tab" data-bs-target="#drawings" type="button" role="tab">
                    ğŸ—‘ï¸ Dibujos
                  </button>
                </li>
                <li class="nav-item admin-only" role="presentation">
                  <button class="nav-link" id="moderators-tab" data-bs-toggle="tab" data-bs-target="#moderators" type="button" role="tab">
                    ğŸ‘¥ Moderadores
                  </button>
                </li>
              </ul>
              
              <!-- Contenido de tabs -->
              <div class="tab-content" id="adminTabContent">
                <!-- Tab de Sugerencias -->
                <div class="tab-pane fade show active" id="suggestions" role="tabpanel">
                  <div id="adminSuggestions" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando sugerencias...</div>
                  </div>
                </div>
                
                <!-- Tab de Dibujos -->
                <div class="tab-pane fade" id="drawings" role="tabpanel">
                  <div id="adminDrawings" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando dibujos...</div>
                  </div>
                </div>
                
                <!-- Tab de Moderadores (solo admin) -->
                <div class="tab-pane fade admin-only" id="moderators" role="tabpanel">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="text-primary">â• Gestionar Moderador</h6>
                      <form id="addModeratorForm">
                        <div class="mb-2">
                          <input type="text" id="modName" class="form-control form-control-sm" placeholder="Nombre completo" maxlength="50">
                        </div>
                        <div class="mb-2">
                          <input type="text" id="modUsername" class="form-control form-control-sm" placeholder="Usuario" maxlength="30">
                        </div>
                        <div class="mb-2">
                          <input type="password" id="modPassword" class="form-control form-control-sm" placeholder="ContraseÃ±a" minlength="6">
                        </div>
                        <div class="mb-2">
                          <label class="form-label small text-light">Permisos:</label>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="delete_drawings" id="perm1">
                            <label class="form-check-label small" for="perm1">Eliminar dibujos</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="manage_comments" id="perm2">
                            <label class="form-check-label small" for="perm2">Gestionar comentarios</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="manage_suggestions" id="perm3">
                            <label class="form-check-label small" for="perm3">Gestionar sugerencias</label>
                          </div>
                        </div>
                        <button type="button" onclick="addModerator()" class="btn btn-primary btn-sm w-100">â• AÃ±adir</button>
                      </form>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-warning">ğŸ‘¥ Moderadores Actuales</h6>
                      <div id="moderatorsList" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted">Cargando moderadores...</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Panel de Moderador -->
    <div id="modPanel" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
          <div class="modal-header" style="border-bottom: 1px solid var(--primary);">
            <h5 class="modal-title" style="color: var(--primary);">ğŸ›¡ï¸ Panel de Moderador</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
          </div>
          <div class="modal-body">
            <div id="modLogin">
              <div class="mb-3">
                <label class="form-label text-light">Usuario</label>
                <input type="text" id="modPanelUsername" class="form-control" placeholder="Ingresa tu usuario">
              </div>
              <div class="mb-3">
                <label class="form-label text-light">ContraseÃ±a</label>
                <input type="password" id="modPanelPassword" class="form-control" placeholder="Ingresa tu contraseÃ±a">
              </div>
              <div class="text-center">
                <button onclick="loginMod()" class="btn btn-warning">ğŸ”‘ Iniciar SesiÃ³n</button>
              </div>
            </div>
            
            <div id="modContent" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-success mb-0">âœ… SesiÃ³n Activa</h6>
                <div>
                  <span id="modUserInfo" class="badge bg-warning me-2">Moderador</span>
                  <button onclick="logoutMod()" class="btn btn-outline-danger btn-sm">ğŸšº Salir</button>
                </div>
              </div>
              
              <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                  <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mod-suggestions">ğŸ“ Sugerencias</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mod-drawings">ğŸ—‘ï¸ Dibujos</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mod-reports">âš ï¸ Reportes</button>
                </li>
              </ul>
              
              <div class="tab-content">
                <div class="tab-pane fade show active" id="mod-suggestions">
                  <div id="modSuggestions" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando...</div>
                  </div>
                </div>
                <div class="tab-pane fade" id="mod-drawings">
                  <div id="modDrawings" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando...</div>
                  </div>
                </div>
                <div class="tab-pane fade" id="mod-reports">
                  <div id="modReports" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Panel de Updates -->
    <div id="updatesPanel" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
          <div class="modal-header" style="border-bottom: 1px solid var(--primary);">
            <h5 class="modal-title" style="color: var(--primary);">ğŸš€ Guestbook Updates v2.0.9</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <div class="d-flex align-items-center gap-3 mb-3">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em;">
                  ğŸ¨
                </div>
                <div>
                  <h6 style="color: var(--primary); margin: 0; font-size: 1.2em;">Guestbook v2.0.9</h6>
                  <small style="color: var(--text-secondary);">20 de Diciembre, 2024</small>
                </div>
                <div class="ms-auto">
                  <span class="badge" style="background: var(--primary); color: white; padding: 0.5rem 1rem;">ESTABLE</span>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <h6 style="color: var(--primary); margin-bottom: 1rem;">âœ¨ Nuevas CaracterÃ­sticas</h6>
                <div style="max-height: 300px; overflow-y: auto;">
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ‘¤ Sistema de Perfiles</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Fotos personalizadas y avatares inteligentes</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ¨ Avatares Ãšnicos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">20 emojis diferentes por usuario</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ“Š Modal Clickeable</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Perfil detallado con estadÃ­sticas</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸŒˆ Tema Funky Atlas</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Nuevo tema con colores vibrantes</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ“± Metadatos Discord</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Optimizado para redes sociales</div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <h6 style="color: var(--secondary); margin-bottom: 1rem;">ğŸ”§ Mejoras y Correcciones</h6>
                <div style="max-height: 300px; overflow-y: auto;">
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ”§ Modal Optimizado</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Perfil compacto que no cubre comentarios</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸ“± Comentarios Compactos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">MÃ¡s contenido visible sin scroll</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">âš¡ ValidaciÃ³n AutomÃ¡tica</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Archivos de imagen y tamaÃ±o</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">ğŸš« Errores Suprimidos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Extensiones del navegador</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">âœ¨ Efectos Visuales</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Hover effects y transiciones suaves</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mt-4 p-3" style="background: var(--bg-light); border-radius: 8px; border: 1px solid var(--primary);">
              <h6 style="color: var(--primary); margin-bottom: 1rem;">ğŸ“ˆ EstadÃ­sticas de Desarrollo</h6>
              <div class="row text-center">
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">10</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Versiones</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">50+</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Herramientas</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">11</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Temas</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">4</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Meses</div>
                </div>
              </div>
            </div>
            
            <div class="mt-3 text-center">
              <a href="../README.md" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                ğŸ“ Ver README completo
              </a>
              <a href="../updates.json" target="_blank" class="btn btn-outline-info btn-sm">
                ğŸ“„ Ver updates.json
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="text-center mb-4">
      <h1 style="color: var(--primary);">ğŸ¨ Guestbook NEW</h1>
      <p style="color: var(--text-secondary);">Sistema modular avanzado</p>
      <div class="d-flex justify-content-center gap-2 mb-3">
        <a href="../index.html" class="btn btn-outline-secondary btn-sm">
          ğŸ  Volver al Lab
        </a>
      </div>
    </div>
    
    <!-- Canvas y Controles -->
    <div class="row">
      <!-- Canvas -->
      <div class="col-lg-8 col-md-12">
        <div class="canvas-container text-center">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="badge bg-primary">ğŸ¨ Lienzo de Dibujo</div>
              <div class="d-flex gap-2">
                <span class="badge bg-secondary" id="canvasInfo">600Ã—400</span>
                <span class="badge bg-info" id="zoomInfo">100%</span>
              </div>
            </div>
          </div>
          
          <div style="position: relative; display: inline-block;">
            <div id="gifBackground" style="position: absolute; top: 0; left: 0; width: 600px; height: 400px; z-index: 1; display: none; border-radius: 8px; overflow: hidden;">
              <img id="gifBackgroundImg" style="width: 100%; height: 100%; object-fit: cover;" alt="Fondo GIF">
            </div>
            <canvas id="drawCanvas" width="600" height="400" style="position: relative; z-index: 2;"></canvas>
            <div id="gifStickersContainer" style="position: absolute; top: 0; left: 0; width: 600px; height: 400px; z-index: 3; pointer-events: none;"></div>
          </div>
        </div>
      </div>
      
      <!-- Panel de Control -->
      <div class="col-lg-4 col-md-12">
        <div class="card h-100" style="background: var(--bg-light); border: 1px solid var(--primary);">
          <div class="card-header text-center" style="background: linear-gradient(45deg, var(--primary), #ff8c42); color: white;">
            <h6 class="mb-0">ğŸ›ï¸ Panel de Control</h6>
          </div>
          <div class="card-body p-3">
            <!-- Info del dibujo -->
            <div class="control-section">
              <div class="mb-2">
                <label class="form-label text-light small">ğŸ‘¤ Autor</label>
                <input type="text" id="authorName" placeholder="Tu nombre" class="form-control form-control-sm">
              </div>
              <div class="mb-2">
                <label class="form-label text-light small">ğŸ“· Foto de Perfil</label>
                <input type="file" id="profilePicture" accept="image/*" class="form-control form-control-sm">
                <small class="text-muted">Opcional: Sube tu foto de perfil</small>
              </div>
              <div class="mb-2">
                <label class="form-label text-light small">ğŸ“‚ CategorÃ­a</label>
                <select id="categorySelect" class="form-select form-select-sm">
                  <option value="Arte">ğŸ¨ Arte</option>
                  <option value="Meme">ğŸ˜‚ Meme</option>
                  <option value="Divertido">ğŸ‰ Divertido</option>
                  <option value="Abstracto">ğŸŒŒ Abstracto</option>
                  <option value="Otro">âœ¨ Otro</option>
                </select>
              </div>
              <button id="useProfileName" class="btn btn-outline-info btn-sm w-100">ğŸ‘¤ Usar perfil</button>
            </div>
          
            <!-- Herramientas principales -->
            <div class="control-section">
              <label class="form-label text-light small">ğŸ› ï¸ Herramientas</label>
              <div class="btn-group-custom">
                <button id="brushBtn" class="btn btn-neon btn-sm">ğŸ–Œï¸ Pincel</button>
                <button id="eraserBtn" class="btn btn-neon btn-sm">ğŸ§½ Borrar</button>
                <button id="bucketBtn" class="btn btn-neon btn-sm">ğŸª£ Relleno</button>
                <button id="textBtn" class="btn btn-neon btn-sm">ğŸ…°ï¸ Texto</button>
                <button id="stickerMoveBtn" class="btn btn-neon btn-sm">âœ‹ Mover</button>
              </div>
              <div class="btn-group-custom mt-2">
                <button id="undoBtn" class="btn btn-outline-warning btn-sm">â†¶ Deshacer</button>
                <button id="redoBtn" class="btn btn-outline-info btn-sm">â†· Rehacer</button>
                <button id="clearBtn" class="btn btn-outline-danger btn-sm">ğŸ—‘ï¸ Limpiar</button>
              </div>
            </div>
            
            <!-- TamaÃ±o y opacidad -->
            <div class="control-section">
              <label class="form-label text-light small">ğŸ“ Pincel</label>
              <div class="d-flex align-items-center gap-2">
                <input type="range" id="brushSize" min="1" max="20" value="3" class="form-range form-range-sm">
                <span id="sizeDisplay" class="badge bg-secondary">3px</span>
                <input type="range" id="opacitySlider" min="10" max="100" value="100" class="form-range form-range-sm">
                <span id="opacityDisplay" class="badge bg-secondary">100%</span>
              </div>
            </div>
            
            <!-- Colores -->
            <div class="control-section">
              <label class="form-label text-light small">ğŸ¨ Colores</label>
              <div class="d-flex flex-wrap gap-1 justify-content-center">
                <div class="color-btn active" style="background: #000; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#000000"></div>
                <div class="color-btn" style="background: #ff6b35; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff6b35"></div>
                <div class="color-btn" style="background: #f00; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff0000"></div>
                <div class="color-btn" style="background: #0f0; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#00ff00"></div>
                <div class="color-btn" style="background: #00f; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#0000ff"></div>
                <div class="color-btn" style="background: #fff; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #000;" data-color="#ffffff"></div>
                <div class="color-btn" style="background: #ff0080; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff0080"></div>
                <div class="color-btn" style="background: #00ffff; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#00ffff"></div>
                <div class="color-btn" style="background: #ffff00; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ffff00"></div>
                <div class="color-btn" style="background: #ff8000; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff8000"></div>
                <div class="color-btn" style="background: #8000ff; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#8000ff"></div>
                <div class="color-btn" style="background: #00ff80; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#00ff80"></div>
                <div class="color-btn" style="background: #ff4444; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff4444"></div>
                <div class="color-btn" style="background: #4444ff; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#4444ff"></div>
                <div class="color-btn" style="background: #44ff44; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#44ff44"></div>
                <div class="color-btn" style="background: #ffd700; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ffd700"></div>
                <input type="color" id="customColor" value="#ff6b35" class="form-control form-control-sm" style="width: 30px; height: 25px; padding: 0; border: none;">
              </div>
            </div>
            
            <!-- Sistema de Capas -->
            <div class="control-section">
              <label class="form-label text-light small">ğŸ† Capas</label>
              <div class="d-flex gap-1 mb-2">
                <button id="addLayerBtn" class="btn btn-outline-success btn-sm flex-fill">â• Nueva</button>
                <button id="deleteLayerBtn" class="btn btn-outline-danger btn-sm flex-fill">â– Eliminar</button>
              </div>
              <div id="layersList" style="max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 4px;">
                <!-- Las capas se generarÃ¡n dinÃ¡micamente -->
              </div>
            </div>
            
            <!-- Herramientas extras -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#extraTools">
                âš™ï¸ MÃ¡s Herramientas
              </button>
              <div class="collapse mt-2" id="extraTools">
                <div class="btn-group-custom mb-2">
                  <button id="sprayBtn" class="btn btn-neon btn-sm">ğŸ’¨ Spray</button>
                  <button id="selectBtn" class="btn btn-neon btn-sm">ğŸ”² Seleccionar</button>
                  <button id="lineBtn" class="btn btn-neon btn-sm">ğŸ“ LÃ­nea</button>
                  <button id="eyedropperBtn" class="btn btn-neon btn-sm">ğŸ’§ Cuentagotas</button>
                </div>
              </div>
            </div>
            
            <!-- Efectos -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#effects">
                âœ¨ Efectos
              </button>
              <div class="collapse mt-2" id="effects">
                <div class="btn-group-custom mb-2">
                  <button id="gradientBtn" class="btn btn-neon btn-sm">ğŸŒˆ Gradiente</button>
                  <button id="patternBtn" class="btn btn-neon btn-sm">ğŸ”³ PatrÃ³n</button>
                  <button id="symmetryBtn" class="btn btn-neon btn-sm">ğŸª SimetrÃ­a</button>
                </div>
                <div class="btn-group-custom mb-2">
                  <button id="neonBtn" class="btn btn-neon btn-sm">ğŸ’« NeÃ³n</button>
                  <button id="watercolorBtn" class="btn btn-neon btn-sm">ğŸ¨ Acuarela</button>
                </div>
              </div>
            </div>
            
            <!-- Filtros -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#filters">
                ğŸ¨ Filtros
              </button>
              <div class="collapse mt-2" id="filters">
                <div class="btn-group-custom mb-2">
                  <button id="blurBtn" class="btn btn-neon btn-sm">ğŸŒ«ï¸ Blur</button>
                  <button id="pixelBtn" class="btn btn-neon btn-sm">ğŸ–¼ï¸ Pixel</button>
                  <button id="vintageBtn" class="btn btn-neon btn-sm">ğŸ“· Vintage</button>
                </div>
                <div class="btn-group-custom mb-2">
                  <button id="oleoBtn" class="btn btn-neon btn-sm">ğŸ¨ Ã“leo</button>
                  <button id="carbonBtn" class="btn btn-neon btn-sm">âœï¸ CarbÃ³n</button>
                  <button id="clearFiltersBtn" class="btn btn-warning btn-sm">âŒ Quitar</button>
                </div>
              </div>
            </div>
            
            <!-- Fondos y Stickers -->
            <div class="control-section">
              <button class="btn btn-outline-primary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mediaTools">
                ğŸ–¼ï¸ Fondos y Stickers
              </button>
              <div class="collapse mt-2" id="mediaTools">
                <div class="mb-2">
                  <input type="file" id="bgUpload" accept=".png,.jpg,.jpeg,.gif" class="form-control form-control-sm mb-1">
                  <button id="setBgBtn" class="btn btn-outline-primary btn-sm w-100" disabled>ğŸ–¼ï¸ Aplicar Fondo</button>
                  <small class="text-muted d-block mt-1">ğŸ“¸ PNG/JPG en canvas â€¢ ğŸ¬ GIF como fondo animado</small>
                </div>
                <div>
                  <input type="file" id="stickerUpload" accept=".png,.jpg,.jpeg,.gif" class="form-control form-control-sm mb-1">
                  <button id="placeStickerBtn" class="btn btn-outline-success btn-sm w-100" disabled>ğŸ“Œ Sticker</button>
                  <small class="text-muted d-block mt-1">ğŸ–¼ï¸ PNG/JPG en canvas â€¢ ğŸ¦ GIF como elemento animado</small>
                </div>
              </div>
            </div>
            
            <!-- Herramientas avanzadas -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#advancedTools">
                ğŸ”§ Avanzadas
              </button>
              <div class="collapse mt-2" id="advancedTools">
                <div class="btn-group-custom mb-2">
                  <button id="rulerBtn" class="btn btn-neon btn-sm">ğŸ“ Reglas</button>
                  <button id="perspectiveBtn" class="btn btn-neon btn-sm">ğŸ“ Perspectiva</button>
                </div>
                <div class="btn-group-custom mb-2">
                  <button id="cloneBtn" class="btn btn-neon btn-sm">ğŸ“‹ Clonar</button>
                  <button id="histogramBtn" class="btn btn-neon btn-sm">ğŸ“Š Histograma</button>
                </div>
              </div>
            </div>
            
            <!-- TamaÃ±o Canvas -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#canvasSize">
                ğŸ“ TamaÃ±o Canvas
              </button>
              <div class="collapse mt-2" id="canvasSize">
                <div class="btn-group-custom mb-2">
                  <button id="smallCanvas" class="btn btn-outline-info btn-sm">400Ã—300</button>
                  <button id="mediumCanvas" class="btn btn-info btn-sm">600Ã—400</button>
                  <button id="largeCanvas" class="btn btn-outline-info btn-sm">800Ã—600</button>
                  <button id="wideCanvas" class="btn btn-outline-info btn-sm">800Ã—400</button>
                </div>
                <div class="d-flex gap-1 mb-2">
                  <input type="number" id="customWidth" placeholder="W" class="form-control form-control-sm" min="100" max="1200" value="600">
                  <span class="align-self-center text-light">Ã—</span>
                  <input type="number" id="customHeight" placeholder="H" class="form-control form-control-sm" min="100" max="800" value="400">
                </div>
                <button id="customCanvasBtn" class="btn btn-outline-info btn-sm w-100">ğŸ“ Aplicar</button>
              </div>
            </div>
            
            <!-- ConfiguraciÃ³n Pincel -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#brushConfig">
                âš™ï¸ ConfiguraciÃ³n Pincel
              </button>
              <div class="collapse mt-2" id="brushConfig">
                <select id="brushType" class="form-select form-select-sm" style="width: 150px; margin: 0 auto;">
                  <option value="normal">ğŸ–Œï¸ Normal</option>
                  <option value="fine">âœï¸ Fino</option>
                  <option value="thick">ğŸ–ï¸ Grueso</option>
                  <option value="art">ğŸ¨ Arte</option>
                </select>
              </div>
            </div>
            

            <!-- AnimaciÃ³n GIF -->
            <div class="control-section">
              <label class="form-label text-light small">ğŸ¬ AnimaciÃ³n GIF</label>
              <div class="btn-group-custom mb-2">
                <button id="captureFrameBtn" class="btn btn-outline-primary btn-sm">ğŸ“¸ Capturar</button>
                <button id="clearFramesBtn" class="btn btn-outline-warning btn-sm">ğŸ—‘ï¸ Limpiar</button>
              </div>
              <div id="frameCounter" class="text-center small text-muted">0 frames</div>
            </div>
            
            <!-- Vista y Archivo -->
            <div class="control-section">
              <label class="form-label text-light small">ğŸ” Vista & Archivo</label>
              <div class="btn-group-custom mb-2">
                <button id="zoomInBtn" class="btn btn-outline-success btn-sm">ğŸ”+ Zoom</button>
                <button id="zoomOutBtn" class="btn btn-outline-success btn-sm">ğŸ”- Zoom</button>
              </div>
              <div class="btn-group-custom mb-2">
                <input type="file" id="importBtn" accept="image/*" style="display:none">
                <button class="btn btn-info btn-sm" onclick="document.getElementById('importBtn').click()">ğŸ“ Importar</button>
                <button id="exportBtn" class="btn btn-success btn-sm">ğŸ’¾ Exportar</button>
              </div>
            </div>
            
            <!-- Acciones -->
            <div class="control-section">
              <label class="form-label text-light small">âš¡ Guardar</label>
              <button id="saveBtn" class="btn btn-primary btn-sm w-100">
                <span id="saveText">ğŸš€ Guardar</span>
                <span id="saveLoader" style="display: none;">â³ Guardando...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Rankings y Sugerencias -->
    <hr style="border-color: var(--primary);">
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
          <div class="card-header" style="background: linear-gradient(45deg, #ffd700, #ffed4e); color: #000;">
            <h5 class="mb-0">ğŸ† Top Rankings</h5>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <h6 class="text-warning">ğŸ‘‘ Top Artistas</h6>
              <div id="topArtists" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ğŸ¥‡ Cargando...</span>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <h6 class="text-info">â¤ï¸ MÃ¡s Populares</h6>
              <div id="topLiked" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ğŸ¥‡ Cargando...</span>
                </div>
              </div>
            </div>
            <div>
              <h6 class="text-success">ğŸ”¥ MÃ¡s Activos</h6>
              <div id="topActive" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ğŸ¥‡ Cargando...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
          <div class="card-header" style="background: linear-gradient(45deg, #ff6b35, #ff8c42); color: white;">
            <h5 class="mb-0">ğŸ’¡ Sugerencias</h5>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <textarea id="suggestionText" class="form-control form-control-sm" rows="3" placeholder="Tu sugerencia..."></textarea>
            </div>
            <div class="mb-3">
              <input type="file" id="suggestionImage" accept="image/*" class="form-control form-control-sm">
              <small class="text-muted">Opcional: Adjunta una imagen</small>
            </div>
            <div class="mb-3">
              <select id="suggestionType" class="form-select form-select-sm">
                <option value="feature">âœ¨ Nueva FunciÃ³n</option>
                <option value="bug">ğŸ› Reportar Bug</option>
                <option value="improvement">ğŸ”§ Mejora</option>
                <option value="other">ğŸ’­ Otro</option>
              </select>
            </div>
            <button id="submitSuggestion" class="btn btn-primary btn-sm w-100">ğŸ“¤ Enviar</button>
            <div id="recentSuggestions" class="mt-3" style="max-height: 200px; overflow-y: auto;">
              <small class="text-muted">Cargando sugerencias...</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- GalerÃ­a -->
    <div class="text-center mb-4">
      <h2 style="color: var(--primary);">ğŸ›ï¸ GalerÃ­a Interactiva</h2>
      <p style="color: var(--text-secondary);">Sistema de comentarios y likes en tiempo real</p>
    </div>
    
    <div class="row justify-content-center mb-4">
      <div class="col-md-8">
        <div class="d-flex justify-content-center gap-2 flex-wrap">
          <input type="text" id="searchAuthor" placeholder="Buscar por autor" class="form-control" style="width: 200px;">
          <select id="filterCategory" class="form-select" style="width: 180px;">
            <option value="">Todas las categorÃ­as</option>
            <option value="Arte">ğŸ¨ Arte</option>
            <option value="Meme">ğŸ˜‚ Meme</option>
            <option value="Divertido">ğŸ‰ Divertido</option>
            <option value="Abstracto">ğŸŒŒ Abstracto</option>
            <option value="Otro">âœ¨ Otro</option>
          </select>
          <button id="clearFilters" class="btn btn-outline-secondary">âŒ Limpiar</button>
          <button id="reloadData" class="btn btn-outline-info">ğŸ”„ Recargar</button>
        </div>
      </div>
    </div>
    

    
    <div id="gallery" class="row">
      <div class="col-12 text-center" style="color: var(--text-secondary);">
        <div class="spinner-border" role="status" style="color: var(--primary);">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando galerÃ­a...</p>
      </div>
    </div>
    
    <div id="pagination" class="text-center mt-4"></div>
  </div>
  
  <!-- Scripts modulares -->
  <script type="module">
    import { FirebaseManager } from './js/firebase.js';
    import { CanvasManager } from './js/canvas.js';
    import { GalleryManager } from './js/gallery.js';
    import { UIManager } from './js/ui.js';
    import { ProfileManager } from './js/profiles.js';
    
    class GuestbookApp {
      constructor() {
        this.firebase = new FirebaseManager();
        this.canvas = new CanvasManager();
        this.gallery = new GalleryManager(this.firebase);
        this.ui = new UIManager();
        this.profiles = new ProfileManager(this.firebase);
        
        // Hacer disponible globalmente
        window.guestbookApp = this;
      }
      
      async init() {
        try {
          this.setupCanvasControls();
          await this.gallery.init();
          await this.loadRecentSuggestions();
          
          // Actualizar rankings despuÃ©s de cargar la galerÃ­a
          setTimeout(() => {
            if (this.gallery.allDrawings && this.gallery.allDrawings.length > 0) {
              this.gallery.updateRankingsSection();
            }
          }, 1000);
          
          console.log('âœ… Guestbook NEW inicializado correctamente');
        } catch (error) {
          console.error('âŒ Error inicializando:', error);
        }
      }
      
      setupCanvasControls() {
        // Configurar detecciÃ³n de cambios en canvas
        this.setupUnsavedChangesDetection();
        
        // Controles de herramientas
        document.getElementById('brushBtn')?.addEventListener('click', () => {
          this.canvas.setTool('brush');
          this.currentTool = 'brush';
          this.updateToolButtons('brushBtn');
        });
        document.getElementById('eraserBtn')?.addEventListener('click', () => {
          this.canvas.setTool('eraser');
          this.currentTool = 'eraser';
          this.updateToolButtons('eraserBtn');
        });
        document.getElementById('bucketBtn')?.addEventListener('click', () => {
          this.canvas.setTool('bucket');
          this.currentTool = 'bucket';
          this.updateToolButtons('bucketBtn');
        });
        document.getElementById('textBtn')?.addEventListener('click', () => {
          this.canvas.setTool('text');
          this.currentTool = 'text';
          this.updateToolButtons('textBtn');
        });
        document.getElementById('stickerMoveBtn')?.addEventListener('click', () => this.setStickerMoveTool());
        
        // Controles de tamaÃ±o y opacidad
        document.getElementById('brushSize')?.addEventListener('input', (e) => {
          this.canvas.setSize(e.target.value);
          document.getElementById('sizeDisplay').textContent = e.target.value + 'px';
        });
        
        document.getElementById('opacitySlider')?.addEventListener('input', (e) => {
          this.canvas.setOpacity(e.target.value);
          document.getElementById('opacityDisplay').textContent = e.target.value + '%';
        });
        
        // Controles de color
        document.querySelectorAll('.color-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelector('.color-btn.active')?.classList.remove('active');
            btn.classList.add('active');
            this.canvas.setColor(btn.dataset.color);
            this.saveUserColor(btn.dataset.color);
          });
        });
        
        document.getElementById('customColor')?.addEventListener('change', (e) => {
          this.canvas.setColor(e.target.value);
          document.querySelector('.color-btn.active')?.classList.remove('active');
          this.saveUserColor(e.target.value);
        });
        
        // Cargar color guardado del usuario
        this.loadUserColor();
        
        // Configurar validaciÃ³n de foto de perfil
        document.getElementById('profilePicture')?.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 1024 * 1024) {
              this.ui.showNotification('ğŸš« Imagen muy grande. MÃ¡ximo 1MB.', 'error');
              e.target.value = '';
              return;
            }
            if (!file.type.startsWith('image/')) {
              this.ui.showNotification('ğŸš« Solo se permiten imÃ¡genes.', 'error');
              e.target.value = '';
              return;
            }
            this.ui.showNotification('âœ… Foto de perfil cargada', 'success');
          }
        });
        
        // Controles de capas
        document.getElementById('addLayerBtn')?.addEventListener('click', () => {
          this.canvas.addLayer();
        });
        
        document.getElementById('deleteLayerBtn')?.addEventListener('click', () => {
          this.canvas.deleteLayer();
        });
        
        // Controles de acciÃ³n
        document.getElementById('undoBtn')?.addEventListener('click', () => this.canvas.undo());
        document.getElementById('clearBtn')?.addEventListener('click', () => {
          if (confirm('Â¿Limpiar todo el dibujo?')) {
            this.canvas.clear();
            // Limpiar tambiÃ©n fondos y stickers GIF
            this.hideVisualGifBackground();
            document.getElementById('gifStickersContainer').innerHTML = '';
            this.gifStickers = [];
            this.currentBackgroundImage = null;
            this.isBackgroundGif = false;
            // Resetear cambios sin guardar
            window.hasUnsavedChanges = false;
          }
        });
        
        // BotÃ³n de guardar
        document.getElementById('saveBtn')?.addEventListener('click', async () => {
          await this.saveDrawing();
        });
        
        // Herramientas extras
        const tools = ['spray', 'select', 'line', 'eyedropper'];
        tools.forEach(tool => {
          const btn = document.getElementById(tool + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => {
              this.canvas.setTool(tool);
              this.currentTool = tool;
              this.updateToolButtons(tool + 'Btn');
            });
          }
        });
        
        // Efectos
        const effects = ['gradient', 'pattern', 'symmetry', 'neon', 'watercolor'];
        effects.forEach(effect => {
          const btn = document.getElementById(effect + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.setEffect(effect));
          }
        });
        
        // Filtros
        const filters = ['blur', 'pixel', 'vintage', 'oleo', 'carbon'];
        filters.forEach(filter => {
          const btn = document.getElementById(filter + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.applyFilter(filter));
          }
        });
        
        // Herramientas avanzadas
        const advancedTools = ['ruler', 'perspective', 'clone', 'histogram'];
        advancedTools.forEach(tool => {
          const btn = document.getElementById(tool + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.setAdvancedTool(tool));
          }
        });
        
        // Canvas size controls
        document.getElementById('smallCanvas')?.addEventListener('click', () => this.resizeCanvas(400, 300));
        document.getElementById('mediumCanvas')?.addEventListener('click', () => this.resizeCanvas(600, 400));
        document.getElementById('largeCanvas')?.addEventListener('click', () => this.resizeCanvas(800, 600));
        document.getElementById('wideCanvas')?.addEventListener('click', () => this.resizeCanvas(800, 400));
        document.getElementById('customCanvasBtn')?.addEventListener('click', () => {
          const width = parseInt(document.getElementById('customWidth').value) || 600;
          const height = parseInt(document.getElementById('customHeight').value) || 400;
          this.resizeCanvas(width, height);
        });
        
        // Brush type
        document.getElementById('brushType')?.addEventListener('change', (e) => {
          this.canvas.setBrushType(e.target.value);
        });
        
        // Zoom
        document.getElementById('zoomInBtn')?.addEventListener('click', () => {
          this.canvas.zoomIn();
          this.updateZoomInfo();
        });
        document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
          this.canvas.zoomOut();
          this.updateZoomInfo();
        });
        
        // Import/Export
        document.getElementById('importBtn')?.addEventListener('change', (e) => this.handleImport(e));
        
        // Fondos y stickers
        document.getElementById('bgUpload')?.addEventListener('change', (e) => this.handleBackgroundUpload(e));
        document.getElementById('setBgBtn')?.addEventListener('click', () => this.setBackground());
        document.getElementById('stickerUpload')?.addEventListener('change', (e) => this.handleStickerUpload(e));
        document.getElementById('placeStickerBtn')?.addEventListener('click', () => this.placeSticker());
        
        // BotÃ³n para limpiar fondo
        const clearBgBtn = document.createElement('button');
        clearBgBtn.className = 'btn btn-outline-warning btn-sm w-100 mt-1';
        clearBgBtn.innerHTML = 'âŒ Quitar Fondo';
        clearBgBtn.addEventListener('click', () => this.clearBackground());
        document.getElementById('setBgBtn').parentNode.appendChild(clearBgBtn);
        

        
        // Controles de GIF
        document.getElementById('captureFrameBtn')?.addEventListener('click', () => {
          this.canvas.captureFrame();
          this.updateFrameCounter();
        });
        document.getElementById('clearFramesBtn')?.addEventListener('click', () => {
          if (confirm('Â¿Eliminar todos los frames capturados?')) {
            this.canvas.clearFrames();
            this.updateFrameCounter();
          }
        });
        
        // Filtros y acciones
        document.getElementById('clearFiltersBtn')?.addEventListener('click', () => this.canvas.clearFilters());
        document.getElementById('redoBtn')?.addEventListener('click', () => this.canvas.redo());
        document.getElementById('exportBtn')?.addEventListener('click', () => this.canvas.exportImage());
        
        // Sugerencias y datos
        document.getElementById('submitSuggestion')?.addEventListener('click', () => this.submitSuggestion());
        document.getElementById('reloadData')?.addEventListener('click', () => this.gallery.loadGallery());
        
        // Inicializar lista de capas y contador de frames
        this.canvas.updateLayersList();
        this.updateFrameCounter();
        
        // Inicializar variables para GIFs
        this.currentBackgroundImage = null;
        this.isBackgroundGif = false;
        this.currentStickerImage = null;
        this.isStickerGif = false;
        this.gifStickers = [];
        this.selectedSticker = null;
        this.isDragging = false;
        this.currentTool = 'brush';
        
        // Configurar canvas para GIFs
        this.setupGifCanvas();
        
        // Configurar eventos para mover stickers
        this.setupStickerMoveEvents();
      }
      
      setupGifCanvas() {
        // Ajustar contenedores GIF al cambiar tamaÃ±o de canvas
        const observer = new ResizeObserver(() => {
          const canvas = this.canvas.canvas;
          const gifBackground = document.getElementById('gifBackground');
          const gifStickersContainer = document.getElementById('gifStickersContainer');
          
          if (gifBackground && canvas) {
            gifBackground.style.width = canvas.width + 'px';
            gifBackground.style.height = canvas.height + 'px';
          }
          
          if (gifStickersContainer && canvas) {
            gifStickersContainer.style.width = canvas.width + 'px';
            gifStickersContainer.style.height = canvas.height + 'px';
          }
        });
        
        if (this.canvas.canvas) {
          observer.observe(this.canvas.canvas);
        }
      }
      
      resizeCanvas(width, height) {
        if (!this.canvas.isEmpty() && !confirm('Â¿Cambiar tamaÃ±o del canvas? Se perderÃ¡ el dibujo actual.')) return;
        
        this.canvas.canvas.width = width;
        this.canvas.canvas.height = height;
        this.canvas.ctx.lineCap = 'round';
        this.canvas.ctx.lineJoin = 'round';
        
        const canvasInfo = document.getElementById('canvasInfo');
        if (canvasInfo) {
          canvasInfo.textContent = `${width}Ã—${height}`;
        }
        
        // Actualizar contenedores GIF
        const gifBackground = document.getElementById('gifBackground');
        const gifStickersContainer = document.getElementById('gifStickersContainer');
        
        if (gifBackground) {
          gifBackground.style.width = width + 'px';
          gifBackground.style.height = height + 'px';
        }
        
        if (gifStickersContainer) {
          gifStickersContainer.style.width = width + 'px';
          gifStickersContainer.style.height = height + 'px';
        }
        
        this.canvas.saveState();
      }
      
      updateZoomInfo() {
        const zoomInfo = document.getElementById('zoomInfo');
        if (zoomInfo && this.canvas.zoomLevel) {
          zoomInfo.textContent = Math.round(this.canvas.zoomLevel * 100) + '%';
        }
      }
      
      updateFrameCounter() {
        const counter = document.getElementById('frameCounter');
        if (counter) {
          const count = this.canvas.getFrameCount();
          counter.textContent = `${count} frame${count !== 1 ? 's' : ''}`;
          counter.style.color = count > 1 ? 'var(--primary)' : 'var(--text-secondary)';
        }
      }
      

      
      handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          this.ui.showNotification('ğŸš« Formato no soportado.', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
            this.canvas.ctx.drawImage(img, 0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
            this.canvas.saveState();
            this.ui.showNotification('âœ… Imagen importada', 'success');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      async saveDrawing() {
        const saveBtn = document.getElementById('saveBtn');
        const saveText = document.getElementById('saveText');
        const saveLoader = document.getElementById('saveLoader');
        
        if (this.canvas.isEmpty()) {
          this.ui.showNotification('Â¡Dibuja algo primero!', 'error');
          return;
        }
        
        saveBtn.disabled = true;
        saveText.style.display = 'none';
        saveLoader.style.display = 'inline';
        
        try {
          // Mostrar mensaje si es GIF animado
          const frameCount = this.canvas.getFrameCount();
          if (frameCount > 1) {
            this.ui.showNotification('ğŸ¬ Creando GIF animado...', 'info');
          }
          
          let imageData = await this.canvas.getImageData();
          const author = document.getElementById('authorName').value || 'AnÃ³nimo';
          const category = document.getElementById('categorySelect').value;
          
          // Comprimir imagen si es muy grande
          const imageSize = imageData.length;
          if (imageSize > 800000) { // ~800KB
            console.log('ğŸ—‚ï¸ Comprimiendo imagen:', imageSize, 'bytes');
            imageData = await this.compressImage(imageData, 600);
            console.log('âœ… Imagen comprimida:', imageData.length, 'bytes');
            this.ui.showNotification('ğŸ—‚ï¸ Imagen comprimida para Firebase', 'info');
          }
          
          // Procesar foto de perfil si se subiÃ³
          let profilePicture = null;
          const profileFile = document.getElementById('profilePicture').files[0];
          if (profileFile) {
            profilePicture = await this.processProfilePicture(profileFile);
            // Guardar en localStorage para uso futuro
            localStorage.setItem('user-profile-picture', profilePicture);
            localStorage.setItem('user-profile-name', author);
          } else {
            // Usar foto guardada si existe
            profilePicture = localStorage.getItem('user-profile-picture');
          }
          
          const drawingData = {
            titulo: `Dibujo de ${author}`,
            imagenData: imageData,
            timestamp: Date.now(),
            autor: author,
            categoria: category,
            domain: 'thisisfenix.github.io',
            likes: 0,
            comments: [],
            layers: this.canvas.getLayers(),
            filters: this.canvas.getAppliedFilters(),
            isAnimated: frameCount > 1,
            strokes: this.canvas.getStrokeCount ? this.canvas.getStrokeCount() : 0,
            profilePicture: profilePicture
          };
          
          // Si es GIF animado, guardar en backgroundGif
          if (frameCount > 1) {
            drawingData.backgroundGif = imageData;
          }
          
          // Guardar fondo GIF si existe
          if (this.isBackgroundGif && this.currentBackgroundImage) {
            const bgSize = this.currentBackgroundImage.src.length;
            if (bgSize > 800000) {
              console.warn('âš ï¸ Fondo GIF muy grande:', bgSize, 'bytes');
              this.ui.showNotification('âš ï¸ Fondo GIF muy grande, se comprimirÃ¡', 'warning');
              drawingData.backgroundGif = await this.compressGifForFirebase(this.currentBackgroundImage.src);
            } else {
              drawingData.backgroundGif = this.currentBackgroundImage.src;
            }
          }
          
          // Guardar stickers GIF animados (solo datos primitivos)
          if (this.gifStickers && this.gifStickers.length > 0) {
            drawingData.gifStickers = this.gifStickers.map(s => {
              // Verificar tamaÃ±o del src
              const srcSize = s.src ? s.src.length : 0;
              if (srcSize > 800000) { // ~800KB
                console.warn('âš ï¸ Sticker GIF muy grande, se omitirÃ¡:', srcSize, 'bytes');
                return null;
              }
              
              return {
                src: String(s.src || ''),
                x: Number(s.x) || 0,
                y: Number(s.y) || 0,
                width: Number(s.width) || 60,
                height: Number(s.height) || 60
              };
            }).filter(s => s !== null); // Filtrar stickers nulos
          }
          
          await this.firebase.saveDrawing(drawingData);
          
          this.canvas.clear();
          document.getElementById('authorName').value = '';
          document.getElementById('categorySelect').value = 'Arte';
          document.getElementById('profilePicture').value = '';
          
          // Limpiar fondos y stickers GIF
          this.hideVisualGifBackground();
          document.getElementById('gifStickersContainer').innerHTML = '';
          this.gifStickers = [];
          this.currentBackgroundImage = null;
          this.isBackgroundGif = false;
          this.currentStickerImage = null;
          this.isStickerGif = false;
          
          // Resetear botones
          document.getElementById('setBgBtn').disabled = true;
          document.getElementById('setBgBtn').innerHTML = 'ğŸ–¼ï¸ Aplicar Fondo';
          document.getElementById('placeStickerBtn').disabled = true;
          document.getElementById('placeStickerBtn').innerHTML = 'ğŸ“Œ Sticker';
          document.getElementById('bgUpload').value = '';
          document.getElementById('stickerUpload').value = '';
          
          // Marcar como guardado
          window.hasUnsavedChanges = false;
          
          this.ui.showNotification('âœ… Â¡Dibujo guardado!', 'success');
          this.ui.createConfetti();
          
          // Actualizar galerÃ­a
          setTimeout(() => {
            this.gallery.loadGallery();
            document.getElementById('gallery').scrollIntoView({ behavior: 'smooth' });
          }, 1000);
          
        } catch (error) {
          console.error('Error:', error);
          
          // Mensajes de error mÃ¡s especÃ­ficos
          let errorMessage = 'âŒ Error al guardar';
          if (error.message && error.message.includes('invalid nested entity')) {
            errorMessage = 'âŒ Error: Datos demasiado complejos para Firebase';
          } else if (error.message && error.message.includes('too large')) {
            errorMessage = 'âŒ Error: Archivo muy grande (mÃ¡x 800KB)';
          } else if (error.code === 'permission-denied') {
            errorMessage = 'âŒ Error: Sin permisos para guardar';
          } else if (error.code === 'unavailable') {
            errorMessage = 'âŒ Error: Servicio no disponible';
          }
          
          this.ui.showNotification(errorMessage, 'error');
        } finally {
          saveBtn.disabled = false;
          saveText.style.display = 'inline';
          saveLoader.style.display = 'none';
        }
      }
      
      handleBackgroundUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Verificar tamaÃ±o de archivo (mÃ¡x 3MB para evitar problemas)
        if (file.size > 3 * 1024 * 1024) {
          this.ui.showNotification('ğŸš« Archivo muy grande. MÃ¡ximo 3MB permitido.', 'error');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.currentBackgroundImage = img;
            this.isBackgroundGif = file.type === 'image/gif';
            
            const btn = document.getElementById('setBgBtn');
            btn.disabled = false;
            
            if (this.isBackgroundGif) {
              btn.innerHTML = 'ğŸ¬ GIF Listo';
              btn.style.background = '#28a745';
              btn.style.color = 'white';
            } else {
              btn.innerHTML = 'ğŸ–¼ï¸ Listo';
              btn.style.background = '';
              btn.style.color = '';
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      setBackground() {
        if (!this.currentBackgroundImage) return;
        
        // Si es GIF, usar fondo visual animado
        if (this.isBackgroundGif) {
          this.setVisualGifBackground(this.currentBackgroundImage.src);
        } else {
          // Para imÃ¡genes estÃ¡ticas, dibujar en canvas
          this.hideVisualGifBackground();
          
          // Guardar el dibujo actual
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = this.canvas.canvas.width;
          tempCanvas.height = this.canvas.canvas.height;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(this.canvas.canvas, 0, 0);
          
          // Limpiar canvas
          this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
          
          // Dibujar imagen de fondo adaptada al canvas
          this.canvas.ctx.drawImage(this.currentBackgroundImage, 0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
          
          // Restaurar el dibujo encima del fondo
          this.canvas.ctx.drawImage(tempCanvas, 0, 0);
        }
        
        this.canvas.saveState();
        
        const btn = document.getElementById('setBgBtn');
        if (this.isBackgroundGif) {
          btn.innerHTML = 'ğŸ¬ GIF Aplicado';
          btn.style.background = '#28a745';
          btn.style.color = 'white';
        } else {
          btn.innerHTML = 'âœ… Aplicado';
        }
        
        setTimeout(() => {
          btn.innerHTML = 'ğŸ–¼ï¸ Aplicar Fondo';
          btn.style.background = '';
          btn.style.color = '';
        }, 3000);
      }
      
      setVisualGifBackground(gifSrc) {
        const gifBackground = document.getElementById('gifBackground');
        const gifImg = document.getElementById('gifBackgroundImg');
        
        gifImg.src = gifSrc;
        gifBackground.style.display = 'block';
        
        // Ajustar el contenedor GIF al tamaÃ±o actual del canvas
        gifBackground.style.width = this.canvas.canvas.width + 'px';
        gifBackground.style.height = this.canvas.canvas.height + 'px';
        
        // Hacer el canvas semi-transparente para que se vea el GIF
        this.canvas.canvas.style.background = 'rgba(255, 255, 255, 0.1)';
      }
      
      hideVisualGifBackground() {
        const gifBackground = document.getElementById('gifBackground');
        gifBackground.style.display = 'none';
        this.canvas.canvas.style.background = 'white';
      }
      
      clearBackground() {
        if (!confirm('Â¿Quitar el fondo de imagen?')) return;
        
        // Guardar el dibujo actual
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = this.canvas.canvas.width;
        tempCanvas.height = this.canvas.canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(this.canvas.canvas, 0, 0);
        
        // Limpiar canvas completamente
        this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
        
        // Solo restaurar el dibujo (sin fondo)
        this.canvas.ctx.globalCompositeOperation = 'source-over';
        this.canvas.ctx.drawImage(tempCanvas, 0, 0);
        
        // Limpiar variables de fondo
        this.currentBackgroundImage = null;
        this.isBackgroundGif = false;
        this.hideVisualGifBackground();
        
        this.canvas.saveState();
        this.ui.showNotification('âœ… Fondo eliminado', 'success');
      }
      
      handleStickerUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Verificar tamaÃ±o de archivo (mÃ¡x 2MB para stickers)
        if (file.size > 2 * 1024 * 1024) {
          this.ui.showNotification('ğŸš« Sticker muy grande. MÃ¡ximo 2MB permitido.', 'error');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.currentStickerImage = img;
            this.isStickerGif = file.type === 'image/gif';
            
            const btn = document.getElementById('placeStickerBtn');
            btn.disabled = false;
            
            // Mostrar preview si es GIF
            if (this.isStickerGif) {
              btn.innerHTML = 'ğŸ“Œ GIF Listo';
              btn.style.background = '#28a745';
              btn.style.color = 'white';
            } else {
              btn.innerHTML = 'ğŸ“Œ Listo';
              btn.style.background = '';
              btn.style.color = '';
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      placeSticker() {
        if (!this.currentStickerImage) return;
        
        this.canvas.canvas.style.cursor = 'copy';
        this.ui.showNotification('ğŸ“Œ Haz clic donde quieras colocar el sticker', 'info');
        
        const placeHandler = (e) => {
          const rect = this.canvas.canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (this.canvas.canvas.width / rect.width) - 30;
          const y = (e.clientY - rect.top) * (this.canvas.canvas.height / rect.height) - 30;
          
          if (this.isStickerGif) {
            // Para GIFs, crear elemento HTML animado
            this.createGifStickerElement({
              id: Date.now(),
              image: this.currentStickerImage,
              x: x,
              y: y,
              width: 60,
              height: 60,
              isGif: true
            });
          } else {
            // Para imÃ¡genes estÃ¡ticas, dibujar en canvas
            this.canvas.ctx.drawImage(this.currentStickerImage, x, y, 60, 60);
          }
          
          this.canvas.canvas.style.cursor = 'crosshair';
          this.canvas.canvas.removeEventListener('click', placeHandler);
          this.canvas.saveState();
        };
        
        this.canvas.canvas.addEventListener('click', placeHandler, { once: true });
      }
      
      createGifStickerElement(sticker) {
        const container = document.getElementById('gifStickersContainer');
        const gifElement = document.createElement('img');
        
        gifElement.src = sticker.image.src;
        gifElement.style.cssText = `
          position: absolute;
          left: ${sticker.x}px;
          top: ${sticker.y}px;
          width: ${sticker.width}px;
          height: ${sticker.height}px;
          pointer-events: auto;
          cursor: grab;
          z-index: 10;
          image-rendering: auto;
        `;
        
        gifElement.dataset.stickerId = sticker.id;
        
        container.appendChild(gifElement);
        
        // Agregar a la lista de stickers para guardar (sin elemento DOM)
        if (!this.gifStickers) this.gifStickers = [];
        const stickerData = {
          src: sticker.image.src,
          x: sticker.x,
          y: sticker.y,
          width: sticker.width,
          height: sticker.height
        };
        
        // Verificar tamaÃ±o antes de agregar
        const srcSize = stickerData.src ? stickerData.src.length : 0;
        if (srcSize > 800000) {
          this.ui.showNotification('âš ï¸ Sticker GIF muy grande (>800KB), se guardarÃ¡ localmente pero no en Firebase', 'warning');
        }
        
        // Agregar referencia al elemento para mover
        stickerData.element = gifElement;
        this.gifStickers.push(stickerData);
      }
      
      setStickerMoveTool() {
        this.currentTool = 'stickerMove';
        this.canvas.canvas.style.cursor = 'grab';
        this.updateToolButtons('stickerMoveBtn');
        this.ui.showNotification('âœ‹ Herramienta de mover stickers activada', 'info');
      }
      
      updateToolButtons(activeButtonId) {
        // Remover clase activa de todos los botones
        document.querySelectorAll('.btn-neon').forEach(btn => btn.classList.remove('btn-primary'));
        // Agregar clase activa al botÃ³n seleccionado
        const activeBtn = document.getElementById(activeButtonId);
        if (activeBtn) {
          activeBtn.classList.add('btn-primary');
        }
      }
      
      setupStickerMoveEvents() {
        const canvas = this.canvas.canvas;
        
        // FunciÃ³n para limpiar el estado de arrastre
        const cleanupDrag = () => {
          if (this.isDragging) {
            this.isDragging = false;
            this.selectedSticker = null;
            canvas.style.cursor = this.currentTool === 'stickerMove' ? 'grab' : 'crosshair';
            this.canvas.saveState();
          }
        };
        
        canvas.addEventListener('mousedown', (e) => {
          if (this.currentTool === 'stickerMove') {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            this.selectedSticker = this.findStickerAt(x, y);
            if (this.selectedSticker) {
              this.isDragging = true;
              canvas.style.cursor = 'grabbing';
              e.preventDefault();
              e.stopPropagation();
            }
          }
        });
        
        canvas.addEventListener('mousemove', (e) => {
          if (this.currentTool === 'stickerMove' && this.isDragging && this.selectedSticker) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            // Centrar el sticker en el punto de toque
            const centerOffsetX = this.selectedSticker.width / 2;
            const centerOffsetY = this.selectedSticker.height / 2;
            this.selectedSticker.x = x - centerOffsetX;
            this.selectedSticker.y = y - centerOffsetY;
            
            // Mantener dentro del canvas
            this.selectedSticker.x = Math.max(0, Math.min(canvas.width - this.selectedSticker.width, this.selectedSticker.x));
            this.selectedSticker.y = Math.max(0, Math.min(canvas.height - this.selectedSticker.height, this.selectedSticker.y));
            
            // Actualizar posiciÃ³n del elemento
            if (this.selectedSticker.element) {
              this.selectedSticker.element.style.left = this.selectedSticker.x + 'px';
              this.selectedSticker.element.style.top = this.selectedSticker.y + 'px';
            }
            
            e.preventDefault();
            e.stopPropagation();
          }
        });
        
        // Eventos de mouseup en canvas y document para asegurar que se libere
        canvas.addEventListener('mouseup', cleanupDrag);
        document.addEventListener('mouseup', cleanupDrag);
        
        // Limpiar cuando el mouse sale del canvas
        canvas.addEventListener('mouseleave', cleanupDrag);
        
        // Limpiar cuando se cambia de herramienta
        const originalSetTool = this.canvas.setTool;
        this.canvas.setTool = (tool) => {
          cleanupDrag();
          originalSetTool.call(this.canvas, tool);
        };
        
        // Touch events para mÃ³vil con mejor manejo
        canvas.addEventListener('touchstart', (e) => {
          if (this.currentTool === 'stickerMove') {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
            
            this.selectedSticker = this.findStickerAt(x, y);
            if (this.selectedSticker) {
              this.isDragging = true;
              canvas.style.cursor = 'grabbing';
            }
          }
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
          if (this.currentTool === 'stickerMove' && this.isDragging && this.selectedSticker) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
            
            // Centrar el sticker en el punto de toque
            const centerOffsetX = this.selectedSticker.width / 2;
            const centerOffsetY = this.selectedSticker.height / 2;
            this.selectedSticker.x = x - centerOffsetX;
            this.selectedSticker.y = y - centerOffsetY;
            
            // Mantener dentro del canvas
            this.selectedSticker.x = Math.max(0, Math.min(canvas.width - this.selectedSticker.width, this.selectedSticker.x));
            this.selectedSticker.y = Math.max(0, Math.min(canvas.height - this.selectedSticker.height, this.selectedSticker.y));
            
            // Actualizar posiciÃ³n del elemento
            if (this.selectedSticker.element) {
              this.selectedSticker.element.style.left = this.selectedSticker.x + 'px';
              this.selectedSticker.element.style.top = this.selectedSticker.y + 'px';
            }
          }
        }, { passive: false });
        
        canvas.addEventListener('touchend', cleanupDrag, { passive: false });
        canvas.addEventListener('touchcancel', cleanupDrag, { passive: false });
        
        // Limpiar cuando se pierde el foco de la ventana
        window.addEventListener('blur', cleanupDrag);
        
        // Limpiar cuando se presiona Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isDragging) {
            cleanupDrag();
            this.ui.showNotification('âŒ Movimiento de sticker cancelado', 'info');
          }
        });
      }
      
      findStickerAt(x, y) {
        if (!this.gifStickers) return null;
        
        // Buscar desde el Ãºltimo (mÃ¡s arriba) hacia el primero
        for (let i = this.gifStickers.length - 1; i >= 0; i--) {
          const sticker = this.gifStickers[i];
          if (!sticker) continue;
          
          const margin = 10; // Margen para facilitar la selecciÃ³n
          
          if (x >= sticker.x - margin && x <= sticker.x + sticker.width + margin &&
              y >= sticker.y - margin && y <= sticker.y + sticker.height + margin) {
            return sticker;
          }
        }
        return null;
      }
      
      async submitSuggestion() {
        const text = document.getElementById('suggestionText').value.trim();
        const type = document.getElementById('suggestionType').value;
        const imageFile = document.getElementById('suggestionImage').files[0];
        
        if (!text) {
          this.ui.showNotification('âœï¸ Escribe tu sugerencia primero', 'error');
          return;
        }
        
        try {
          let imageData = null;
          
          if (imageFile) {
            if (imageFile.size > 2 * 1024 * 1024) {
              this.ui.showNotification('ğŸš« Imagen muy grande. MÃ¡ximo 2MB.', 'error');
              return;
            }
            
            imageData = await this.processImageForSuggestion(imageFile);
          }
          
          const suggestionData = {
            texto: text,
            tipo: type,
            timestamp: Date.now(),
            autor: document.getElementById('authorName').value.trim() || 'AnÃ³nimo',
            domain: 'thisisfenix.github.io',
            status: 'pendiente'
          };
          
          if (imageData) {
            suggestionData.imagen = imageData;
          }
          
          await this.firebase.saveSuggestion(suggestionData);
          
          document.getElementById('suggestionText').value = '';
          document.getElementById('suggestionImage').value = '';
          this.ui.showNotification('âœ… Sugerencia enviada', 'success');
          this.loadRecentSuggestions();
          
        } catch (error) {
          console.error('Error:', error);
          this.ui.showNotification('âŒ Error al enviar sugerencia', 'error');
        }
      }
      
      processImageForSuggestion(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              // Redimensionar si es muy grande
              const maxSize = 300;
              let { width, height } = img;
              
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height * maxSize) / width;
                  width = maxSize;
                } else {
                  width = (width * maxSize) / height;
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              
              resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }
      
      async loadRecentSuggestions() {
        try {
          const suggestions = await this.firebase.getRecentSuggestions();
          const container = document.getElementById('recentSuggestions');
          
          if (!container) return;
          
          if (!suggestions || suggestions.length === 0) {
            container.innerHTML = '<div class="text-muted">No hay sugerencias aÃºn</div>';
            return;
          }
          
          container.innerHTML = suggestions.slice(0, 5).map(s => `
            <div class="mb-2 p-2" style="background: rgba(255,255,255,0.1); border-radius: 6px; border-left: 3px solid var(--primary);">
              <div class="d-flex justify-content-between mb-1">
                <span class="text-warning small">${this.getSuggestionIcon(s.tipo)} <strong>${s.autor || 'AnÃ³nimo'}</strong></span>
                <small class="text-muted">${this.formatDate(s.timestamp)}</small>
              </div>
              <div class="text-light small">${s.texto || 'Sin texto'}</div>
              ${s.imagen ? `<div class="mt-2"><img src="${s.imagen}" style="max-width: 100%; max-height: 100px; border-radius: 4px; cursor: pointer;" onclick="this.style.maxHeight=this.style.maxHeight=='100px'?'300px':'100px'"></div>` : ''}
              <div class="mt-1">
                <span class="badge bg-secondary" style="font-size: 0.6em;">${this.getSuggestionTypeText(s.tipo)}</span>
                ${this.getSuggestionStatusBadge(s.status)}
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          console.error('Error loading suggestions:', error);
          const container = document.getElementById('recentSuggestions');
          if (container) {
            container.innerHTML = '<div class="text-danger small">Error cargando sugerencias</div>';
          }
        }
      }
      
      getSuggestionStatusBadge(status) {
        const badges = {
          'pendiente': '<span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">â³ Pendiente</span>',
          'proceso': '<span class="badge bg-info ms-1" style="font-size: 0.6em;">ğŸ”„ En Proceso</span>',
          'aprobado': '<span class="badge bg-success ms-1" style="font-size: 0.6em;">âœ… Aprobado</span>',
          'rechazado': '<span class="badge bg-danger ms-1" style="font-size: 0.6em;">âŒ Rechazado</span>'
        };
        return badges[status] || badges['pendiente'];
      }
      
      async loadAdminSuggestions() {
        try {
          const suggestions = await this.firebase.getAllSuggestions();
          const container = document.getElementById('adminSuggestions');
          
          if (!container) return;
          
          if (!suggestions || suggestions.length === 0) {
            container.innerHTML = '<div class="text-muted text-center">No hay sugerencias</div>';
            return;
          }
          
          container.innerHTML = suggestions.map(s => `
            <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
              <div class="card-body p-3">
                <div class="d-flex justify-content-between mb-2">
                  <div>
                    <strong style="color: var(--primary);">${this.getSuggestionIcon(s.tipo)} ${s.autor || 'AnÃ³nimo'}</strong>
                    <span class="badge bg-secondary ms-2" style="font-size: 0.7em;">${this.getSuggestionTypeText(s.tipo)}</span>
                    ${this.getSuggestionStatusBadge(s.status)}
                  </div>
                  <small class="text-muted">${this.formatDate(s.timestamp)}</small>
                </div>
                <p class="text-light mb-2">${s.texto || 'Sin texto'}</p>
                ${s.imagen ? `<img src="${s.imagen}" class="img-fluid mb-2" style="max-height: 150px; border-radius: 4px;">` : ''}
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-warning" onclick="updateSuggestionStatus('${s.id}', 'pendiente')">â³ Pendiente</button>
                  <button class="btn btn-info" onclick="updateSuggestionStatus('${s.id}', 'proceso')">ğŸ”„ En Proceso</button>
                  <button class="btn btn-success" onclick="updateSuggestionStatus('${s.id}', 'aprobado')">âœ… Aprobar</button>
                  <button class="btn btn-danger" onclick="updateSuggestionStatus('${s.id}', 'rechazado')">âŒ Rechazar</button>
                </div>
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          console.error('Error loading admin suggestions:', error);
          const container = document.getElementById('adminSuggestions');
          if (container) {
            container.innerHTML = '<div class="text-danger text-center">Error cargando sugerencias</div>';
          }
        }
      }
      
      async loadAdminDrawings() {
        try {
          const drawings = await this.firebase.getAllDrawings();
          const container = document.getElementById('adminDrawings');
          
          if (!container) return;
          
          if (!drawings || drawings.length === 0) {
            container.innerHTML = '<div class="text-muted text-center">No hay dibujos</div>';
            return;
          }
          
          container.innerHTML = drawings.slice(0, 20).map(d => `
            <div class="card mb-2" style="background: var(--bg-light); border: 1px solid var(--primary);">
              <div class="card-body p-2">
                <div class="d-flex align-items-center">
                  <img src="${d.data.backgroundGif || d.data.imagenData}" style="width: 60px; height: 60px; object-fit: contain; background: white; border-radius: 4px; margin-right: 10px;">
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between">
                      <strong style="color: var(--primary); font-size: 0.9em;">${d.data.autor}</strong>
                      <small class="text-muted">${new Date(d.data.timestamp).toLocaleDateString()}</small>
                    </div>
                    <div class="text-light small">${d.data.categoria}</div>
                    <div class="text-muted small">â¤ï¸ ${d.data.likes || 0} | ğŸ’¬ ${d.data.comments?.length || 0}</div>
                  </div>
                  <button class="btn btn-danger btn-sm" onclick="deleteDrawing('${d.id}', '${d.data.autor}')" title="Eliminar dibujo">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          console.error('Error loading admin drawings:', error);
          const container = document.getElementById('adminDrawings');
          if (container) {
            container.innerHTML = '<div class="text-danger text-center">Error cargando dibujos</div>';
          }
        }
      }
      
      getSuggestionIcon(type) {
        const icons = {
          'feature': 'âœ¨',
          'bug': 'ğŸ›',
          'improvement': 'ğŸ”§',
          'other': 'ğŸ’­'
        };
        return icons[type] || 'ğŸ’­';
      }
      
      getSuggestionTypeText(type) {
        const types = {
          'feature': 'Nueva FunciÃ³n',
          'bug': 'Bug Report',
          'improvement': 'Mejora',
          'other': 'Otro'
        };
        return types[type] || 'Otro';
      }
      
      formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'hace un momento';
        if (diff < 3600000) return `hace ${Math.floor(diff/60000)}m`;
        if (diff < 86400000) return `hace ${Math.floor(diff/3600000)}h`;
        return `hace ${Math.floor(diff/86400000)}d`;
      }
      
      saveUserColor(color) {
        localStorage.setItem('guestbook-user-color', color);
      }
      
      loadUserColor() {
        const savedColor = localStorage.getItem('guestbook-user-color');
        if (savedColor) {
          // Buscar si el color estÃ¡ en los botones predefinidos
          const colorBtn = document.querySelector(`[data-color="${savedColor}"]`);
          if (colorBtn) {
            document.querySelector('.color-btn.active')?.classList.remove('active');
            colorBtn.classList.add('active');
          } else {
            // Si es un color personalizado, establecerlo en el input
            const customColorInput = document.getElementById('customColor');
            if (customColorInput) {
              customColorInput.value = savedColor;
            }
          }
          this.canvas.setColor(savedColor);
        }
        
        // Cargar datos de perfil guardados
        this.loadUserProfile();
      }
      
      loadUserProfile() {
        const savedName = localStorage.getItem('user-profile-name');
        const savedPicture = localStorage.getItem('user-profile-picture');
        
        if (savedName) {
          const authorInput = document.getElementById('authorName');
          if (authorInput && !authorInput.value) {
            authorInput.value = savedName;
          }
        }
        
        // Configurar botÃ³n "Usar perfil"
        const useProfileBtn = document.getElementById('useProfileName');
        if (useProfileBtn) {
          useProfileBtn.addEventListener('click', () => {
            if (savedName) {
              document.getElementById('authorName').value = savedName;
              this.ui.showNotification('âœ… Perfil cargado', 'success');
            } else {
              this.ui.showNotification('âŒ No hay perfil guardado', 'error');
            }
          });
        }
      }
      
      async processProfilePicture(file) {
        return new Promise((resolve, reject) => {
          if (file.size > 1024 * 1024) { // 1MB mÃ¡ximo
            reject(new Error('Imagen muy grande. MÃ¡ximo 1MB.'));
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              // Redimensionar a 150x150 mÃ¡ximo
              const maxSize = 150;
              let { width, height } = img;
              
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height * maxSize) / width;
                  width = maxSize;
                } else {
                  width = (width * maxSize) / height;
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              
              resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.onerror = () => reject(new Error('Error procesando imagen'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('Error leyendo archivo'));
          reader.readAsDataURL(file);
        });
      }
      
      // FunciÃ³n para comprimir GIFs manteniendo animaciÃ³n
      async compressGifForFirebase(gifDataUrl) {
        if (!gifDataUrl) return null;
        
        try {
          // Convertir dataURL a blob
          const response = await fetch(gifDataUrl);
          const blob = await response.blob();
          
          // Si el GIF es pequeÃ±o, devolverlo sin comprimir
          if (blob.size < 800000) {
            return gifDataUrl;
          }
          
          // Para GIFs grandes, crear una versiÃ³n comprimida simple
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              // Reducir tamaÃ±o manteniendo proporciÃ³n
              const maxSize = 400;
              let { width, height } = img;
              
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height * maxSize) / width;
                  width = maxSize;
                } else {
                  width = (width * maxSize) / height;
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              
              // Comprimir como JPEG para reducir tamaÃ±o
              const compressed = canvas.toDataURL('image/jpeg', 0.6);
              console.log(`GIF comprimido: ${gifDataUrl.length} â†’ ${compressed.length} bytes`);
              resolve(compressed);
            };
            
            img.onerror = () => {
              console.log('Error comprimiendo GIF, usando original');
              resolve(gifDataUrl);
            };
            
            img.src = gifDataUrl;
          });
        } catch (error) {
          console.error('Error comprimiendo GIF:', error);
          return gifDataUrl;
        }
      }
      
      // FunciÃ³n para comprimir imÃ¡genes
      async compressImage(dataUrl, maxSizeKB = 600) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calcular nuevo tamaÃ±o manteniendo proporciÃ³n
            let { width, height } = img;
            const maxDimension = 800;
            
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = (height * maxDimension) / width;
                width = maxDimension;
              } else {
                width = (width * maxDimension) / height;
                height = maxDimension;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Dibujar imagen redimensionada
            ctx.drawImage(img, 0, 0, width, height);
            
            // Comprimir con calidad variable
            let quality = 0.8;
            let compressed = canvas.toDataURL('image/jpeg', quality);
            
            // Reducir calidad hasta alcanzar el tamaÃ±o objetivo
            while (compressed.length > maxSizeKB * 1024 * 1.37 && quality > 0.3) {
              quality -= 0.1;
              compressed = canvas.toDataURL('image/jpeg', quality);
            }
            
            resolve(compressed);
          };
          img.src = dataUrl;
        });
      }
      
      setupUnsavedChangesDetection() {
        const canvas = this.canvas.canvas;
        if (!canvas) return;
        
        // Detectar cambios en el canvas
        const detectChange = () => {
          window.hasUnsavedChanges = true;
        };
        
        // Eventos de dibujo
        canvas.addEventListener('mousedown', detectChange);
        canvas.addEventListener('touchstart', detectChange);
        
        // Detectar cambios en herramientas que modifican el canvas
        const toolButtons = [
          'brushBtn', 'eraserBtn', 'bucketBtn', 'textBtn',
          'sprayBtn', 'lineBtn', 'clearBtn', 'undoBtn', 'redoBtn'
        ];
        
        toolButtons.forEach(btnId => {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.addEventListener('click', detectChange);
          }
        });
        
        // Detectar importaciÃ³n de imÃ¡genes
        document.getElementById('importBtn')?.addEventListener('change', detectChange);
        document.getElementById('setBgBtn')?.addEventListener('click', detectChange);
        document.getElementById('placeStickerBtn')?.addEventListener('click', detectChange);
      }
    }
    
    // Inicializar aplicaciÃ³n
    const app = new GuestbookApp();
    app.init();
    
    // Hacer disponible globalmente
    window.guestbookApp = app;
    
    // Prevenir errores de extensiones del navegador
    window.addEventListener('error', function(e) {
      if (e.message && e.message.includes('message channel closed')) {
        e.preventDefault();
        return true;
      }
    });
    
    window.addEventListener('unhandledrejection', function(e) {
      if (e.reason && e.reason.message && e.reason.message.includes('message channel closed')) {
        e.preventDefault();
        return true;
      }
    });
    
    // Variables globales para admin y moderadores
    let isAdminLoggedIn = false;
    window.currentUser = null;
    
    // Verificar permisos de usuario
    window.hasPermission = function(permission) {
      if (!window.currentUser) return false;
      if (window.currentUser.role === 'admin') return true;
      return window.currentUser.permissions?.includes(permission) || false;
    };
    
    // Actualizar UI segÃºn permisos
    window.updateUIForUser = function() {
      const user = window.currentUser;
      if (!user) return;
      
      // Mostrar/ocultar elementos segÃºn permisos
      const adminOnlyElements = document.querySelectorAll('.admin-only');
      adminOnlyElements.forEach(el => {
        el.style.display = user.role === 'admin' ? 'block' : 'none';
      });
      
      // Actualizar botones de acciÃ³n
      if (window.galleryManager) {
        window.galleryManager.updateDeleteButtons();
      }
      
      // Mostrar nombre de usuario
      const userInfo = document.getElementById('userInfo');
      if (userInfo) {
        userInfo.textContent = user.role === 'admin' ? 'Admin' : `Moderador: ${user.name}`;
      }
    };
    
    // Funciones para gestiÃ³n de moderadores
    window.loadModerators = async function() {
      try {
        const moderators = await app.firebase.getModerators();
        const container = document.getElementById('moderatorsList');
        
        if (!container) return;
        
        if (!moderators || moderators.length === 0) {
          container.innerHTML = '<div class="text-muted text-center">No hay moderadores</div>';
          return;
        }
        
        container.innerHTML = moderators.map(mod => `
          <div class="card mb-2" style="background: var(--bg-light); border: 1px solid var(--primary);">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong style="color: var(--primary);">${mod.name}</strong>
                  <div class="small text-info">@${mod.username || 'sin_usuario'}</div>
                  <div class="small text-muted">
                    Permisos: ${mod.permissions?.join(', ') || 'Ninguno'}
                  </div>
                  <div class="small text-muted">
                    Creado: ${new Date(mod.createdAt).toLocaleDateString()}
                  </div>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-${mod.active ? 'success' : 'secondary'} btn-sm" 
                          onclick="toggleModerator('${mod.id}', ${!mod.active})">
                    ${mod.active ? 'âœ…' : 'âŒ'}
                  </button>
                  <button class="btn btn-danger btn-sm" 
                          onclick="deleteModerator('${mod.id}', '${mod.name}')">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading moderators:', error);
      }
    };
    
    window.addModerator = async function() {
      const name = document.getElementById('modName').value.trim();
      const username = document.getElementById('modUsername').value.trim();
      const password = document.getElementById('modPassword').value.trim();
      
      if (!name || !username || !password) {
        app.ui.showNotification('âŒ Completa todos los campos', 'error');
        return;
      }
      
      if (password.length < 6) {
        app.ui.showNotification('âŒ La contraseÃ±a debe tener al menos 6 caracteres', 'error');
        return;
      }
      
      const permissions = [];
      document.querySelectorAll('#addModeratorForm input[type="checkbox"]:checked').forEach(cb => {
        permissions.push(cb.value);
      });
      
      if (permissions.length === 0) {
        app.ui.showNotification('âŒ Selecciona al menos un permiso', 'error');
        return;
      }
      
      try {
        await app.firebase.addModerator({ name, username, password, permissions });
        app.ui.showNotification('âœ… Moderador aÃ±adido', 'success');
        document.getElementById('modName').value = '';
        document.getElementById('modUsername').value = '';
        document.getElementById('modPassword').value = '';
        document.querySelectorAll('#addModeratorForm input[type="checkbox"]').forEach(cb => cb.checked = false);
        loadModerators();
      } catch (error) {
        if (error.message.includes('ya existe')) {
          app.ui.showNotification('âŒ El nombre de usuario ya existe', 'error');
        } else {
          app.ui.showNotification('âŒ Error aÃ±adiendo moderador', 'error');
        }
      }
    };
    
    window.toggleModerator = async function(moderatorId, active) {
      try {
        await app.firebase.updateModerator(moderatorId, { active });
        app.ui.showNotification(`âœ… Moderador ${active ? 'activado' : 'desactivado'}`, 'success');
        loadModerators();
      } catch (error) {
        app.ui.showNotification('âŒ Error actualizando moderador', 'error');
      }
    };
    
    window.deleteModerator = async function(moderatorId, name) {
      if (!confirm(`Â¿Eliminar moderador ${name}?\n\nEsta acciÃ³n no se puede deshacer.`)) return;
      
      try {
        await app.firebase.deleteModerator(moderatorId);
        
        // Registrar acciÃ³n si hay usuario logueado
        if (window.currentUser) {
          await app.firebase.logModeratorAction(
            'delete_moderator',
            window.currentUser.name || 'Admin',
            name
          );
        }
        
        app.ui.showNotification('âœ… Moderador eliminado', 'success');
        loadModerators();
      } catch (error) {
        app.ui.showNotification('âŒ Error eliminando moderador', 'error');
      }
    };
    
    // FunciÃ³n para eliminar dibujos (moderadores)
    window.deleteDrawing = async function(drawingId, author) {
      if (!hasPermission('delete_drawings')) {
        app.ui.showNotification('âŒ No tienes permisos para eliminar dibujos', 'error');
        return;
      }
      
      const reason = prompt(`Â¿Eliminar dibujo de ${author}?\n\nRazÃ³n (opcional):`);
      if (reason === null) return; // Usuario cancelÃ³
      
      try {
        const moderatorName = window.currentUser?.name || 'Moderador';
        await app.firebase.deleteDrawing(drawingId, moderatorName, reason);
        
        app.ui.showNotification('âœ… Dibujo eliminado', 'success');
        
        // Actualizar galeria
        if (window.galleryManager) {
          await window.galleryManager.loadGallery();
        }
        
        // Cerrar modal si estÃ¡ abierto
        const modal = document.querySelector('.image-modal');
        if (modal) modal.remove();
        
      } catch (error) {
        console.error('Error eliminando dibujo:', error);
        app.ui.showNotification('âŒ Error eliminando dibujo', 'error');
      }
    };
    
    // Variable global para cambios sin guardar
    window.hasUnsavedChanges = false;
    
    // FunciÃ³n global para refrescar pÃ¡gina
    window.refreshPage = function() {
      // Verificar cambios sin guardar
      if (window.hasUnsavedChanges) {
        const confirmRefresh = confirm(
          'âš ï¸ Â¿EstÃ¡s seguro de actualizar la pÃ¡gina?\n\n' +
          'ğŸ¨ Tienes cambios sin guardar en tu dibujo\n' +
          'ğŸ”„ Esta acciÃ³n limpiarÃ¡ el cache y recargarÃ¡ completamente la pÃ¡gina\n' +
          'ğŸ’¾ Se perderÃ¡n todos los cambios no guardados\n\n' +
          'âœ… Presiona OK para continuar\n' +
          'âŒ Presiona Cancelar para seguir dibujando'
        );
        
        if (!confirmRefresh) {
          return;
        }
      }
      
      // Mostrar animaciÃ³n de carga
      const btn = document.querySelector('.mobile-refresh');
      if (btn) {
        btn.innerHTML = 'â³';
        btn.style.animation = 'spin 1s linear infinite';
      }
      
      // Limpiar cache del service worker si existe
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
          }
        });
      }
      
      // Limpiar cache del navegador
      if ('caches' in window) {
        caches.keys().then(function(names) {
          for (let name of names) {
            caches.delete(name);
          }
        });
      }
      
      // Refrescar con cache bypass
      setTimeout(() => {
        window.location.reload(true);
      }, 500);
    };
    
    // Funciones globales de administraciÃ³n
    window.toggleAdminPanel = function() {
      const modal = new bootstrap.Modal(document.getElementById('adminPanel'));
      modal.show();
    };
    
    window.toggleUpdatesPanel = function() {
      const modal = new bootstrap.Modal(document.getElementById('updatesPanel'));
      modal.show();
    };
    
    window.toggleModPanel = function() {
      const modal = new bootstrap.Modal(document.getElementById('modPanel'));
      modal.show();
    };
    
    window.loginMod = async function() {
      const username = document.getElementById('modPanelUsername').value.trim();
      const password = document.getElementById('modPanelPassword').value.trim();
      
      if (!username || !password) {
        alert('Por favor completa todos los campos');
        return;
      }
      
      try {
        const authResult = await app.firebase.loginModerator(username, password);
        if (authResult) {
          window.currentUser = authResult;
          
          document.getElementById('modLogin').style.display = 'none';
          document.getElementById('modContent').style.display = 'block';
          
          document.getElementById('modToggle').innerHTML = `ğŸ›¡ï¸ ${authResult.name}`;
          document.getElementById('modToggle').classList.remove('btn-outline-warning');
          document.getElementById('modToggle').classList.add('btn-success');
          
          document.getElementById('modUserInfo').textContent = authResult.name;
          
          loadModSuggestions();
          loadModDrawings();
          loadModReports();
          
          alert(`Bienvenido ${authResult.name}`);
        } else {
          alert('Usuario o contraseÃ±a incorrectos');
        }
      } catch (error) {
        alert('Error iniciando sesiÃ³n');
      }
    };
    
    window.logoutMod = function() {
      window.currentUser = null;
      document.getElementById('modLogin').style.display = 'block';
      document.getElementById('modContent').style.display = 'none';
      document.getElementById('modPanelUsername').value = '';
      document.getElementById('modPanelPassword').value = '';
      document.getElementById('modToggle').innerHTML = 'ğŸ›¡ï¸ Mod';
      document.getElementById('modToggle').classList.remove('btn-success');
      document.getElementById('modToggle').classList.add('btn-outline-warning');
      
      app.ui.showNotification('ğŸšº SesiÃ³n cerrada', 'info');
    };
    
    window.loadModSuggestions = async function() {
      try {
        const suggestions = await app.firebase.getAllSuggestions();
        const container = document.getElementById('modSuggestions');
        
        if (!container) return;
        
        if (!suggestions || suggestions.length === 0) {
          container.innerHTML = '<div class="text-muted text-center">No hay sugerencias</div>';
          return;
        }
        
        container.innerHTML = suggestions.map(s => `
          <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between mb-2">
                <div>
                  <strong style="color: var(--primary);">${app.getSuggestionIcon(s.tipo)} ${s.autor || 'AnÃ³nimo'}</strong>
                  <span class="badge bg-secondary ms-2" style="font-size: 0.7em;">${app.getSuggestionTypeText(s.tipo)}</span>
                  ${app.getSuggestionStatusBadge(s.status)}
                </div>
                <small class="text-muted">${app.formatDate(s.timestamp)}</small>
              </div>
              <p class="text-light mb-2">${s.texto || 'Sin texto'}</p>
              ${s.imagen ? `<img src="${s.imagen}" class="img-fluid mb-2" style="max-height: 150px; border-radius: 4px;">` : ''}
              <div class="btn-group btn-group-sm">
                <button class="btn btn-warning" onclick="updateSuggestionStatus('${s.id}', 'pendiente')">â³ Pendiente</button>
                <button class="btn btn-info" onclick="updateSuggestionStatus('${s.id}', 'proceso')">ğŸ”„ En Proceso</button>
                <button class="btn btn-success" onclick="updateSuggestionStatus('${s.id}', 'aprobado')">âœ… Aprobar</button>
                <button class="btn btn-danger" onclick="updateSuggestionStatus('${s.id}', 'rechazado')">âŒ Rechazar</button>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading mod suggestions:', error);
        const container = document.getElementById('modSuggestions');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center">Error cargando sugerencias</div>';
        }
      }
    };
    
    window.loadModDrawings = async function() {
      try {
        const drawings = await app.firebase.getAllDrawings();
        const container = document.getElementById('modDrawings');
        
        if (!container) return;
        
        if (!drawings || drawings.length === 0) {
          container.innerHTML = '<div class="text-muted text-center">No hay dibujos</div>';
          return;
        }
        
        container.innerHTML = drawings.slice(0, 20).map(d => `
          <div class="card mb-2" style="background: var(--bg-light); border: 1px solid var(--primary);">
            <div class="card-body p-2">
              <div class="d-flex align-items-center">
                <img src="${d.data.backgroundGif || d.data.imagenData}" style="width: 60px; height: 60px; object-fit: contain; background: white; border-radius: 4px; margin-right: 10px;">
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between">
                    <strong style="color: var(--primary); font-size: 0.9em;">${d.data.autor}</strong>
                    <small class="text-muted">${new Date(d.data.timestamp).toLocaleDateString()}</small>
                  </div>
                  <div class="text-light small">${d.data.categoria}</div>
                  <div class="text-muted small">â¤ï¸ ${d.data.likes || 0} | ğŸ’¬ ${d.data.comments?.length || 0}</div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="deleteDrawingMod('${d.id}', '${d.data.autor}')" title="Eliminar dibujo">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading mod drawings:', error);
        const container = document.getElementById('modDrawings');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center">Error cargando dibujos</div>';
        }
      }
    };
    
    window.reportDrawing = async function(drawingId, author) {
      const reason = prompt(`Reportar dibujo de ${author}\n\nRazÃ³n del reporte:`);
      if (!reason || !reason.trim()) return;
      
      try {
        await app.firebase.reportDrawing({
          drawingId: drawingId,
          drawingAuthor: author,
          reportedBy: 'Usuario anÃ³nimo',
          reason: reason.trim(),
          type: 'inappropriate_content'
        });
        
        app.ui.showNotification('âœ… Reporte enviado a moderadores', 'success');
      } catch (error) {
        app.ui.showNotification('âŒ Error enviando reporte', 'error');
      }
    };
    
    window.loadModReports = async function() {
      try {
        const reports = await app.firebase.getAllReports();
        const container = document.getElementById('modReports');
        
        if (!container) return;
        
        if (!reports || reports.length === 0) {
          container.innerHTML = '<div class="text-muted text-center">No hay reportes</div>';
          return;
        }
        
        container.innerHTML = reports.map(r => `
          <div class="card mb-3" style="background: var(--bg-light); border: 1px solid ${r.status === 'pending' ? '#ffc107' : r.status === 'resolved' ? '#28a745' : '#dc3545'};">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between mb-2">
                <div>
                  <strong style="color: var(--primary);">âš ï¸ ${r.drawingAuthor}</strong>
                  <span class="badge ${r.status === 'pending' ? 'bg-warning' : r.status === 'resolved' ? 'bg-success' : 'bg-danger'} ms-2" style="font-size: 0.7em;">
                    ${r.status === 'pending' ? 'â³ Pendiente' : r.status === 'resolved' ? 'âœ… Resuelto' : 'âŒ Rechazado'}
                  </span>
                </div>
                <small class="text-muted">${app.formatDate(r.timestamp)}</small>
              </div>
              <p class="text-light mb-2"><strong>RazÃ³n:</strong> ${r.reason}</p>
              <p class="text-muted small mb-2">Reportado por: ${r.reportedBy}</p>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-warning" onclick="updateReportStatus('${r.id}', 'pending')">â³ Pendiente</button>
                <button class="btn btn-success" onclick="updateReportStatus('${r.id}', 'resolved')">âœ… Resolver</button>
                <button class="btn btn-danger" onclick="updateReportStatus('${r.id}', 'rejected')">âŒ Rechazar</button>
                <button class="btn btn-info" onclick="viewReportedDrawing('${r.drawingId}')">ğŸ‘ï¸ Ver</button>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading reports:', error);
        const container = document.getElementById('modReports');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center">Error cargando reportes</div>';
        }
      }
    };
    
    window.updateReportStatus = async function(reportId, status) {
      try {
        await app.firebase.updateReportStatus(reportId, status);
        app.ui.showNotification(`âœ… Reporte ${status === 'resolved' ? 'resuelto' : status === 'rejected' ? 'rechazado' : 'marcado como pendiente'}`, 'success');
        loadModReports();
      } catch (error) {
        app.ui.showNotification('âŒ Error actualizando reporte', 'error');
      }
    };
    
    window.viewReportedDrawing = async function(drawingId) {
      try {
        const drawing = await app.firebase.getDrawing(drawingId);
        if (drawing) {
          viewImage(drawing.data.imagenData, drawingId);
        } else {
          app.ui.showNotification('âŒ Dibujo no encontrado (posiblemente eliminado)', 'error');
        }
      } catch (error) {
        app.ui.showNotification('âŒ Error cargando dibujo', 'error');
      }
    };
    
    window.deleteDrawingMod = async function(drawingId, author) {
      if (!window.currentUser || window.currentUser.role !== 'moderator') {
        app.ui.showNotification('âŒ Acceso denegado', 'error');
        return;
      }
      
      if (!window.currentUser.permissions.includes('delete_drawings')) {
        app.ui.showNotification('âŒ Sin permisos para eliminar dibujos', 'error');
        return;
      }
      
      const reason = prompt(`Â¿Eliminar dibujo de ${author}?\n\nRazÃ³n (opcional):`) || '';
      if (reason === null) return;
      
      try {
        await app.firebase.deleteDrawing(drawingId, window.currentUser.name, reason);
        app.ui.showNotification('âœ… Dibujo eliminado', 'success');
        loadModDrawings();
        app.gallery.loadGallery();
      } catch (error) {
        app.ui.showNotification('âŒ Error eliminando dibujo', 'error');
      }
    };
    
    window.loginAdmin = async function() {
      const password = document.getElementById('adminPassword').value;
      if (!password) {
        app.ui.showNotification('Ingresa la contraseÃ±a', 'error');
        return;
      }
      
      try {
        const authResult = await app.firebase.checkAdminPassword(password);
        if (authResult && authResult.role) {
          if (authResult.role === 'moderator_access') {
            // Mostrar panel de moderador
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('moderatorLogin').style.display = 'block';
            app.ui.showNotification('âœ… Acceso de moderador habilitado', 'success');
            return;
          }
          
          window.currentUser = authResult;
          isAdminLoggedIn = true;
          
          document.getElementById('adminLogin').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
          
          document.getElementById('adminToggle').innerHTML = 'ğŸ”“ Admin';
          document.getElementById('adminToggle').classList.remove('btn-outline-danger');
          document.getElementById('adminToggle').classList.add('btn-success');
          
          updateUIForUser();
          loadModerators();
          app.loadAdminSuggestions();
          app.loadAdminDrawings();
          
          app.ui.showNotification('âœ… Acceso de administrador concedido', 'success');
        } else {
          app.ui.showNotification('âŒ ContraseÃ±a incorrecta', 'error');
        }
      } catch (error) {
        app.ui.showNotification('âŒ Error verificando contraseÃ±a', 'error');
      }
    };
    
    window.loginModerator = async function() {
      const username = document.getElementById('modLoginUsername').value.trim();
      const password = document.getElementById('modLoginPassword').value.trim();
      
      if (!username || !password) {
        app.ui.showNotification('âŒ Completa todos los campos', 'error');
        return;
      }
      
      try {
        const authResult = await app.firebase.loginModerator(username, password);
        if (authResult) {
          window.currentUser = authResult;
          isAdminLoggedIn = true;
          
          document.getElementById('moderatorLogin').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
          
          document.getElementById('adminToggle').innerHTML = `ğŸ›¡ï¸ ${authResult.name}`;
          document.getElementById('adminToggle').classList.remove('btn-outline-danger');
          document.getElementById('adminToggle').classList.add('btn-success');
          
          updateUIForUser();
          app.loadAdminSuggestions();
          app.loadAdminDrawings();
          
          app.ui.showNotification(`âœ… Bienvenido ${authResult.name}`, 'success');
        } else {
          app.ui.showNotification('âŒ Usuario o contraseÃ±a incorrectos', 'error');
        }
      } catch (error) {
        app.ui.showNotification('âŒ Error iniciando sesiÃ³n', 'error');
      }
    };
    
    window.createModerator = async function() {
      const authPassword = document.getElementById('modCreateAuth').value.trim();
      const name = document.getElementById('modCreateName').value.trim();
      const username = document.getElementById('modCreateUsername').value.trim();
      const password = document.getElementById('modCreatePassword').value.trim();
      
      if (!authPassword || !name || !username || !password) {
        app.ui.showNotification('âŒ Completa todos los campos', 'error');
        return;
      }
      
      if (password.length < 6) {
        app.ui.showNotification('âŒ La contraseÃ±a debe tener al menos 6 caracteres', 'error');
        return;
      }
      
      try {
        await app.firebase.addModerator({
          moderatorPassword: authPassword,
          name,
          username,
          password,
          permissions: ['delete_drawings', 'manage_comments']
        });
        
        app.ui.showNotification('âœ… Cuenta de moderador creada', 'success');
        
        // Limpiar campos
        document.getElementById('modCreateAuth').value = '';
        document.getElementById('modCreateName').value = '';
        document.getElementById('modCreateUsername').value = '';
        document.getElementById('modCreatePassword').value = '';
        
        // Auto-login
        document.getElementById('modLoginUsername').value = username;
        document.getElementById('modLoginPassword').value = password;
        
      } catch (error) {
        if (error.message.includes('ya existe')) {
          app.ui.showNotification('âŒ El nombre de usuario ya existe', 'error');
        } else if (error.code === 'permission-denied') {
          app.ui.showNotification('âŒ ContraseÃ±a de moderador incorrecta', 'error');
        } else {
          app.ui.showNotification('âŒ Error creando cuenta', 'error');
        }
      }
    };
    
    window.backToMainLogin = function() {
      document.getElementById('moderatorLogin').style.display = 'none';
      document.getElementById('adminLogin').style.display = 'block';
      document.getElementById('adminPassword').value = '';
    };
    
    window.logoutAdmin = function() {
      isAdminLoggedIn = false;
      window.currentUser = null;
      document.getElementById('adminLogin').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminToggle').innerHTML = 'ğŸ” Admin';
      document.getElementById('adminToggle').classList.remove('btn-success');
      document.getElementById('adminToggle').classList.add('btn-outline-danger');
      
      // Actualizar UI para usuario no logueado
      updateUIForUser();
      
      app.ui.showNotification('ğŸšª SesiÃ³n cerrada', 'info');
    };
    
    window.updateSuggestionStatus = async function(suggestionId, status) {
      if (!isAdminLoggedIn || !window.currentUser) {
        app.ui.showNotification('âŒ Acceso denegado', 'error');
        return;
      }
      
      // Verificar permisos
      if (window.currentUser.role === 'moderator' && !window.currentUser.permissions.includes('manage_suggestions')) {
        app.ui.showNotification('âŒ Sin permisos para gestionar sugerencias', 'error');
        return;
      }
      
      try {
        await app.firebase.updateSuggestionStatus(suggestionId, status);
        app.ui.showNotification(`âœ… Estado actualizado a ${status}`, 'success');
        app.loadAdminSuggestions();
        app.loadRecentSuggestions();
      } catch (error) {
        app.ui.showNotification('âŒ Error actualizando estado', 'error');
      }
    };
    
    window.deleteDrawing = async function(drawingId, author) {
      if (!isAdminLoggedIn || !window.currentUser) {
        app.ui.showNotification('âŒ Acceso denegado', 'error');
        return;
      }
      
      // Verificar permisos
      if (window.currentUser.role === 'moderator' && !window.currentUser.permissions.includes('delete_drawings')) {
        app.ui.showNotification('âŒ Sin permisos para eliminar dibujos', 'error');
        return;
      }
      
      const reason = prompt(`Â¿Eliminar dibujo de ${author}?\n\nRazÃ³n (opcional):`) || '';
      if (reason === null) return;
      
      try {
        await app.firebase.deleteDrawing(drawingId, window.currentUser.id, reason);
        app.ui.showNotification('âœ… Dibujo eliminado', 'success');
        app.loadAdminDrawings();
        app.gallery.loadGallery();
      } catch (error) {
        app.ui.showNotification('âŒ Error eliminando dibujo', 'error');
      }
    };
  </script>
  
  <!-- Suprimir errores de extensiones -->
  <script>
    // Prevenir errores de extensiones del navegador
    const originalConsoleError = console.error;
    console.error = function(...args) {
      const message = args.join(' ');
      if (message.includes('message channel closed') || 
          message.includes('listener indicated an asynchronous response')) {
        return; // Suprimir este error especÃ­fico
      }
      originalConsoleError.apply(console, args);
    };
    
    // Agregar animaciÃ³n de spin para el botÃ³n de refresh
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>