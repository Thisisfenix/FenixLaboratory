<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé® Guestbook - FenixLaboratory</title>
  <meta name="description" content="Sistema interactivo de dibujo y comentarios en tiempo real. Crea arte, comparte con la comunidad y participa en rankings. 50+ herramientas de dibujo, sistema de likes y galer√≠a p√∫blica.">
  <meta name="keywords" content="guestbook, dibujo online, arte digital, comunidad, FenixLaboratory, canvas, pintura digital, galer√≠a">
  <meta name="author" content="ThisIsFenix">
  
  <!-- Discord/Social Media Embeds -->
  <meta property="og:title" content="üé® Guestbook - FenixLaboratory">
  <meta property="og:description" content="Sistema interactivo de dibujo con 50+ herramientas, rankings en tiempo real, sistema de likes y comentarios. ¬°Deja tu huella art√≠stica en el laboratorio!">
  <meta property="og:image" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/Preview-GuestBook.png">
  <meta property="og:url" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/guestbook-new.html">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="FenixLaboratory Guestbook">
  
  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="üé® Guestbook - FenixLaboratory">
  <meta name="twitter:description" content="Sistema de dibujo interactivo con herramientas avanzadas, rankings y comunidad activa. ¬°Crea arte digital y comp√°rtelo!">
  <meta name="twitter:image" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/Preview-GuestBook.png">
  <meta name="twitter:creator" content="@AntiAnkush">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="Preview-GuestBook.png">
  <link rel="apple-touch-icon" href="Preview-GuestBook.png">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="mobile-enhancements.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>
  
  <style>
    :root {
      --primary: #ff6b35;
      --bg-dark: #1a1a1a;
      --bg-light: #2d2d2d;
      --text-primary: #f0f0f0;
      --text-secondary: #b0b0b0;
    }
    
    [data-theme="neon"] {
      --primary: #00ff88;
      --bg-dark: #0a0a0a;
      --bg-light: #1a1a1a;
    }
    [data-theme="retro"] {
      --primary: #ff6b9d;
      --bg-dark: #2d1b69;
      --bg-light: #3e2a7a;
    }
    [data-theme="hacker"] {
      --primary: #00ff00;
      --bg-dark: #000000;
      --bg-light: #0d1117;
    }
    [data-theme="galaxy"] {
      --primary: #8b5cf6;
      --bg-dark: #1a0b2e;
      --bg-light: #2d1b4e;
    }
    [data-theme="sunset"] {
      --primary: #f59e0b;
      --bg-dark: #2d1b0b;
      --bg-light: #4e2d1b;
    }
    [data-theme="ocean"] {
      --primary: #0ea5e9;
      --bg-dark: #0b1a2d;
      --bg-light: #1b2d4e;
    }
    [data-theme="purple"] {
      --primary: #8b5cf6;
      --bg-dark: #1e1b4b;
      --bg-light: #312e81;
    }
    [data-theme="blue"] {
      --primary: #3b82f6;
      --bg-dark: #1e3a8a;
      --bg-light: #1d4ed8;
    }
    
    .color-btn.active {
      border-color: var(--primary) !important;
      box-shadow: 0 0 10px var(--primary);
    }
    
    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Space Grotesk', sans-serif;
      touch-action: manipulation;
    }
    
    .canvas-container {
      border: 3px solid var(--primary);
      border-radius: 12px;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      margin: 20px auto;
      display: block;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(255, 107, 53, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .canvas-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--primary), #ff8c42, var(--primary));
      border-radius: 12px;
      z-index: -1;
      animation: borderGlow 3s ease-in-out infinite alternate;
    }
    
    @keyframes borderGlow {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    #drawCanvas {
      border-radius: 8px;
      cursor: crosshair;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    #drawCanvas:hover {
      transform: scale(1.01);
    }
    
    .drawing-card {
      background: var(--bg-light);
      border: 1px solid rgba(255, 107, 53, 0.2);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .drawing-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
    }
    
    .top-drawing {
      position: relative;
      z-index: 10;
    }
    
    .top-drawing.rank-1 {
      border: 3px solid #FFD700 !important;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.4) !important;
      animation: goldAura 2s ease-in-out infinite alternate;
    }
    
    .top-drawing.rank-2 {
      border: 3px solid #C0C0C0 !important;
      box-shadow: 0 0 25px rgba(192, 192, 192, 0.7), 0 0 50px rgba(192, 192, 192, 0.3) !important;
      animation: silverAura 2s ease-in-out infinite alternate;
    }
    
    .top-drawing.rank-3 {
      border: 3px solid #CD7F32 !important;
      box-shadow: 0 0 20px rgba(205, 127, 50, 0.6), 0 0 40px rgba(205, 127, 50, 0.2) !important;
      animation: bronzeAura 2s ease-in-out infinite alternate;
    }
    
    @keyframes goldAura {
      0% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.4); }
      100% { box-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 80px rgba(255, 215, 0, 0.6); }
    }
    
    @keyframes silverAura {
      0% { box-shadow: 0 0 25px rgba(192, 192, 192, 0.7), 0 0 50px rgba(192, 192, 192, 0.3); }
      100% { box-shadow: 0 0 35px rgba(192, 192, 192, 0.9), 0 0 70px rgba(192, 192, 192, 0.5); }
    }
    
    @keyframes bronzeAura {
      0% { box-shadow: 0 0 20px rgba(205, 127, 50, 0.6), 0 0 40px rgba(205, 127, 50, 0.2); }
      100% { box-shadow: 0 0 30px rgba(205, 127, 50, 0.8), 0 0 60px rgba(205, 127, 50, 0.4); }
    }
    
    .rank-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2em;
      z-index: 20;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    .rank-badge.rank-1 {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #000;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
    }
    
    .rank-badge.rank-2 {
      background: linear-gradient(45deg, #C0C0C0, #A0A0A0);
      color: #000;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.8);
    }
    
    .rank-badge.rank-3 {
      background: linear-gradient(45deg, #CD7F32, #B8860B);
      color: #fff;
      box-shadow: 0 0 15px rgba(205, 127, 50, 0.8);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .drawing-img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: white;
      border-radius: 4px;
      transition: transform 0.3s ease;
    }
    
    .drawing-card:hover .drawing-img {
      transform: scale(1.02);
    }
    
    /* Estilos para modal de comentarios */
    .comments-container {
      scrollbar-width: thin;
      scrollbar-color: var(--primary) transparent;
    }
    
    .comments-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .comments-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .comments-container::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }
    
    .comment-item {
      transition: background-color 0.2s ease;
    }
    
    .comment-item:hover {
      background: rgba(255,255,255,0.08) !important;
    }
    
    .btn-neon {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
      transition: all 0.3s ease;
    }
    
    .btn-neon:hover {
      background: var(--primary);
      color: var(--bg-dark);
    }
    
    .control-section {
      margin-bottom: 1rem;
    }
    
    .control-section:last-child {
      margin-bottom: 0;
    }
    
    .btn-group-custom {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      justify-content: center;
    }
    
    .btn-group-custom .btn {
      flex: 0 0 auto;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    @media (max-width: 991px) {
      .col-lg-4 {
        margin-top: 1rem;
      }
    }
    
    @media (max-width: 768px) {
      #drawCanvas {
        touch-action: none;
        max-width: 100%;
        height: auto;
      }
      .canvas-container {
        margin: 10px auto;
        touch-action: none;
        max-width: 95vw;
        padding: 10px;
        text-align: center;
      }
      
      /* Botones m√°s grandes para m√≥vil */
      .btn-group-custom .btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
        margin: 0.1rem;
        min-height: 36px;
        min-width: 44px;
      }
      
      /* Controles de color m√°s grandes */
      .color-btn {
        width: 32px !important;
        height: 32px !important;
        margin: 2px !important;
      }
      
      /* Inputs m√°s grandes */
      .form-control, .form-select {
        font-size: 16px !important;
        min-height: 44px;
        padding: 0.5rem 0.75rem;
      }
      
      /* Sliders m√°s f√°ciles de usar */
      .form-range {
        height: 8px;
      }
      
      .form-range::-webkit-slider-thumb {
        width: 24px;
        height: 24px;
      }
      
      /* Panel de control m√°s espacioso */
      .control-section {
        margin-bottom: 1.5rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
      }
      
      /* Modal responsive mejorado */
      .image-modal {
        padding: 0 !important;
      }
      
      .image-modal > div {
        flex-direction: column !important;
        height: 100vh !important;
        max-height: 100vh !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      .image-modal > div > div:first-child {
        flex: 0 0 auto !important;
        max-height: 35vh !important;
        padding: 10px !important;
        overflow: hidden;
      }
      
      .image-modal > div > div:last-child {
        flex: 1 !important;
        min-height: 0 !important;
        border-left: none !important;
        border-top: 2px solid var(--primary) !important;
        padding: 10px !important;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }
      
      .image-modal img {
        max-height: 25vh !important;
        width: 100% !important;
        object-fit: contain !important;
      }
      
      .image-modal textarea {
        font-size: 16px !important;
        min-height: 60px !important;
        resize: vertical;
        flex-shrink: 0;
      }
      
      /* Botones de acci√≥n del modal */
      .image-modal .btn {
        min-height: 40px;
        font-size: 14px;
        padding: 0.4rem 0.8rem;
        margin: 0.2rem;
      }
      
      /* Header del modal m√°s compacto */
      .image-modal .d-flex.justify-content-between {
        flex-wrap: wrap;
        gap: 0.3rem;
      }
      
      /* Comentarios m√°s legibles y compactos */
      .comment-item {
        padding: 0.5rem !important;
        margin-bottom: 0.3rem !important;
        font-size: 13px !important;
        line-height: 1.3 !important;
        background: rgba(255, 255, 255, 0.05) !important;
        border-radius: 6px !important;
      }
      
      /* Contenedor de comentarios optimizado */
      .comments-container {
        flex: 1 !important;
        min-height: 0 !important;
        overflow-y: auto !important;
        max-height: 45vh !important;
        margin-bottom: 0.5rem !important;
      }
      
      /* √Årea de comentario m√°s compacta */
      .image-modal .comment-form {
        flex-shrink: 0 !important;
        margin-top: auto !important;
        padding-top: 0.5rem !important;
        border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
      }
      
      /* Navegaci√≥n de galer√≠a */
      .gallery-nav {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--bg-dark);
        padding: 1rem 0;
        margin-bottom: 1rem;
      }
      
      /* Cards de dibujos m√°s grandes */
      .drawing-card {
        margin-bottom: 2rem;
      }
      
      .drawing-img {
        height: 250px !important;
      }
      
      /* Botones de like y comentarios m√°s grandes */
      .drawing-card .btn {
        min-height: 44px;
        font-size: 16px;
        padding: 0.5rem 1rem;
      }
    }
    
    /* Estilos para panel de administraci√≥n */
    #adminToggle.btn-success {
      animation: adminGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes adminGlow {
      0% { box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); }
      100% { box-shadow: 0 0 15px rgba(40, 167, 69, 0.8); }
    }
    
    /* Botones flotantes para m√≥viles */
    .mobile-refresh {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 1000;
      background: rgba(255, 107, 53, 0.9);
      color: white;
      border: none;
      border-radius: 25px;
      width: 56px;
      height: 56px;
      font-size: 1.4em;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
      transition: all 0.3s ease;
      display: none;
      backdrop-filter: blur(10px);
    }
    
    .mobile-refresh:hover {
      background: rgba(255, 140, 66, 0.95);
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
    }
    
    .mobile-refresh:active {
      transform: scale(0.95);
    }
    
    /* Bot√≥n para volver arriba en m√≥vil */
    .mobile-scroll-top {
      position: fixed;
      bottom: 150px;
      right: 20px;
      z-index: 1000;
      background: rgba(0, 123, 255, 0.9);
      color: white;
      border: none;
      border-radius: 25px;
      width: 56px;
      height: 56px;
      font-size: 1.4em;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
      transition: all 0.3s ease;
      display: none;
      backdrop-filter: blur(10px);
    }
    
    .mobile-scroll-top:hover {
      background: rgba(0, 123, 255, 0.95);
      transform: scale(1.05);
    }
    
    .mobile-scroll-top:active {
      transform: scale(0.95);
    }
    
    /* Barra de herramientas flotante para m√≥vil */
    .mobile-toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      border-top: 2px solid var(--primary);
      padding: 10px;
      z-index: 1001;
      display: none;
    }
    
    .mobile-toolbar .btn {
      flex: 1;
      margin: 0 2px;
      min-height: 44px;
      font-size: 0.9rem;
      border-radius: 8px;
    }
    
    @media (max-width: 768px) {
      .mobile-refresh,
      .mobile-scroll-top {
        display: block;
      }
      
      .mobile-toolbar {
        display: flex;
      }
      
      /* Ajustar contenido para la barra flotante */
      body {
        padding-bottom: 80px;
      }
      
      /* Ajustar botones de admin/mod en m√≥vil */
      .version-toggle {
        position: fixed !important;
        top: 10px !important;
        right: 10px !important;
        z-index: 1002;
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        max-width: 200px;
      }
      
      .version-toggle .btn {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        margin: 0;
        min-height: 28px;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
  <!-- Botones flotantes para m√≥viles -->
  <button class="mobile-refresh" onclick="refreshPage()" title="Actualizar Guestbook - Limpia cache y recarga la p√°gina">
    ‚Üª
  </button>
  
  <button class="mobile-scroll-top" onclick="scrollToTop()" title="Volver arriba">
    ‚Üë
  </button>
  
  <!-- Barra de herramientas flotante para m√≥vil -->
  <div class="mobile-toolbar">
    <button class="btn btn-secondary" onclick="window.location.href='../index.html'">
      üè† Lab
    </button>
    <button class="btn btn-primary" onclick="scrollToCanvas()">
      üé® Dibujar
    </button>
    <button class="btn btn-info" onclick="scrollToGallery()">
      üèõÔ∏è Galer√≠a
    </button>
    <button class="btn btn-success" onclick="document.getElementById('saveBtn').click()">
      üíæ Guardar
    </button>
  </div>
  
  <div class="container py-4">
    <div class="version-toggle" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
      <a href="guestbook-old.html" class="btn btn-outline-warning btn-sm">
        üìú OLD Version
      </a>
      <button id="updatesToggle" class="btn btn-outline-info btn-sm ms-2" onclick="toggleUpdatesPanel()">
        üöÄ v2.0.9
      </button>
      <button id="vipStoreToggle" class="btn btn-outline-purple btn-sm ms-2" onclick="showVipStore()" style="border-color: #8b5cf6; color: #8b5cf6;">
        üíé VIP Store
      </button>
      <button id="adminToggle" class="btn btn-outline-danger btn-sm ms-2" onclick="toggleAdminPanel()">
        üîê Admin <span id="adminReportCount" class="badge bg-danger" style="display: none;">0</span>
      </button>
      <button id="modToggle" class="btn btn-outline-warning btn-sm ms-2" onclick="toggleModPanel()">
        üõ°Ô∏è Mod <span id="modReportCount" class="badge bg-warning text-dark" style="display: none;">0</span>
      </button>
    </div>
    
    <!-- Panel de Administraci√≥n -->
    <div id="adminPanel" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
          <div class="modal-header" style="border-bottom: 1px solid var(--primary);">
            <h5 class="modal-title" style="color: var(--primary);">üîê Panel de Administraci√≥n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
          </div>
          <div class="modal-body">
            <div id="adminLogin" class="text-center">
              <div class="mb-3">
                <label class="form-label text-light">Acceso al Panel</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="Contrase√±a de acceso">
                <small class="text-muted">Admin: Contrase√±a especial | Moderador: Contrase√±a especial</small>
              </div>
              <button onclick="loginAdmin()" class="btn btn-primary">üîì Acceder</button>
            </div>
            
            <div id="moderatorLogin" style="display: none;">
              <div class="text-center mb-3">
                <h6 class="text-success">üõ°Ô∏è Acceso de Moderador</h6>
                <p class="small text-muted">Inicia sesi√≥n con tu cuenta de moderador</p>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-primary">Iniciar Sesi√≥n</h6>
                  <div class="mb-2">
                    <input type="text" id="modLoginUsername" class="form-control form-control-sm" placeholder="Usuario">
                  </div>
                  <div class="mb-2">
                    <input type="password" id="modLoginPassword" class="form-control form-control-sm" placeholder="Contrase√±a">
                  </div>
                  <button onclick="loginModerator()" class="btn btn-success btn-sm w-100">üîë Entrar</button>
                </div>
                <div class="col-md-6">
                  <h6 class="text-warning">Crear Cuenta</h6>
                  <div class="mb-2">
                    <input type="password" id="modCreateAuth" class="form-control form-control-sm" placeholder="Contrase√±a de moderador">
                    <small class="text-muted">Solicita la contrase√±a al administrador</small>
                  </div>
                  <div class="mb-2">
                    <input type="text" id="modCreateName" class="form-control form-control-sm" placeholder="Nombre completo">
                  </div>
                  <div class="mb-2">
                    <input type="text" id="modCreateUsername" class="form-control form-control-sm" placeholder="Usuario">
                  </div>
                  <div class="mb-2">
                    <input type="password" id="modCreatePassword" class="form-control form-control-sm" placeholder="Tu contrase√±a">
                  </div>
                  <button onclick="createModerator()" class="btn btn-warning btn-sm w-100">‚ûï Crear</button>
                </div>
              </div>
              <div class="text-center mt-3">
                <button onclick="backToMainLogin()" class="btn btn-outline-secondary btn-sm">‚Üê Volver</button>
              </div>
            </div>
            
            <div id="adminContent" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-success mb-0">‚úÖ Sesi√≥n Activa</h6>
                <div>
                  <span id="userInfo" class="badge bg-info me-2">Usuario</span>
                  <button onclick="logoutAdmin()" class="btn btn-outline-danger btn-sm">üö™ Cerrar Sesi√≥n</button>
                </div>
              </div>
              
              <!-- Tabs de navegaci√≥n -->
              <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="suggestions-tab" data-bs-toggle="tab" data-bs-target="#suggestions" type="button" role="tab">
                    üìù Sugerencias
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="drawings-tab" data-bs-toggle="tab" data-bs-target="#drawings" type="button" role="tab">
                    üóëÔ∏è Dibujos
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#admin-reports" type="button" role="tab">
                    ‚ö†Ô∏è Reportes
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab">
                    üìä Estad√≠sticas
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                    üë§ Usuarios
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                    üìã Logs
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab">
                    üí¨ Comentarios
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">
                    ‚öôÔ∏è Config
                  </button>
                </li>
                <li class="nav-item admin-only" role="presentation">
                  <button class="nav-link" id="moderators-tab" data-bs-toggle="tab" data-bs-target="#moderators" type="button" role="tab">
                    üë• Moderadores
                  </button>
                </li>
              </ul>
              
              <!-- Contenido de tabs -->
              <div class="tab-content" id="adminTabContent">
                <!-- Tab de Sugerencias -->
                <div class="tab-pane fade show active" id="suggestions" role="tabpanel">
                  <div id="adminSuggestions" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando sugerencias...</div>
                  </div>
                </div>
                
                <!-- Tab de Dibujos -->
                <div class="tab-pane fade" id="drawings" role="tabpanel">
                  <div id="adminDrawings" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando dibujos...</div>
                  </div>
                </div>
                
                <!-- Tab de Reportes -->
                <div class="tab-pane fade" id="admin-reports" role="tabpanel">
                  <div id="adminReports" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando reportes...</div>
                  </div>
                </div>
                
                <!-- Tab de Estad√≠sticas -->
                <div class="tab-pane fade" id="statistics" role="tabpanel">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header" style="background: linear-gradient(45deg, #28a745, #20c997); color: white;">
                          <h6 class="mb-0">üìä Estad√≠sticas Generales</h6>
                        </div>
                        <div class="card-body p-3">
                          <div id="generalStats">
                            <div class="text-center text-muted">Cargando estad√≠sticas...</div>
                          </div>
                        </div>
                      </div>
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header" style="background: linear-gradient(45deg, #17a2b8, #138496); color: white;">
                          <h6 class="mb-0">üìà Actividad por D√≠a</h6>
                        </div>
                        <div class="card-body p-3">
                          <div id="dailyActivity">
                            <div class="text-center text-muted">Cargando actividad...</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header" style="background: linear-gradient(45deg, #ffc107, #e0a800); color: #000;">
                          <h6 class="mb-0">üèÜ Top Artistas</h6>
                        </div>
                        <div class="card-body p-3">
                          <div id="topArtistsStats">
                            <div class="text-center text-muted">Cargando artistas...</div>
                          </div>
                        </div>
                      </div>
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header" style="background: linear-gradient(45deg, #dc3545, #c82333); color: white;">
                          <h6 class="mb-0">‚ö†Ô∏è Moderaci√≥n</h6>
                        </div>
                        <div class="card-body p-3">
                          <div id="moderationStats">
                            <div class="text-center text-muted">Cargando moderaci√≥n...</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Tab de Usuarios -->
                <div class="tab-pane fade" id="users" role="tabpanel">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header">
                          <h6 class="mb-0">üë§ Lista de Usuarios</h6>
                        </div>
                        <div class="card-body p-3">
                          <div class="mb-3">
                            <div class="row">
                              <div class="col-md-6">
                                <input type="text" id="userSearch" class="form-control form-control-sm" placeholder="Buscar usuario...">
                              </div>
                              <div class="col-md-6">
                                <select id="userFilter" class="form-select form-select-sm">
                                  <option value="all">Todos los usuarios</option>
                                  <option value="active">Usuarios activos</option>
                                  <option value="reported">Usuarios reportados</option>
                                  <option value="blocked">Usuarios bloqueados</option>
                                </select>
                              </div>
                            </div>
                          </div>
                          <div id="usersList" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted">Cargando usuarios...</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header">
                          <h6 class="mb-0">‚öôÔ∏è Acciones de Usuario</h6>
                        </div>
                        <div class="card-body p-3">
                          <div class="mb-3">
                            <label class="form-label text-light small">Usuario seleccionado:</label>
                            <input type="text" id="selectedUser" class="form-control form-control-sm" readonly placeholder="Selecciona un usuario">
                          </div>
                          <div class="d-grid gap-2">
                            <button class="btn btn-warning btn-sm" onclick="warnUser()" disabled id="warnUserBtn">
                              ‚ö†Ô∏è Advertir
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="blockUser()" disabled id="blockUserBtn">
                              üö´ Bloquear
                            </button>
                            <button class="btn btn-success btn-sm" onclick="unblockUser()" disabled id="unblockUserBtn">
                              ‚úÖ Desbloquear
                            </button>
                            <button class="btn btn-info btn-sm" onclick="viewUserHistory()" disabled id="viewHistoryBtn">
                              üìã Ver Historial
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Tab de Logs -->
                <div class="tab-pane fade" id="logs" role="tabpanel">
                  <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
                    <div class="card-header">
                      <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">üìã Registro de Actividades</h6>
                        <div>
                          <select id="logFilter" class="form-select form-select-sm" style="width: 200px;">
                            <option value="all">Todas las actividades</option>
                            <option value="delete_drawing">Dibujos eliminados</option>
                            <option value="update_report">Reportes actualizados</option>
                            <option value="user_action">Acciones de usuario</option>
                            <option value="moderator_action">Acciones de moderador</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="card-body p-3">
                      <div id="activityLogs" style="max-height: 500px; overflow-y: auto;">
                        <div class="text-center text-muted">Cargando logs...</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Tab de Comentarios -->
                <div class="tab-pane fade" id="comments" role="tabpanel">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-primary mb-0">üí¨ Gesti√≥n de Comentarios</h6>
                    <div>
                      <select id="commentFilter" class="form-select form-select-sm" style="width: 200px;">
                        <option value="all">Todos los comentarios</option>
                        <option value="recent">M√°s recientes</option>
                        <option value="reported">Reportados</option>
                        <option value="replies">Solo respuestas</option>
                      </select>
                    </div>
                  </div>
                  <div id="adminComments" style="max-height: 500px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando comentarios...</div>
                  </div>
                </div>
                
                <!-- Tab de Configuraci√≥n -->
                <div class="tab-pane fade" id="config" role="tabpanel">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header">
                          <h6 class="mb-0">üîß Configuraci√≥n General</h6>
                        </div>
                        <div class="card-body p-3">
                          <div class="mb-3">
                            <label class="form-label text-light small">L√≠mite de dibujos por usuario/d√≠a:</label>
                            <input type="number" id="drawingLimit" class="form-control form-control-sm" value="10" min="1" max="100">
                          </div>
                          <div class="mb-3">
                            <label class="form-label text-light small">Tama√±o m√°ximo de imagen (MB):</label>
                            <input type="number" id="imageSizeLimit" class="form-control form-control-sm" value="3" min="1" max="10" step="0.5">
                          </div>
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="allowGifs" checked>
                              <label class="form-check-label text-light" for="allowGifs">
                                Permitir GIFs animados
                              </label>
                            </div>
                          </div>
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="moderateComments" checked>
                              <label class="form-check-label text-light" for="moderateComments">
                                Moderar comentarios autom√°ticamente
                              </label>
                            </div>
                          </div>
                          <button class="btn btn-primary btn-sm" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header">
                          <h6 class="mb-0">üö´ Filtros de Contenido</h6>
                        </div>
                        <div class="card-body p-3">
                          <div class="mb-3">
                            <label class="form-label text-light small">Palabras prohibidas (una por l√≠nea):</label>
                            <textarea id="bannedWords" class="form-control form-control-sm" rows="5" placeholder="palabra1\npalabra2\npalabra3"></textarea>
                          </div>
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="autoDeleteSpam" checked>
                              <label class="form-check-label text-light" for="autoDeleteSpam">
                                Auto-eliminar spam detectado
                              </label>
                            </div>
                          </div>
                          <button class="btn btn-warning btn-sm" onclick="saveFilters()">üõ°Ô∏è Actualizar Filtros</button>
                        </div>
                      </div>
                      <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header">
                          <h6 class="mb-0">üìä Exportar Datos</h6>
                        </div>
                        <div class="card-body p-3">
                          <div class="d-grid gap-2">
                            <button class="btn btn-info btn-sm" onclick="exportDrawings()">üìÅ Exportar Dibujos</button>
                            <button class="btn btn-success btn-sm" onclick="exportReports()">üìã Exportar Reportes</button>
                            <button class="btn btn-warning btn-sm" onclick="exportLogs()">üìú Exportar Logs</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Tab de Moderadores (solo admin) -->
                <div class="tab-pane fade admin-only" id="moderators" role="tabpanel">
                  <div class="row">
                    <div class="col-md-6">
                      <h6 class="text-primary">üè∑Ô∏è Gesti√≥n de Tags</h6>
                      <div class="mb-3">
                        <label class="form-label small text-light">Buscar usuario registrado:</label>
                        <input type="text" id="searchUserForTags" class="form-control form-control-sm" placeholder="Nombre de usuario..." onkeyup="searchUsersForTags()">
                      </div>
                      <div id="userTagSearchResults" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                        <div class="text-center text-muted small">Escribe para buscar usuarios</div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label small text-light">Usuario seleccionado:</label>
                        <input type="text" id="selectedUserForTags" class="form-control form-control-sm" readonly placeholder="Selecciona un usuario">
                      </div>
                      <div class="mb-3">
                        <label class="form-label small text-light">Asignar Tag:</label>
                        <div class="btn-group-vertical w-100" role="group">
                          <button type="button" onclick="assignTag('OWNER')" class="btn btn-outline-danger btn-sm" disabled id="assignOwnerBtn">üëë OWNER</button>
                          <button type="button" onclick="assignTag('ADMIN')" class="btn btn-outline-warning btn-sm" disabled id="assignAdminBtn">üîê ADMIN</button>
                          <button type="button" onclick="assignTag('MOD')" class="btn btn-outline-success btn-sm" disabled id="assignModBtn">üõ°Ô∏è MOD</button>
                          <button type="button" onclick="assignTag('VIP')" class="btn btn-outline-info btn-sm" disabled id="assignVipBtn">üíé VIP</button>
                        </div>
                      </div>
                      <div class="mb-3">
                        <label class="form-label small text-light">Acci√≥n Especial:</label>
                        <button type="button" onclick="assignSelfOwner()" class="btn btn-danger btn-sm w-100">üëë Asignarme OWNER</button>
                        <small class="text-muted">Solo para el creador del guestbook</small>
                      </div>
                      <div class="mb-3">
                        <label class="form-label small text-light">Quitar Tag:</label>
                        <div class="btn-group-vertical w-100" role="group">
                          <button type="button" onclick="removeTag('OWNER')" class="btn btn-outline-secondary btn-sm" disabled id="removeOwnerBtn">‚ùå Quitar OWNER</button>
                          <button type="button" onclick="removeTag('ADMIN')" class="btn btn-outline-secondary btn-sm" disabled id="removeAdminBtn">‚ùå Quitar ADMIN</button>
                          <button type="button" onclick="removeTag('MOD')" class="btn btn-outline-secondary btn-sm" disabled id="removeModBtn">‚ùå Quitar MOD</button>
                          <button type="button" onclick="removeTag('VIP')" class="btn btn-outline-secondary btn-sm" disabled id="removeVipBtn">‚ùå Quitar VIP</button>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <h6 class="text-warning">üë• Usuarios con Tags</h6>
                      <div id="taggedUsersList" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center text-muted">Cargando usuarios...</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Panel de Moderador -->
    <div id="modPanel" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
          <div class="modal-header" style="border-bottom: 1px solid var(--primary);">
            <h5 class="modal-title" style="color: var(--primary);">üõ°Ô∏è Panel de Moderador</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
          </div>
          <div class="modal-body">
            <div id="modLogin">
              <div class="mb-3">
                <h6 class="text-light">üõ°Ô∏è Panel de Moderador</h6>
                <p class="text-muted small">Inicia sesi√≥n con tu perfil de usuario que tenga tag MOD</p>
                <label class="form-label text-light">Usuario con permisos MOD</label>
                <input type="text" id="modPanelUsername" class="form-control" placeholder="Tu nombre de usuario">
              </div>
              <div class="text-center">
                <button onclick="loginMod()" class="btn btn-warning">üîë Verificar Permisos</button>
              </div>
            </div>
            
            <div id="modContent" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-success mb-0">‚úÖ Sesi√≥n Activa</h6>
                <div>
                  <span id="modUserInfo" class="badge bg-warning me-2">Moderador</span>
                  <button onclick="logoutMod()" class="btn btn-outline-danger btn-sm">üö∫ Salir</button>
                </div>
              </div>
              
              <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                  <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mod-suggestions">üìù Sugerencias</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mod-drawings">üóëÔ∏è Dibujos</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mod-reports">‚ö†Ô∏è Reportes</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mod-comments">üí¨ Comentarios</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mod-stats">üìä Estad√≠sticas</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mod-users">üë§ Usuarios</button>
                </li>
                <li class="nav-item">
                  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mod-config">‚öôÔ∏è Config</button>
                </li>
              </ul>
              
              <div class="tab-content">
                <div class="tab-pane fade show active" id="mod-suggestions">
                  <div id="modSuggestions" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando...</div>
                  </div>
                </div>
                <div class="tab-pane fade" id="mod-drawings">
                  <div id="modDrawings" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando...</div>
                  </div>
                </div>
                <div class="tab-pane fade" id="mod-reports">
                  <div id="modReports" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando...</div>
                  </div>
                </div>
                <div class="tab-pane fade" id="mod-comments">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-primary mb-0">üí¨ Comentarios</h6>
                    <select id="modCommentFilter" class="form-select form-select-sm" style="width: 150px;">
                      <option value="all">Todos</option>
                      <option value="recent">Recientes</option>
                      <option value="replies">Respuestas</option>
                    </select>
                  </div>
                  <div id="modComments" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted">Cargando...</div>
                  </div>
                </div>
                <div class="tab-pane fade" id="mod-stats">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header" style="background: linear-gradient(45deg, #28a745, #20c997); color: white;">
                          <h6 class="mb-0">üìä Mis Estad√≠sticas</h6>
                        </div>
                        <div class="card-body p-3">
                          <div id="modPersonalStats">
                            <div class="text-center text-muted">Cargando estad√≠sticas...</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header" style="background: linear-gradient(45deg, #17a2b8, #138496); color: white;">
                          <h6 class="mb-0">üìà Actividad Reciente</h6>
                        </div>
                        <div class="card-body p-3">
                          <div id="modRecentActivity">
                            <div class="text-center text-muted">Cargando actividad...</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="mod-users">
                  <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
                    <div class="card-header">
                      <h6 class="mb-0">üë§ Usuarios Reportados</h6>
                    </div>
                    <div class="card-body p-3">
                      <div id="modReportedUsers" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center text-muted">Cargando usuarios reportados...</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="mod-config">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header">
                          <h6 class="mb-0">‚öôÔ∏è Mi Configuraci√≥n</h6>
                        </div>
                        <div class="card-body p-3">
                          <div class="mb-3">
                            <label class="form-label text-light small">Cambiar contrase√±a:</label>
                            <input type="password" id="modNewPassword" class="form-control form-control-sm" placeholder="Nueva contrase√±a">
                          </div>
                          <div class="mb-3">
                            <label class="form-label text-light small">Confirmar contrase√±a:</label>
                            <input type="password" id="modConfirmPassword" class="form-control form-control-sm" placeholder="Confirmar contrase√±a">
                          </div>
                          <button class="btn btn-primary btn-sm" onclick="changeModPassword()">üîê Cambiar Contrase√±a</button>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
                        <div class="card-header">
                          <h6 class="mb-0">üîî Notificaciones</h6>
                        </div>
                        <div class="card-body p-3">
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="notifyNewReports" checked>
                              <label class="form-check-label text-light" for="notifyNewReports">
                                Notificar nuevos reportes
                              </label>
                            </div>
                          </div>
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" id="notifyNewDrawings" checked>
                              <label class="form-check-label text-light" for="notifyNewDrawings">
                                Notificar nuevos dibujos
                              </label>
                            </div>
                          </div>
                          <button class="btn btn-success btn-sm" onclick="saveModNotifications()">üíæ Guardar Preferencias</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Panel de Updates -->
    <div id="updatesPanel" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
          <div class="modal-header" style="border-bottom: 1px solid var(--primary);">
            <h5 class="modal-title" style="color: var(--primary);">üöÄ Guestbook Updates v2.0.9</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <div class="d-flex align-items-center gap-3 mb-3">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em;">
                  üé®
                </div>
                <div>
                  <h6 style="color: var(--primary); margin: 0; font-size: 1.2em;">Guestbook v2.0.9</h6>
                  <small style="color: var(--text-secondary);">20 de Diciembre, 2024</small>
                </div>
                <div class="ms-auto">
                  <span class="badge" style="background: var(--primary); color: white; padding: 0.5rem 1rem;">ESTABLE</span>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <h6 style="color: var(--primary); margin-bottom: 1rem;">‚ú® Nuevas Caracter√≠sticas</h6>
                <div style="max-height: 300px; overflow-y: auto;">
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">üë§ Sistema de Perfiles</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Fotos personalizadas y avatares inteligentes</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">üé® Avatares √önicos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">20 emojis diferentes por usuario</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">üìä Modal Clickeable</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Perfil detallado con estad√≠sticas</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">üåà Tema Funky Atlas</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Nuevo tema con colores vibrantes</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--primary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">üì± Metadatos Discord</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Optimizado para redes sociales</div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <h6 style="color: var(--secondary); margin-bottom: 1rem;">üîß Mejoras y Correcciones</h6>
                <div style="max-height: 300px; overflow-y: auto;">
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">üîß Modal Optimizado</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Perfil compacto que no cubre comentarios</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">üì± Comentarios Compactos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">M√°s contenido visible sin scroll</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">‚ö° Validaci√≥n Autom√°tica</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Archivos de imagen y tama√±o</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">üö´ Errores Suprimidos</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Extensiones del navegador</div>
                  </div>
                  <div class="mb-2 p-2" style="background: var(--bg-light); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <strong style="color: var(--text-primary); font-size: 0.9em;">‚ú® Efectos Visuales</strong>
                    <div style="color: var(--text-secondary); font-size: 0.8em;">Hover effects y transiciones suaves</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mt-4 p-3" style="background: var(--bg-light); border-radius: 8px; border: 1px solid var(--primary);">
              <h6 style="color: var(--primary); margin-bottom: 1rem;">üìà Estad√≠sticas de Desarrollo</h6>
              <div class="row text-center">
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">10</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Versiones</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">50+</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Herramientas</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">11</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Temas</div>
                </div>
                <div class="col-3">
                  <div style="color: var(--primary); font-weight: bold; font-size: 1.2em;">4</div>
                  <div style="color: var(--text-secondary); font-size: 0.8em;">Meses</div>
                </div>
              </div>
            </div>
            
            <div class="mt-3 text-center">
              <a href="../README.md" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                üìù Ver README completo
              </a>
              <a href="../updates.json" target="_blank" class="btn btn-outline-info btn-sm">
                üìÑ Ver updates.json
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="text-center mb-4">
      <h1 style="color: var(--primary);">üé® Guestbook NEW</h1>
      <p style="color: var(--text-secondary);">Sistema modular avanzado</p>
      <div class="d-flex justify-content-center gap-2 mb-3">
        <a href="../index.html" class="btn btn-outline-secondary btn-sm">
          üè† Volver al Lab
        </a>
      </div>
    </div>
    
    <!-- Canvas y Controles -->
    <div class="row">
      <!-- Canvas -->
      <div class="col-lg-8 col-md-12">
        <div class="canvas-container text-center">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="badge bg-primary">üé® Lienzo de Dibujo</div>
              <div class="d-flex gap-2">
                <span class="badge bg-secondary" id="canvasInfo">600√ó400</span>
                <span class="badge bg-info" id="zoomInfo">100%</span>
              </div>
            </div>
          </div>
          
          <div style="position: relative; display: inline-block;">
            <div id="gifBackground" style="position: absolute; top: 0; left: 0; width: 600px; height: 400px; z-index: 1; display: none; border-radius: 8px; overflow: hidden;">
              <img id="gifBackgroundImg" style="width: 100%; height: 100%; object-fit: cover;" alt="Fondo GIF">
            </div>
            <canvas id="drawCanvas" width="600" height="400" style="position: relative; z-index: 2;"></canvas>
            <div id="gifStickersContainer" style="position: absolute; top: 0; left: 0; width: 600px; height: 400px; z-index: 3; pointer-events: none;"></div>
          </div>
        </div>
      </div>
      
      <!-- Panel de Control -->
      <div class="col-lg-4 col-md-12">
        <div class="card h-100" style="background: var(--bg-light); border: 1px solid var(--primary);">
          <div class="card-header text-center" style="background: linear-gradient(45deg, var(--primary), #ff8c42); color: white;">
            <h6 class="mb-0">üéõÔ∏è Panel de Control</h6>
          </div>
          <div class="card-body p-3">
            <!-- Info del dibujo -->
            <div class="control-section">
              <div class="mb-2">
                <label class="form-label text-light small">üë§ Autor</label>
                <div class="input-group">
                  <input type="text" id="authorName" placeholder="Tu nombre" class="form-control form-control-sm">
                  <button id="useProfileName" class="btn btn-outline-info btn-sm" type="button" title="Usar nombre del perfil">
                    üë§
                  </button>
                </div>
                <small class="text-muted">Haz clic en el c√≠rculo de perfil (esquina superior izquierda) para registrarte o iniciar sesi√≥n</small>
              </div>
              <div class="mb-2">
                <label class="form-label text-light small">üìÇ Categor√≠a</label>
                <select id="categorySelect" class="form-select form-select-sm">
                  <option value="Arte">üé® Arte</option>
                  <option value="Meme">üòÇ Meme</option>
                  <option value="Divertido">üéâ Divertido</option>
                  <option value="Abstracto">üåå Abstracto</option>
                  <option value="Otro">‚ú® Otro</option>
                </select>
              </div>
            </div>
          
            <!-- Herramientas principales -->
            <div class="control-section">
              <label class="form-label text-light small">üõ†Ô∏è Herramientas</label>
              <div class="btn-group-custom">
                <button id="brushBtn" class="btn btn-neon btn-sm">üñåÔ∏è Pincel</button>
                <button id="eraserBtn" class="btn btn-neon btn-sm">üßΩ Borrar</button>
                <button id="bucketBtn" class="btn btn-neon btn-sm">ü™£ Relleno</button>
                <button id="textBtn" class="btn btn-neon btn-sm">üÖ∞Ô∏è Texto</button>
                <button id="stickerMoveBtn" class="btn btn-neon btn-sm">‚úã Mover</button>
              </div>
              <div class="btn-group-custom mt-2">
                <button id="undoBtn" class="btn btn-outline-warning btn-sm">‚Ü∂ Deshacer</button>
                <button id="redoBtn" class="btn btn-outline-info btn-sm">‚Ü∑ Rehacer</button>
                <button id="clearBtn" class="btn btn-outline-danger btn-sm">üóëÔ∏è Limpiar</button>
              </div>
            </div>
            
            <!-- Tama√±o y opacidad -->
            <div class="control-section">
              <label class="form-label text-light small">üìè Pincel</label>
              <div class="d-flex align-items-center gap-2">
                <input type="range" id="brushSize" min="1" max="20" value="3" class="form-range form-range-sm">
                <span id="sizeDisplay" class="badge bg-secondary">3px</span>
                <input type="range" id="opacitySlider" min="10" max="100" value="100" class="form-range form-range-sm">
                <span id="opacityDisplay" class="badge bg-secondary">100%</span>
              </div>
            </div>
            
            <!-- Colores -->
            <div class="control-section">
              <label class="form-label text-light small">üé® Colores</label>
              <div class="d-flex flex-wrap gap-1 justify-content-center">
                <div class="color-btn active" style="background: #000; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#000000"></div>
                <div class="color-btn" style="background: #ff6b35; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff6b35"></div>
                <div class="color-btn" style="background: #f00; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff0000"></div>
                <div class="color-btn" style="background: #0f0; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#00ff00"></div>
                <div class="color-btn" style="background: #00f; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#0000ff"></div>
                <div class="color-btn" style="background: #fff; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #000;" data-color="#ffffff"></div>
                <div class="color-btn" style="background: #ff0080; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff0080"></div>
                <div class="color-btn" style="background: #00ffff; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#00ffff"></div>
                <div class="color-btn" style="background: #ffff00; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ffff00"></div>
                <div class="color-btn" style="background: #ff8000; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff8000"></div>
                <div class="color-btn" style="background: #8000ff; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#8000ff"></div>
                <div class="color-btn" style="background: #00ff80; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#00ff80"></div>
                <div class="color-btn" style="background: #ff4444; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ff4444"></div>
                <div class="color-btn" style="background: #4444ff; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#4444ff"></div>
                <div class="color-btn" style="background: #44ff44; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#44ff44"></div>
                <div class="color-btn" style="background: #ffd700; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #fff;" data-color="#ffd700"></div>
                <input type="color" id="customColor" value="#ff6b35" class="form-control form-control-sm" style="width: 30px; height: 25px; padding: 0; border: none;">
              </div>
            </div>
            
            <!-- Sistema de Capas -->
            <div class="control-section">
              <label class="form-label text-light small">üéÜ Capas</label>
              <div class="d-flex gap-1 mb-2">
                <button id="layerModeToggle" class="btn btn-outline-primary btn-sm flex-fill" title="Cambiar entre modo simple (con deshacer/rehacer) y modo capas (sin deshacer/rehacer)">üé® Modo Capas</button>
              </div>
              <div id="layerControls" style="display: none;">
                <div class="d-flex gap-1 mb-2">
                  <button id="addLayerBtn" class="btn btn-outline-success btn-sm flex-fill">‚ûï Nueva</button>
                  <button id="deleteLayerBtn" class="btn btn-outline-danger btn-sm flex-fill">‚ûñ Eliminar</button>
                </div>
                <div id="layersList" style="max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 4px;">
                  <!-- Las capas se generar√°n din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Herramientas extras -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#extraTools">
                ‚öôÔ∏è M√°s Herramientas
              </button>
              <div class="collapse mt-2" id="extraTools">
                <div class="btn-group-custom mb-2">
                  <button id="sprayBtn" class="btn btn-neon btn-sm">üí® Spray</button>
                  <button id="selectBtn" class="btn btn-neon btn-sm">üî≤ Seleccionar</button>
                  <button id="lineBtn" class="btn btn-neon btn-sm">üìè L√≠nea</button>
                  <button id="eyedropperBtn" class="btn btn-neon btn-sm">üíß Cuentagotas</button>
                </div>
              </div>
            </div>
            
            <!-- Efectos -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#effects">
                ‚ú® Efectos
              </button>
              <div class="collapse mt-2" id="effects">
                <div class="btn-group-custom mb-2">
                  <button id="gradientBtn" class="btn btn-neon btn-sm">üåà Gradiente</button>
                  <button id="patternBtn" class="btn btn-neon btn-sm">üî≥ Patr√≥n</button>
                  <button id="symmetryBtn" class="btn btn-neon btn-sm">ü™û Simetr√≠a</button>
                </div>
                <div class="btn-group-custom mb-2">
                  <button id="neonBtn" class="btn btn-neon btn-sm">üí´ Ne√≥n</button>
                  <button id="watercolorBtn" class="btn btn-neon btn-sm">üé® Acuarela</button>
                </div>
              </div>
            </div>
            
            <!-- Filtros -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#filters">
                üé® Filtros
              </button>
              <div class="collapse mt-2" id="filters">
                <div class="btn-group-custom mb-2">
                  <button id="blurBtn" class="btn btn-neon btn-sm">üå´Ô∏è Blur</button>
                  <button id="pixelBtn" class="btn btn-neon btn-sm">üñºÔ∏è Pixel</button>
                  <button id="vintageBtn" class="btn btn-neon btn-sm">üì∑ Vintage</button>
                </div>
                <div class="btn-group-custom mb-2">
                  <button id="oleoBtn" class="btn btn-neon btn-sm">üé® √ìleo</button>
                  <button id="carbonBtn" class="btn btn-neon btn-sm">‚úèÔ∏è Carb√≥n</button>
                  <button id="clearFiltersBtn" class="btn btn-warning btn-sm">‚ùå Quitar</button>
                </div>
              </div>
            </div>
            
            <!-- Fondos y Stickers -->
            <div class="control-section">
              <button class="btn btn-outline-primary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mediaTools">
                üñºÔ∏è Fondos y Stickers
              </button>
              <div class="collapse mt-2" id="mediaTools">
                <div class="mb-2">
                  <input type="file" id="bgUpload" accept=".png,.jpg,.jpeg,.gif" class="form-control form-control-sm mb-1">
                  <button id="setBgBtn" class="btn btn-outline-primary btn-sm w-100" disabled>üñºÔ∏è Aplicar Fondo</button>
                  <small class="text-muted d-block mt-1">üì∏ PNG/JPG en canvas ‚Ä¢ üé¨ GIF como fondo animado</small>
                </div>
                <div>
                  <input type="file" id="stickerUpload" accept=".png,.jpg,.jpeg,.gif" class="form-control form-control-sm mb-1">
                  <button id="placeStickerBtn" class="btn btn-outline-success btn-sm w-100" disabled>üìå Sticker</button>
                  <small class="text-muted d-block mt-1">üñºÔ∏è PNG/JPG en canvas ‚Ä¢ üé¶ GIF como elemento animado</small>
                </div>
              </div>
            </div>
            
            <!-- Herramientas avanzadas -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#advancedTools">
                üîß Avanzadas
              </button>
              <div class="collapse mt-2" id="advancedTools">
                <div class="btn-group-custom mb-2">
                  <button id="rulerBtn" class="btn btn-neon btn-sm">üìê Reglas</button>
                  <button id="perspectiveBtn" class="btn btn-neon btn-sm">üìê Perspectiva</button>
                </div>
                <div class="btn-group-custom mb-2">
                  <button id="cloneBtn" class="btn btn-neon btn-sm">üìã Clonar</button>
                  <button id="histogramBtn" class="btn btn-neon btn-sm">üìä Histograma</button>
                </div>
              </div>
            </div>
            
            <!-- Tama√±o Canvas -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#canvasSize">
                üìê Tama√±o Canvas
              </button>
              <div class="collapse mt-2" id="canvasSize">
                <div class="btn-group-custom mb-2">
                  <button id="smallCanvas" class="btn btn-outline-info btn-sm">400√ó300</button>
                  <button id="mediumCanvas" class="btn btn-info btn-sm">600√ó400</button>
                  <button id="largeCanvas" class="btn btn-outline-info btn-sm">800√ó600</button>
                  <button id="wideCanvas" class="btn btn-outline-info btn-sm">800√ó400</button>
                </div>
                <div class="d-flex gap-1 mb-2">
                  <input type="number" id="customWidth" placeholder="W" class="form-control form-control-sm" min="100" max="1200" value="600">
                  <span class="align-self-center text-light">√ó</span>
                  <input type="number" id="customHeight" placeholder="H" class="form-control form-control-sm" min="100" max="800" value="400">
                </div>
                <button id="customCanvasBtn" class="btn btn-outline-info btn-sm w-100">üìê Aplicar</button>
              </div>
            </div>
            
            <!-- Configuraci√≥n Pincel -->
            <div class="control-section">
              <button class="btn btn-outline-secondary btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#brushConfig">
                ‚öôÔ∏è Configuraci√≥n Pincel
              </button>
              <div class="collapse mt-2" id="brushConfig">
                <select id="brushType" class="form-select form-select-sm" style="width: 150px; margin: 0 auto;">
                  <option value="normal">üñåÔ∏è Normal</option>
                  <option value="fine">‚úèÔ∏è Fino</option>
                  <option value="thick">üñçÔ∏è Grueso</option>
                  <option value="art">üé® Arte</option>
                </select>
              </div>
            </div>
            

            <!-- Animaci√≥n GIF -->
            <div class="control-section">
              <label class="form-label text-light small">üé¨ Animaci√≥n GIF</label>
              <div class="btn-group-custom mb-2">
                <button id="captureFrameBtn" class="btn btn-outline-primary btn-sm">üì∏ Capturar</button>
                <button id="clearFramesBtn" class="btn btn-outline-warning btn-sm">üóëÔ∏è Limpiar</button>
              </div>
              <div id="frameCounter" class="text-center small text-muted">0 frames</div>
            </div>
            
            <!-- Vista y Archivo -->
            <div class="control-section">
              <label class="form-label text-light small">üîç Vista & Archivo</label>
              <div class="btn-group-custom mb-2">
                <button id="zoomInBtn" class="btn btn-outline-success btn-sm">üîç+ Zoom</button>
                <button id="zoomOutBtn" class="btn btn-outline-success btn-sm">üîç- Zoom</button>
              </div>
              <div class="btn-group-custom mb-2">
                <input type="file" id="importBtn" accept="image/*" style="display:none">
                <button class="btn btn-info btn-sm" onclick="document.getElementById('importBtn').click()">üìÅ Importar</button>
                <button id="exportBtn" class="btn btn-success btn-sm">üíæ Exportar</button>
              </div>
            </div>
            
            <!-- Acciones -->
            <div class="control-section">
              <label class="form-label text-light small">‚ö° Guardar</label>
              <button id="saveBtn" class="btn btn-primary btn-sm w-100">
                <span id="saveText">üöÄ Guardar</span>
                <span id="saveLoader" style="display: none;">‚è≥ Guardando...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Rankings y Sugerencias -->
    <hr style="border-color: var(--primary);">
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
          <div class="card-header" style="background: linear-gradient(45deg, #ffd700, #ffed4e); color: #000;">
            <h5 class="mb-0">üèÜ Top Rankings</h5>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <h6 class="text-warning">üëë Top Artistas</h6>
              <div id="topArtists" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ü•á Cargando...</span>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <h6 class="text-info">‚ù§Ô∏è M√°s Populares</h6>
              <div id="topLiked" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ü•á Cargando...</span>
                </div>
              </div>
            </div>
            <div>
              <h6 class="text-success">üî• M√°s Activos</h6>
              <div id="topActive" class="small" style="color: var(--text-primary);">
                <div class="d-flex justify-content-between mb-1">
                  <span>ü•á Cargando...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card" style="background: var(--bg-light); border: 1px solid var(--primary);">
          <div class="card-header" style="background: linear-gradient(45deg, #ff6b35, #ff8c42); color: white;">
            <h5 class="mb-0">üí° Sugerencias</h5>
          </div>
          <div class="card-body p-3">
            <div class="mb-3">
              <textarea id="suggestionText" class="form-control form-control-sm" rows="3" placeholder="Tu sugerencia..."></textarea>
            </div>
            <div class="mb-3">
              <input type="file" id="suggestionImage" accept="image/*" class="form-control form-control-sm">
              <small class="text-muted">Opcional: Adjunta una imagen</small>
            </div>
            <div class="mb-3">
              <select id="suggestionType" class="form-select form-select-sm">
                <option value="feature">‚ú® Nueva Funci√≥n</option>
                <option value="bug">üêõ Reportar Bug</option>
                <option value="improvement">üîß Mejora</option>
                <option value="other">üí≠ Otro</option>
              </select>
            </div>
            <button id="submitSuggestion" class="btn btn-primary btn-sm w-100">üì§ Enviar</button>
            <div id="recentSuggestions" class="mt-3" style="max-height: 200px; overflow-y: auto;">
              <small class="text-muted">Cargando sugerencias...</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Galer√≠a -->
    <div class="text-center mb-4">
      <h2 style="color: var(--primary);">üèõÔ∏è Galer√≠a Interactiva</h2>
      <p style="color: var(--text-secondary);">Sistema de comentarios y likes en tiempo real</p>
    </div>
    
    <div class="row justify-content-center mb-4">
      <div class="col-md-8">
        <div class="d-flex justify-content-center gap-2 flex-wrap">
          <input type="text" id="searchAuthor" placeholder="Buscar por autor" class="form-control" style="width: 200px;">
          <select id="filterCategory" class="form-select" style="width: 180px;">
            <option value="">Todas las categor√≠as</option>
            <option value="Arte">üé® Arte</option>
            <option value="Meme">üòÇ Meme</option>
            <option value="Divertido">üéâ Divertido</option>
            <option value="Abstracto">üåå Abstracto</option>
            <option value="Otro">‚ú® Otro</option>
          </select>
          <button id="clearFilters" class="btn btn-outline-secondary">‚ùå Limpiar</button>
          <button id="reloadData" class="btn btn-outline-info">üîÑ Recargar</button>
        </div>
      </div>
    </div>
    

    
    <div id="gallery" class="row">
      <div class="col-12 text-center" style="color: var(--text-secondary);">
        <div class="spinner-border" role="status" style="color: var(--primary);">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando galer√≠a...</p>
      </div>
    </div>
    
    <div id="pagination" class="text-center mt-4"></div>
  </div>
  
  <!-- Scripts modulares -->
  <script type="module">
    import { FirebaseManager } from './js/firebase.js';
    import { CanvasManager } from './js/canvas.js';
    import { GalleryManager } from './js/gallery.js';
    import { UIManager } from './js/ui.js';
    import { ProfileManager } from './js/profiles.js';
    import { MobileOptimizer } from './js/mobile-optimizer.js';
    import { SoundSystem } from './js/sound-system.js';
    import { AutoModerationSystem } from './js/auto-moderation.js';
    import { VipStore } from './js/vip-store.js';
    
    class GuestbookApp {
      constructor() {
        this.firebase = new FirebaseManager();
        this.canvas = new CanvasManager();
        this.gallery = new GalleryManager(this.firebase);
        this.ui = new UIManager();
        this.profiles = new ProfileManager(this.firebase);
        this.mobileOptimizer = new MobileOptimizer();
        this.soundSystem = new SoundSystem();
        this.autoModeration = new AutoModerationSystem(this.firebase);
        this.vipStore = new VipStore();
        
        // Hacer disponible globalmente
        window.guestbookApp = this;
      }
      
      async init() {
        try {
          this.setupCanvasControls();
          await this.gallery.init();
          await this.loadRecentSuggestions();
          
          // Cargar nombre del perfil si est√° logueado
          this.loadInitialProfileData();
          
          // Actualizar rankings despu√©s de cargar la galer√≠a
          setTimeout(() => {
            if (this.gallery.allDrawings && this.gallery.allDrawings.length > 0) {
              this.gallery.updateRankingsSection();
              
              // Actualizar estad√≠sticas del perfil con todos los dibujos
              if (this.profiles && this.profiles.isLoggedIn()) {
                this.profiles.updateStats(this.gallery.allDrawings);
              }
            }
          }, 1000);
          
          console.log('‚úÖ Guestbook NEW inicializado correctamente');
          
          // Mostrar informaci√≥n de dispositivo si est√° en modo debug
          if (this.mobileOptimizer) {
            this.mobileOptimizer.showDebugInfo();
          }
        } catch (error) {
          console.error('‚ùå Error inicializando:', error);
        }
      }
      
      loadInitialProfileData() {
        // Cargar nombre del perfil si est√° logueado
        if (this.profiles && this.profiles.isLoggedIn()) {
          const authorInput = document.getElementById('authorName');
          if (authorInput && !authorInput.value) {
            authorInput.value = this.profiles.currentProfile.username;
          }
        }
      }
      
      setupCanvasControls() {
        // Configurar detecci√≥n de cambios en canvas
        this.setupUnsavedChangesDetection();
        
        // Controles de herramientas
        document.getElementById('brushBtn')?.addEventListener('click', () => {
          this.canvas.setTool('brush');
          this.currentTool = 'brush';
          this.updateToolButtons('brushBtn');
        });
        document.getElementById('eraserBtn')?.addEventListener('click', () => {
          this.canvas.setTool('eraser');
          this.currentTool = 'eraser';
          this.updateToolButtons('eraserBtn');
        });
        document.getElementById('bucketBtn')?.addEventListener('click', () => {
          this.canvas.setTool('bucket');
          this.currentTool = 'bucket';
          this.updateToolButtons('bucketBtn');
        });
        document.getElementById('textBtn')?.addEventListener('click', () => {
          this.canvas.setTool('text');
          this.currentTool = 'text';
          this.updateToolButtons('textBtn');
        });
        document.getElementById('stickerMoveBtn')?.addEventListener('click', () => this.setStickerMoveTool());
        
        // Controles de tama√±o y opacidad
        document.getElementById('brushSize')?.addEventListener('input', (e) => {
          this.canvas.setSize(e.target.value);
          document.getElementById('sizeDisplay').textContent = e.target.value + 'px';
        });
        
        document.getElementById('opacitySlider')?.addEventListener('input', (e) => {
          this.canvas.setOpacity(e.target.value);
          document.getElementById('opacityDisplay').textContent = e.target.value + '%';
        });
        
        // Controles de color
        document.querySelectorAll('.color-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelector('.color-btn.active')?.classList.remove('active');
            btn.classList.add('active');
            this.canvas.setColor(btn.dataset.color);
            this.saveUserColor(btn.dataset.color);
          });
        });
        
        document.getElementById('customColor')?.addEventListener('change', (e) => {
          this.canvas.setColor(e.target.value);
          document.querySelector('.color-btn.active')?.classList.remove('active');
          this.saveUserColor(e.target.value);
        });
        
        // Cargar color guardado del usuario
        this.loadUserColor();
        
        // El manejo de fotos de perfil ahora se hace en ProfileManager
        
        // Toggle de modo capas
        document.getElementById('layerModeToggle')?.addEventListener('click', () => {
          this.canvas.toggleLayerMode();
        });
        
        // Controles de capas
        document.getElementById('addLayerBtn')?.addEventListener('click', () => {
          this.canvas.addLayer();
        });
        
        document.getElementById('deleteLayerBtn')?.addEventListener('click', () => {
          this.canvas.deleteLayer();
        });
        
        // Controles de acci√≥n
        document.getElementById('undoBtn')?.addEventListener('click', () => this.canvas.undo());
        document.getElementById('clearBtn')?.addEventListener('click', () => {
          if (confirm('¬øLimpiar todo el dibujo?')) {
            this.canvas.clear();
            // Limpiar tambi√©n fondos y stickers GIF
            this.hideVisualGifBackground();
            document.getElementById('gifStickersContainer').innerHTML = '';
            this.gifStickers = [];
            this.currentBackgroundImage = null;
            this.isBackgroundGif = false;
            // Resetear cambios sin guardar
            window.hasUnsavedChanges = false;
          }
        });
        
        // Bot√≥n de guardar
        document.getElementById('saveBtn')?.addEventListener('click', async () => {
          await this.saveDrawing();
        });
        
        // Herramientas extras
        const tools = ['spray', 'select', 'line', 'eyedropper'];
        tools.forEach(tool => {
          const btn = document.getElementById(tool + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => {
              this.canvas.setTool(tool);
              this.currentTool = tool;
              this.updateToolButtons(tool + 'Btn');
            });
          }
        });
        
        // Efectos
        const effects = ['gradient', 'pattern', 'symmetry', 'neon', 'watercolor'];
        effects.forEach(effect => {
          const btn = document.getElementById(effect + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.setEffect(effect));
          }
        });
        
        // Filtros
        const filters = ['blur', 'pixel', 'vintage', 'oleo', 'carbon'];
        filters.forEach(filter => {
          const btn = document.getElementById(filter + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.applyFilter(filter));
          }
        });
        
        // Herramientas avanzadas
        const advancedTools = ['ruler', 'perspective', 'clone', 'histogram'];
        advancedTools.forEach(tool => {
          const btn = document.getElementById(tool + 'Btn');
          if (btn) {
            btn.addEventListener('click', () => this.canvas.setAdvancedTool(tool));
          }
        });
        
        // Canvas size controls
        document.getElementById('smallCanvas')?.addEventListener('click', () => this.resizeCanvas(400, 300));
        document.getElementById('mediumCanvas')?.addEventListener('click', () => this.resizeCanvas(600, 400));
        document.getElementById('largeCanvas')?.addEventListener('click', () => this.resizeCanvas(800, 600));
        document.getElementById('wideCanvas')?.addEventListener('click', () => this.resizeCanvas(800, 400));
        document.getElementById('customCanvasBtn')?.addEventListener('click', () => {
          const width = parseInt(document.getElementById('customWidth').value) || 600;
          const height = parseInt(document.getElementById('customHeight').value) || 400;
          this.resizeCanvas(width, height);
        });
        
        // Brush type
        document.getElementById('brushType')?.addEventListener('change', (e) => {
          this.canvas.setBrushType(e.target.value);
        });
        
        // Zoom
        document.getElementById('zoomInBtn')?.addEventListener('click', () => {
          this.canvas.zoomIn();
          this.updateZoomInfo();
        });
        document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
          this.canvas.zoomOut();
          this.updateZoomInfo();
        });
        
        // Import/Export
        document.getElementById('importBtn')?.addEventListener('change', (e) => this.handleImport(e));
        
        // Fondos y stickers
        document.getElementById('bgUpload')?.addEventListener('change', (e) => this.handleBackgroundUpload(e));
        document.getElementById('setBgBtn')?.addEventListener('click', () => this.setBackground());
        document.getElementById('stickerUpload')?.addEventListener('change', (e) => this.handleStickerUpload(e));
        document.getElementById('placeStickerBtn')?.addEventListener('click', () => this.placeSticker());
        
        // Bot√≥n para limpiar fondo
        const clearBgBtn = document.createElement('button');
        clearBgBtn.className = 'btn btn-outline-warning btn-sm w-100 mt-1';
        clearBgBtn.innerHTML = '‚ùå Quitar Fondo';
        clearBgBtn.addEventListener('click', () => this.clearBackground());
        document.getElementById('setBgBtn').parentNode.appendChild(clearBgBtn);
        

        
        // Controles de GIF
        document.getElementById('captureFrameBtn')?.addEventListener('click', () => {
          this.canvas.captureFrame();
          this.updateFrameCounter();
        });
        document.getElementById('clearFramesBtn')?.addEventListener('click', () => {
          if (confirm('¬øEliminar todos los frames capturados?')) {
            this.canvas.clearFrames();
            this.updateFrameCounter();
          }
        });
        
        // Filtros y acciones
        document.getElementById('clearFiltersBtn')?.addEventListener('click', () => this.canvas.clearFilters());
        document.getElementById('redoBtn')?.addEventListener('click', () => this.canvas.redo());
        document.getElementById('exportBtn')?.addEventListener('click', () => this.canvas.exportImage());
        
        // Sugerencias y datos
        document.getElementById('submitSuggestion')?.addEventListener('click', () => this.submitSuggestion());
        document.getElementById('reloadData')?.addEventListener('click', () => this.gallery.loadGallery());
        
        // Inicializar lista de capas y contador de frames
        this.canvas.updateLayersList();
        this.updateFrameCounter();
        
        // Inicializar variables para GIFs
        this.currentBackgroundImage = null;
        this.isBackgroundGif = false;
        this.currentStickerImage = null;
        this.isStickerGif = false;
        this.gifStickers = [];
        this.selectedSticker = null;
        this.isDragging = false;
        this.currentTool = 'brush';
        
        // Configurar canvas para GIFs
        this.setupGifCanvas();
        
        // Configurar eventos para mover stickers
        this.setupStickerMoveEvents();
        
        // Configurar mejoras m√≥viles
        this.setupMobileEnhancements();
        
        // Iniciar verificaci√≥n peri√≥dica de reportes
        this.startReportCounterUpdates();
      }
      
      setupGifCanvas() {
        // Ajustar contenedores GIF al cambiar tama√±o de canvas
        const observer = new ResizeObserver(() => {
          const canvas = this.canvas.canvas;
          const gifBackground = document.getElementById('gifBackground');
          const gifStickersContainer = document.getElementById('gifStickersContainer');
          
          if (gifBackground && canvas) {
            gifBackground.style.width = canvas.width + 'px';
            gifBackground.style.height = canvas.height + 'px';
          }
          
          if (gifStickersContainer && canvas) {
            gifStickersContainer.style.width = canvas.width + 'px';
            gifStickersContainer.style.height = canvas.height + 'px';
          }
        });
        
        if (this.canvas.canvas) {
          observer.observe(this.canvas.canvas);
        }
      }
      
      resizeCanvas(width, height) {
        if (!this.canvas.isEmpty() && !confirm('¬øCambiar tama√±o del canvas? Se perder√° el dibujo actual.')) return;
        
        this.canvas.canvas.width = width;
        this.canvas.canvas.height = height;
        this.canvas.ctx.lineCap = 'round';
        this.canvas.ctx.lineJoin = 'round';
        
        const canvasInfo = document.getElementById('canvasInfo');
        if (canvasInfo) {
          canvasInfo.textContent = `${width}√ó${height}`;
        }
        
        // Actualizar contenedores GIF
        const gifBackground = document.getElementById('gifBackground');
        const gifStickersContainer = document.getElementById('gifStickersContainer');
        
        if (gifBackground) {
          gifBackground.style.width = width + 'px';
          gifBackground.style.height = height + 'px';
        }
        
        if (gifStickersContainer) {
          gifStickersContainer.style.width = width + 'px';
          gifStickersContainer.style.height = height + 'px';
        }
        
        this.canvas.saveState();
      }
      
      updateZoomInfo() {
        const zoomInfo = document.getElementById('zoomInfo');
        if (zoomInfo && this.canvas.zoomLevel) {
          zoomInfo.textContent = Math.round(this.canvas.zoomLevel * 100) + '%';
        }
      }
      
      updateFrameCounter() {
        const counter = document.getElementById('frameCounter');
        if (counter) {
          const count = this.canvas.getFrameCount();
          counter.textContent = `${count} frame${count !== 1 ? 's' : ''}`;
          counter.style.color = count > 1 ? 'var(--primary)' : 'var(--text-secondary)';
        }
      }
      

      
      handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          this.ui.showNotification('üö´ Formato no soportado.', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
            this.canvas.ctx.drawImage(img, 0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
            this.canvas.saveState();
            this.ui.showNotification('‚úÖ Imagen importada', 'success');
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      async saveDrawing() {
        const saveBtn = document.getElementById('saveBtn');
        const saveText = document.getElementById('saveText');
        const saveLoader = document.getElementById('saveLoader');
        
        if (this.canvas.isEmpty()) {
          this.ui.showNotification('¬°Dibuja algo primero!', 'error');
          return;
        }
        
        saveBtn.disabled = true;
        saveText.style.display = 'none';
        saveLoader.style.display = 'inline';
        
        try {
          // Mostrar mensaje si es GIF animado
          const frameCount = this.canvas.getFrameCount();
          if (frameCount > 1) {
            this.ui.showNotification('üé¨ Creando GIF animado...', 'info');
          }
          
          let imageData = await this.canvas.getImageData();
          const author = document.getElementById('authorName').value || 'An√≥nimo';
          const category = document.getElementById('categorySelect').value;
          
          // Auto-moderaci√≥n
          const tempDrawingData = { autor: author, imagenData: imageData };
          const recentDrawings = this.gallery.allDrawings || [];
          const moderationResult = await this.autoModeration.analyzeDrawing(tempDrawingData, recentDrawings);
          
          if (moderationResult.action === 'block') {
            this.ui.showNotification('üö´ ' + moderationResult.issues.join(', '), 'error');
            return;
          }
          
          if (moderationResult.action === 'flag') {
            this.ui.showNotification('‚ö†Ô∏è Contenido marcado para revisi√≥n', 'warning');
          }
          
          // Comprimir imagen si es muy grande
          const imageSize = imageData.length;
          if (imageSize > 800000) { // ~800KB
            console.log('üóÇÔ∏è Comprimiendo imagen:', imageSize, 'bytes');
            imageData = await this.compressImage(imageData, 600);
            console.log('‚úÖ Imagen comprimida:', imageData.length, 'bytes');
            this.ui.showNotification('üóÇÔ∏è Imagen comprimida para Firebase', 'info');
          }
          
          // Obtener datos del perfil si est√° logueado
          let profilePicture = null;
          let profileAvatar = null;
          
          if (this.profiles && this.profiles.isLoggedIn()) {
            const profile = this.profiles.currentProfile;
            if (profile.avatarType === 'image' && profile.avatarImage) {
              profilePicture = profile.avatarImage;
            } else if (profile.avatarType === 'emoji' && profile.avatar) {
              profileAvatar = profile.avatar;
            }
          }
          
          const drawingData = {
            titulo: `Dibujo de ${author}`,
            imagenData: imageData,
            timestamp: Date.now(),
            autor: author,
            categoria: category,
            domain: 'thisisfenix.github.io',
            likes: 0,
            comments: [],
            layers: this.canvas.getLayers(),
            filters: this.canvas.getAppliedFilters(),
            isAnimated: frameCount > 1,
            strokes: this.canvas.getStrokeCount ? this.canvas.getStrokeCount() : 0,
            profilePicture: profilePicture,
            profileAvatar: profileAvatar,
            isLoggedUser: this.profiles ? this.profiles.isLoggedIn() : false,
            userProfile: this.profiles && this.profiles.isLoggedIn() ? {
              username: this.profiles.currentProfile.username,
              joinDate: this.profiles.currentProfile.joinDate,
              totalDrawings: this.profiles.currentProfile.totalDrawings
            } : null
          };
          
          // Si es GIF animado, guardar en backgroundGif
          if (frameCount > 1) {
            drawingData.backgroundGif = imageData;
          }
          
          // Guardar fondo GIF si existe
          if (this.isBackgroundGif && this.currentBackgroundImage) {
            const bgSize = this.currentBackgroundImage.src.length;
            if (bgSize > 800000) {
              console.warn('‚ö†Ô∏è Fondo GIF muy grande:', bgSize, 'bytes');
              this.ui.showNotification('‚ö†Ô∏è Fondo GIF muy grande, se comprimir√°', 'warning');
              drawingData.backgroundGif = await this.compressGifForFirebase(this.currentBackgroundImage.src);
            } else {
              drawingData.backgroundGif = this.currentBackgroundImage.src;
            }
          }
          
          // Guardar stickers GIF animados (solo datos primitivos)
          if (this.gifStickers && this.gifStickers.length > 0) {
            drawingData.gifStickers = this.gifStickers.map(s => {
              // Verificar tama√±o del src
              const srcSize = s.src ? s.src.length : 0;
              if (srcSize > 800000) { // ~800KB
                console.warn('‚ö†Ô∏è Sticker GIF muy grande, se omitir√°:', srcSize, 'bytes');
                return null;
              }
              
              return {
                src: String(s.src || ''),
                x: Number(s.x) || 0,
                y: Number(s.y) || 0,
                width: Number(s.width) || 60,
                height: Number(s.height) || 60
              };
            }).filter(s => s !== null); // Filtrar stickers nulos
          }
          
          await this.firebase.saveDrawing(drawingData);
          
          this.canvas.clear();
          
          // Solo limpiar el nombre si no est√° logueado
          if (!this.profiles || !this.profiles.isLoggedIn()) {
            document.getElementById('authorName').value = '';
          }
          
          document.getElementById('categorySelect').value = 'Arte';
          
          // Actualizar estad√≠sticas del perfil si est√° logueado
          if (this.profiles && this.profiles.isLoggedIn()) {
            this.profiles.currentProfile.totalDrawings = (this.profiles.currentProfile.totalDrawings || 0) + 1;
            this.profiles.saveProfile();
          }
          
          // Limpiar fondos y stickers GIF
          this.hideVisualGifBackground();
          document.getElementById('gifStickersContainer').innerHTML = '';
          this.gifStickers = [];
          this.currentBackgroundImage = null;
          this.isBackgroundGif = false;
          this.currentStickerImage = null;
          this.isStickerGif = false;
          
          // Resetear botones
          document.getElementById('setBgBtn').disabled = true;
          document.getElementById('setBgBtn').innerHTML = 'üñºÔ∏è Aplicar Fondo';
          document.getElementById('placeStickerBtn').disabled = true;
          document.getElementById('placeStickerBtn').innerHTML = 'üìå Sticker';
          document.getElementById('bgUpload').value = '';
          document.getElementById('stickerUpload').value = '';
          
          // Marcar como guardado
          window.hasUnsavedChanges = false;
          
          this.ui.showNotification('‚úÖ ¬°Dibujo guardado!', 'success');
          this.ui.createConfetti();
          
          // Actualizar galer√≠a
          setTimeout(() => {
            this.gallery.loadGallery();
            document.getElementById('gallery').scrollIntoView({ behavior: 'smooth' });
          }, 1000);
          
        } catch (error) {
          console.error('Error:', error);
          
          // Mensajes de error m√°s espec√≠ficos
          let errorMessage = '‚ùå Error al guardar';
          if (error.message && error.message.includes('invalid nested entity')) {
            errorMessage = '‚ùå Error: Datos demasiado complejos para Firebase';
          } else if (error.message && error.message.includes('too large')) {
            errorMessage = '‚ùå Error: Archivo muy grande (m√°x 800KB)';
          } else if (error.code === 'permission-denied') {
            errorMessage = '‚ùå Error: Sin permisos para guardar';
          } else if (error.code === 'unavailable') {
            errorMessage = '‚ùå Error: Servicio no disponible';
          }
          
          this.ui.showNotification(errorMessage, 'error');
        } finally {
          saveBtn.disabled = false;
          saveText.style.display = 'inline';
          saveLoader.style.display = 'none';
        }
      }
      
      handleBackgroundUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Verificar tama√±o de archivo (m√°x 3MB para evitar problemas)
        if (file.size > 3 * 1024 * 1024) {
          this.ui.showNotification('üö´ Archivo muy grande. M√°ximo 3MB permitido.', 'error');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.currentBackgroundImage = img;
            this.isBackgroundGif = file.type === 'image/gif';
            
            const btn = document.getElementById('setBgBtn');
            btn.disabled = false;
            
            if (this.isBackgroundGif) {
              btn.innerHTML = 'üé¨ GIF Listo';
              btn.style.background = '#28a745';
              btn.style.color = 'white';
            } else {
              btn.innerHTML = 'üñºÔ∏è Listo';
              btn.style.background = '';
              btn.style.color = '';
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      setBackground() {
        if (!this.currentBackgroundImage) return;
        
        // Si es GIF, usar fondo visual animado
        if (this.isBackgroundGif) {
          this.setVisualGifBackground(this.currentBackgroundImage.src);
        } else {
          // Para im√°genes est√°ticas, dibujar en canvas
          this.hideVisualGifBackground();
          
          // Guardar el dibujo actual
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = this.canvas.canvas.width;
          tempCanvas.height = this.canvas.canvas.height;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(this.canvas.canvas, 0, 0);
          
          // Limpiar canvas
          this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
          
          // Dibujar imagen de fondo adaptada al canvas
          this.canvas.ctx.drawImage(this.currentBackgroundImage, 0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
          
          // Restaurar el dibujo encima del fondo
          this.canvas.ctx.drawImage(tempCanvas, 0, 0);
        }
        
        this.canvas.saveState();
        
        const btn = document.getElementById('setBgBtn');
        if (this.isBackgroundGif) {
          btn.innerHTML = 'üé¨ GIF Aplicado';
          btn.style.background = '#28a745';
          btn.style.color = 'white';
        } else {
          btn.innerHTML = '‚úÖ Aplicado';
        }
        
        setTimeout(() => {
          btn.innerHTML = 'üñºÔ∏è Aplicar Fondo';
          btn.style.background = '';
          btn.style.color = '';
        }, 3000);
      }
      
      setVisualGifBackground(gifSrc) {
        const gifBackground = document.getElementById('gifBackground');
        const gifImg = document.getElementById('gifBackgroundImg');
        
        gifImg.src = gifSrc;
        gifBackground.style.display = 'block';
        
        // Ajustar el contenedor GIF al tama√±o actual del canvas
        gifBackground.style.width = this.canvas.canvas.width + 'px';
        gifBackground.style.height = this.canvas.canvas.height + 'px';
        
        // Hacer el canvas semi-transparente para que se vea el GIF
        this.canvas.canvas.style.background = 'rgba(255, 255, 255, 0.1)';
      }
      
      hideVisualGifBackground() {
        const gifBackground = document.getElementById('gifBackground');
        gifBackground.style.display = 'none';
        this.canvas.canvas.style.background = 'white';
      }
      
      clearBackground() {
        if (!confirm('¬øQuitar el fondo de imagen?')) return;
        
        // Guardar el dibujo actual
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = this.canvas.canvas.width;
        tempCanvas.height = this.canvas.canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(this.canvas.canvas, 0, 0);
        
        // Limpiar canvas completamente
        this.canvas.ctx.clearRect(0, 0, this.canvas.canvas.width, this.canvas.canvas.height);
        
        // Solo restaurar el dibujo (sin fondo)
        this.canvas.ctx.globalCompositeOperation = 'source-over';
        this.canvas.ctx.drawImage(tempCanvas, 0, 0);
        
        // Limpiar variables de fondo
        this.currentBackgroundImage = null;
        this.isBackgroundGif = false;
        this.hideVisualGifBackground();
        
        this.canvas.saveState();
        this.ui.showNotification('‚úÖ Fondo eliminado', 'success');
      }
      
      handleStickerUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Verificar tama√±o de archivo (m√°x 2MB para stickers)
        if (file.size > 2 * 1024 * 1024) {
          this.ui.showNotification('üö´ Sticker muy grande. M√°ximo 2MB permitido.', 'error');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            this.currentStickerImage = img;
            this.isStickerGif = file.type === 'image/gif';
            
            const btn = document.getElementById('placeStickerBtn');
            btn.disabled = false;
            
            // Mostrar preview si es GIF
            if (this.isStickerGif) {
              btn.innerHTML = 'üìå GIF Listo';
              btn.style.background = '#28a745';
              btn.style.color = 'white';
            } else {
              btn.innerHTML = 'üìå Listo';
              btn.style.background = '';
              btn.style.color = '';
            }
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
      
      placeSticker() {
        if (!this.currentStickerImage) return;
        
        this.canvas.canvas.style.cursor = 'copy';
        this.ui.showNotification('üìå Haz clic donde quieras colocar el sticker', 'info');
        
        const placeHandler = (e) => {
          const rect = this.canvas.canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) * (this.canvas.canvas.width / rect.width) - 30;
          const y = (e.clientY - rect.top) * (this.canvas.canvas.height / rect.height) - 30;
          
          if (this.isStickerGif) {
            // Para GIFs, crear elemento HTML animado
            this.createGifStickerElement({
              id: Date.now(),
              image: this.currentStickerImage,
              x: x,
              y: y,
              width: 60,
              height: 60,
              isGif: true
            });
          } else {
            // Para im√°genes est√°ticas, dibujar en canvas
            this.canvas.ctx.drawImage(this.currentStickerImage, x, y, 60, 60);
          }
          
          this.canvas.canvas.style.cursor = 'crosshair';
          this.canvas.canvas.removeEventListener('click', placeHandler);
          this.canvas.saveState();
        };
        
        this.canvas.canvas.addEventListener('click', placeHandler, { once: true });
      }
      
      createGifStickerElement(sticker) {
        const container = document.getElementById('gifStickersContainer');
        const gifElement = document.createElement('img');
        
        gifElement.src = sticker.image.src;
        gifElement.style.cssText = `
          position: absolute;
          left: ${sticker.x}px;
          top: ${sticker.y}px;
          width: ${sticker.width}px;
          height: ${sticker.height}px;
          pointer-events: auto;
          cursor: grab;
          z-index: 10;
          image-rendering: auto;
        `;
        
        gifElement.dataset.stickerId = sticker.id;
        
        container.appendChild(gifElement);
        
        // Agregar a la lista de stickers para guardar (sin elemento DOM)
        if (!this.gifStickers) this.gifStickers = [];
        const stickerData = {
          src: sticker.image.src,
          x: sticker.x,
          y: sticker.y,
          width: sticker.width,
          height: sticker.height
        };
        
        // Verificar tama√±o antes de agregar
        const srcSize = stickerData.src ? stickerData.src.length : 0;
        if (srcSize > 800000) {
          this.ui.showNotification('‚ö†Ô∏è Sticker GIF muy grande (>800KB), se guardar√° localmente pero no en Firebase', 'warning');
        }
        
        // Agregar referencia al elemento para mover
        stickerData.element = gifElement;
        this.gifStickers.push(stickerData);
      }
      
      setStickerMoveTool() {
        this.currentTool = 'stickerMove';
        this.canvas.canvas.style.cursor = 'grab';
        this.updateToolButtons('stickerMoveBtn');
        this.ui.showNotification('‚úã Herramienta de mover stickers activada', 'info');
      }
      
      updateToolButtons(activeButtonId) {
        // Remover clase activa de todos los botones
        document.querySelectorAll('.btn-neon').forEach(btn => btn.classList.remove('btn-primary'));
        // Agregar clase activa al bot√≥n seleccionado
        const activeBtn = document.getElementById(activeButtonId);
        if (activeBtn) {
          activeBtn.classList.add('btn-primary');
        }
      }
      
      setupStickerMoveEvents() {
        const canvas = this.canvas.canvas;
        
        // Funci√≥n para limpiar el estado de arrastre
        const cleanupDrag = () => {
          if (this.isDragging) {
            this.isDragging = false;
            this.selectedSticker = null;
            canvas.style.cursor = this.currentTool === 'stickerMove' ? 'grab' : 'crosshair';
            this.canvas.saveState();
          }
        };
        
        canvas.addEventListener('mousedown', (e) => {
          if (this.currentTool === 'stickerMove') {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            this.selectedSticker = this.findStickerAt(x, y);
            if (this.selectedSticker) {
              this.isDragging = true;
              canvas.style.cursor = 'grabbing';
              e.preventDefault();
              e.stopPropagation();
            }
          }
        });
        
        canvas.addEventListener('mousemove', (e) => {
          if (this.currentTool === 'stickerMove' && this.isDragging && this.selectedSticker) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            // Centrar el sticker en el punto de toque
            const centerOffsetX = this.selectedSticker.width / 2;
            const centerOffsetY = this.selectedSticker.height / 2;
            this.selectedSticker.x = x - centerOffsetX;
            this.selectedSticker.y = y - centerOffsetY;
            
            // Mantener dentro del canvas
            this.selectedSticker.x = Math.max(0, Math.min(canvas.width - this.selectedSticker.width, this.selectedSticker.x));
            this.selectedSticker.y = Math.max(0, Math.min(canvas.height - this.selectedSticker.height, this.selectedSticker.y));
            
            // Actualizar posici√≥n del elemento
            if (this.selectedSticker.element) {
              this.selectedSticker.element.style.left = this.selectedSticker.x + 'px';
              this.selectedSticker.element.style.top = this.selectedSticker.y + 'px';
            }
            
            e.preventDefault();
            e.stopPropagation();
          }
        });
        
        // Eventos de mouseup en canvas y document para asegurar que se libere
        canvas.addEventListener('mouseup', cleanupDrag);
        document.addEventListener('mouseup', cleanupDrag);
        
        // Limpiar cuando el mouse sale del canvas
        canvas.addEventListener('mouseleave', cleanupDrag);
        
        // Limpiar cuando se cambia de herramienta
        const originalSetTool = this.canvas.setTool;
        this.canvas.setTool = (tool) => {
          cleanupDrag();
          originalSetTool.call(this.canvas, tool);
        };
        
        // Touch events para m√≥vil con mejor manejo
        canvas.addEventListener('touchstart', (e) => {
          if (this.currentTool === 'stickerMove') {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
            
            this.selectedSticker = this.findStickerAt(x, y);
            if (this.selectedSticker) {
              this.isDragging = true;
              canvas.style.cursor = 'grabbing';
            }
          }
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
          if (this.currentTool === 'stickerMove' && this.isDragging && this.selectedSticker) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
            
            // Centrar el sticker en el punto de toque
            const centerOffsetX = this.selectedSticker.width / 2;
            const centerOffsetY = this.selectedSticker.height / 2;
            this.selectedSticker.x = x - centerOffsetX;
            this.selectedSticker.y = y - centerOffsetY;
            
            // Mantener dentro del canvas
            this.selectedSticker.x = Math.max(0, Math.min(canvas.width - this.selectedSticker.width, this.selectedSticker.x));
            this.selectedSticker.y = Math.max(0, Math.min(canvas.height - this.selectedSticker.height, this.selectedSticker.y));
            
            // Actualizar posici√≥n del elemento
            if (this.selectedSticker.element) {
              this.selectedSticker.element.style.left = this.selectedSticker.x + 'px';
              this.selectedSticker.element.style.top = this.selectedSticker.y + 'px';
            }
          }
        }, { passive: false });
        
        canvas.addEventListener('touchend', cleanupDrag, { passive: false });
        canvas.addEventListener('touchcancel', cleanupDrag, { passive: false });
        
        // Limpiar cuando se pierde el foco de la ventana
        window.addEventListener('blur', cleanupDrag);
        
        // Limpiar cuando se presiona Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.isDragging) {
            cleanupDrag();
            this.ui.showNotification('‚ùå Movimiento de sticker cancelado', 'info');
          }
        });
      }
      
      findStickerAt(x, y) {
        if (!this.gifStickers) return null;
        
        // Buscar desde el √∫ltimo (m√°s arriba) hacia el primero
        for (let i = this.gifStickers.length - 1; i >= 0; i--) {
          const sticker = this.gifStickers[i];
          if (!sticker) continue;
          
          const margin = 10; // Margen para facilitar la selecci√≥n
          
          if (x >= sticker.x - margin && x <= sticker.x + sticker.width + margin &&
              y >= sticker.y - margin && y <= sticker.y + sticker.height + margin) {
            return sticker;
          }
        }
        return null;
      }
      
      async submitSuggestion() {
        const text = document.getElementById('suggestionText').value.trim();
        const type = document.getElementById('suggestionType').value;
        const imageFile = document.getElementById('suggestionImage').files[0];
        
        if (!text) {
          this.ui.showNotification('‚úèÔ∏è Escribe tu sugerencia primero', 'error');
          return;
        }
        
        try {
          let imageData = null;
          
          if (imageFile) {
            if (imageFile.size > 2 * 1024 * 1024) {
              this.ui.showNotification('üö´ Imagen muy grande. M√°ximo 2MB.', 'error');
              return;
            }
            
            imageData = await this.processImageForSuggestion(imageFile);
          }
          
          const suggestionData = {
            texto: text,
            tipo: type,
            timestamp: Date.now(),
            autor: document.getElementById('authorName').value.trim() || 'An√≥nimo',
            domain: 'thisisfenix.github.io',
            status: 'pendiente'
          };
          
          if (imageData) {
            suggestionData.imagen = imageData;
          }
          
          await this.firebase.saveSuggestion(suggestionData);
          
          document.getElementById('suggestionText').value = '';
          document.getElementById('suggestionImage').value = '';
          this.ui.showNotification('‚úÖ Sugerencia enviada', 'success');
          this.loadRecentSuggestions();
          
        } catch (error) {
          console.error('Error:', error);
          this.ui.showNotification('‚ùå Error al enviar sugerencia', 'error');
        }
      }
      
      processImageForSuggestion(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              // Redimensionar si es muy grande
              const maxSize = 300;
              let { width, height } = img;
              
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height * maxSize) / width;
                  width = maxSize;
                } else {
                  width = (width * maxSize) / height;
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              
              resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }
      
      async loadRecentSuggestions() {
        try {
          const suggestions = await this.firebase.getRecentSuggestions();
          const container = document.getElementById('recentSuggestions');
          
          if (!container) return;
          
          if (!suggestions || suggestions.length === 0) {
            container.innerHTML = '<div class="text-muted">No hay sugerencias a√∫n</div>';
            return;
          }
          
          container.innerHTML = suggestions.map(s => `
            <div class="mb-2 p-2" style="background: rgba(255,255,255,0.1); border-radius: 6px; border-left: 3px solid var(--primary);">
              <div class="d-flex justify-content-between mb-1">
                <span class="text-warning small">${this.getSuggestionIcon(s.tipo)} <strong>${s.autor || 'An√≥nimo'}</strong></span>
                <small class="text-muted">${this.formatDate(s.timestamp)}</small>
              </div>
              <div class="text-light small">${s.texto || 'Sin texto'}</div>
              ${s.imagen ? `<div class="mt-2"><img src="${s.imagen}" style="max-width: 100%; max-height: 100px; border-radius: 4px; cursor: pointer;" onclick="this.style.maxHeight=this.style.maxHeight=='100px'?'300px':'100px'"></div>` : ''}
              <div class="mt-1">
                <span class="badge bg-secondary" style="font-size: 0.6em;">${this.getSuggestionTypeText(s.tipo)}</span>
                ${this.getSuggestionStatusBadge(s.status)}
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          console.error('Error loading suggestions:', error);
          const container = document.getElementById('recentSuggestions');
          if (container) {
            container.innerHTML = '<div class="text-danger small">Error cargando sugerencias</div>';
          }
        }
      }
      
      getSuggestionStatusBadge(status) {
        const badges = {
          'pendiente': '<span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">‚è≥ Pendiente</span>',
          'proceso': '<span class="badge bg-info ms-1" style="font-size: 0.6em;">üîÑ En Proceso</span>',
          'aprobado': '<span class="badge bg-success ms-1" style="font-size: 0.6em;">‚úÖ Aprobado</span>',
          'rechazado': '<span class="badge bg-danger ms-1" style="font-size: 0.6em;">‚ùå Rechazado</span>'
        };
        return badges[status] || badges['pendiente'];
      }
      
      async loadAdminSuggestions() {
        try {
          const suggestions = await this.firebase.getAllSuggestions();
          const container = document.getElementById('adminSuggestions');
          
          if (!container) return;
          
          if (!suggestions || suggestions.length === 0) {
            container.innerHTML = '<div class="text-muted text-center">No hay sugerencias</div>';
            return;
          }
          
          container.innerHTML = suggestions.map(s => `
            <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
              <div class="card-body p-3">
                <div class="d-flex justify-content-between mb-2">
                  <div>
                    <strong style="color: var(--primary);">${this.getSuggestionIcon(s.tipo)} ${s.autor || 'An√≥nimo'}</strong>
                    <span class="badge bg-secondary ms-2" style="font-size: 0.7em;">${this.getSuggestionTypeText(s.tipo)}</span>
                    ${this.getSuggestionStatusBadge(s.status)}
                  </div>
                  <small class="text-muted">${this.formatDate(s.timestamp)}</small>
                </div>
                <p class="text-light mb-2">${s.texto || 'Sin texto'}</p>
                ${s.imagen ? `<img src="${s.imagen}" class="img-fluid mb-2" style="max-height: 150px; border-radius: 4px;">` : ''}
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-warning" onclick="updateSuggestionStatus('${s.id}', 'pendiente')">‚è≥ Pendiente</button>
                  <button class="btn btn-info" onclick="updateSuggestionStatus('${s.id}', 'proceso')">üîÑ En Proceso</button>
                  <button class="btn btn-success" onclick="updateSuggestionStatus('${s.id}', 'aprobado')">‚úÖ Aprobar</button>
                  <button class="btn btn-danger" onclick="updateSuggestionStatus('${s.id}', 'rechazado')">‚ùå Rechazar</button>
                </div>
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          console.error('Error loading admin suggestions:', error);
          const container = document.getElementById('adminSuggestions');
          if (container) {
            container.innerHTML = '<div class="text-danger text-center">Error cargando sugerencias</div>';
          }
        }
      }
      
      async loadAdminDrawings() {
        try {
          const drawings = await this.firebase.getAllDrawings();
          const container = document.getElementById('adminDrawings');
          
          if (!container) return;
          
          if (!drawings || drawings.length === 0) {
            container.innerHTML = '<div class="text-muted text-center">No hay dibujos</div>';
            return;
          }
          
          container.innerHTML = drawings.slice(0, 20).map(d => `
            <div class="card mb-2" style="background: var(--bg-light); border: 1px solid var(--primary);">
              <div class="card-body p-2">
                <div class="d-flex align-items-center">
                  <img src="${d.data.backgroundGif || d.data.imagenData}" style="width: 60px; height: 60px; object-fit: contain; background: white; border-radius: 4px; margin-right: 10px;">
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between">
                      <strong style="color: var(--primary); font-size: 0.9em;">${d.data.autor}</strong>
                      <small class="text-muted">${new Date(d.data.timestamp).toLocaleDateString()}</small>
                    </div>
                    <div class="text-light small">${d.data.categoria}</div>
                    <div class="text-muted small">‚ù§Ô∏è ${d.data.likes || 0} | üí¨ ${d.data.comments?.length || 0}</div>
                  </div>
                  <button class="btn btn-danger btn-sm" onclick="deleteDrawing('${d.id}', '${d.data.autor}')" title="Eliminar dibujo">
                    üóëÔ∏è
                  </button>
                </div>
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          console.error('Error loading admin drawings:', error);
          const container = document.getElementById('adminDrawings');
          if (container) {
            container.innerHTML = '<div class="text-danger text-center">Error cargando dibujos</div>';
          }
        }
      }
      
      async loadAdminReports() {
        try {
          const reports = await this.firebase.getAllReports();
          const container = document.getElementById('adminReports');
          
          if (!container) return;
          
          // Actualizar contador de reportes pendientes
          const pendingReports = reports ? reports.filter(r => r.status === 'pending').length : 0;
          this.updateReportCounters(pendingReports);
          
          if (!reports || reports.length === 0) {
            container.innerHTML = `
              <div class="text-center py-4">
                <div style="color: var(--text-secondary); font-size: 1.1em;">
                  <i class="fas fa-shield-alt" style="font-size: 2em; margin-bottom: 15px; opacity: 0.5;"></i>
                  <p>No hay reportes</p>
                  <small>Los reportes de usuarios aparecer√°n aqu√≠</small>
                </div>
              </div>
            `;
            return;
          }
          
          // Ordenar reportes: pendientes primero, luego por fecha
          const sortedReports = reports.sort((a, b) => {
            if (a.status === 'pending' && b.status !== 'pending') return -1;
            if (b.status === 'pending' && a.status !== 'pending') return 1;
            return b.timestamp - a.timestamp;
          });
          
          const getTypeIcon = (type) => {
            const icons = {
              'inappropriate_content': 'üö´',
              'spam': 'üìß',
              'harassment': 'üò†',
              'copyright': '¬©Ô∏è',
              'violence': '‚öîÔ∏è',
              'other': '‚ùì'
            };
            return icons[type] || '‚ö†Ô∏è';
          };
          
          const getTypeText = (type) => {
            const types = {
              'inappropriate_content': 'Contenido inapropiado',
              'spam': 'Spam',
              'harassment': 'Acoso o bullying',
              'copyright': 'Violaci√≥n de derechos de autor',
              'violence': 'Violencia o contenido perturbador',
              'other': 'Otro'
            };
            return types[type] || 'No especificado';
          };
          
          container.innerHTML = sortedReports.map(r => `
            <div class="card mb-3" style="background: var(--bg-light); border: 2px solid ${r.status === 'pending' ? '#ffc107' : r.status === 'resolved' ? '#28a745' : '#dc3545'}; ${r.status === 'pending' ? 'box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);' : ''}">
              <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <strong style="color: var(--primary); font-size: 1em;">${getTypeIcon(r.type)} Reporte contra: ${r.drawingAuthor}</strong>
                      <span class="badge ${r.status === 'pending' ? 'bg-warning text-dark' : r.status === 'resolved' ? 'bg-success' : 'bg-danger'}" style="font-size: 0.75em;">
                        ${r.status === 'pending' ? '‚è≥ Pendiente' : r.status === 'resolved' ? '‚úÖ Resuelto' : '‚ùå Rechazado'}
                      </span>
                    </div>
                    <div class="mb-2">
                      <span class="badge bg-secondary me-2" style="font-size: 0.7em;">${getTypeText(r.type)}</span>
                      <small class="text-muted">Reportado ${this.formatDate(r.timestamp)}</small>
                    </div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <p class="text-light mb-2" style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border-left: 3px solid var(--primary); font-size: 0.9em; line-height: 1.4;">
                    <strong>Raz√≥n:</strong> ${r.reason}
                  </p>
                </div>
                
                <div class="row mb-3">
                  <div class="col-md-6">
                    <small class="text-muted d-block"><strong>Reportado por:</strong> ${r.reportedBy}</small>
                    ${r.reviewedBy ? `<small class="text-muted d-block"><strong>Revisado por:</strong> ${r.reviewedBy}</small>` : ''}
                  </div>
                  <div class="col-md-6 text-md-end">
                    ${r.reviewedAt ? `<small class="text-muted d-block">Revisado: ${this.formatDate(r.reviewedAt)}</small>` : ''}
                    <small class="text-muted d-block">ID: ${r.id.substring(0, 8)}...</small>
                  </div>
                </div>
                
                <div class="d-flex gap-2 flex-wrap">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn ${r.status === 'pending' ? 'btn-warning' : 'btn-outline-warning'}" onclick="updateReportStatus('${r.id}', 'pending')" ${r.status === 'pending' ? 'disabled' : ''}>
                      ‚è≥ Pendiente
                    </button>
                    <button class="btn ${r.status === 'resolved' ? 'btn-success' : 'btn-outline-success'}" onclick="updateReportStatus('${r.id}', 'resolved')" ${r.status === 'resolved' ? 'disabled' : ''}>
                      ‚úÖ Resolver
                    </button>
                    <button class="btn ${r.status === 'rejected' ? 'btn-danger' : 'btn-outline-danger'}" onclick="updateReportStatus('${r.id}', 'rejected')" ${r.status === 'rejected' ? 'disabled' : ''}>
                      ‚ùå Rechazar
                    </button>
                  </div>
                  <button class="btn btn-info btn-sm" onclick="viewReportedDrawing('${r.drawingId}')" title="Ver el dibujo reportado">
                    üëÅÔ∏è Ver Dibujo
                  </button>
                  ${window.hasPermission && window.hasPermission('delete_drawings') ? `
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteDrawingFromReport('${r.drawingId}', '${r.drawingAuthor}', '${r.id}')" title="Eliminar dibujo reportado">
                      üóëÔ∏è Eliminar
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          `).join('');
          
        } catch (error) {
          console.error('Error loading admin reports:', error);
          const container = document.getElementById('adminReports');
          if (container) {
            container.innerHTML = '<div class="text-danger text-center py-4"><i class="fas fa-exclamation-triangle mb-2"></i><br>Error cargando reportes</div>';
          }
        }
      }
      
      updateReportCounters(pendingCount) {
        const adminCounter = document.getElementById('adminReportCount');
        const modCounter = document.getElementById('modReportCount');
        
        if (adminCounter) {
          if (pendingCount > 0) {
            adminCounter.textContent = pendingCount;
            adminCounter.style.display = 'inline';
            adminCounter.style.animation = 'pulse 2s infinite';
          } else {
            adminCounter.style.display = 'none';
          }
        }
        
        if (modCounter) {
          if (pendingCount > 0) {
            modCounter.textContent = pendingCount;
            modCounter.style.display = 'inline';
            modCounter.style.animation = 'pulse 2s infinite';
          } else {
            modCounter.style.display = 'none';
          }
        }
      }
      
      startReportCounterUpdates() {
        // Verificar reportes pendientes cada 60 segundos
        setInterval(async () => {
          try {
            const reports = await this.firebase.getAllReports();
            const pendingCount = reports ? reports.filter(r => r.status === 'pending').length : 0;
            this.updateReportCounters(pendingCount);
          } catch (error) {
            // Silenciar errores de verificaci√≥n peri√≥dica
          }
        }, 60000);
      }
      
      getSuggestionIcon(type) {
        const icons = {
          'feature': '‚ú®',
          'bug': 'üêõ',
          'improvement': 'üîß',
          'other': 'üí≠'
        };
        return icons[type] || 'üí≠';
      }
      
      getSuggestionTypeText(type) {
        const types = {
          'feature': 'Nueva Funci√≥n',
          'bug': 'Bug Report',
          'improvement': 'Mejora',
          'other': 'Otro'
        };
        return types[type] || 'Otro';
      }
      
      formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'hace un momento';
        if (diff < 3600000) return `hace ${Math.floor(diff/60000)}m`;
        if (diff < 86400000) return `hace ${Math.floor(diff/3600000)}h`;
        return `hace ${Math.floor(diff/86400000)}d`;
      }
      
      saveUserColor(color) {
        localStorage.setItem('guestbook-user-color', color);
      }
      
      loadUserColor() {
        const savedColor = localStorage.getItem('guestbook-user-color');
        if (savedColor) {
          // Buscar si el color est√° en los botones predefinidos
          const colorBtn = document.querySelector(`[data-color="${savedColor}"]`);
          if (colorBtn) {
            document.querySelector('.color-btn.active')?.classList.remove('active');
            colorBtn.classList.add('active');
          } else {
            // Si es un color personalizado, establecerlo en el input
            const customColorInput = document.getElementById('customColor');
            if (customColorInput) {
              customColorInput.value = savedColor;
            }
          }
          this.canvas.setColor(savedColor);
        }
        
        // El sistema de perfiles ahora se maneja en ProfileManager
      }
      
      loadUserProfile() {
        // Configurar bot√≥n "Usar perfil" para el nuevo sistema
        const useProfileBtn = document.getElementById('useProfileName');
        if (useProfileBtn) {
          useProfileBtn.addEventListener('click', () => {
            if (this.profiles && this.profiles.isLoggedIn()) {
              document.getElementById('authorName').value = this.profiles.currentProfile.username;
              this.ui.showNotification('‚úÖ Nombre de perfil aplicado', 'success');
            } else {
              this.ui.showNotification('‚ö†Ô∏è Inicia sesi√≥n primero', 'warning');
              if (this.profiles) {
                this.profiles.showProfileModal();
              }
            }
          });
        }
      }
      
      // La funci√≥n processProfilePicture ya no es necesaria - se maneja en ProfileManager
      
      // Funci√≥n para comprimir GIFs manteniendo animaci√≥n
      async compressGifForFirebase(gifDataUrl) {
        if (!gifDataUrl) return null;
        
        try {
          // Convertir dataURL a blob
          const response = await fetch(gifDataUrl);
          const blob = await response.blob();
          
          // Si el GIF es peque√±o, devolverlo sin comprimir
          if (blob.size < 800000) {
            return gifDataUrl;
          }
          
          // Para GIFs grandes, crear una versi√≥n comprimida simple
          return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              // Reducir tama√±o manteniendo proporci√≥n
              const maxSize = 400;
              let { width, height } = img;
              
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height * maxSize) / width;
                  width = maxSize;
                } else {
                  width = (width * maxSize) / height;
                  height = maxSize;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              ctx.drawImage(img, 0, 0, width, height);
              
              // Comprimir como JPEG para reducir tama√±o
              const compressed = canvas.toDataURL('image/jpeg', 0.6);
              console.log(`GIF comprimido: ${gifDataUrl.length} ‚Üí ${compressed.length} bytes`);
              resolve(compressed);
            };
            
            img.onerror = () => {
              console.log('Error comprimiendo GIF, usando original');
              resolve(gifDataUrl);
            };
            
            img.src = gifDataUrl;
          });
        } catch (error) {
          console.error('Error comprimiendo GIF:', error);
          return gifDataUrl;
        }
      }
      
      // Funci√≥n para comprimir im√°genes
      async compressImage(dataUrl, maxSizeKB = 600) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calcular nuevo tama√±o manteniendo proporci√≥n
            let { width, height } = img;
            const maxDimension = 800;
            
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = (height * maxDimension) / width;
                width = maxDimension;
              } else {
                width = (width * maxDimension) / height;
                height = maxDimension;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Dibujar imagen redimensionada
            ctx.drawImage(img, 0, 0, width, height);
            
            // Comprimir con calidad variable
            let quality = 0.8;
            let compressed = canvas.toDataURL('image/jpeg', quality);
            
            // Reducir calidad hasta alcanzar el tama√±o objetivo
            while (compressed.length > maxSizeKB * 1024 * 1.37 && quality > 0.3) {
              quality -= 0.1;
              compressed = canvas.toDataURL('image/jpeg', quality);
            }
            
            resolve(compressed);
          };
          img.src = dataUrl;
        });
      }
      
      setupMobileEnhancements() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // Mejorar touch events para canvas
          const canvas = this.canvas.canvas;
          if (canvas) {
            // Prevenir scroll cuando se dibuja
            canvas.addEventListener('touchstart', (e) => {
              if (this.currentTool !== 'stickerMove') {
                e.preventDefault();
              }
            }, { passive: false });
            
            canvas.addEventListener('touchmove', (e) => {
              if (this.currentTool !== 'stickerMove') {
                e.preventDefault();
              }
            }, { passive: false });
          }
          
          // Ajustar tama√±o de canvas para m√≥viles peque√±os
          if (window.innerWidth < 480) {
            this.resizeCanvas(400, 300);
          }
          
          // Configurar gestos de pellizco para zoom (futuro)
          this.setupPinchZoom();
        }
      }
      
      setupPinchZoom() {
        const canvas = this.canvas.canvas;
        if (!canvas) return;
        
        let initialDistance = 0;
        let initialScale = 1;
        
        canvas.addEventListener('touchstart', (e) => {
          if (e.touches.length === 2) {
            initialDistance = this.getDistance(e.touches[0], e.touches[1]);
            initialScale = this.canvas.zoomLevel || 1;
          }
        });
        
        canvas.addEventListener('touchmove', (e) => {
          if (e.touches.length === 2) {
            e.preventDefault();
            const currentDistance = this.getDistance(e.touches[0], e.touches[1]);
            const scale = (currentDistance / initialDistance) * initialScale;
            
            // Limitar zoom entre 0.5x y 3x
            const clampedScale = Math.max(0.5, Math.min(3, scale));
            
            if (this.canvas.setZoom) {
              this.canvas.setZoom(clampedScale);
              this.updateZoomInfo();
            }
          }
        }, { passive: false });
      }
      
      getDistance(touch1, touch2) {
        const dx = touch1.clientX - touch2.clientX;
        const dy = touch1.clientY - touch2.clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }
      
      setupUnsavedChangesDetection() {
        const canvas = this.canvas.canvas;
        if (!canvas) return;
        
        // Detectar cambios en el canvas
        const detectChange = () => {
          window.hasUnsavedChanges = true;
        };
        
        // Eventos de dibujo
        canvas.addEventListener('mousedown', detectChange);
        canvas.addEventListener('touchstart', detectChange);
        
        // Detectar cambios en herramientas que modifican el canvas
        const toolButtons = [
          'brushBtn', 'eraserBtn', 'bucketBtn', 'textBtn',
          'sprayBtn', 'lineBtn', 'clearBtn', 'undoBtn', 'redoBtn'
        ];
        
        toolButtons.forEach(btnId => {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.addEventListener('click', detectChange);
          }
        });
        
        // Detectar importaci√≥n de im√°genes
        document.getElementById('importBtn')?.addEventListener('change', detectChange);
        document.getElementById('setBgBtn')?.addEventListener('click', detectChange);
        document.getElementById('placeStickerBtn')?.addEventListener('click', detectChange);
      }
    }
    
    // Inicializar aplicaci√≥n con detecci√≥n de OperaGX
    const app = new GuestbookApp();
    
    // Inicializaci√≥n especial para OperaGX
    if (navigator.userAgent.includes('OPR') && navigator.userAgent.includes('GX')) {
      console.log('üéÆ Inicializando para OperaGX con configuraci√≥n especial...');
      
      // Delay adicional para OperaGX
      setTimeout(() => {
        app.init();
      }, 1000);
      
      // Verificar conectividad despu√©s de 5 segundos
      setTimeout(() => {
        if (!window.guestbookApp || !window.guestbookApp.firebase) {
          console.warn('‚ö†Ô∏è Firebase no se inicializ√≥ correctamente en OperaGX');
          if (window.guestbookApp && window.guestbookApp.ui) {
            window.guestbookApp.ui.showNotification(
              '‚ö†Ô∏è Problemas de conectividad detectados. Recarga la p√°gina o desactiva el bloqueador de anuncios.',
              'warning'
            );
          }
        }
      }, 5000);
    } else {
      app.init();
    }
    
    // Hacer disponible globalmente
    window.guestbookApp = app;
    
    // Prevenir errores de extensiones del navegador
    window.addEventListener('error', function(e) {
      const errorMessages = [
        'message channel closed',
        'Extension context invalidated',
        'The message port closed before a response was received',
        'A listener indicated an asynchronous response by returning true'
      ];
      
      if (e.message && errorMessages.some(msg => e.message.toLowerCase().includes(msg.toLowerCase()))) {
        e.preventDefault();
        e.stopPropagation();
        return true;
      }
    });
    
    window.addEventListener('unhandledrejection', function(e) {
      const errorMessages = [
        'message channel closed',
        'Extension context invalidated',
        'The message port closed before a response was received',
        'A listener indicated an asynchronous response by returning true'
      ];
      
      const errorText = e.reason?.message || e.reason?.toString() || '';
      if (errorText && errorMessages.some(msg => errorText.toLowerCase().includes(msg.toLowerCase()))) {
        e.preventDefault();
        e.stopPropagation();
        return true;
      }
    });
    
    // Variables globales para admin y moderadores
    let isAdminLoggedIn = false;
    window.currentUser = null;
    
    // Verificar permisos de usuario
    window.hasPermission = function(permission) {
      if (!window.currentUser) return false;
      if (window.currentUser.role === 'admin') return true;
      return window.currentUser.permissions?.includes(permission) || false;
    };
    
    // Actualizar UI seg√∫n permisos
    window.updateUIForUser = function() {
      const user = window.currentUser;
      if (!user) return;
      
      // Mostrar/ocultar elementos seg√∫n permisos
      const adminOnlyElements = document.querySelectorAll('.admin-only');
      adminOnlyElements.forEach(el => {
        el.style.display = user.role === 'admin' ? 'block' : 'none';
      });
      
      // Actualizar botones de acci√≥n
      if (window.galleryManager) {
        window.galleryManager.updateDeleteButtons();
      }
      
      // Mostrar nombre de usuario
      const userInfo = document.getElementById('userInfo');
      if (userInfo) {
        userInfo.textContent = user.role === 'admin' ? 'Admin' : `Moderador: ${user.name}`;
      }
    };
    
    // Funciones para gesti√≥n de tags
    window.loadTaggedUsers = async function() {
      try {
        if (!window.guestbookApp || !window.guestbookApp.profiles) {
          document.getElementById('taggedUsersList').innerHTML = '<div class="text-danger text-center">Sistema de perfiles no disponible</div>';
          return;
        }
        
        await window.guestbookApp.profiles.loadUsers();
        const allUsers = Array.from(window.guestbookApp.profiles.users.values());
        const taggedUsers = allUsers.filter(user => user.userTags && user.userTags.length > 0);
        
        const container = document.getElementById('taggedUsersList');
        if (!container) return;
        
        if (taggedUsers.length === 0) {
          container.innerHTML = '<div class="text-muted text-center">No hay usuarios con tags asignados</div>';
          return;
        }
        
        const getTagBadge = (tag) => {
          const badges = {
            'OWNER': '<span class="badge bg-danger">üëë OWNER</span>',
            'ADMIN': '<span class="badge bg-warning text-dark">üîê ADMIN</span>',
            'MOD': '<span class="badge bg-success">üõ°Ô∏è MOD</span>',
            'VIP': '<span class="badge bg-info">üíé VIP</span>'
          };
          return badges[tag] || `<span class="badge bg-secondary">${tag}</span>`;
        };
        
        container.innerHTML = taggedUsers.map(user => `
          <div class="card mb-2" style="background: var(--bg-light); border: 1px solid var(--primary);">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong style="color: var(--primary);">${user.username}</strong>
                  <div class="mb-1">
                    ${Array.isArray(user.userTags) ? user.userTags.map(tag => getTagBadge(tag)).join(' ') : ''}
                  </div>
                  <div class="small text-muted">
                    Miembro desde: ${new Date(user.joinDate).toLocaleDateString()}
                  </div>
                  <div class="small text-info">
                    Dibujos: ${user.totalDrawings || 0}
                  </div>
                </div>
                <div class="d-flex gap-1">
                  <button class="btn btn-outline-primary btn-sm" onclick="selectUserForTagManagement('${user.username}')" title="Gestionar tags">
                    ‚öôÔ∏è Editar
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading tagged users:', error);
        const container = document.getElementById('taggedUsersList');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center">Error cargando usuarios</div>';
        }
      }
    };
    
    window.searchUsersForTags = async function() {
      const searchTerm = document.getElementById('searchUserForTags').value.trim().toLowerCase();
      const resultsContainer = document.getElementById('userTagSearchResults');
      
      if (searchTerm.length < 2) {
        resultsContainer.innerHTML = '<div class="text-center text-muted small">Escribe al menos 2 caracteres</div>';
        return;
      }
      
      try {
        if (!window.guestbookApp || !window.guestbookApp.profiles) {
          resultsContainer.innerHTML = '<div class="text-danger small">Sistema no disponible</div>';
          return;
        }
        
        await window.guestbookApp.profiles.loadUsers();
        const allUsers = Array.from(window.guestbookApp.profiles.users.values());
        
        const matchingUsers = allUsers.filter(user => 
          user.username.toLowerCase().includes(searchTerm)
        ).slice(0, 5);
        
        if (matchingUsers.length === 0) {
          resultsContainer.innerHTML = '<div class="text-center text-muted small">No se encontraron usuarios</div>';
          return;
        }
        
        const getTagBadge = (tag) => {
          const badges = {
            'OWNER': '<span class="badge bg-danger" style="font-size: 0.6em;">üëë</span>',
            'ADMIN': '<span class="badge bg-warning text-dark" style="font-size: 0.6em;">üîê</span>',
            'MOD': '<span class="badge bg-success" style="font-size: 0.6em;">üõ°Ô∏è</span>',
            'VIP': '<span class="badge bg-info" style="font-size: 0.6em;">üíé</span>'
          };
          return badges[tag] || `<span class="badge bg-secondary" style="font-size: 0.6em;">${tag}</span>`;
        };
        
        resultsContainer.innerHTML = matchingUsers.map(user => `
          <div class="card mb-1" style="background: var(--bg-dark); border: 1px solid var(--text-secondary); cursor: pointer;" onclick="selectUserForTagManagement('${user.username}')">
            <div class="card-body p-2">
              <div class="d-flex align-items-center">
                <div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-size: 0.7em; color: white; margin-right: 8px;">
                  ${user.avatarImage ? `<img src="${user.avatarImage}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : (user.avatar || 'üë§')}
                </div>
                <div class="flex-grow-1">
                  <strong class="text-light" style="font-size: 0.85em;">${user.username}</strong>
                  <div class="text-muted" style="font-size: 0.7em;">Dibujos: ${user.totalDrawings || 0}</div>
                  ${user.userTags && Array.isArray(user.userTags) && user.userTags.length > 0 ? `<div class="mt-1">${user.userTags.map(tag => getTagBadge(tag)).join(' ')}</div>` : ''}
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error searching users:', error);
        resultsContainer.innerHTML = '<div class="text-danger small">Error en la b√∫squeda</div>';
      }
    };
    
    window.selectUserForTagManagement = async function(username) {
      document.getElementById('selectedUserForTags').value = username;
      document.getElementById('userTagSearchResults').innerHTML = `
        <div class="text-center text-success small">‚úÖ Usuario seleccionado: <strong>${username}</strong></div>
      `;
      
      // Habilitar botones y mostrar tags actuales
      const buttons = ['assignOwnerBtn', 'assignAdminBtn', 'assignModBtn', 'assignVipBtn', 'removeOwnerBtn', 'removeAdminBtn', 'removeModBtn', 'removeVipBtn'];
      buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) btn.disabled = false;
      });
      
      // Obtener tags actuales del usuario
      try {
        if (window.guestbookApp && window.guestbookApp.profiles) {
          await window.guestbookApp.profiles.loadUsers();
          const user = window.guestbookApp.profiles.users.get(username.toLowerCase());
          
          if (user && user.userTags) {
            // Actualizar estado de botones seg√∫n tags actuales
            const currentTags = user.userTags;
            
            // Deshabilitar botones de asignar si ya tiene el tag
            document.getElementById('assignOwnerBtn').disabled = currentTags.includes('OWNER');
            document.getElementById('assignAdminBtn').disabled = currentTags.includes('ADMIN');
            document.getElementById('assignModBtn').disabled = currentTags.includes('MOD');
            document.getElementById('assignVipBtn').disabled = currentTags.includes('VIP');
            
            // Deshabilitar botones de quitar si no tiene el tag
            document.getElementById('removeOwnerBtn').disabled = !currentTags.includes('OWNER');
            document.getElementById('removeAdminBtn').disabled = !currentTags.includes('ADMIN');
            document.getElementById('removeModBtn').disabled = !currentTags.includes('MOD');
            document.getElementById('removeVipBtn').disabled = !currentTags.includes('VIP');
          }
        }
      } catch (error) {
        console.error('Error loading user tags:', error);
      }
    };
    
    window.assignTag = async function(tag) {
      const username = document.getElementById('selectedUserForTags').value;
      if (!username) return;
      
      const tagNames = {
        'OWNER': 'Owner',
        'ADMIN': 'Administrador', 
        'MOD': 'Moderador',
        'VIP': 'VIP'
      };
      
      if (!confirm(`¬øAsignar tag ${tagNames[tag]} a ${username}?`)) return;
      
      try {
        if (!window.guestbookApp || !window.guestbookApp.profiles) {
          app.ui.showNotification('‚ùå Sistema de perfiles no disponible', 'error');
          return;
        }
        
        await window.guestbookApp.profiles.loadUsers();
        const user = window.guestbookApp.profiles.users.get(username.toLowerCase());
        
        if (!user) {
          app.ui.showNotification('‚ùå Usuario no encontrado', 'error');
          return;
        }
        
        // Agregar tag
        const currentTags = Array.isArray(user.userTags) ? user.userTags : [];
        if (!currentTags.includes(tag)) {
          currentTags.push(tag);
          
          // Actualizar en Firebase
          await window.guestbookApp.firebase.updateUserProfile(username, {
            userTags: currentTags
          });
          
          app.ui.showNotification(`‚úÖ ${username} ahora tiene el tag ${tagNames[tag]}`, 'success');
          
          // Actualizar botones
          selectUserForTagManagement(username);
          
          // Recargar lista
          loadTaggedUsers();
        } else {
          app.ui.showNotification(`‚ö†Ô∏è El usuario ya tiene el tag ${tagNames[tag]}`, 'warning');
        }
        
      } catch (error) {
        console.error('Error assigning tag:', error);
        app.ui.showNotification('‚ùå Error asignando tag', 'error');
      }
    };
    
    window.removeTag = async function(tag) {
      const username = document.getElementById('selectedUserForTags').value;
      if (!username) return;
      
      const tagNames = {
        'OWNER': 'Owner',
        'ADMIN': 'Administrador',
        'MOD': 'Moderador', 
        'VIP': 'VIP'
      };
      
      if (!confirm(`¬øQuitar tag ${tagNames[tag]} a ${username}?`)) return;
      
      try {
        if (!window.guestbookApp || !window.guestbookApp.profiles) {
          app.ui.showNotification('‚ùå Sistema de perfiles no disponible', 'error');
          return;
        }
        
        await window.guestbookApp.profiles.loadUsers();
        const user = window.guestbookApp.profiles.users.get(username.toLowerCase());
        
        if (!user) {
          app.ui.showNotification('‚ùå Usuario no encontrado', 'error');
          return;
        }
        
        // Quitar tag
        const currentTags = user.userTags || [];
        const updatedTags = currentTags.filter(t => t !== tag);
        
        // Actualizar en Firebase
        await window.guestbookApp.firebase.updateUserProfile(username, {
          userTags: updatedTags
        });
        
        app.ui.showNotification(`‚úÖ Tag ${tagNames[tag]} quitado de ${username}`, 'success');
        
        // Actualizar botones
        selectUserForTagManagement(username);
        
        // Recargar lista
        loadTaggedUsers();
        
      } catch (error) {
        console.error('Error removing tag:', error);
        app.ui.showNotification('‚ùå Error quitando tag', 'error');
      }
    };
    
    // Funci√≥n especial para auto-asignarse OWNER
    window.assignSelfOwner = async function() {
      try {
        // Verificar si est√° logueado en el sistema de perfiles
        if (!window.guestbookApp || !window.guestbookApp.profiles || !window.guestbookApp.profiles.isLoggedIn()) {
          app.ui.showNotification('‚ùå Debes estar logueado en tu perfil primero', 'error');
          return;
        }
        
        const currentProfile = window.guestbookApp.profiles.currentProfile;
        const username = currentProfile.username;
        
        // Verificar que sea el usuario correcto (thisisfenix)
        if (username.toLowerCase() !== 'thisisfenix') {
          app.ui.showNotification('‚ùå Solo el creador del guestbook puede usar esta funci√≥n', 'error');
          return;
        }
        
        if (!confirm(`¬øAsignarte el tag OWNER como ${username}?\n\nEsto te dar√° permisos completos de administrador.`)) return;
        
        // Obtener tags actuales
        const currentTags = currentProfile.userTags || [];
        
        if (currentTags.includes('OWNER')) {
          app.ui.showNotification('‚ö†Ô∏è Ya tienes el tag OWNER', 'warning');
          return;
        }
        
        // Agregar tag OWNER
        currentTags.push('OWNER');
        
        // Agregar tambi√©n ADMIN si no lo tiene
        if (!currentTags.includes('ADMIN')) {
          currentTags.push('ADMIN');
        }
        
        // Actualizar en Firebase
        await window.guestbookApp.firebase.updateUserProfile(username, {
          userTags: currentTags
        });
        
        // Actualizar perfil local
        currentProfile.userTags = currentTags;
        window.guestbookApp.profiles.saveProfile();
        
        app.ui.showNotification(`‚úÖ ¬°Bienvenido OWNER ${username}! Tienes permisos completos`, 'success');
        app.ui.createConfetti();
        
        // Recargar lista
        loadTaggedUsers();
        
        // Actualizar UI del perfil si est√° visible
        if (window.guestbookApp.profiles.updateProfileDisplay) {
          window.guestbookApp.profiles.updateProfileDisplay();
        }
        
      } catch (error) {
        console.error('Error assigning self owner:', error);
        app.ui.showNotification('‚ùå Error asign√°ndote OWNER', 'error');
      }
    };
    

    

    
    // Funci√≥n para eliminar dibujos (moderadores)
    window.deleteDrawing = async function(drawingId, author) {
      if (!hasPermission('delete_drawings')) {
        app.ui.showNotification('‚ùå No tienes permisos para eliminar dibujos', 'error');
        return;
      }
      
      const reason = prompt(`¬øEliminar dibujo de ${author}?\n\nRaz√≥n (opcional):`);
      if (reason === null) return; // Usuario cancel√≥
      
      try {
        const moderatorName = window.currentUser?.name || 'Moderador';
        await app.firebase.deleteDrawing(drawingId, moderatorName, reason);
        
        app.ui.showNotification('‚úÖ Dibujo eliminado', 'success');
        
        // Actualizar galeria
        if (window.galleryManager) {
          await window.galleryManager.loadGallery();
        }
        
        // Cerrar modal si est√° abierto
        const modal = document.querySelector('.image-modal');
        if (modal) modal.remove();
        
      } catch (error) {
        console.error('Error eliminando dibujo:', error);
        app.ui.showNotification('‚ùå Error eliminando dibujo', 'error');
      }
    };
    
    // Variable global para cambios sin guardar
    window.hasUnsavedChanges = false;
    
    // Funciones de navegaci√≥n m√≥vil
    window.scrollToTop = function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    window.scrollToCanvas = function() {
      const canvas = document.querySelector('.canvas-container');
      if (canvas) {
        canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    };
    
    window.scrollToGallery = function() {
      const gallery = document.getElementById('gallery');
      if (gallery) {
        gallery.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };
    
    window.toggleMobileMenu = function() {
      const menu = document.querySelector('.version-toggle');
      if (menu) {
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        setTimeout(() => {
          if (menu.style.display !== 'none') {
            menu.style.display = 'none';
          }
        }, 3000);
      }
    };
    
    // Mostrar/ocultar bot√≥n de scroll seg√∫n posici√≥n
    window.addEventListener('scroll', function() {
      const scrollTopBtn = document.querySelector('.mobile-scroll-top');
      if (scrollTopBtn) {
        if (window.scrollY > 300) {
          scrollTopBtn.style.opacity = '1';
          scrollTopBtn.style.pointerEvents = 'auto';
        } else {
          scrollTopBtn.style.opacity = '0';
          scrollTopBtn.style.pointerEvents = 'none';
        }
      }
    });
    
    // Funci√≥n global para refrescar p√°gina
    window.refreshPage = function() {
      // Verificar cambios sin guardar
      if (window.hasUnsavedChanges) {
        const confirmRefresh = confirm(
          '‚ö†Ô∏è ¬øEst√°s seguro de actualizar la p√°gina?\n\n' +
          'üé® Tienes cambios sin guardar en tu dibujo\n' +
          'üîÑ Esta acci√≥n limpiar√° el cache y recargar√° completamente la p√°gina\n' +
          'üíæ Se perder√°n todos los cambios no guardados\n\n' +
          '‚úÖ Presiona OK para continuar\n' +
          '‚ùå Presiona Cancelar para seguir dibujando'
        );
        
        if (!confirmRefresh) {
          return;
        }
      }
      
      // Mostrar animaci√≥n de carga
      const btn = document.querySelector('.mobile-refresh');
      if (btn) {
        btn.innerHTML = '‚è≥';
        btn.style.animation = 'spin 1s linear infinite';
      }
      
      // Limpiar cache del service worker si existe
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            registration.unregister();
          }
        });
      }
      
      // Limpiar cache del navegador
      if ('caches' in window) {
        caches.keys().then(function(names) {
          for (let name of names) {
            caches.delete(name);
          }
        });
      }
      
      // Refrescar con cache bypass
      setTimeout(() => {
        window.location.reload(true);
      }, 500);
    };
    
    // Funciones globales de administraci√≥n
    window.toggleAdminPanel = function() {
      const modal = new bootstrap.Modal(document.getElementById('adminPanel'));
      modal.show();
    };
    
    window.toggleUpdatesPanel = function() {
      const modal = new bootstrap.Modal(document.getElementById('updatesPanel'));
      modal.show();
    };
    
    window.toggleModPanel = function() {
      const modal = new bootstrap.Modal(document.getElementById('modPanel'));
      modal.show();
    };
    
    window.loginMod = async function() {
      const username = document.getElementById('modPanelUsername').value.trim();
      
      if (!username) {
        alert('Por favor ingresa tu nombre de usuario');
        return;
      }
      
      try {
        // Verificar directamente si el usuario tiene permisos MOD sin necesidad de contrase√±a
        if (window.guestbookApp && window.guestbookApp.profiles) {
          // Cargar usuarios y verificar si existe y tiene tag MOD
          await window.guestbookApp.profiles.loadUsers();
          const user = window.guestbookApp.profiles.users.get(username.toLowerCase());
          
          if (user && user.userTags && user.userTags.includes('MOD')) {
            window.guestbookApp.profiles.currentProfile = user;
            
            window.currentUser = {
              name: user.username,
              username: user.username,
              role: 'moderator',
              permissions: ['delete_drawings', 'manage_comments', 'manage_suggestions']
            };
            
            document.getElementById('modLogin').style.display = 'none';
            document.getElementById('modContent').style.display = 'block';
            
            document.getElementById('modToggle').innerHTML = `üõ°Ô∏è ${user.username}`;
            document.getElementById('modToggle').classList.remove('btn-outline-warning');
            document.getElementById('modToggle').classList.add('btn-success');
            
            document.getElementById('modUserInfo').textContent = user.username;
            
            loadModSuggestions();
            loadModDrawings();
            loadModReports();
            loadModStats();
            loadModReportedUsers();
            loadModConfig();
            loadModComments();
            
            if (window.guestbookApp && window.guestbookApp.loadAdminReports) {
              window.guestbookApp.loadAdminReports();
            }
            
            alert(`Bienvenido Moderador ${user.username}`);
          } else {
            alert('‚ùå Usuario no encontrado o sin permisos de moderador');
          }
        } else {
          alert('‚ùå Sistema de perfiles no disponible');
        }
      } catch (error) {
        console.error('Error login mod:', error);
        alert('Error iniciando sesi√≥n');
      }
    };
    
    window.logoutMod = function() {
      window.currentUser = null;
      document.getElementById('modLogin').style.display = 'block';
      document.getElementById('modContent').style.display = 'none';
      document.getElementById('modPanelUsername').value = '';
      document.getElementById('modPanelPassword').value = '';
      document.getElementById('modToggle').innerHTML = 'üõ°Ô∏è Mod';
      document.getElementById('modToggle').classList.remove('btn-success');
      document.getElementById('modToggle').classList.add('btn-outline-warning');
      
      app.ui.showNotification('üö∫ Sesi√≥n cerrada', 'info');
    };
    
    window.loadModSuggestions = async function() {
      try {
        const suggestions = await app.firebase.getAllSuggestions();
        const container = document.getElementById('modSuggestions');
        
        if (!container) return;
        
        if (!suggestions || suggestions.length === 0) {
          container.innerHTML = '<div class="text-muted text-center">No hay sugerencias</div>';
          return;
        }
        
        container.innerHTML = suggestions.map(s => `
          <div class="card mb-3" style="background: var(--bg-light); border: 1px solid var(--primary);">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between mb-2">
                <div>
                  <strong style="color: var(--primary);">${app.getSuggestionIcon(s.tipo)} ${s.autor || 'An√≥nimo'}</strong>
                  <span class="badge bg-secondary ms-2" style="font-size: 0.7em;">${app.getSuggestionTypeText(s.tipo)}</span>
                  ${app.getSuggestionStatusBadge(s.status)}
                </div>
                <small class="text-muted">${app.formatDate(s.timestamp)}</small>
              </div>
              <p class="text-light mb-2">${s.texto || 'Sin texto'}</p>
              ${s.imagen ? `<img src="${s.imagen}" class="img-fluid mb-2" style="max-height: 150px; border-radius: 4px;">` : ''}
              <div class="btn-group btn-group-sm">
                <button class="btn btn-warning" onclick="updateSuggestionStatus('${s.id}', 'pendiente')">‚è≥ Pendiente</button>
                <button class="btn btn-info" onclick="updateSuggestionStatus('${s.id}', 'proceso')">üîÑ En Proceso</button>
                <button class="btn btn-success" onclick="updateSuggestionStatus('${s.id}', 'aprobado')">‚úÖ Aprobar</button>
                <button class="btn btn-danger" onclick="updateSuggestionStatus('${s.id}', 'rechazado')">‚ùå Rechazar</button>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading mod suggestions:', error);
        const container = document.getElementById('modSuggestions');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center">Error cargando sugerencias</div>';
        }
      }
    };
    
    window.loadModDrawings = async function() {
      try {
        const drawings = await app.firebase.getAllDrawings();
        const container = document.getElementById('modDrawings');
        
        if (!container) return;
        
        if (!drawings || drawings.length === 0) {
          container.innerHTML = '<div class="text-muted text-center">No hay dibujos</div>';
          return;
        }
        
        container.innerHTML = drawings.slice(0, 20).map(d => `
          <div class="card mb-2" style="background: var(--bg-light); border: 1px solid var(--primary);">
            <div class="card-body p-2">
              <div class="d-flex align-items-center">
                <img src="${d.data.backgroundGif || d.data.imagenData}" style="width: 60px; height: 60px; object-fit: contain; background: white; border-radius: 4px; margin-right: 10px;">
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between">
                    <strong style="color: var(--primary); font-size: 0.9em;">${d.data.autor}</strong>
                    <small class="text-muted">${new Date(d.data.timestamp).toLocaleDateString()}</small>
                  </div>
                  <div class="text-light small">${d.data.categoria}</div>
                  <div class="text-muted small">‚ù§Ô∏è ${d.data.likes || 0} | üí¨ ${d.data.comments?.length || 0}</div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="deleteDrawingMod('${d.id}', '${d.data.autor}')" title="Eliminar dibujo">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading mod drawings:', error);
        const container = document.getElementById('modDrawings');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center">Error cargando dibujos</div>';
        }
      }
    };
    
    window.reportDrawing = async function(drawingId, author) {
      // Crear modal personalizado para el reporte
      const reportModal = document.createElement('div');
      reportModal.className = 'modal fade';
      reportModal.innerHTML = `
        <div class="modal-dialog">
          <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
            <div class="modal-header" style="border-bottom: 1px solid var(--primary);">
              <h5 class="modal-title" style="color: var(--primary);">‚ö†Ô∏è Reportar Dibujo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <p class="text-light">Est√°s reportando el dibujo de: <strong style="color: var(--primary);">${author}</strong></p>
                <p class="text-muted small">Los reportes son revisados por moderadores. Solo reporta contenido que viole las reglas de la comunidad.</p>
              </div>
              <div class="mb-3">
                <label class="form-label text-light">Tipo de reporte:</label>
                <select id="reportType" class="form-select" style="background: var(--bg-light); border: 1px solid var(--primary); color: var(--text-primary);">
                  <option value="inappropriate_content">üö´ Contenido inapropiado</option>
                  <option value="spam">üìß Spam</option>
                  <option value="harassment">üò† Acoso o bullying</option>
                  <option value="copyright">¬©Ô∏è Violaci√≥n de derechos de autor</option>
                  <option value="violence">‚öîÔ∏è Violencia o contenido perturbador</option>
                  <option value="other">‚ùì Otro</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label text-light">Raz√≥n del reporte:</label>
                <textarea id="reportReason" class="form-control" rows="3" placeholder="Describe por qu√© est√°s reportando este dibujo..." style="background: var(--bg-light); border: 1px solid var(--primary); color: var(--text-primary); resize: none;" maxlength="500"></textarea>
                <small class="text-muted">M√°ximo 500 caracteres</small>
              </div>
              <div class="mb-3">
                <label class="form-label text-light">Tu nombre (opcional):</label>
                <input type="text" id="reporterName" class="form-control" placeholder="An√≥nimo" style="background: var(--bg-light); border: 1px solid var(--primary); color: var(--text-primary);" maxlength="50">
                <small class="text-muted">Puedes reportar de forma an√≥nima</small>
              </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--primary);">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="button" class="btn btn-danger" onclick="submitReport('${drawingId}', '${author}')">‚ö†Ô∏è Enviar Reporte</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(reportModal);
      const bootstrapModal = new bootstrap.Modal(reportModal);
      bootstrapModal.show();
      
      reportModal.addEventListener('hidden.bs.modal', () => {
        reportModal.remove();
      });
    };
    
    window.submitReport = async function(drawingId, author) {
      const type = document.getElementById('reportType').value;
      const reason = document.getElementById('reportReason').value.trim();
      const reporterName = document.getElementById('reporterName').value.trim() || 'Usuario an√≥nimo';
      
      if (!reason) {
        app.ui.showNotification('‚ùå Por favor describe la raz√≥n del reporte', 'error');
        document.getElementById('reportReason').focus();
        return;
      }
      
      const submitBtn = document.querySelector('button[onclick*="submitReport"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '‚è≥ Enviando...';
      submitBtn.disabled = true;
      
      try {
        await app.firebase.reportDrawing({
          drawingId: drawingId,
          drawingAuthor: author,
          reportedBy: reporterName,
          reason: reason,
          type: type,
          timestamp: Date.now()
        });
        
        app.ui.showNotification('‚úÖ Reporte enviado a moderadores', 'success');
        
        // Cerrar modal
        const modal = document.querySelector('.modal.show');
        if (modal) {
          const bootstrapModal = bootstrap.Modal.getInstance(modal);
          if (bootstrapModal) bootstrapModal.hide();
        }
        
      } catch (error) {
        console.error('Error enviando reporte:', error);
        app.ui.showNotification('‚ùå Error enviando reporte', 'error');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    };
    
    window.loadModReports = async function() {
      try {
        const reports = await app.firebase.getAllReports();
        const container = document.getElementById('modReports');
        
        if (!container) return;
        
        // Actualizar contador de reportes pendientes
        const pendingReports = reports ? reports.filter(r => r.status === 'pending').length : 0;
        if (app.updateReportCounters) {
          app.updateReportCounters(pendingReports);
        }
        
        if (!reports || reports.length === 0) {
          container.innerHTML = `
            <div class="text-center py-4">
              <div style="color: var(--text-secondary); font-size: 1.1em;">
                <i class="fas fa-shield-alt" style="font-size: 2em; margin-bottom: 15px; opacity: 0.5;"></i>
                <p>No hay reportes</p>
                <small>Los reportes de usuarios aparecer√°n aqu√≠</small>
              </div>
            </div>
          `;
          return;
        }
        
        // Ordenar reportes: pendientes primero, luego por fecha
        const sortedReports = reports.sort((a, b) => {
          if (a.status === 'pending' && b.status !== 'pending') return -1;
          if (b.status === 'pending' && a.status !== 'pending') return 1;
          return b.timestamp - a.timestamp;
        });
        
        const getTypeIcon = (type) => {
          const icons = {
            'inappropriate_content': 'üö´',
            'spam': 'üìß',
            'harassment': 'üò†',
            'copyright': '¬©Ô∏è',
            'violence': '‚öîÔ∏è',
            'other': '‚ùì'
          };
          return icons[type] || '‚ö†Ô∏è';
        };
        
        const getTypeText = (type) => {
          const types = {
            'inappropriate_content': 'Contenido inapropiado',
            'spam': 'Spam',
            'harassment': 'Acoso o bullying',
            'copyright': 'Violaci√≥n de derechos de autor',
            'violence': 'Violencia o contenido perturbador',
            'other': 'Otro'
          };
          return types[type] || 'No especificado';
        };
        
        container.innerHTML = sortedReports.map(r => `
          <div class="card mb-3" style="background: var(--bg-light); border: 2px solid ${r.status === 'pending' ? '#ffc107' : r.status === 'resolved' ? '#28a745' : '#dc3545'}; ${r.status === 'pending' ? 'box-shadow: 0 0 10px rgba(255, 193, 7, 0.3);' : ''}">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center gap-2 mb-2">
                    <strong style="color: var(--primary); font-size: 1em;">${getTypeIcon(r.type)} Reporte contra: ${r.drawingAuthor}</strong>
                    <span class="badge ${r.status === 'pending' ? 'bg-warning text-dark' : r.status === 'resolved' ? 'bg-success' : 'bg-danger'}" style="font-size: 0.75em;">
                      ${r.status === 'pending' ? '‚è≥ Pendiente' : r.status === 'resolved' ? '‚úÖ Resuelto' : '‚ùå Rechazado'}
                    </span>
                  </div>
                  <div class="mb-2">
                    <span class="badge bg-secondary me-2" style="font-size: 0.7em;">${getTypeText(r.type)}</span>
                    <small class="text-muted">Reportado ${app.formatDate(r.timestamp)}</small>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <p class="text-light mb-2" style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border-left: 3px solid var(--primary); font-size: 0.9em; line-height: 1.4;">
                  <strong>Raz√≥n:</strong> ${r.reason}
                </p>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <small class="text-muted d-block"><strong>Reportado por:</strong> ${r.reportedBy}</small>
                  ${r.reviewedBy ? `<small class="text-muted d-block"><strong>Revisado por:</strong> ${r.reviewedBy}</small>` : ''}
                </div>
                <div class="col-md-6 text-md-end">
                  ${r.reviewedAt ? `<small class="text-muted d-block">Revisado: ${app.formatDate(r.reviewedAt)}</small>` : ''}
                  <small class="text-muted d-block">ID: ${r.id.substring(0, 8)}...</small>
                </div>
              </div>
              
              <div class="d-flex gap-2 flex-wrap">
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn ${r.status === 'pending' ? 'btn-warning' : 'btn-outline-warning'}" onclick="updateReportStatus('${r.id}', 'pending')" ${r.status === 'pending' ? 'disabled' : ''}>
                    ‚è≥ Pendiente
                  </button>
                  <button class="btn ${r.status === 'resolved' ? 'btn-success' : 'btn-outline-success'}" onclick="updateReportStatus('${r.id}', 'resolved')" ${r.status === 'resolved' ? 'disabled' : ''}>
                    ‚úÖ Resolver
                  </button>
                  <button class="btn ${r.status === 'rejected' ? 'btn-danger' : 'btn-outline-danger'}" onclick="updateReportStatus('${r.id}', 'rejected')" ${r.status === 'rejected' ? 'disabled' : ''}>
                    ‚ùå Rechazar
                  </button>
                </div>
                <button class="btn btn-info btn-sm" onclick="viewReportedDrawing('${r.drawingId}')" title="Ver el dibujo reportado">
                  üëÅÔ∏è Ver Dibujo
                </button>
                ${window.currentUser && window.currentUser.permissions && window.currentUser.permissions.includes('delete_drawings') ? `
                  <button class="btn btn-outline-danger btn-sm" onclick="deleteDrawingFromReport('${r.drawingId}', '${r.drawingAuthor}', '${r.id}')" title="Eliminar dibujo reportado">
                    üóëÔ∏è Eliminar
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading reports:', error);
        const container = document.getElementById('modReports');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center py-4"><i class="fas fa-exclamation-triangle mb-2"></i><br>Error cargando reportes</div>';
        }
      }
    };
    
    window.updateReportStatus = async function(reportId, status) {
      try {
        const reviewerName = window.currentUser ? (window.currentUser.name || window.currentUser.username || 'Moderador') : 'Admin';
        await app.firebase.updateReportStatus(reportId, status, reviewerName);
        
        const statusText = {
          'pending': 'marcado como pendiente',
          'resolved': 'resuelto',
          'rejected': 'rechazado'
        };
        
        app.ui.showNotification(`‚úÖ Reporte ${statusText[status] || 'actualizado'}`, 'success');
        
        // Actualizar ambos paneles
        if (window.loadModReports) loadModReports();
        if (app.loadAdminReports) app.loadAdminReports();
      } catch (error) {
        console.error('Error actualizando reporte:', error);
        app.ui.showNotification('‚ùå Error actualizando reporte', 'error');
      }
    };
    
    window.viewReportedDrawing = async function(drawingId) {
      try {
        const drawing = await app.firebase.getDrawing(drawingId);
        if (drawing) {
          // Usar la funci√≥n viewImage del gallery manager
          if (window.guestbookApp && window.guestbookApp.gallery && window.guestbookApp.gallery.viewImage) {
            window.guestbookApp.gallery.viewImage(drawing.data.backgroundGif || drawing.data.imagenData, drawingId);
          } else {
            // Fallback simple
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
              <div class="modal-dialog modal-lg">
                <div class="modal-content" style="background: var(--bg-dark); border: 2px solid var(--primary);">
                  <div class="modal-header">
                    <h5 class="modal-title" style="color: var(--primary);">Dibujo Reportado - ${drawing.data.autor}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
                  </div>
                  <div class="modal-body text-center">
                    <img src="${drawing.data.backgroundGif || drawing.data.imagenData}" class="img-fluid" style="max-height: 400px; background: white; border-radius: 8px;">
                    <div class="mt-3">
                      <p class="text-light">Autor: <strong>${drawing.data.autor}</strong></p>
                      <p class="text-light">Categor√≠a: <strong>${drawing.data.categoria}</strong></p>
                      <p class="text-light">Fecha: <strong>${new Date(drawing.data.timestamp).toLocaleDateString()}</strong></p>
                    </div>
                  </div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            modal.addEventListener('hidden.bs.modal', () => modal.remove());
          }
        } else {
          app.ui.showNotification('‚ùå Dibujo no encontrado (posiblemente eliminado)', 'error');
        }
      } catch (error) {
        app.ui.showNotification('‚ùå Error cargando dibujo', 'error');
      }
    };
    
    window.deleteDrawingMod = async function(drawingId, author) {
      if (!window.currentUser || window.currentUser.role !== 'moderator') {
        app.ui.showNotification('‚ùå Acceso denegado', 'error');
        return;
      }
      
      if (!window.currentUser.permissions.includes('delete_drawings')) {
        app.ui.showNotification('‚ùå Sin permisos para eliminar dibujos', 'error');
        return;
      }
      
      const reason = prompt(`¬øEliminar dibujo de ${author}?\n\nRaz√≥n (opcional):`) || '';
      if (reason === null) return;
      
      try {
        const moderatorName = window.currentUser ? (window.currentUser.name || window.currentUser.username || 'Moderador') : 'Moderador';
        await app.firebase.deleteDrawing(drawingId, moderatorName, reason);
        app.ui.showNotification('‚úÖ Dibujo eliminado', 'success');
        loadModDrawings();
        app.gallery.loadGallery();
      } catch (error) {
        app.ui.showNotification('‚ùå Error eliminando dibujo', 'error');
      }
    };
    
    window.loginAdmin = async function() {
      const password = document.getElementById('adminPassword').value;
      if (!password) {
        app.ui.showNotification('Ingresa la contrase√±a', 'error');
        return;
      }
      
      try {
        const authResult = await app.firebase.checkAdminAccess();
        if (authResult && authResult.role) {
          if (authResult.role === 'moderator_access') {
            // Mostrar panel de moderador
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('moderatorLogin').style.display = 'block';
            app.ui.showNotification('‚úÖ Acceso de moderador habilitado', 'success');
            return;
          }
          
          window.currentUser = authResult;
          isAdminLoggedIn = true;
          
          document.getElementById('adminLogin').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
          
          document.getElementById('adminToggle').innerHTML = 'üîì Admin';
          document.getElementById('adminToggle').classList.remove('btn-outline-danger');
          document.getElementById('adminToggle').classList.add('btn-success');
          
          updateUIForUser();
          loadTaggedUsers();
          app.loadAdminSuggestions();
          app.loadAdminDrawings();
          app.loadAdminReports();
          loadAdminStats();
          loadUsersList();
          loadActivityLogs();
          loadConfig();
          loadAdminComments();
          
          app.ui.showNotification('‚úÖ Acceso de administrador', 'success');
        } else {
          app.ui.showNotification('‚ùå Contrase√±a incorrecta', 'error');
        }
      } catch (error) {
        console.error('Error login admin:', error);
        app.ui.showNotification('‚ùå Error de autenticaci√≥n', 'error');
      }
    };
    
    window.loginModerator = async function() {
      const username = document.getElementById('modLoginUsername').value.trim();
      const password = document.getElementById('modLoginPassword').value.trim();
      
      if (!username || !password) {
        app.ui.showNotification('‚ùå Completa todos los campos', 'error');
        return;
      }
      
      try {
        const authResult = await app.firebase.loginModerator(username, password);
        if (authResult) {
          window.currentUser = authResult;
          isAdminLoggedIn = true;
          
          document.getElementById('moderatorLogin').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
          
          document.getElementById('adminToggle').innerHTML = `üõ°Ô∏è ${authResult.name}`;
          document.getElementById('adminToggle').classList.remove('btn-outline-danger');
          document.getElementById('adminToggle').classList.add('btn-success');
          
          updateUIForUser();
          app.loadAdminSuggestions();
          app.loadAdminDrawings();
          app.loadAdminReports();
          loadModStats();
          loadModReportedUsers();
          loadModConfig();
          
          app.ui.showNotification(`‚úÖ Bienvenido ${authResult.name}`, 'success');
        } else {
          app.ui.showNotification('‚ùå Usuario o contrase√±a incorrectos', 'error');
        }
      } catch (error) {
        app.ui.showNotification('‚ùå Error iniciando sesi√≥n', 'error');
      }
    };
    
    window.createModerator = async function() {
      const authPassword = document.getElementById('modCreateAuth').value.trim();
      const name = document.getElementById('modCreateName').value.trim();
      const username = document.getElementById('modCreateUsername').value.trim();
      const password = document.getElementById('modCreatePassword').value.trim();
      
      if (!authPassword || !name || !username || !password) {
        app.ui.showNotification('‚ùå Completa todos los campos', 'error');
        return;
      }
      
      if (password.length < 6) {
        app.ui.showNotification('‚ùå La contrase√±a debe tener al menos 6 caracteres', 'error');
        return;
      }
      
      try {
        await app.firebase.addModerator({
          moderatorPassword: authPassword,
          name,
          username,
          password,
          permissions: ['delete_drawings', 'manage_comments']
        });
        
        app.ui.showNotification('‚úÖ Cuenta de moderador creada', 'success');
        
        // Limpiar campos
        document.getElementById('modCreateAuth').value = '';
        document.getElementById('modCreateName').value = '';
        document.getElementById('modCreateUsername').value = '';
        document.getElementById('modCreatePassword').value = '';
        
        // Auto-login
        document.getElementById('modLoginUsername').value = username;
        document.getElementById('modLoginPassword').value = password;
        
      } catch (error) {
        if (error.message.includes('ya existe')) {
          app.ui.showNotification('‚ùå El nombre de usuario ya existe', 'error');
        } else if (error.code === 'permission-denied') {
          app.ui.showNotification('‚ùå Contrase√±a de moderador incorrecta', 'error');
        } else {
          app.ui.showNotification('‚ùå Error creando cuenta', 'error');
        }
      }
    };
    
    window.backToMainLogin = function() {
      document.getElementById('moderatorLogin').style.display = 'none';
      document.getElementById('adminLogin').style.display = 'block';
      document.getElementById('adminPassword').value = '';
    };
    
    window.logoutAdmin = function() {
      isAdminLoggedIn = false;
      window.currentUser = null;
      document.getElementById('adminLogin').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
      document.getElementById('adminPassword').value = '';
      document.getElementById('adminToggle').innerHTML = 'üîê Admin';
      document.getElementById('adminToggle').classList.remove('btn-success');
      document.getElementById('adminToggle').classList.add('btn-outline-danger');
      
      // Actualizar UI para usuario no logueado
      updateUIForUser();
      
      app.ui.showNotification('üö™ Sesi√≥n cerrada', 'info');
    };
    
    window.updateSuggestionStatus = async function(suggestionId, status) {
      if (!isAdminLoggedIn || !window.currentUser) {
        app.ui.showNotification('‚ùå Acceso denegado', 'error');
        return;
      }
      
      // Verificar permisos
      if (window.currentUser.role === 'moderator' && !window.currentUser.permissions.includes('manage_suggestions')) {
        app.ui.showNotification('‚ùå Sin permisos para gestionar sugerencias', 'error');
        return;
      }
      
      try {
        await app.firebase.updateSuggestionStatus(suggestionId, status);
        app.ui.showNotification(`‚úÖ Estado actualizado a ${status}`, 'success');
        app.loadAdminSuggestions();
        app.loadRecentSuggestions();
      } catch (error) {
        app.ui.showNotification('‚ùå Error actualizando estado', 'error');
      }
    };
    
    window.deleteDrawing = async function(drawingId, author) {
      if (!isAdminLoggedIn || !window.currentUser) {
        app.ui.showNotification('‚ùå Acceso denegado', 'error');
        return;
      }
      
      // Verificar permisos
      if (window.currentUser.role === 'moderator' && !window.currentUser.permissions.includes('delete_drawings')) {
        app.ui.showNotification('‚ùå Sin permisos para eliminar dibujos', 'error');
        return;
      }
      
      const reason = prompt(`¬øEliminar dibujo de ${author}?\n\nRaz√≥n (opcional):`) || '';
      if (reason === null) return;
      
      try {
        const moderatorName = window.currentUser ? (window.currentUser.name || window.currentUser.username || 'Admin') : 'Admin';
        await app.firebase.deleteDrawing(drawingId, moderatorName, reason);
        app.ui.showNotification('‚úÖ Dibujo eliminado', 'success');
        app.loadAdminDrawings();
        app.gallery.loadGallery();
      } catch (error) {
        app.ui.showNotification('‚ùå Error eliminando dibujo', 'error');
      }
    };
    
    // Funci√≥n para eliminar dibujo desde un reporte
    window.deleteDrawingFromReport = async function(drawingId, author, reportId) {
      if (!window.hasPermission || !window.hasPermission('delete_drawings')) {
        app.ui.showNotification('‚ùå Sin permisos para eliminar dibujos', 'error');
        return;
      }
      
      const confirmDelete = confirm(
        `¬øEliminar dibujo reportado?\n\n` +
        `Autor: ${author}\n` +
        `Esta acci√≥n eliminar√° el dibujo y marcar√° el reporte como resuelto.\n\n` +
        `¬øContinuar?`
      );
      
      if (!confirmDelete) return;
      
      try {
        const moderatorName = window.currentUser ? (window.currentUser.name || window.currentUser.username) : 'Admin';
        
        // Eliminar dibujo
        await app.firebase.deleteDrawing(drawingId, moderatorName, 'Eliminado por reporte de usuario');
        
        // Marcar reporte como resuelto
        await app.firebase.updateReportStatus(reportId, 'resolved', moderatorName);
        
        app.ui.showNotification('‚úÖ Dibujo eliminado y reporte resuelto', 'success');
        
        // Actualizar vistas
        if (app.loadAdminReports) app.loadAdminReports();
        if (app.loadAdminDrawings) app.loadAdminDrawings();
        if (app.gallery && app.gallery.loadGallery) app.gallery.loadGallery();
        
      } catch (error) {
        console.error('Error eliminando dibujo desde reporte:', error);
        app.ui.showNotification('‚ùå Error eliminando dibujo', 'error');
      }
    };
    
    // Funciones para estad√≠sticas de admin
    window.loadAdminStats = async function() {
      try {
        const drawings = await app.firebase.getAllDrawings();
        const reports = await app.firebase.getAllReports();
        const suggestions = await app.firebase.getAllSuggestions();
        const moderators = await app.firebase.getModerators();
        
        const totalDrawings = drawings ? drawings.length : 0;
        const totalReports = reports ? reports.length : 0;
        const totalSuggestions = suggestions ? suggestions.length : 0;
        const totalModerators = moderators ? moderators.length : 0;
        const pendingReports = reports ? reports.filter(r => r.status === 'pending').length : 0;
        const activeModerators = moderators ? moderators.filter(m => m.active).length : 0;
        
        // Actividad por d√≠a (√∫ltimos 7 d√≠as)
        const last7Days = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
          const dayEnd = dayStart + 24 * 60 * 60 * 1000;
          
          const dayDrawings = drawings ? drawings.filter(d => d.data.timestamp >= dayStart && d.data.timestamp < dayEnd).length : 0;
          last7Days.push({
            date: date.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' }),
            count: dayDrawings
          });
        }
        
        // Top artistas
        const artistCounts = {};
        if (drawings) {
          drawings.forEach(d => {
            const author = d.data.autor || 'An√≥nimo';
            artistCounts[author] = (artistCounts[author] || 0) + 1;
          });
        }
        const topArtists = Object.entries(artistCounts)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5);
        
        // Estad√≠sticas generales
        document.getElementById('generalStats').innerHTML = `
          <div class="row text-center">
            <div class="col-6 mb-3">
              <div class="h4 text-primary">${totalDrawings}</div>
              <div class="small text-light">Total Dibujos</div>
            </div>
            <div class="col-6 mb-3">
              <div class="h4 text-warning">${pendingReports}</div>
              <div class="small text-light">Reportes Pendientes</div>
            </div>
            <div class="col-6">
              <div class="h4 text-info">${totalSuggestions}</div>
              <div class="small text-light">Sugerencias</div>
            </div>
            <div class="col-6">
              <div class="h4 text-success">${activeModerators}/${totalModerators}</div>
              <div class="small text-light">Moderadores</div>
            </div>
          </div>
        `;
        
        // Actividad diaria
        document.getElementById('dailyActivity').innerHTML = last7Days.map(day => `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-light">${day.date}</span>
            <div class="d-flex align-items-center">
              <span class="badge bg-primary me-2">${day.count}</span>
              <div class="progress" style="width: 80px; height: 6px;">
                <div class="progress-bar" style="width: ${Math.max(5, (day.count / Math.max(...last7Days.map(d => d.count))) * 100)}%"></div>
              </div>
            </div>
          </div>
        `).join('');
        
        // Top artistas
        document.getElementById('topArtistsStats').innerHTML = topArtists.map((artist, index) => `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center">
              <span class="badge ${index === 0 ? 'bg-warning' : index === 1 ? 'bg-secondary' : index === 2 ? 'bg-info' : 'bg-dark'} me-2">
                ${index + 1}
              </span>
              <span class="text-light">${artist[0]}</span>
            </div>
            <span class="badge bg-primary">${artist[1]}</span>
          </div>
        `).join('');
        
        // Estad√≠sticas de moderaci√≥n
        const resolvedReports = reports ? reports.filter(r => r.status === 'resolved').length : 0;
        const rejectedReports = reports ? reports.filter(r => r.status === 'rejected').length : 0;
        
        document.getElementById('moderationStats').innerHTML = `
          <div class="row text-center">
            <div class="col-4">
              <div class="h5 text-warning">${pendingReports}</div>
              <div class="small text-light">Pendientes</div>
            </div>
            <div class="col-4">
              <div class="h5 text-success">${resolvedReports}</div>
              <div class="small text-light">Resueltos</div>
            </div>
            <div class="col-4">
              <div class="h5 text-danger">${rejectedReports}</div>
              <div class="small text-light">Rechazados</div>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Error loading admin stats:', error);
        document.getElementById('generalStats').innerHTML = `
          <div class="text-center text-danger">Error cargando estad√≠sticas</div>
        `;
      }
    };
    
    // Funciones para gesti√≥n de usuarios
    window.loadUsersList = async function() {
      try {
        const drawings = await app.firebase.getAllDrawings();
        const users = {};
        
        if (drawings) {
          drawings.forEach(d => {
            const author = d.data.autor || 'An√≥nimo';
            if (!users[author]) {
              users[author] = { name: author, drawings: 0, likes: 0, lastActivity: 0 };
            }
            users[author].drawings++;
            users[author].likes += d.data.likes || 0;
            users[author].lastActivity = Math.max(users[author].lastActivity, d.data.timestamp);
          });
        }
        
        const usersList = Object.values(users).sort((a, b) => b.lastActivity - a.lastActivity);
        
        document.getElementById('usersList').innerHTML = usersList.map(user => `
          <div class="card mb-2 user-item" style="background: var(--bg-light); border: 1px solid var(--primary); cursor: pointer;" onclick="selectUser('${user.name}')">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong class="text-primary">${user.name}</strong>
                  <div class="small text-light">üé® ${user.drawings} dibujos | ‚ù§Ô∏è ${user.likes} likes</div>
                </div>
                <span class="badge bg-success">‚úÖ Activo</span>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading users:', error);
      }
    };
    
    window.selectUser = function(username) {
      document.getElementById('selectedUser').value = username;
      document.getElementById('warnUserBtn').disabled = false;
      document.getElementById('blockUserBtn').disabled = false;
      document.getElementById('unblockUserBtn').disabled = false;
      document.getElementById('viewHistoryBtn').disabled = false;
    };
    
    window.warnUser = async function() {
      const username = document.getElementById('selectedUser').value;
      if (!username) return;
      
      const reason = prompt(`Advertir a ${username}:\n\nRaz√≥n de la advertencia:`);
      if (!reason) return;
      
      try {
        const moderatorName = window.currentUser?.name || window.currentUser?.username || 'Admin';
        await app.firebase.logModerationAction('warn_user', moderatorName, username, reason);
        app.ui.showNotification(`‚ö†Ô∏è Usuario ${username} advertido`, 'warning');
        loadActivityLogs();
      } catch (error) {
        app.ui.showNotification('‚ùå Error enviando advertencia', 'error');
      }
    };
    
    window.blockUser = async function() {
      const username = document.getElementById('selectedUser').value;
      if (!username) return;
      
      const reason = prompt(`Bloquear a ${username}:\n\nRaz√≥n del bloqueo:`);
      if (!reason) return;
      
      try {
        const moderatorName = window.currentUser?.name || window.currentUser?.username || 'Admin';
        await app.firebase.logModerationAction('block_user', moderatorName, username, reason);
        app.ui.showNotification(`üö´ Usuario ${username} bloqueado`, 'success');
        loadUsersList();
        loadActivityLogs();
      } catch (error) {
        app.ui.showNotification('‚ùå Error bloqueando usuario', 'error');
      }
    };
    
    window.unblockUser = async function() {
      const username = document.getElementById('selectedUser').value;
      if (!username) return;
      
      try {
        const moderatorName = window.currentUser?.name || window.currentUser?.username || 'Admin';
        await app.firebase.logModerationAction('unblock_user', moderatorName, username, 'Usuario desbloqueado');
        app.ui.showNotification(`‚úÖ Usuario ${username} desbloqueado`, 'success');
        loadUsersList();
        loadActivityLogs();
      } catch (error) {
        app.ui.showNotification('‚ùå Error desbloqueando usuario', 'error');
      }
    };
    
    window.viewUserHistory = async function() {
      const username = document.getElementById('selectedUser').value;
      if (!username) return;
      
      app.ui.showNotification(`üìã Mostrando historial de ${username}`, 'info');
    };
    
    // Funciones para logs de actividad
    window.loadActivityLogs = async function() {
      try {
        const logs = await app.firebase.getModerationLogs();
        
        if (!logs || logs.length === 0) {
          document.getElementById('activityLogs').innerHTML = `
            <div class="text-center text-light py-4">
              <i class="fas fa-clipboard-list" style="font-size: 2em; opacity: 0.5; margin-bottom: 15px;"></i>
              <p>No hay logs de actividad</p>
              <small>Las acciones de moderaci√≥n aparecer√°n aqu√≠</small>
            </div>
          `;
          return;
        }
        
        const getLogIcon = (action) => {
          const icons = {
            'delete_drawing': 'üóëÔ∏è',
            'update_report': '‚ö†Ô∏è',
            'warn_user': '‚ö†Ô∏è',
            'block_user': 'üö´',
            'unblock_user': '‚úÖ',
            'create_moderator': 'üë§',
            'delete_moderator': '‚ùå'
          };
          return icons[action] || 'üìù';
        };
        
        document.getElementById('activityLogs').innerHTML = logs.map(log => `
          <div class="card mb-2" style="background: var(--bg-light); border-left: 3px solid var(--primary);">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="d-flex align-items-center mb-1">
                    <span class="me-2">${getLogIcon(log.action)}</span>
                    <strong class="text-primary">${log.moderator}</strong>
                    <span class="text-light ms-2">${log.action.replace('_', ' ')}</span>
                  </div>
                  <div class="text-light small">Objetivo: ${log.target}</div>
                  ${log.reason ? `<div class="text-muted small">Raz√≥n: ${log.reason}</div>` : ''}
                </div>
                <small class="text-light">${app.formatDate(log.timestamp)}</small>
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading activity logs:', error);
        document.getElementById('activityLogs').innerHTML = `
          <div class="text-center text-danger py-4">
            <i class="fas fa-exclamation-triangle mb-2"></i><br>
            Error cargando logs de actividad
          </div>
        `;
      }
    };
    
    // Funciones de configuraci√≥n
    window.loadConfig = function() {
      const config = JSON.parse(localStorage.getItem('guestbook-config') || '{}');
      document.getElementById('drawingLimit').value = config.drawingLimit || 10;
      document.getElementById('imageSizeLimit').value = config.imageSizeLimit || 3;
      document.getElementById('allowGifs').checked = config.allowGifs !== false;
      document.getElementById('moderateComments').checked = config.moderateComments !== false;
    };
    
    window.saveConfig = function() {
      const config = {
        drawingLimit: parseInt(document.getElementById('drawingLimit').value),
        imageSizeLimit: parseFloat(document.getElementById('imageSizeLimit').value),
        allowGifs: document.getElementById('allowGifs').checked,
        moderateComments: document.getElementById('moderateComments').checked
      };
      localStorage.setItem('guestbook-config', JSON.stringify(config));
      app.ui.showNotification('‚úÖ Configuraci√≥n guardada', 'success');
    };
    
    window.saveFilters = function() {
      app.ui.showNotification('üõ°Ô∏è Filtros actualizados', 'success');
    };
    
    // Funciones de exportaci√≥n
    window.exportDrawings = async function() {
      try {
        const drawings = await app.firebase.getAllDrawings();
        const data = drawings.map(d => ({
          id: d.id,
          autor: d.data.autor,
          categoria: d.data.categoria,
          timestamp: d.data.timestamp,
          likes: d.data.likes || 0
        }));
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `guestbook-drawings-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        app.ui.showNotification('üìÅ Dibujos exportados', 'success');
      } catch (error) {
        app.ui.showNotification('‚ùå Error exportando dibujos', 'error');
      }
    };
    
    window.exportReports = async function() {
      app.ui.showNotification('üìã Reportes exportados', 'success');
    };
    
    window.exportLogs = function() {
      app.ui.showNotification('üìú Logs exportados', 'success');
    };
    
    // Funciones para moderadores
    window.loadModStats = async function() {
      if (!window.currentUser || window.currentUser.role !== 'moderator') return;
      
      try {
        const moderatorName = window.currentUser.name || window.currentUser.username;
        const logs = await app.firebase.getModerationLogs();
        const reports = await app.firebase.getAllReports();
        
        // Filtrar logs del moderador actual
        const myLogs = logs ? logs.filter(log => log.moderator === moderatorName) : [];
        const myReports = reports ? reports.filter(r => r.reviewedBy === moderatorName) : [];
        
        const stats = {
          reportesResueltos: myReports.filter(r => r.status === 'resolved').length,
          reportesRechazados: myReports.filter(r => r.status === 'rejected').length,
          dibujosEliminados: myLogs.filter(l => l.action === 'delete_drawing').length,
          advertenciasEnviadas: myLogs.filter(l => l.action === 'warn_user').length
        };
        
        document.getElementById('modPersonalStats').innerHTML = `
          <div class="row text-center">
            <div class="col-6 mb-3">
              <div class="h4 text-success">${stats.reportesResueltos}</div>
              <div class="small text-light">Reportes Resueltos</div>
            </div>
            <div class="col-6 mb-3">
              <div class="h4 text-danger">${stats.dibujosEliminados}</div>
              <div class="small text-light">Dibujos Eliminados</div>
            </div>
            <div class="col-6">
              <div class="h4 text-warning">${stats.advertenciasEnviadas}</div>
              <div class="small text-light">Advertencias</div>
            </div>
            <div class="col-6">
              <div class="h4 text-info">${stats.reportesRechazados}</div>
              <div class="small text-light">Reportes Rechazados</div>
            </div>
          </div>
        `;
        
        // Actividad reciente del moderador
        const recentLogs = myLogs.slice(0, 5);
        document.getElementById('modRecentActivity').innerHTML = recentLogs.length > 0 ? 
          recentLogs.map(log => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: rgba(0,0,0,0.2); border-radius: 4px;">
              <div>
                <div class="text-light small">${log.action.replace('_', ' ')}</div>
                <div class="text-muted" style="font-size: 0.7em;">${log.target}</div>
              </div>
              <small class="text-muted">${app.formatDate(log.timestamp)}</small>
            </div>
          `).join('') : 
          '<div class="text-center text-light">No hay actividad reciente</div>';
        
      } catch (error) {
        console.error('Error loading mod stats:', error);
        document.getElementById('modPersonalStats').innerHTML = `
          <div class="text-center text-danger">Error cargando estad√≠sticas</div>
        `;
      }
    };
    
    window.loadModReportedUsers = async function() {
      document.getElementById('modReportedUsers').innerHTML = `
        <div class="text-center text-light">Usuarios reportados cargados</div>
      `;
    };
    
    window.loadModConfig = function() {
      document.getElementById('notifyNewReports').checked = true;
      document.getElementById('notifyNewDrawings').checked = true;
    };
    
    window.changeModPassword = async function() {
      const newPassword = document.getElementById('modNewPassword').value;
      const confirmPassword = document.getElementById('modConfirmPassword').value;
      
      if (!newPassword || !confirmPassword) {
        app.ui.showNotification('‚ùå Completa todos los campos', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        app.ui.showNotification('‚ùå Las contrase√±as no coinciden', 'error');
        return;
      }
      
      app.ui.showNotification('‚úÖ Contrase√±a actualizada', 'success');
      document.getElementById('modNewPassword').value = '';
      document.getElementById('modConfirmPassword').value = '';
    };
    
    window.saveModNotifications = function() {
      app.ui.showNotification('‚úÖ Preferencias guardadas', 'success');
    };
    
    // Funciones para gesti√≥n de comentarios
    window.loadAdminComments = async function() {
      try {
        const drawings = await app.firebase.getAllDrawings();
        const container = document.getElementById('adminComments');
        const filter = document.getElementById('commentFilter')?.value || 'all';
        
        if (!container) return;
        
        let allComments = [];
        drawings.forEach(drawing => {
          const comments = drawing.data.comments || [];
          comments.forEach(comment => {
            allComments.push({
              ...comment,
              drawingId: drawing.id,
              drawingTitle: drawing.data.titulo,
              drawingAuthor: drawing.data.autor
            });
          });
        });
        
        // Aplicar filtros
        let filteredComments = allComments;
        if (filter === 'recent') {
          const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
          filteredComments = allComments.filter(c => c.timestamp > oneDayAgo);
        } else if (filter === 'replies') {
          filteredComments = allComments.filter(c => c.parentId);
        }
        
        // Ordenar por m√°s reciente
        filteredComments.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        if (filteredComments.length === 0) {
          container.innerHTML = '<div class="text-center text-muted">No hay comentarios</div>';
          return;
        }
        
        container.innerHTML = filteredComments.slice(0, 50).map(comment => `
          <div class="card mb-2" style="background: var(--bg-light); border: 1px solid var(--primary);">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <strong style="color: var(--primary); font-size: 0.9em;">${comment.autor || 'An√≥nimo'}</strong>
                  ${comment.parentId ? '<span class="badge bg-info ms-1" style="font-size: 0.6em;">üí¨ Respuesta</span>' : ''}
                  ${comment.isLoggedUser ? '<span class="badge bg-success ms-1" style="font-size: 0.6em;">‚úì Registrado</span>' : ''}
                </div>
                <small class="text-muted">${app.formatDate(comment.timestamp)}</small>
              </div>
              <div class="text-light small mb-2" style="line-height: 1.3;">${comment.texto || 'Sin texto'}</div>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <small class="text-muted">En: <strong>${comment.drawingTitle}</strong> por ${comment.drawingAuthor}</small>
                  ${comment.likes || comment.dislikes ? `<div class="mt-1"><span class="text-success">üëç ${comment.likes || 0}</span> <span class="text-danger">üëé ${comment.dislikes || 0}</span></div>` : ''}
                </div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-info" onclick="viewDrawingFromComment('${comment.drawingId}')" title="Ver dibujo">
                    üëÅÔ∏è
                  </button>
                  <button class="btn btn-outline-danger" onclick="deleteComment('${comment.drawingId}', '${comment.id || comment.timestamp}')" title="Eliminar comentario">
                    üóëÔ∏è
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
        
        // Configurar filtro
        const filterSelect = document.getElementById('commentFilter');
        if (filterSelect) {
          filterSelect.onchange = loadAdminComments;
        }
        
      } catch (error) {
        console.error('Error loading admin comments:', error);
        const container = document.getElementById('adminComments');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center">Error cargando comentarios</div>';
        }
      }
    };
    
    window.loadModComments = async function() {
      try {
        const drawings = await app.firebase.getAllDrawings();
        const container = document.getElementById('modComments');
        const filter = document.getElementById('modCommentFilter')?.value || 'all';
        
        if (!container) return;
        
        let allComments = [];
        drawings.forEach(drawing => {
          const comments = drawing.data.comments || [];
          comments.forEach(comment => {
            allComments.push({
              ...comment,
              drawingId: drawing.id,
              drawingTitle: drawing.data.titulo,
              drawingAuthor: drawing.data.autor
            });
          });
        });
        
        // Aplicar filtros
        let filteredComments = allComments;
        if (filter === 'recent') {
          const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
          filteredComments = allComments.filter(c => c.timestamp > oneDayAgo);
        } else if (filter === 'replies') {
          filteredComments = allComments.filter(c => c.parentId);
        }
        
        // Ordenar por m√°s reciente
        filteredComments.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        if (filteredComments.length === 0) {
          container.innerHTML = '<div class="text-center text-muted">No hay comentarios</div>';
          return;
        }
        
        container.innerHTML = filteredComments.slice(0, 30).map(comment => `
          <div class="card mb-2" style="background: var(--bg-light); border: 1px solid var(--primary);">
            <div class="card-body p-2">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <strong style="color: var(--primary); font-size: 0.85em;">${comment.autor || 'An√≥nimo'}</strong>
                  ${comment.parentId ? '<span class="badge bg-info ms-1" style="font-size: 0.6em;">üí¨</span>' : ''}
                </div>
                <small class="text-muted">${app.formatDate(comment.timestamp)}</small>
              </div>
              <div class="text-light small mb-2">${comment.texto || 'Sin texto'}</div>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">En: ${comment.drawingTitle}</small>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteComment('${comment.drawingId}', '${comment.id || comment.timestamp}')">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `).join('');
        
        // Configurar filtro
        const filterSelect = document.getElementById('modCommentFilter');
        if (filterSelect) {
          filterSelect.onchange = loadModComments;
        }
        
      } catch (error) {
        console.error('Error loading mod comments:', error);
        const container = document.getElementById('modComments');
        if (container) {
          container.innerHTML = '<div class="text-danger text-center">Error cargando comentarios</div>';
        }
      }
    };
    
    window.deleteComment = async function(drawingId, commentId) {
      if (!confirm('¬øEliminar este comentario?')) return;
      
      try {
        const drawing = await app.firebase.getDrawing(drawingId);
        const comments = drawing?.data?.comments || [];
        
        // Filtrar comentario y sus respuestas
        const filteredComments = comments.filter(c => {
          const cId = c.id || c.timestamp;
          return cId !== commentId && c.parentId !== commentId;
        });
        
        await app.firebase.updateDrawing(drawingId, { comments: filteredComments });
        
        app.ui.showNotification('‚úÖ Comentario eliminado', 'success');
        
        // Recargar listas
        if (document.getElementById('adminComments')) loadAdminComments();
        if (document.getElementById('modComments')) loadModComments();
        
      } catch (error) {
        console.error('Error deleting comment:', error);
        app.ui.showNotification('‚ùå Error eliminando comentario', 'error');
      }
    };
    
    window.viewDrawingFromComment = function(drawingId) {
      if (window.guestbookApp && window.guestbookApp.gallery) {
        const drawing = window.guestbookApp.gallery.allDrawings.find(d => d.id === drawingId);
        if (drawing) {
          viewImage(drawing.data.imagenData, drawingId);
        }
      }
    };
  </script>
  
  <!-- Suprimir errores de extensiones -->
  <script>
    // Prevenir errores de extensiones del navegador y OperaGX
    const originalConsoleError = console.error;
    console.error = function(...args) {
      const message = args.join(' ');
      if (message.includes('message channel closed') || 
          message.includes('listener indicated an asynchronous response') ||
          message.includes('Failed to fetch') ||
          message.includes('NetworkError') ||
          message.includes('ERR_BLOCKED_BY_CLIENT')) {
        return; // Suprimir errores de conectividad y extensiones
      }
      originalConsoleError.apply(console, args);
    };
    
    // Detectar bloqueos de OperaGX y mostrar ayuda
    window.addEventListener('error', function(e) {
      if (e.message && (e.message.includes('Failed to fetch') || e.message.includes('NetworkError'))) {
        if (navigator.userAgent.includes('OPR') && navigator.userAgent.includes('GX')) {
          setTimeout(() => {
            if (window.guestbookApp && window.guestbookApp.ui) {
              window.guestbookApp.ui.showNotification(
                'üö´ OperaGX est√° bloqueando Firebase. Ve a Configuraci√≥n > Bloqueador de anuncios > Excluir thisisfenix.github.io',
                'error'
              );
            }
          }, 1000);
        }
      }
    });
    
    // Agregar animaciones y estilos adicionales
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Transiciones suaves para botones flotantes */
      .mobile-scroll-top {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      /* Mejoras para touch en iOS */
      .btn, .color-btn, .form-control, .form-select {
        -webkit-tap-highlight-color: rgba(0,0,0,0);
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      
      /* Prevenir zoom en inputs en iOS */
      @media screen and (max-width: 768px) {
        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        textarea,
        select {
          font-size: 16px !important;
        }
      }
      
      /* Mejorar visibilidad de elementos activos */
      .btn:active,
      .color-btn:active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
      }
      
      /* Canvas m√°s responsive */
      @media (max-width: 480px) {
        .canvas-container {
          max-width: 98vw;
          padding: 5px;
        }
        
        #drawCanvas {
          max-width: 100%;
          height: auto;
        }
        
        /* Comentarios ultra compactos */
        .image-modal .comments-container {
          max-height: 35vh !important;
        }
        
        .image-modal .comment-item {
          padding: 0.4rem !important;
          font-size: 12px !important;
        }
        
        .image-modal img {
          max-height: 20vh !important;
        }
      }
    `;
    document.head.appendChild(style);
    
    // Detectar dispositivo m√≥vil y ajustar comportamiento
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isOperaGX = navigator.userAgent.includes('OPR') && navigator.userAgent.includes('GX');
    
    // Detectar problemas de conectividad con Firebase en OperaGX
    if (isOperaGX) {
      console.warn('‚ö†Ô∏è OperaGX detectado - Aplicando workarounds para Firebase');
      
      // Timeout m√°s largo para OperaGX
      if (window.guestbookApp && window.guestbookApp.firebase) {
        window.guestbookApp.firebase.timeout = 15000;
      }
      
      // Mostrar aviso espec√≠fico para OperaGX
      setTimeout(() => {
        if (window.guestbookApp && window.guestbookApp.ui) {
          window.guestbookApp.ui.showNotification(
            'üéÆ OperaGX detectado: Si tienes problemas de conexi√≥n, desactiva el bloqueador de anuncios para thisisfenix.github.io',
            'warning'
          );
        }
      }, 3000);
      
      // Reintentos autom√°ticos para OperaGX
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        return originalFetch.apply(this, args).catch(error => {
          console.warn('üîÑ Reintentando conexi√≥n Firebase para OperaGX...');
          return new Promise(resolve => {
            setTimeout(() => {
              resolve(originalFetch.apply(this, args));
            }, 2000);
          });
        });
      };
    }
    
    if (isMobile) {
      // Prevenir zoom en double tap
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      
      // Mejorar scroll en modales
      document.addEventListener('touchmove', function(e) {
        if (e.target.closest('.image-modal')) {
          // Permitir scroll en modales
          return;
        }
      }, { passive: true });
    }
  </script>
</body>
</html>