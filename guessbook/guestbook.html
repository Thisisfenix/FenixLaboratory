<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guestbook de Dibujos - FenixLaboratory</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #ff6b35;
      --bg-dark: #1a1a1a;
      --bg-light: #2d2d2d;
      --text-primary: #f0f0f0;
      --text-secondary: #b0b0b0;
    }
    
    /* Temas dinÃ¡micos */
    [data-theme="neon"] {
      --primary: #00ff88;
      --bg-dark: #0a0a0a;
      --bg-light: #1a1a1a;
    }
    [data-theme="retro"] {
      --primary: #ff6b9d;
      --bg-dark: #2d1b69;
      --bg-light: #3e2a7a;
    }
    [data-theme="hacker"] {
      --primary: #00ff00;
      --bg-dark: #000000;
      --bg-light: #0d1117;
    }
    [data-theme="sunset"] {
      --primary: #ff6b35;
      --bg-dark: #1a0f0a;
      --bg-light: #2d1a0f;
    }
    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Space Grotesk', sans-serif;
    }
    .canvas-container {
      border: 2px solid var(--primary);
      border-radius: 8px;
      background: white;
      margin: 20px 0;
    }
    #drawCanvas {
      border-radius: 6px;
      cursor: crosshair;
    }
    .drawing-card {
      background: var(--bg-light);
      border: 1px solid rgba(255, 107, 53, 0.2);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .drawing-img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: white;
      border-radius: 4px;
      transition: transform 0.3s ease;
    }
    .drawing-card:hover .drawing-img {
      transform: scale(1.02);
    }
    .drawing-card {
      transition: all 0.3s ease;
    }
    .drawing-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
    }
    .btn-neon {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
      transition: all 0.3s ease;
    }
    .btn-neon:hover {
      background: var(--primary);
      color: var(--bg-dark);
    }
    .color-btn {
      width: 30px;
      height: 30px;
      border: 2px solid #fff;
      border-radius: 50%;
      margin: 2px;
      cursor: pointer;
    }
    .color-btn.active {
      border-color: var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }
    
    /* Responsive canvas */
    @media (max-width: 768px) {
      #drawCanvas {
        width: 100%;
        height: 300px;
      }
      .canvas-container {
        margin: 10px 0;
      }
      .color-btn {
        width: 25px;
        height: 25px;
        margin: 1px;
      }
      #customColor {
        width: 40px;
        height: 25px;
      }
    }
    
    .tool-active {
      background: var(--primary) !important;
      color: white !important;
    }
    
    @keyframes sparkle {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      100% { transform: scale(1) rotate(180deg); opacity: 0; }
    }
    
    .sparkle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      pointer-events: none;
      animation: sparkle 0.6s ease-out forwards;
    }
    
    /* Controles Compactos */
    .controls-compact {
      background: var(--bg-light);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(255, 107, 53, 0.2);
    }
    
    .control-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0,0,0,0.1);
      padding: 8px 12px;
      border-radius: 8px;
    }
    
    .control-label {
      font-size: 1.1em;
      min-width: 20px;
      text-align: center;
    }
    
    .color-picker {
      width: 30px;
      height: 25px;
      border: 1px solid var(--primary);
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
    }
    
    .btn-tool, .btn-action {
      padding: 4px 8px;
      height: 28px;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 5px;
      font-size: 0.8em;
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn-tool-sm, .btn-size, .btn-upload, .btn-filter, .btn-export {
      padding: 4px 6px;
      height: 28px;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 5px;
      font-size: 0.7em;
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn-emoji {
      width: 32px;
      height: 28px;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 5px;
      font-size: 0.9em;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-tool:hover, .btn-tool-sm:hover, .btn-size:hover, .btn-upload:hover, 
    .btn-emoji:hover, .btn-filter:hover, .btn-action:hover, .btn-export:hover,
    .btn-tool.tool-active, .btn-size.tool-active {
      background: var(--primary);
      color: white;
    }
    
    .btn-danger {
      padding: 4px 8px;
      height: 28px;
      border: 1px solid #dc3545;
      background: transparent;
      color: #dc3545;
      border-radius: 5px;
      font-size: 0.8em;
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn-danger:hover {
      background: #dc3545;
      color: white;
    }
    
    .size-slider {
      width: 70px;
      accent-color: var(--primary);
    }
    
    .size-display {
      font-size: 0.8em;
      color: var(--primary);
      font-weight: bold;
      min-width: 25px;
    }
    
    .btn-toggle {
      padding: 6px 12px;
      border: 1px solid var(--text-secondary);
      background: transparent;
      color: var(--text-secondary);
      border-radius: 15px;
      font-size: 0.8em;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-toggle:hover {
      background: var(--text-secondary);
      color: var(--bg-dark);
    }
    
    .advanced-section {
      background: rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
    }
    
    .file-input {
      width: 80px;
      font-size: 0.7em;
      padding: 2px;
      background: var(--bg-dark);
      border: 1px solid var(--primary);
      color: var(--text-primary);
      border-radius: 3px;
    }
    
    .user-row {
      background: rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 12px;
    }
    
    .input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .input-icon {
      font-size: 1.1em;
    }
    
    .input-field, .select-field {
      padding: 6px 10px;
      border: 1px solid var(--primary);
      background: var(--bg-dark);
      color: var(--text-primary);
      border-radius: 5px;
      font-size: 0.9em;
      min-width: 100px;
    }
    
    .btn-save {
      padding: 8px 16px;
      border: 2px solid var(--primary);
      background: var(--primary);
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9em;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-save:hover {
      background: transparent;
      color: var(--primary);
      transform: scale(1.05);
    }
    
    .btn-save:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-save:disabled:hover {
      background: var(--primary);
      color: white;
      transform: none;
    }
    
    .btn-back {
      padding: 6px 12px;
      border: 1px solid var(--text-secondary);
      background: transparent;
      color: var(--text-secondary);
      border-radius: 5px;
      font-size: 0.8em;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    
    .btn-back:hover {
      background: var(--text-secondary);
      color: var(--bg-dark);
      text-decoration: none;
    }
    
    .control-label {
      font-size: 0.8em;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    @media (max-width: 768px) {
      .control-label {
        font-size: 0.7em;
      }
      
      .control-row {
        gap: 8px;
        flex-direction: column;
      }
      
      .control-group {
        padding: 8px;
        gap: 8px;
        flex-direction: column;
        align-items: center;
        min-width: 100%;
      }
      
      .control-group .d-flex {
        justify-content: center;
      }
      
      .btn-tool, .btn-action, .btn-danger {
        padding: 3px 6px;
        height: 30px;
        font-size: 0.7em;
      }
      
      .btn-tool-sm, .btn-size, .btn-upload, .btn-filter, .btn-export {
        padding: 3px 4px;
        height: 30px;
        font-size: 0.6em;
      }
      
      .btn-emoji {
        width: 35px;
        height: 30px;
        font-size: 0.9em;
      }
      
      .size-slider {
        width: 60px;
      }
      
      .input-field, .select-field {
        min-width: 120px;
        font-size: 0.9em;
      }
      
      .user-row .d-flex {
        flex-direction: column;
        gap: 10px;
      }
      
      .advanced-section {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <script>
    // Aplicar tema desde localStorage
    const initialTheme = localStorage.getItem('selectedTheme') || 'default';
    if (initialTheme !== 'default') {
      document.documentElement.setAttribute('data-theme', initialTheme);
    }
  </script>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="text-center flex-grow-1" style="color: var(--primary);">ğŸ¨ Guestbook de Dibujos</h1>
      <select id="themeSelector" class="form-select" style="width: 150px; background: var(--bg-light); border: 1px solid var(--primary); color: var(--text-primary);">
        <option value="default">ğŸ”¥ Default</option>
        <option value="neon">ğŸ’š Neon</option>
        <option value="retro">ğŸ’œ Retro</option>
        <option value="hacker">ğŸ’š Hacker</option>
        <option value="sunset">ğŸ§¡ Sunset</option>
      </select>
    </div>
    
    <!-- Canvas para dibujar -->
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="canvas-container text-center">
          <canvas id="drawCanvas" width="600" height="400"></canvas>
        </div>
        
        <!-- Controles Compactos -->
        <div class="controls-compact mb-4">
          <!-- Fila 1: Herramientas BÃ¡sicas -->
          <div class="control-row mb-3">
            <div class="control-group">
              <div class="d-flex align-items-center gap-2">
                <span class="control-label" title="Colores">ğŸ¨ Colores</span>
              </div>
              <div class="d-flex gap-1">
                <div class="color-btn active" style="background: #000" data-color="#000000" title="Negro"></div>
                <div class="color-btn" style="background: #ff6b35" data-color="#ff6b35" title="Naranja"></div>
                <div class="color-btn" style="background: #f00" data-color="#ff0000" title="Rojo"></div>
                <div class="color-btn" style="background: #0f0" data-color="#00ff00" title="Verde"></div>
                <div class="color-btn" style="background: #00f" data-color="#0000ff" title="Azul"></div>
                <div class="color-btn" style="background: #fff" data-color="#ffffff" title="Blanco"></div>
                <input type="color" id="customColor" value="#ff6b35" class="color-picker" title="Color personalizado">
              </div>
            </div>
            
            <div class="control-group">
              <div class="d-flex align-items-center gap-2">
                <span class="control-label" title="Herramientas">ğŸ› ï¸ Herramientas</span>
              </div>
              <div class="d-flex gap-1">
                <button id="brushBtn" class="btn-tool tool-active" title="Pincel (B)">ğŸ–Œï¸ Pincel</button>
                <button id="handBtn" class="btn-tool" title="Mano - Mover stickers (H)">âœ‹ Mano</button>
                <button id="eraserBtn" class="btn-tool" title="Borrador (E)">ğŸ§½ Borrar</button>
                <button id="textBtn" class="btn-tool" title="Texto (T)">ğŸ…°ï¸ Texto</button>
                <button id="circleBtn" class="btn-tool" title="CÃ­rculo (C)">â­• CÃ­rculo</button>
              </div>
            </div>
            
            <div class="control-group">
              <div class="d-flex align-items-center gap-2">
                <span class="control-label" title="Grosor y opacidad">ğŸ“ Pincel</span>
              </div>
              <div class="d-flex gap-1 align-items-center">
                <input type="range" id="brushSize" min="1" max="20" value="3" class="size-slider" title="Grosor">
                <span id="sizeDisplay" class="size-display">3px</span>
                <input type="range" id="opacitySlider" min="10" max="100" value="100" class="size-slider" title="Opacidad">
                <span id="opacityDisplay" class="size-display">100%</span>
              </div>
            </div>
            
            <div class="control-group">
              <div class="d-flex align-items-center gap-2">
                <span class="control-label" title="Acciones rÃ¡pidas">âš¡ Acciones</span>
              </div>
              <div class="d-flex gap-1">
                <button id="undoBtn" class="btn-action" title="Deshacer (Ctrl+Z)">â†¶ Deshacer</button>
                <button id="clearBtn" class="btn-danger" title="Limpiar todo">ğŸ—‘ï¸ Limpiar</button>
              </div>
            </div>
          </div>
          
          <!-- Fila 2: Herramientas Avanzadas (Colapsable) -->
          <div class="text-center mb-2">
            <button id="toggleAdvanced" class="btn-toggle">âš™ï¸ MÃ¡s opciones</button>
          </div>
          
          <div id="advancedControls" class="advanced-section" style="display: none;">
            <div class="control-row mb-2">
              <div class="control-group">
                <span class="control-label" title="Herramientas avanzadas">ğŸ”§</span>
                <div class="d-flex gap-1">
                  <button id="sprayBtn" class="btn-tool-sm" title="Spray (S)">ğŸ’¨ Spray</button>
                  <button id="bucketBtn" class="btn-tool-sm" title="Relleno (F)">ğŸª£ Relleno</button>
                  <button id="eyedropperBtn" class="btn-tool-sm" title="Cuentagotas (I)">ğŸ’§ Cuentagotas</button>
                  <button id="selectBtn" class="btn-tool-sm" title="Seleccionar Ã¡rea">ğŸ“¦ Seleccionar</button>
                  <button id="lineBtn" class="btn-tool-sm" title="LÃ­nea (L)">â€” LÃ­nea</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Presets de pincel">ğŸ–Œï¸</span>
                <div class="d-flex gap-1">
                  <button id="presetFine" class="btn-tool-sm" title="Pincel fino">âœï¸ Fino</button>
                  <button id="presetThick" class="btn-tool-sm" title="Pincel grueso">ğŸ–ï¸ Grueso</button>
                  <button id="presetArt" class="btn-tool-sm" title="Pincel artÃ­stico">ğŸ¨ Arte</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="TamaÃ±o del canvas">ğŸ“</span>
                <div class="d-flex gap-1">
                  <button id="smallCanvas" class="btn-size" title="PequeÃ±o (400x300)">ğŸ“± PequeÃ±o</button>
                  <button id="mediumCanvas" class="btn-size tool-active" title="Mediano (600x400)">ğŸ’» Mediano</button>
                  <button id="largeCanvas" class="btn-size" title="Grande (800x600)">ğŸ–¥ï¸ Grande</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Subir imÃ¡genes PNG">ğŸ–¼ï¸</span>
                <div class="d-flex gap-1">
                  <button id="stickerBtn" class="btn-upload" title="Modo sticker">ğŸ·ï¸ Sticker</button>
                  <button id="backgroundBtn" class="btn-upload" title="Modo fondo">ğŸ–¼ï¸ Fondo</button>
                </div>
                <input type="file" id="pngUpload" accept=".png" class="file-input" title="Seleccionar PNG">
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Stickers movibles">âœ¨</span>
                <div class="d-flex gap-1 flex-wrap">
                  <button class="btn-emoji emoji-btn" data-emoji="ğŸ˜‚" title="Risa - Click para colocar">ğŸ˜‚</button>
                  <button class="btn-emoji emoji-btn" data-emoji="ğŸ”¥" title="Fuego - Click para colocar">ğŸ”¥</button>
                  <button class="btn-emoji emoji-btn" data-emoji="â¤ï¸" title="CorazÃ³n - Click para colocar">â¤ï¸</button>
                  <button class="btn-emoji emoji-btn" data-emoji="ğŸ‰" title="Fiesta - Click para colocar">ğŸ‰</button>
                  <button class="btn-emoji emoji-btn" data-emoji="ğŸ’€" title="Calavera - Click para colocar">ğŸ’€</button>
                  <button class="btn-emoji emoji-btn" data-emoji="ğŸ˜" title="Cool - Click para colocar">ğŸ˜</button>
                  <button class="btn-emoji emoji-btn" data-emoji="ğŸ¤”" title="Pensando - Click para colocar">ğŸ¤”</button>
                  <button class="btn-emoji emoji-btn" data-emoji="ğŸ’¯" title="100 - Click para colocar">ğŸ’¯</button>
                </div>
                <div class="mt-1" style="font-size: 0.7em; color: var(--text-secondary); text-align: center;">
                  ğŸ“Œ Usa la âœ‹ Mano para mover stickers
                </div>
              </div>
            </div>
            
            <div class="control-row">
              <div class="control-group">
                <span class="control-label" title="Filtros de imagen">ğŸ¨</span>
                <div class="d-flex gap-1">
                  <button id="blurBtn" class="btn-filter" title="Filtro blur">ğŸŒ«ï¸ Blur</button>
                  <button id="pixelBtn" class="btn-filter" title="Filtro pixel art">ğŸ–¼ï¸ Pixel</button>
                  <button id="vintageBtn" class="btn-filter" title="Filtro vintage">ğŸ¨ Vintage</button>
                  <button id="clearFilterBtn" class="btn-filter" title="Quitar filtros">âŒ Quitar</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Utilidades">ğŸ”</span>
                <div class="d-flex gap-1">
                  <button id="redoBtn" class="btn-action" title="Rehacer (Ctrl+Y)">â†· Rehacer</button>
                  <button id="zoomBtn" class="btn-action" title="Zoom in/out">ğŸ” Zoom</button>
                  <button id="exportPNG" class="btn-export" title="Descargar PNG">ğŸ’¾ Exportar</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Fila 3: InformaciÃ³n del Usuario -->
          <div class="user-row mt-3">
            <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
              <div class="input-group">
                <span class="input-icon" title="Nombre del artista">ğŸ‘¤</span>
                <input type="text" id="authorName" placeholder="Tu nombre" class="input-field" title="Escribe tu nombre">
              </div>
              <div class="input-group">
                <span class="input-icon" title="CategorÃ­a del dibujo">ğŸ·ï¸</span>
                <select id="categorySelect" class="select-field" title="Selecciona una categorÃ­a">
                  <option value="Arte">ğŸ¨ Arte</option>
                  <option value="Meme">ğŸ˜‚ Meme</option>
                  <option value="Divertido">ğŸ‰ Divertido</option>
                  <option value="Abstracto">ğŸŒŒ Abstracto</option>
                  <option value="Otro">âœ¨ Otro</option>
                </select>
              </div>
              <button id="saveBtn" class="btn-save" title="Guardar dibujo en la galerÃ­a">
                <span id="saveText">ğŸš€ Guardar</span>
                <span id="saveLoader" style="display: none;">â³ Guardando...</span>
              </button>
            </div>
          </div>
          
          <div class="text-center mt-3">
            <div id="unsavedIndicator" style="display: none; color: #ffc107; margin-bottom: 10px; font-size: 0.8em;">
              âš ï¸ Tienes cambios sin guardar
            </div>
            <a href="../index.html" class="btn-back">ğŸ  Volver al Lab</a>
          </div>
        </div>
      </div>
    </div>
    
    <!-- GalerÃ­a de dibujos -->
    <hr style="border-color: var(--primary);">
    <h2 class="text-center mb-4">ğŸ‡¬ GalerÃ­a de Visitantes</h2>
    
    <div class="row justify-content-center mb-4">
      <div class="col-md-8">
        <div class="d-flex justify-content-center gap-2 flex-wrap mb-3">
          <input type="text" id="searchAuthor" placeholder="Buscar por autor" class="form-control" style="width: 150px; background: var(--bg-light); border: 1px solid var(--primary); color: var(--text-primary);">
          <select id="filterCategory" class="form-select" style="width: 150px; background: var(--bg-light); border: 1px solid var(--primary); color: var(--text-primary);">
            <option value="">Todas las categorÃ­as</option>
            <option value="Arte">ğŸ¨ Arte</option>
            <option value="Meme">ğŸ˜‚ Meme</option>
            <option value="Divertido">ğŸ‰ Divertido</option>
            <option value="Abstracto">ğŸŒŒ Abstracto</option>
            <option value="Otro">âœ¨ Otro</option>
          </select>
          <button id="clearFilters" class="btn btn-outline-secondary btn-sm">âŒ Limpiar</button>
        </div>
        <div class="d-flex justify-content-center gap-2">
          <button id="prevPage" class="btn btn-outline-primary btn-sm" disabled>â¬…ï¸ Anterior</button>
          <span id="pageInfo" style="color: var(--text-primary); padding: 5px 10px;">PÃ¡gina 1</span>
          <button id="nextPage" class="btn btn-outline-primary btn-sm">â¡ï¸ Siguiente</button>
        </div>
      </div>
    </div>
    
    <p class="text-center mb-4" style="color: var(--text-secondary);">
      ğŸŒ Los dibujos son pÃºblicos y visibles para todos los visitantes.<br>
      <small>ğŸ”„ Se actualizan en tiempo real gracias a Firebase</small>
    </p>
    <div id="gallery" class="row">
      <div class="col-12 text-center" style="color: var(--text-secondary);">
        <div class="spinner-border" role="status" style="color: var(--primary);">
          <span class="visually-hidden">Cargando dibujos...</span>
        </div>
        <p class="mt-2">Cargando galerÃ­a...</p>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, updateDoc, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase config - Temporal para testing local
    const firebaseConfig = {
      apiKey: "AIzaSyCZk8rs_Vq9ZGgOEiP3_P6zUvZoM1QQOAM",
      authDomain: "fenix-guestbook.firebaseapp.com",
      projectId: "fenix-guestbook",
      storageBucket: "fenix-guestbook.firebasestorage.app",
      messagingSenderId: "90606615201",
      appId: "1:90606615201:web:56c4731fdf2dbdf8c58ee0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Canvas setup
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let currentColor = '#000000';
    let currentSize = 3;
    let currentOpacity = 1;
    let isEraser = false;
    let strokeCount = 0;
    let drawingHistory = [];
    let historyStep = -1;

    // Configurar canvas
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    // Toggle advanced controls
    document.getElementById('toggleAdvanced').addEventListener('click', () => {
      const advanced = document.getElementById('advancedControls');
      const btn = document.getElementById('toggleAdvanced');
      if (advanced.style.display === 'none') {
        advanced.style.display = 'block';
        btn.innerHTML = 'âš™ï¸ Menos opciones';
      } else {
        advanced.style.display = 'none';
        btn.innerHTML = 'âš™ï¸ MÃ¡s opciones';
      }
    });
    
    // Guardar estado inicial
    saveState();
    
    function saveState() {
      historyStep++;
      if (historyStep < drawingHistory.length) {
        drawingHistory.length = historyStep;
      }
      drawingHistory.push(canvas.toDataURL());
    }

    // Eventos de dibujo
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch events mejorados para mÃ³vil
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', handleTouchEnd);
    
    // Prevenir scroll en mÃ³vil
    document.body.addEventListener('touchstart', e => {
      if (e.target === canvas) e.preventDefault();
    }, { passive: false });
    
    document.body.addEventListener('touchend', e => {
      if (e.target === canvas) e.preventDefault();
    }, { passive: false });
    
    document.body.addEventListener('touchmove', e => {
      if (e.target === canvas) e.preventDefault();
    }, { passive: false });

    function startDrawing(e) {
      if (isPlacingSticker) return;
      
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / zoomLevel - panX;
      const y = (e.clientY - rect.top) / zoomLevel - panY;
      
      if (currentTool === 'hand') {
        // Buscar sticker en la posiciÃ³n del click
        selectedSticker = findStickerAt(x, y);
        if (selectedSticker) {
          isDraggingSticker = true;
          canvas.style.cursor = 'grabbing';
        }
        return;
      }
      
      isDrawing = true;
      
      if (currentTool === 'select') {
        isSelecting = true;
        selectionStart = { x, y };
        return;
      }
      
      if (currentTool === 'brush' || currentTool === 'spray') {
        ctx.beginPath();
        ctx.moveTo(x, y);
      } else if (['circle', 'rect', 'line'].includes(currentTool)) {
        isShapeDrawing = true;
        shapeStartX = x;
        shapeStartY = y;
      } else if (currentTool === 'text') {
        const text = prompt('Escribe tu texto:');
        if (text) {
          ctx.font = `${currentSize * 3}px Arial`;
          ctx.fillStyle = currentColor;
          ctx.fillText(text, x, y);
          saveState();
        }
      }
    }

    function draw(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / zoomLevel - panX;
      const y = (e.clientY - rect.top) / zoomLevel - panY;
      
      if (currentTool === 'hand' && isDraggingSticker && selectedSticker) {
        selectedSticker.x = x;
        selectedSticker.y = y;
        redrawCanvas();
        return;
      }
      
      if (!isDrawing) return;
      
      if (currentTool === 'select' && isSelecting) {
        selectionEnd = { x, y };
        drawSelection();
        return;
      }
      
      ctx.lineWidth = currentSize;
      
      if (currentTool === 'brush') {
        if (isEraser) {
          ctx.globalCompositeOperation = 'destination-out';
        } else {
          ctx.globalCompositeOperation = 'source-over';
          ctx.strokeStyle = currentColor;
          ctx.globalAlpha = currentOpacity;
        }
        ctx.lineTo(x, y);
        ctx.stroke();
        strokeCount++;
        updateUnsavedIndicator();
        
        if (Math.random() < 0.2) createSparkle(e.clientX, e.clientY);
      } else if (currentTool === 'spray') {
        drawSpray(x, y);
      } else if (currentTool === 'bucket') {
        bucketFill(x, y);
      } else if (currentTool === 'eyedropper') {
        pickColor(x, y);
      }
    }
    
    function drawSpray(x, y) {
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = currentColor;
      for (let i = 0; i < sprayDensity; i++) {
        const offsetX = (Math.random() - 0.5) * sprayRadius;
        const offsetY = (Math.random() - 0.5) * sprayRadius;
        ctx.fillRect(x + offsetX, y + offsetY, 1, 1);
      }
    }

    function stopDrawing(e) {
      if (currentTool === 'hand' && isDraggingSticker) {
        isDraggingSticker = false;
        selectedSticker = null;
        canvas.style.cursor = 'grab';
        saveState();
        return;
      }
      
      if (isDrawing || isShapeDrawing) {
        if (currentTool === 'select' && isSelecting) {
          isSelecting = false;
        } else if (isShapeDrawing && e) {
          const rect = canvas.getBoundingClientRect();
          const endX = (e.clientX - rect.left) / zoomLevel - panX;
          const endY = (e.clientY - rect.top) / zoomLevel - panY;
          drawShape(shapeStartX, shapeStartY, endX, endY);
          isShapeDrawing = false;
        }
        isDrawing = false;
        if (currentTool !== 'select') saveState();
      }
    }
    
    function drawShape(startX, startY, endX, endY) {
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = currentSize;
      ctx.globalCompositeOperation = 'source-over';
      
      // Limitar formas dentro del canvas
      startX = Math.max(0, Math.min(canvas.width, startX));
      startY = Math.max(0, Math.min(canvas.height, startY));
      endX = Math.max(0, Math.min(canvas.width, endX));
      endY = Math.max(0, Math.min(canvas.height, endY));
      
      if (currentTool === 'circle') {
        const radius = Math.min(
          Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)),
          Math.min(startX, startY, canvas.width - startX, canvas.height - startY)
        );
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
      } else if (currentTool === 'rect') {
        ctx.strokeRect(startX, startY, endX - startX, endY - startY);
      } else if (currentTool === 'line') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.stroke();
      }
    }

    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }
    
    function handleTouchEnd(e) {
      e.preventDefault();
      const mouseEvent = new MouseEvent('mouseup', {
        clientX: 0,
        clientY: 0
      });
      stopDrawing(e.changedTouches[0]);
    }
    
    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z':
            e.preventDefault();
            if (e.shiftKey) {
              document.getElementById('redoBtn').click();
            } else {
              document.getElementById('undoBtn').click();
            }
            break;
          case 'y':
            e.preventDefault();
            document.getElementById('redoBtn').click();
            break;
        }
      }
      
      // Atajos rÃ¡pidos
      switch(e.key) {
        case 'b': setTool('brush'); break;
        case 's': setTool('spray'); break;
        case 'c': setTool('circle'); break;
        case 'r': setTool('rect'); break;
        case 'l': setTool('line'); break;
        case 't': setTool('text'); break;
        case 'e': setTool('eraser'); break;
        case 'f': setTool('bucket'); break;
        case 'i': setTool('eyedropper'); break;
        case 'h': setTool('hand'); break;
      }
    });

    // Controles de color
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelector('.color-btn.active')?.classList.remove('active');
        btn.classList.add('active');
        currentColor = btn.dataset.color;
        isEraser = false;
        document.getElementById('eraserBtn').classList.remove('btn-secondary');
        document.getElementById('eraserBtn').classList.add('btn-outline-secondary');
      });
    });
    
    // Color personalizado
    document.getElementById('customColor').addEventListener('change', (e) => {
      currentColor = e.target.value;
      document.querySelector('.color-btn.active')?.classList.remove('active');
      isEraser = false;
      document.getElementById('eraserBtn').classList.remove('btn-secondary');
      document.getElementById('eraserBtn').classList.add('btn-outline-secondary');
    });
    
    // Variables para herramientas
    let currentTool = 'brush';
    let pngMode = 'background';
    let stickerSize = 100;
    let isShapeDrawing = false;
    let shapeStartX, shapeStartY;
    let zoomLevel = 1;
    let panX = 0, panY = 0;
    let isSelecting = false;
    let selectionStart = { x: 0, y: 0 };
    let selectionEnd = { x: 0, y: 0 };
    let copiedData = null;
    let isPlacingSticker = false;
    let stickers = []; // Array para almacenar stickers colocados
    let selectedSticker = null;
    let isDraggingSticker = false;
    
    // ConfiguraciÃ³n de spray
    let sprayDensity = 20;
    let sprayRadius = 20;
    
    // Botones de modo PNG
    document.getElementById('stickerBtn').addEventListener('click', () => {
      pngMode = 'sticker';
      document.getElementById('stickerBtn').classList.add('btn-info');
      document.getElementById('stickerBtn').classList.remove('btn-outline-info');
      document.getElementById('backgroundBtn').classList.add('btn-outline-success');
      document.getElementById('backgroundBtn').classList.remove('btn-success');
    });
    
    document.getElementById('backgroundBtn').addEventListener('click', () => {
      pngMode = 'background';
      document.getElementById('backgroundBtn').classList.add('btn-success');
      document.getElementById('backgroundBtn').classList.remove('btn-outline-success');
      document.getElementById('stickerBtn').classList.add('btn-outline-info');
      document.getElementById('stickerBtn').classList.remove('btn-info');
    });
    
    // Subir PNG
    document.getElementById('pngUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && file.type === 'image/png') {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            if (pngMode === 'background') {
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            } else {
              // Modo sticker - click para colocar
              canvas.style.cursor = 'copy';
              const placeSticker = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left - stickerSize/2;
                const y = e.clientY - rect.top - stickerSize/2;
                ctx.drawImage(img, x, y, stickerSize, stickerSize);
                canvas.style.cursor = 'crosshair';
                canvas.removeEventListener('click', placeSticker);
                saveState();
              };
              canvas.addEventListener('click', placeSticker);
            }
            if (pngMode === 'background') saveState();
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('brushSize').addEventListener('input', (e) => {
      currentSize = e.target.value;
      document.getElementById('sizeDisplay').textContent = currentSize + 'px';
    });
    
    document.getElementById('opacitySlider').addEventListener('input', (e) => {
      currentOpacity = e.target.value / 100;
      document.getElementById('opacityDisplay').textContent = e.target.value + '%';
    });

    // Herramientas
    function setTool(tool) {
      currentTool = tool;
      isEraser = (tool === 'eraser');
      
      // Cambiar cursor segÃºn la herramienta
      if (tool === 'hand') {
        canvas.style.cursor = 'grab';
      } else {
        canvas.style.cursor = 'crosshair';
      }
      
      document.querySelectorAll('.tool-active').forEach(btn => {
        btn.classList.remove('tool-active');
        btn.classList.add('btn-outline-primary');
      });
      const toolBtn = document.getElementById(tool + 'Btn');
      if (toolBtn) {
        toolBtn.classList.add('tool-active');
        toolBtn.classList.remove('btn-outline-primary');
      }
    }
    
    document.getElementById('brushBtn').addEventListener('click', () => setTool('brush'));
    document.getElementById('sprayBtn').addEventListener('click', () => setTool('spray'));
    document.getElementById('selectBtn').addEventListener('click', () => setTool('select'));
    document.getElementById('circleBtn').addEventListener('click', () => setTool('circle'));

    document.getElementById('lineBtn').addEventListener('click', () => setTool('line'));
    document.getElementById('textBtn').addEventListener('click', () => setTool('text'));
    document.getElementById('eraserBtn').addEventListener('click', () => setTool('eraser'));
    document.getElementById('bucketBtn').addEventListener('click', () => setTool('bucket'));
    document.getElementById('eyedropperBtn').addEventListener('click', () => setTool('eyedropper'));
    document.getElementById('handBtn').addEventListener('click', () => setTool('hand'));
    
    // Brush presets
    document.getElementById('presetFine').addEventListener('click', () => {
      currentSize = 1;
      currentOpacity = 0.8;
      document.getElementById('brushSize').value = 1;
      document.getElementById('opacitySlider').value = 80;
      document.getElementById('sizeDisplay').textContent = '1px';
      document.getElementById('opacityDisplay').textContent = '80%';
      setTool('brush');
    });
    
    document.getElementById('presetThick').addEventListener('click', () => {
      currentSize = 15;
      currentOpacity = 1;
      document.getElementById('brushSize').value = 15;
      document.getElementById('opacitySlider').value = 100;
      document.getElementById('sizeDisplay').textContent = '15px';
      document.getElementById('opacityDisplay').textContent = '100%';
      setTool('brush');
    });
    
    document.getElementById('presetArt').addEventListener('click', () => {
      currentSize = 8;
      currentOpacity = 0.6;
      document.getElementById('brushSize').value = 8;
      document.getElementById('opacitySlider').value = 60;
      document.getElementById('sizeDisplay').textContent = '8px';
      document.getElementById('opacityDisplay').textContent = '60%';
      setTool('brush');
    });
    
    // Canvas size controls
    document.getElementById('smallCanvas').addEventListener('click', () => resizeCanvas(400, 300));
    document.getElementById('mediumCanvas').addEventListener('click', () => resizeCanvas(600, 400));
    document.getElementById('largeCanvas').addEventListener('click', () => resizeCanvas(800, 600));
    
    function resizeCanvas(width, height) {
      if (!isCanvasEmpty() && !confirm('Â¿Cambiar tamaÃ±o del canvas? Se perderÃ¡ el dibujo actual.')) {
        return;
      }
      
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      canvas.width = width;
      canvas.height = height;
      ctx.putImageData(imageData, 0, 0);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      document.querySelectorAll('[id$="Canvas"]').forEach(btn => {
        btn.classList.remove('tool-active');
        btn.classList.add('btn-outline-info');
      });
      event.target.classList.add('tool-active');
      event.target.classList.remove('btn-outline-info');
      
      saveState();
    }
    
    // Selection and copy/paste
    function drawSelection() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(canvas, 0, 0);
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(tempCanvas, 0, 0);
      
      ctx.strokeStyle = '#ff0000';
      ctx.lineWidth = 1;
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(
        selectionStart.x,
        selectionStart.y,
        selectionEnd.x - selectionStart.x,
        selectionEnd.y - selectionStart.y
      );
      ctx.setLineDash([]);
    }
    

    
    // Theme selector
    document.getElementById('themeSelector').addEventListener('change', (e) => {
      const theme = e.target.value;
      if (theme === 'default') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
      localStorage.setItem('selectedTheme', theme);
    });
    
    // Export functions
    document.getElementById('exportPNG').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `dibujo-${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
    
    // Simplified export - only PNG for main button
    document.getElementById('exportPNG').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `dibujo-${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
    
    // Set initial theme
    const savedTheme = localStorage.getItem('selectedTheme') || 'default';
    document.getElementById('themeSelector').value = savedTheme;
    
    // Prevenir abandonar pÃ¡gina con trabajo sin guardar
    let hasUnsavedWork = false;
    
    function markAsUnsaved() {
      hasUnsavedWork = true;
    }
    
    function markAsSaved() {
      hasUnsavedWork = false;
    }
    
    // Detectar cambios en canvas
    const originalSaveState = saveState;
    saveState = function() {
      originalSaveState();
      if (historyStep > 0) {
        markAsUnsaved();
        updateUnsavedIndicator();
      }
    };
    
    function updateUnsavedIndicator() {
      const indicator = document.getElementById('unsavedIndicator');
      if (hasUnsavedWork && !isCanvasEmpty()) {
        indicator.style.display = 'block';
      } else {
        indicator.style.display = 'none';
      }
    }
    
    // Bucket fill function
    function bucketFill(startX, startY) {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const startPos = (Math.floor(startY) * canvas.width + Math.floor(startX)) * 4;
      const startR = data[startPos];
      const startG = data[startPos + 1];
      const startB = data[startPos + 2];
      const startA = data[startPos + 3];
      
      const fillColor = hexToRgb(currentColor);
      if (!fillColor) return;
      
      const stack = [[Math.floor(startX), Math.floor(startY)]];
      const visited = new Set();
      
      while (stack.length > 0) {
        const [x, y] = stack.pop();
        const key = `${x},${y}`;
        
        if (visited.has(key) || x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
        visited.add(key);
        
        const pos = (y * canvas.width + x) * 4;
        const r = data[pos];
        const g = data[pos + 1];
        const b = data[pos + 2];
        const a = data[pos + 3];
        
        if (r === startR && g === startG && b === startB && a === startA) {
          data[pos] = fillColor.r;
          data[pos + 1] = fillColor.g;
          data[pos + 2] = fillColor.b;
          data[pos + 3] = 255;
          
          stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
        }
      }
      
      ctx.putImageData(imageData, 0, 0);
      saveState();
    }
    
    // Eyedropper function
    function pickColor(x, y) {
      const imageData = ctx.getImageData(Math.floor(x), Math.floor(y), 1, 1);
      const data = imageData.data;
      const r = data[0];
      const g = data[1];
      const b = data[2];
      
      const hex = `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
      currentColor = hex;
      document.getElementById('customColor').value = hex;
      document.querySelector('.color-btn.active')?.classList.remove('active');
      setTool('brush');
    }
    
    // Helper function
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }
    
    // Funciones para manejar stickers
    function findStickerAt(x, y) {
      // Buscar desde el Ãºltimo (mÃ¡s arriba) hacia el primero
      for (let i = stickers.length - 1; i >= 0; i--) {
        const sticker = stickers[i];
        const stickerWidth = sticker.size;
        const stickerHeight = sticker.size;
        
        if (x >= sticker.x && x <= sticker.x + stickerWidth &&
            y >= sticker.y - stickerHeight && y <= sticker.y) {
          return sticker;
        }
      }
      return null;
    }
    
    function redrawCanvas() {
      // Guardar el estado actual sin stickers
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      
      // Copiar solo el dibujo base (sin stickers)
      tempCtx.drawImage(canvas, 0, 0);
      
      // Limpiar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Redibujar el fondo base
      ctx.drawImage(tempCanvas, 0, 0);
      
      // Redibujar todos los stickers
      stickers.forEach(sticker => {
        if (sticker.type === 'emoji') {
          ctx.font = `${sticker.size}px Arial`;
          ctx.fillText(sticker.emoji, sticker.x, sticker.y);
        }
      });
    }
    

    
    // Prevenir salida accidental
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedWork && !isCanvasEmpty()) {
        e.preventDefault();
        e.returnValue = 'Â¿Seguro que quieres salir? Tienes cambios sin guardar.';
        return 'Â¿Seguro que quieres salir? Tienes cambios sin guardar.';
      }
    });
    
    // TambiÃ©n prevenir navegaciÃ³n con botones del navegador
    window.addEventListener('pagehide', (e) => {
      if (hasUnsavedWork && !isCanvasEmpty()) {
        e.preventDefault();
      }
    });
    
    // Emojis como stickers movibles
    document.querySelectorAll('.emoji-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const emoji = btn.dataset.emoji;
        isPlacingSticker = true;
        canvas.style.cursor = 'copy';
        const placeEmoji = (e) => {
          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / zoomLevel - panX;
          const y = (e.clientY - rect.top) / zoomLevel - panY;
          
          // Crear sticker objeto
          const sticker = {
            id: Date.now() + Math.random(),
            emoji: emoji,
            x: x,
            y: y,
            size: stickerSize/2,
            type: 'emoji'
          };
          
          stickers.push(sticker);
          redrawCanvas();
          canvas.style.cursor = 'crosshair';
          canvas.removeEventListener('click', placeEmoji);
          isPlacingSticker = false;
          saveState();
        };
        canvas.addEventListener('click', placeEmoji);
      });
    });
    
    // Zoom
    document.getElementById('zoomBtn').addEventListener('click', () => {
      zoomLevel = zoomLevel === 1 ? 2 : 1;
      canvas.style.transform = `scale(${zoomLevel})`;
      document.getElementById('zoomBtn').textContent = zoomLevel === 1 ? 'ğŸ” Zoom' : 'ğŸ” Zoom Out';
    });
    
    // Filtros
    document.getElementById('blurBtn').addEventListener('click', () => {
      ctx.filter = ctx.filter === 'blur(2px)' ? 'none' : 'blur(2px)';
    });
    
    document.getElementById('pixelBtn').addEventListener('click', () => {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 16) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        data[i] = data[i + 1] = data[i + 2] = avg > 128 ? 255 : 0;
      }
      ctx.putImageData(imageData, 0, 0);
      saveState();
    });
    
    document.getElementById('vintageBtn').addEventListener('click', () => {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, data[i] * 1.2 + 30);     // R
        data[i + 1] = Math.min(255, data[i + 1] * 1.1);  // G
        data[i + 2] = Math.min(255, data[i + 2] * 0.8);  // B
      }
      ctx.putImageData(imageData, 0, 0);
      saveState();
    });
    
    document.getElementById('clearFilterBtn').addEventListener('click', () => {
      ctx.filter = 'none';
    });
    
    // Deshacer/Rehacer
    document.getElementById('undoBtn').addEventListener('click', () => {
      if (historyStep > 0) {
        historyStep--;
        restoreState();
      }
    });
    
    document.getElementById('redoBtn').addEventListener('click', () => {
      if (historyStep < drawingHistory.length - 1) {
        historyStep++;
        restoreState();
      }
    });
    
    function restoreState() {
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
      };
      img.src = drawingHistory[historyStep];
    }
    
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('Â¿Limpiar todo el dibujo?')) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        markAsSaved();
        saveState();
      }
    });

    // Cooldown de 10 minutos
    function checkCooldown() {
      const lastSave = localStorage.getItem('lastDrawingSave');
      if (lastSave) {
        const timeDiff = Date.now() - parseInt(lastSave);
        const cooldownTime = 10 * 60 * 1000; // 10 minutos
        if (timeDiff < cooldownTime) {
          const remaining = Math.ceil((cooldownTime - timeDiff) / 60000);
          return remaining;
        }
      }
      return 0;
    }
    
    // Guardar dibujo con loading state
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const saveBtn = document.getElementById('saveBtn');
      const saveText = document.getElementById('saveText');
      const saveLoader = document.getElementById('saveLoader');
      
      const cooldown = checkCooldown();
      if (cooldown > 0) {
        alert(`â° Espera ${cooldown} minuto(s) antes de subir otro dibujo`);
        return;
      }
      
      if (isCanvasEmpty()) {
        alert('Â¡Dibuja algo primero!');
        return;
      }
      
      // Show loading state
      saveBtn.disabled = true;
      saveText.style.display = 'none';
      saveLoader.style.display = 'inline';
      
      const imageData = canvas.toDataURL();
      const author = document.getElementById('authorName').value || 'AnÃ³nimo';
      const category = document.getElementById('categorySelect').value;
      
      try {
        await addDoc(collection(db, 'drawings'), {
          imageData: imageData,
          author: author,
          timestamp: Date.now(),
          likes: 0,
          category: category || 'Arte',
          comments: [],
          strokes: strokeCount
        });
        
        localStorage.setItem('lastDrawingSave', Date.now().toString());
        createConfetti();
        
        setTimeout(() => {
          alert('Â¡Dibujo guardado!');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.filter = 'none';
          ctx.globalAlpha = 1;
          document.getElementById('authorName').value = '';
          document.getElementById('categorySelect').value = 'Arte';
          strokeCount = 0;
          stickers = []; // Limpiar stickers
          hasUnsavedWork = false;
          updateUnsavedIndicator();
          saveState();
        }, 1000);
      } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar. Revisa la configuraciÃ³n de Firebase.');
      } finally {
        // Hide loading state
        saveBtn.disabled = false;
        saveText.style.display = 'inline';
        saveLoader.style.display = 'none';
      }
    });

    function isCanvasEmpty() {
      const blank = document.createElement('canvas');
      blank.width = canvas.width;
      blank.height = canvas.height;
      return canvas.toDataURL() === blank.toDataURL();
    }

    // PaginaciÃ³n
    let currentPage = 1;
    const itemsPerPage = 12;
    let allDrawings = [];
    
    function renderPage(drawings, page) {
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageDrawings = drawings.slice(start, end);
      
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      
      if (pageDrawings.length === 0) {
        gallery.innerHTML = `
          <div class="col-12 text-center" style="color: var(--text-secondary); padding: 3rem;">
            <i class="bi bi-palette" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <h4>No hay dibujos en esta pÃ¡gina</h4>
          </div>
        `;
        return;
      }
      
      pageDrawings.forEach((drawing) => {
        const data = drawing.data;
        const date = new Date(data.timestamp).toLocaleString('es-ES', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const likes = data.likes || 0;
        const category = data.category || 'Arte';
        
        gallery.innerHTML += `
          <div class="col-md-4 col-sm-6 mb-3 drawing-item" data-author="${data.author.toLowerCase()}" data-category="${category}">
            <div class="drawing-card">
              <img src="${data.imageData}" class="drawing-img" alt="Dibujo de ${data.author}" loading="lazy">
              <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <strong style="color: var(--primary);">ğŸ¨ ${data.author}</strong>
                    <br><small style="color: var(--text-secondary);">${category}</small>
                  </div>
                  <small style="color: var(--text-secondary);">${date}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <button class="btn btn-sm btn-outline-danger like-btn" data-id="${drawing.id}" data-likes="${likes}">
                    â¤ï¸ ${likes}
                  </button>
                  <div>
                    <button class="btn btn-sm btn-outline-info me-1" onclick="viewImage('${data.imageData}', '${drawing.id}')">ğŸ”</button>
                    <button class="btn btn-sm btn-outline-success me-1" onclick="downloadImage('${data.imageData}', '${data.author}')">ğŸ’¾</button>
                    <button class="btn btn-sm btn-outline-warning" onclick="shareDrawing('${data.imageData}', '${data.author}')">ğŸ“¤</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      // Update pagination controls
      const totalPages = Math.ceil(drawings.length / itemsPerPage);
      document.getElementById('pageInfo').textContent = `PÃ¡gina ${page} de ${totalPages}`;
      document.getElementById('prevPage').disabled = page === 1;
      document.getElementById('nextPage').disabled = page === totalPages;
      
      // Add like events
      document.querySelectorAll('.like-btn').forEach(btn => {
        const docId = btn.dataset.id;
        const hasLiked = localStorage.getItem(`liked_${docId}`);
        
        if (hasLiked) {
          btn.classList.remove('btn-outline-danger');
          btn.classList.add('btn-danger');
          btn.disabled = true;
        }
        
        btn.addEventListener('click', async () => {
          if (hasLiked) return;
          
          const currentLikes = parseInt(btn.dataset.likes) || 0;
          try {
            await updateDoc(doc(db, 'drawings', docId), {
              likes: currentLikes + 1
            });
            localStorage.setItem(`liked_${docId}`, 'true');
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-danger');
            btn.disabled = true;
          } catch (error) {
            console.error('Error al dar like:', error);
          }
        });
      });
    }
    
    // Pagination controls
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage(allDrawings, currentPage);
      }
    });
    
    document.getElementById('nextPage').addEventListener('click', () => {
      const totalPages = Math.ceil(allDrawings.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderPage(allDrawings, currentPage);
      }
    });
    
    // Cargar dibujos en tiempo real
    const q = query(collection(db, 'drawings'), orderBy('timestamp', 'desc'));
    onSnapshot(q, (snapshot) => {
      allDrawings = [];
      snapshot.forEach((doc) => {
        allDrawings.push({ id: doc.id, data: doc.data() });
      });
      
      // Limpiar galerÃ­a
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      
      if (allDrawings.length === 0) {
        gallery.innerHTML = `
          <div class="col-12 text-center" style="color: var(--text-secondary); padding: 3rem;">
            <i class="bi bi-palette" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <h4>AÃºn no hay dibujos</h4>
            <p>Â¡SÃ© el primero en dejar tu huella artÃ­stica!</p>
          </div>
        `;
        return;
      }
      
      currentPage = 1;
      
      // Mostrar Top 3 y contador ANTES de renderizar para no sobrescribir eventos
      showTopRanking(allDrawings);
      renderPage(allDrawings, currentPage);
      showCounter(allDrawings.length);
      
      // Configurar filtros una sola vez
      setupFilters();
    });
    
    // Funciones auxiliares
    function setupFilters() {
      const searchAuthor = document.getElementById('searchAuthor');
      const filterCategory = document.getElementById('filterCategory');
      const clearFilters = document.getElementById('clearFilters');
      
      if (searchAuthor && filterCategory && clearFilters && !searchAuthor.hasEventListener) {
        function applyFilters() {
          const authorFilter = searchAuthor.value.toLowerCase();
          const categoryFilter = filterCategory.value;
          
          document.querySelectorAll('.drawing-item').forEach(item => {
            const author = item.dataset.author;
            const category = item.dataset.category;
            
            const matchesAuthor = !authorFilter || author.includes(authorFilter);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            item.style.display = matchesAuthor && matchesCategory ? 'block' : 'none';
          });
        }
        
        searchAuthor.addEventListener('input', applyFilters);
        filterCategory.addEventListener('change', applyFilters);
        clearFilters.addEventListener('click', () => {
          searchAuthor.value = '';
          filterCategory.value = '';
          applyFilters();
        });
        
        searchAuthor.hasEventListener = true;
      }
    }
    
    function showTopRanking(drawings) {
      const gallery = document.getElementById('gallery');
      const top3 = drawings.sort((a, b) => (b.data.likes || 0) - (a.data.likes || 0)).slice(0, 3);
      
      if (top3.length >= 3) {
        const topRankingDiv = document.createElement('div');
        topRankingDiv.className = 'col-12 text-center mb-4';
        topRankingDiv.innerHTML = `
          <div style="background: var(--bg-light); border-radius: 15px; padding: 20px; border: 2px solid var(--primary); margin-bottom: 30px;">
            <h4 style="color: var(--primary); margin-bottom: 20px;">ğŸ† Top 3 MÃ¡s Populares</h4>
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
              ${top3.map((drawing, index) => `
                <div style="text-align: center;">
                  <div style="position: relative; display: inline-block; cursor: pointer; margin-bottom: 10px;" onclick="viewImage('${drawing.data.imageData.replace(/'/g, "\\'")}'', '${drawing.id}')">  
                    <img src="${drawing.data.imageData}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 15px; border: 4px solid ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : '#CD7F32'}; box-shadow: 0 4px 15px rgba(0,0,0,0.3); background: white;">
                    <div style="position: absolute; top: -8px; right: -8px; background: ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : '#CD7F32'}; color: ${index === 0 ? '#000' : '#fff'}; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                      ${index + 1}
                    </div>
                  </div>
                  <div style="color: var(--text-primary); font-size: 0.9em; max-width: 100px;">
                    <strong style="color: var(--primary);">${drawing.data.author}</strong><br>
                    <span style="color: #ff6b35;">â¤ï¸ ${drawing.data.likes || 0}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        gallery.prepend(topRankingDiv);
      }
    }
    
    function showCounter(totalDrawings) {
      const gallery = document.getElementById('gallery');
      const counterDiv = document.createElement('div');
      counterDiv.className = 'col-12 text-center mt-4';
      counterDiv.innerHTML = `
        <div style="background: var(--bg-light); border-radius: 10px; padding: 20px; border: 1px solid var(--primary);">
          <h5 style="color: var(--primary); margin: 0;">ğŸ¨ Total de Obras: ${totalDrawings}</h5>
          <p style="color: var(--text-secondary); margin: 5px 0 0 0;">Atajos: B=Pincel, S=Spray, C=CÃ­rculo, R=RectÃ¡ngulo, L=LÃ­nea, T=Texto, E=Borrador</p>
          <small style="color: var(--text-secondary);">Ctrl+Z=Deshacer, Ctrl+Y=Rehacer</small>
        </div>
      `;
      gallery.appendChild(counterDiv);
    }
    
    // Animaciones
    function createSparkle(x, y) {
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle';
      sparkle.style.left = x + 'px';
      sparkle.style.top = y + 'px';
      document.body.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 600);
    }
    
    function createConfetti() {
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.style.position = 'fixed';
          confetti.style.left = Math.random() * window.innerWidth + 'px';
          confetti.style.top = '-10px';
          confetti.style.width = '8px';
          confetti.style.height = '8px';
          confetti.style.background = ['#ff6b35', '#00ff88', '#ff6b9d', '#00ff00'][Math.floor(Math.random() * 4)];
          confetti.style.borderRadius = '50%';
          confetti.style.pointerEvents = 'none';
          confetti.style.zIndex = '9999';
          document.body.appendChild(confetti);
          
          const fall = confetti.animate([
            { transform: 'translateY(0px) rotate(0deg)', opacity: 1 },
            { transform: `translateY(${window.innerHeight + 100}px) rotate(360deg)`, opacity: 0 }
          ], { duration: 2000 });
          
          fall.onfinish = () => confetti.remove();
        }, i * 50);
      }
    }
    
    // Funciones globales
    window.downloadImage = function(imageData, author) {
      const link = document.createElement('a');
      link.download = `dibujo-${author}-${Date.now()}.png`;
      link.href = imageData;
      link.click();
    };
    
    let isSharing = false;
    
    window.shareDrawing = function(imageData, author) {
      if (isSharing) return;
      
      if (navigator.share) {
        isSharing = true;
        navigator.share({
          title: `Dibujo de ${author} - FenixLaboratory`,
          text: `Â¡Mira este increÃ­ble dibujo de ${author}!`,
          url: window.location.href
        }).finally(() => {
          isSharing = false;
        });
      } else {
        const text = `Â¡Mira este increÃ­ble dibujo de ${author} en FenixLaboratory! ${window.location.href}`;
        navigator.clipboard.writeText(text).then(() => {
          alert('Â¡Enlace copiado al portapapeles!');
        });
      }
    };
    
    window.viewImage = function(imageData, drawingId) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed !important; 
        top: 0 !important; 
        left: 0 !important; 
        width: 100vw !important; 
        height: 100vh !important; 
        background: rgba(0,0,0,0.95) !important; 
        z-index: 99999 !important; 
        display: flex !important; 
        align-items: center !important; 
        justify-content: center !important; 
        backdrop-filter: blur(5px) !important;
      `;
      
      const container = document.createElement('div');
      container.style.cssText = `
        display: flex !important;
        max-width: 95vw !important;
        max-height: 95vh !important;
        background: rgba(0,0,0,0.8) !important;
        border-radius: 20px !important;
        overflow: hidden !important;
      `;
      
      const img = document.createElement('img');
      img.src = imageData;
      img.style.cssText = `
        max-width: 60vw !important; 
        max-height: 95vh !important; 
        border-radius: 15px 0 0 15px !important;
        object-fit: contain !important;
        background: white !important;
      `;
      
      const commentsPanel = document.createElement('div');
      commentsPanel.style.cssText = `
        width: 350px !important;
        background: var(--bg-light) !important;
        padding: 20px !important;
        overflow-y: auto !important;
        border-radius: 0 15px 15px 0 !important;
      `;
      
      const closeBtn = document.createElement('div');
      closeBtn.innerHTML = 'âœ•';
      closeBtn.style.cssText = `
        position: absolute !important;
        top: 20px !important;
        right: 30px !important;
        color: white !important;
        font-size: 30px !important;
        cursor: pointer !important;
        background: rgba(0,0,0,0.7) !important;
        border-radius: 50% !important;
        width: 50px !important;
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 100000 !important;
      `;
      
      // Cargar comentarios
      loadComments(drawingId, commentsPanel);
      
      container.appendChild(img);
      container.appendChild(commentsPanel);
      modal.appendChild(container);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target === closeBtn) {
          modal.remove();
        }
      });
      
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', escHandler);
        }
      });
    };
    
    async function loadComments(drawingId, panel) {
      try {
        const docRef = doc(db, 'drawings', drawingId);
        onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            const comments = data.comments || [];
            
            panel.innerHTML = `
              <h5 style="color: var(--primary); margin-bottom: 15px;">ğŸ’¬ Comentarios (${comments.length})</h5>
              <div id="commentsList" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                ${comments.map(comment => `
                  <div style="background: var(--bg-dark); padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                    <strong style="color: var(--primary); font-size: 0.9em;">${comment.author}</strong>
                    <p style="color: var(--text-primary); margin: 5px 0 0 0; font-size: 0.9em;">${comment.text}</p>
                    <small style="color: var(--text-secondary);">${new Date(comment.timestamp).toLocaleString('es-ES')}</small>
                  </div>
                `).join('')}
              </div>
              <div style="border-top: 1px solid var(--primary); padding-top: 15px;">
                <input type="text" id="commentAuthor" placeholder="Nombre de usuario (opcional)" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); margin-bottom: 8px; font-size: 0.9em;">
                <input type="text" id="commentInput" placeholder="Escribe un comentario..." style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); margin-bottom: 10px;">
                <button onclick="addComment('${drawingId}')" style="width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">â¤ Comentar</button>
              </div>
            `;
          }
        });
      } catch (error) {
        console.error('Error cargando comentarios:', error);
      }
    }
    
    // Filtro bÃ¡sico - solo palabras extremadamente ofensivas
    function moderateContent(text) {
      const bannedWords = ['nazi', 'hitler', 'terrorista', 'suicidio', 'matar'];
      const lowerText = text.toLowerCase();
      
      for (const word of bannedWords) {
        if (lowerText.includes(word)) {
          return text.replace(new RegExp(word, 'gi'), '***');
        }
      }
      return text;
    }
    
    window.addComment = async function(drawingId) {
      const input = document.getElementById('commentInput');
      const authorInput = document.getElementById('commentAuthor');
      const commentText = input.value.trim();
      if (!commentText) return;
      
      const author = moderateContent(authorInput.value.trim() || 'AnÃ³nimo');
      const moderatedText = moderateContent(commentText);
      
      try {
        const docRef = doc(db, 'drawings', drawingId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const currentComments = docSnap.data().comments || [];
          await updateDoc(docRef, {
            comments: [...currentComments, { 
              author, 
              text: moderatedText, 
              timestamp: Date.now() 
            }]
          });
          input.value = '';
          authorInput.value = '';
        }
      } catch (error) {
        console.error('Error al agregar comentario:', error);
      }
    };
  </script>
  
  <!-- Updates System -->
  <script src="./updates.js"></script>
</body>
</html>