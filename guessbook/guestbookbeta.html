<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guestbook de Dibujos - FenixLaboratory</title>
  
  <!-- Discord/Social Media Embeds -->
  <meta property="og:title" content="ğŸ¨ Guestbook de Dibujos v2.0 - FenixLaboratory">
  <meta property="og:description" content="GalerÃ­a interactiva con sistema de rankings, estadÃ­sticas en tiempo real, likes y comentarios. MÃ¡s de 50 herramientas de dibujo, filtros y efectos. Â¡Ãšnete a la comunidad artÃ­stica!">
  <meta property="og:image" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/Preview-GuestBook.png">
  <meta property="og:url" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/guestbook.html">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="FenixLaboratory">
  
  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ğŸ¨ Guestbook de Dibujos v2.0 - FenixLaboratory">
  <meta name="twitter:description" content="GalerÃ­a con rankings, estadÃ­sticas en tiempo real, sistema social y mÃ¡s de 50 herramientas de dibujo.">
  <meta name="twitter:image" content="https://thisisfenix.github.io/FenixLaboratory/guessbook/Preview-GuestBook.png">
  <meta name="twitter:creator" content="@AntiAnkush">
  
  <!-- Additional Meta -->
  <meta name="description" content="Guestbook interactivo v2.0 con sistema de rankings mÃºltiples, estadÃ­sticas avanzadas, likes, comentarios y galerÃ­a en tiempo real. Herramientas profesionales de dibujo.">
  <meta name="keywords" content="dibujo, arte, canvas, pintura digital, guestbook, galerÃ­a, rankings, estadÃ­sticas, likes, comentarios, tiempo real, FenixLaboratory">
  <meta name="author" content="ThisIsFenix">
  <meta name="robots" content="index, follow">
  
  <!-- PWA Meta -->
  <meta name="theme-color" content="#ff6b35">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #ff6b35;
      --bg-dark: #1a1a1a;
      --bg-light: #2d2d2d;
      --text-primary: #f0f0f0;
      --text-secondary: #b0b0b0;
      --beta-color: #00ff88;
    }
    
    @keyframes betaPulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    /* Temas dinÃ¡micos */
    [data-theme="neon"] {
      --primary: #00ff88;
      --bg-dark: #0a0a0a;
      --bg-light: #1a1a1a;
    }
    [data-theme="retro"] {
      --primary: #ff6b9d;
      --bg-dark: #2d1b69;
      --bg-light: #3e2a7a;
    }
    [data-theme="hacker"] {
      --primary: #00ff00;
      --bg-dark: #000000;
      --bg-light: #0d1117;
    }
    [data-theme="sunset"] {
      --primary: #ff6b35;
      --bg-dark: #1a0f0a;
      --bg-light: #2d1a0f;
    }
    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Space Grotesk', sans-serif;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* Permitir selecciÃ³n en inputs */
    input, textarea, select, #commentInput, #commentAuthor {
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      -webkit-touch-callout: default !important;
    }
    .canvas-container {
      border: 2px solid var(--primary);
      border-radius: 8px;
      background: white;
      margin: 20px 0;
      display: inline-block;
      padding: 10px;
    }
    #drawCanvas {
      border-radius: 6px;
      cursor: crosshair;
    }
    .drawing-card {
      background: var(--bg-light);
      border: 1px solid rgba(255, 107, 53, 0.2);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .drawing-img {
      width: 100%;
      height: 200px;
      object-fit: contain;
      background: white;
      border-radius: 4px;
      transition: transform 0.3s ease;
      /* Asegurar que los GIFs se reproduzcan */
      image-rendering: auto;
      -webkit-image-rendering: auto;
    }
    .drawing-card:hover .drawing-img {
      transform: scale(1.02);
    }
    .drawing-card {
      transition: all 0.3s ease;
    }
    .drawing-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
    }
    
    /* Marcos especiales para rankings */
    .drawing-card.rank-1 {
      border: 2px solid #FFD700;
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
      background: var(--bg-light);
      position: relative;
    }
    .drawing-card.rank-1::after {
      content: 'ğŸ‘‘';
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 215, 0, 0.9);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      z-index: 5;
      animation: goldPulse 2s infinite;
    }
    .drawing-card.rank-1:hover {
      box-shadow: 0 8px 30px rgba(255, 215, 0, 0.6);
    }
    
    .drawing-card.rank-2 {
      border: 2px solid #C0C0C0;
      box-shadow: 0 4px 15px rgba(192, 192, 192, 0.3);
    }
    .drawing-card.rank-2::after {
      content: 'ğŸ¥ˆ';
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(192, 192, 192, 0.9);
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      z-index: 5;
    }
    
    .drawing-card.rank-3 {
      border: 2px solid #CD7F32;
      box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3);
    }
    .drawing-card.rank-3::after {
      content: 'ğŸ¥‰';
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(205, 127, 50, 0.9);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      z-index: 5;
    }
    
    @keyframes goldPulse {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.1); opacity: 1; }
    }
    
    @media (max-width: 768px) {
      .drawing-card.rank-1::after,
      .drawing-card.rank-2::after,
      .drawing-card.rank-3::after {
        width: 20px;
        height: 20px;
        font-size: 10px;
        top: 5px;
        right: 5px;
      }
      
      /* Ajustar indicador de fijado en mÃ³vil */
      .pinned-indicator {
        font-size: 0.6em !important;
        padding: 1px 4px !important;
      }
    }
    
    /* AnimaciÃ³n para elementos fijados */
    .drawing-card.pinned {
      animation: pinnedGlow 3s infinite;
    }
    
    @keyframes pinnedGlow {
      0%, 100% { box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3); }
      50% { box-shadow: 0 6px 25px rgba(255, 107, 53, 0.5); }
    }
    .btn-neon {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
      transition: all 0.3s ease;
    }
    .btn-neon:hover {
      background: var(--primary);
      color: var(--bg-dark);
    }
    .color-btn {
      width: 30px;
      height: 30px;
      border: 2px solid #fff;
      border-radius: 50%;
      margin: 2px;
      cursor: pointer;
    }
    .color-btn.active {
      border-color: var(--primary);
      box-shadow: 0 0 10px var(--primary);
    }
    
    /* Responsive canvas */
    @media (max-width: 768px) {
      #drawCanvas {
        touch-action: none;
      }
      .canvas-container {
        margin: 10px auto;
        touch-action: none;
        max-width: 95vw;
        padding: 5px;
        text-align: center;
      }
      .color-btn {
        width: 28px;
        height: 28px;
        margin: 2px;
        touch-action: manipulation;
      }
      #customColor {
        width: 45px;
        height: 28px;
      }
      
      /* Mejorar Ã¡rea de toque */
      .btn-tool, .btn-action, .btn-danger {
        min-height: 35px;
        min-width: 35px;
        touch-action: manipulation;
      }
      
      .btn-emoji {
        min-height: 35px;
        min-width: 35px;
        touch-action: manipulation;
      }
    }
    
    /* Sistema de Perfiles */
    .profile-circle {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), #ff8c42);
      border: 3px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .profile-circle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
    }
    
    .profile-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .profile-content {
      background: var(--bg-light);
      border-radius: 20px;
      padding: 30px;
      max-width: 800px;
      width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      border: 2px solid var(--primary);
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), #ff8c42);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      color: white;
      margin: 0 auto 20px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      background-size: cover;
      background-position: center;
      overflow: hidden;
    }
    
    .user-drawings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .user-drawing-item {
      background: var(--bg-dark);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--primary);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .user-drawing-item:hover {
      transform: scale(1.05);
    }
    
    .user-drawing-img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      background: white;
    }
    
    .user-drawing-info {
      padding: 8px;
      font-size: 0.8em;
      text-align: center;
    }
    
    .profile-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: var(--bg-dark);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid var(--primary);
    }
    
    .stat-number {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-top: 5px;
    }
    
    /* OrientaciÃ³n horizontal en mÃ³vil */
    @media (max-width: 768px) {
      #drawCanvas {
        width: 100%;
        height: 280px;
        max-height: 60vh;
      }
      .controls-compact {
        padding: 8px;
      }
      .control-row {
        gap: 4px;
      }
      
      .profile-circle {
        width: 50px;
        height: 50px;
        font-size: 1.2em;
        top: 15px;
        left: 15px;
      }
      
      .profile-content {
        padding: 20px;
        width: 95vw;
      }
      
      .profile-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .user-drawings-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 8px;
      }
      
      .user-drawing-img {
        height: 60px;
      }
      .control-group {
        padding: 4px 6px;
        gap: 4px;
      }
      .btn-tool, .btn-action, .btn-danger {
        padding: 3px 6px;
        height: 28px;
        font-size: 0.65em;
        min-height: 28px;
        min-width: 28px;
      }
      .btn-tool-sm, .btn-size, .btn-upload, .btn-filter, .btn-export {
        padding: 2px 4px;
        height: 26px;
        font-size: 0.55em;
        min-height: 26px;
      }
      .btn-emoji {
        width: 30px;
        height: 28px;
        font-size: 0.8em;
        min-height: 28px;
        min-width: 30px;
      }
      .color-btn {
        width: 24px;
        height: 24px;
        margin: 1px;
      }
      .size-slider {
        width: 50px;
      }
      .advanced-section {
        padding: 6px;
      }
      .user-row {
        padding: 8px;
      }
      .input-field, .select-field {
        padding: 4px 8px;
        font-size: 0.8em;
        min-width: 100px;
      }
      .btn-save {
        padding: 6px 12px;
        font-size: 0.8em;
      }
    }
    
    .tool-active {
      background: var(--primary) !important;
      color: white !important;
    }
    
    @keyframes sparkle {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      100% { transform: scale(1) rotate(180deg); opacity: 0; }
    }
    
    .sparkle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      pointer-events: none;
      animation: sparkle 0.6s ease-out forwards;
    }
    
    /* Controles Compactos */
    .controls-compact {
      background: var(--bg-light);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(255, 107, 53, 0.2);
    }
    
    .control-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0,0,0,0.1);
      padding: 8px 12px;
      border-radius: 8px;
    }
    
    .control-label {
      font-size: 1.1em;
      min-width: 20px;
      text-align: center;
    }
    
    .color-picker {
      width: 30px;
      height: 25px;
      border: 1px solid var(--primary);
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
    }
    
    .btn-tool, .btn-action {
      padding: 4px 8px;
      height: 28px;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 5px;
      font-size: 0.8em;
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn-tool-sm, .btn-size, .btn-upload, .btn-filter, .btn-export {
      padding: 4px 6px;
      height: 28px;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 5px;
      font-size: 0.7em;
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn-emoji {
      width: 32px;
      height: 28px;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 5px;
      font-size: 0.9em;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-tool:hover, .btn-tool-sm:hover, .btn-size:hover, .btn-upload:hover, 
    .btn-emoji:hover, .btn-filter:hover, .btn-action:hover, .btn-export:hover,
    .btn-tool.tool-active, .btn-size.tool-active {
      background: var(--primary);
      color: white;
    }
    
    .btn-danger {
      padding: 4px 8px;
      height: 28px;
      border: 1px solid #dc3545;
      background: transparent;
      color: #dc3545;
      border-radius: 5px;
      font-size: 0.8em;
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .btn-danger:hover {
      background: #dc3545;
      color: white;
    }
    
    .size-slider {
      width: 70px;
      accent-color: var(--primary);
    }
    
    .size-display {
      font-size: 0.8em;
      color: var(--primary);
      font-weight: bold;
      min-width: 25px;
    }
    
    .btn-toggle {
      padding: 6px 12px;
      border: 1px solid var(--text-secondary);
      background: transparent;
      color: var(--text-secondary);
      border-radius: 15px;
      font-size: 0.8em;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-toggle:hover {
      background: var(--text-secondary);
      color: var(--bg-dark);
    }
    
    .advanced-section {
      background: rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
    }
    
    .file-input {
      width: 80px;
      font-size: 0.7em;
      padding: 2px;
      background: var(--bg-dark);
      border: 1px solid var(--primary);
      color: var(--text-primary);
      border-radius: 3px;
    }
    
    .user-row {
      background: rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 12px;
    }
    
    .input-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .input-icon {
      font-size: 1.1em;
    }
    
    .input-field, .select-field {
      padding: 6px 10px;
      border: 1px solid var(--primary);
      background: var(--bg-dark);
      color: var(--text-primary);
      border-radius: 5px;
      font-size: 0.9em;
      min-width: 100px;
    }
    
    .btn-save {
      padding: 8px 16px;
      border: 2px solid var(--primary);
      background: var(--primary);
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9em;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-save:hover {
      background: transparent;
      color: var(--primary);
      transform: scale(1.05);
    }
    
    .btn-save:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-save:disabled:hover {
      background: var(--primary);
      color: white;
      transform: none;
    }
    
    .btn-back {
      padding: 6px 12px;
      border: 1px solid var(--text-secondary);
      background: transparent;
      color: var(--text-secondary);
      border-radius: 5px;
      font-size: 0.8em;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    
    .btn-back:hover {
      background: var(--text-secondary);
      color: var(--bg-dark);
      text-decoration: none;
    }
    
    .control-label {
      font-size: 0.8em;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    
    @media (max-width: 768px) {
      .control-label {
        font-size: 0.7em;
      }
      
      .control-row {
        gap: 8px;
        flex-direction: column;
      }
      
      .control-group {
        padding: 6px;
        gap: 6px;
        flex-direction: row;
        align-items: center;
        min-width: auto;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .control-group .d-flex {
        justify-content: center;
      }
      
      .btn-tool, .btn-action, .btn-danger {
        padding: 3px 6px;
        height: 30px;
        font-size: 0.7em;
      }
      
      .btn-tool-sm, .btn-size, .btn-upload, .btn-filter, .btn-export {
        padding: 3px 4px;
        height: 30px;
        font-size: 0.6em;
      }
      
      .btn-emoji {
        width: 35px;
        height: 30px;
        font-size: 0.9em;
      }
      
      .size-slider {
        width: 60px;
      }
      
      .input-field, .select-field {
        min-width: 120px;
        font-size: 0.9em;
      }
      
      .user-row .d-flex {
        flex-direction: column;
        gap: 8px;
      }
      
      .input-field, .select-field {
        min-width: 140px;
      }
      
      .btn-save {
        padding: 10px 20px;
        font-size: 1em;
      }
      
      .advanced-section {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <script>
    // Aplicar tema desde localStorage
    const initialTheme = localStorage.getItem('selectedTheme') || 'default';
    if (initialTheme !== 'default') {
      document.documentElement.setAttribute('data-theme', initialTheme);
    }
  </script>
  <!-- CÃ­rculo de Perfil -->
  <div id="profileCircle" class="profile-circle" title="Mi Perfil">
    ğŸ‘¤
  </div>
  
  <div class="container py-4">
    <div class="text-center mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="flex-grow-1">
          <h1 style="color: var(--primary); margin: 0;">ğŸ¨ Guestbook de Dibujos</h1>
          <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 0.9em;">
            <strong style="color: var(--primary);">v2.0</strong> â€¢ Sistema de Rankings â€¢ EstadÃ­sticas en Tiempo Real
          </p>
        </div>
        <select id="themeSelector" class="form-select" style="width: 150px; background: var(--bg-light); border: 1px solid var(--primary); color: var(--text-primary);">
          <option value="default">ğŸ”¥ Default</option>
          <option value="neon">ğŸ’š Neon</option>
          <option value="retro">ğŸ’œ Retro</option>
          <option value="hacker">ğŸ’š Hacker</option>
          <option value="sunset">ğŸ§¡ Sunset</option>
        </select>
      </div>
      
      <!-- Badges de caracterÃ­sticas -->
      <div class="d-flex justify-content-center gap-2 flex-wrap">
        <span class="badge" style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.8em;">
          ğŸ† Rankings MÃºltiples
        </span>
        <span class="badge" style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.8em;">
          ğŸ“Š EstadÃ­sticas Avanzadas
        </span>
        <span class="badge" style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.8em;">
          ğŸ’¬ Sistema Social
        </span>
        <span class="badge" style="background: var(--primary); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.8em;">
          ğŸ”„ Tiempo Real
        </span>
      </div>
    </div>
    
    <!-- Canvas para dibujar -->
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="canvas-container text-center" style="position: relative;">
          <!-- Fondo GIF animado -->
          <div id="gifBackground" style="position: absolute; top: 10px; left: 10px; width: 600px; height: 400px; z-index: 1; display: none; border-radius: 6px; overflow: hidden;">
            <img id="gifBackgroundImg" style="width: 100%; height: 100%; object-fit: cover;" alt="Fondo GIF">
          </div>
          <!-- Canvas transparente encima -->
          <canvas id="drawCanvas" width="600" height="400" style="position: relative; z-index: 2; background: transparent;"></canvas>
          <!-- Contenedor para stickers GIF animados -->
          <div id="gifStickersContainer" style="position: absolute; top: 10px; left: 10px; width: 600px; height: 400px; z-index: 3; pointer-events: none;"></div>
          <div class="mt-2">
            <small style="color: var(--text-secondary);">ğŸ’¡ Gira tu mÃ³vil para mÃ¡s espacio de dibujo</small>
          </div>
        </div>
        
        <!-- Controles Compactos -->
        <div class="controls-compact mb-4">
          <!-- Fila 1: Herramientas BÃ¡sicas -->
          <div class="control-row mb-3">
            <div class="control-group">
              <div class="d-flex align-items-center gap-2">
                <span class="control-label" title="Colores">ğŸ¨ Colores</span>
              </div>
              <div class="d-flex gap-1">
                <div class="color-btn active" style="background: #000" data-color="#000000" title="Negro"></div>
                <div class="color-btn" style="background: #ff6b35" data-color="#ff6b35" title="Naranja"></div>
                <div class="color-btn" style="background: #f00" data-color="#ff0000" title="Rojo"></div>
                <div class="color-btn" style="background: #0f0" data-color="#00ff00" title="Verde"></div>
                <div class="color-btn" style="background: #00f" data-color="#0000ff" title="Azul"></div>
                <div class="color-btn" style="background: #fff" data-color="#ffffff" title="Blanco"></div>
                <input type="color" id="customColor" value="#ff6b35" class="color-picker" title="Color personalizado">
              </div>
            </div>
            
            <div class="control-group">
              <div class="d-flex align-items-center gap-2">
                <span class="control-label" title="Herramientas">ğŸ› ï¸ Herramientas</span>
              </div>
              <div class="d-flex gap-1">
                <button id="brushBtn" class="btn-tool tool-active" title="Pincel (B)">ğŸ–Œï¸ Pincel</button>
                <button id="stickerMoveBtn" class="btn-tool" title="Mover stickers">âœ‹ Mover</button>
                <button id="eraserBtn" class="btn-tool" title="Borrador (E)">ğŸ§½ Borrar</button>
                <button id="textBtn" class="btn-tool" title="Texto (T)">ğŸ…°ï¸ Texto</button>
                <button id="circleBtn" class="btn-tool" title="CÃ­rculo (C)">â­• CÃ­rculo</button>
              </div>
            </div>
            
            <div class="control-group">
              <div class="d-flex align-items-center gap-2">
                <span class="control-label" title="Grosor y opacidad">ğŸ“ Pincel</span>
              </div>
              <div class="d-flex gap-1 align-items-center">
                <input type="range" id="brushSize" min="1" max="20" value="3" class="size-slider" title="Grosor">
                <span id="sizeDisplay" class="size-display">3px</span>
                <input type="range" id="opacitySlider" min="10" max="100" value="100" class="size-slider" title="Opacidad">
                <span id="opacityDisplay" class="size-display">100%</span>
              </div>
            </div>
            
            <div class="control-group">
              <div class="d-flex align-items-center gap-2">
                <span class="control-label" title="Acciones rÃ¡pidas">âš¡ Acciones</span>
              </div>
              <div class="d-flex gap-1">
                <button id="undoBtn" class="btn-action" title="Deshacer (Ctrl+Z)">â†¶ Deshacer</button>
                <button id="clearBtn" class="btn-danger" title="Limpiar todo">ğŸ—‘ï¸ Limpiar</button>
              </div>
            </div>
          </div>
          
          <!-- Fila 2: Herramientas Avanzadas (Colapsable) -->
          <div class="text-center mb-2">
            <button id="toggleAdvanced" class="btn-toggle">âš™ï¸ MÃ¡s opciones</button>
          </div>
          
          <div id="advancedControls" class="advanced-section" style="display: none;">
            <div class="control-row mb-2">
              <div class="control-group">
                <span class="control-label" title="Herramientas avanzadas">ğŸ”§</span>
                <div class="d-flex gap-1">
                  <button id="sprayBtn" class="btn-tool-sm" title="Spray (S)">ğŸ’¨ Spray</button>
                  <button id="bucketBtn" class="btn-tool-sm" title="Relleno (F)">ğŸª£ Relleno</button>
                  <button id="eyedropperBtn" class="btn-tool-sm" title="Cuentagotas (I)">ğŸ’§ Cuentagotas</button>
                  <button id="selectBtn" class="btn-tool-sm" title="Seleccionar Ã¡rea">ğŸ“¦ Seleccionar</button>
                  <button id="lineBtn" class="btn-tool-sm" title="LÃ­nea (L)">â€” LÃ­nea</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Herramientas pro">âœ¨</span>
                <div class="d-flex gap-1">
                  <button id="gradientBtn" class="btn-tool-sm" title="Gradiente (G)">ğŸŒˆ Gradiente</button>
                  <button id="patternBtn" class="btn-tool-sm" title="Patrones (P)">ğŸ”³ PatrÃ³n</button>
                  <button id="symmetryBtn" class="btn-tool-sm" title="SimetrÃ­a (Y)">âš™ï¸ SimetrÃ­a</button>
                  <button id="neonBtn" class="btn-tool-sm" title="NeÃ³n (N)">ğŸ’¡ NeÃ³n</button>
                  <button id="watercolorBtn" class="btn-tool-sm" title="Acuarela (W)">ğŸ¨ Acuarela</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Herramientas tÃ©cnicas">ğŸ”§</span>
                <div class="d-flex gap-1">
                  <button id="rulerBtn" class="btn-tool-sm" title="Regla (R)">ğŸ“ Regla</button>
                  <button id="perspectiveBtn" class="btn-tool-sm" title="Perspectiva (V)">ğŸ“Š Perspectiva</button>
                  <button id="cloneBtn" class="btn-tool-sm" title="Clonar (K)">ğŸ“‹ Clonar</button>
                  <button id="histogramBtn" class="btn-tool-sm" title="Histograma (H)">ğŸ“ˆ Histograma</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Presets de pincel">ğŸ–Œï¸</span>
                <div class="d-flex gap-1">
                  <button id="presetFine" class="btn-tool-sm" title="Pincel fino">âœï¸ Fino</button>
                  <button id="presetThick" class="btn-tool-sm" title="Pincel grueso">ğŸ–ï¸ Grueso</button>
                  <button id="presetArt" class="btn-tool-sm" title="Pincel artÃ­stico">ğŸ¨ Arte</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="TamaÃ±o del canvas">ğŸ“</span>
                <div class="d-flex gap-1 flex-wrap">
                  <button id="smallCanvas" class="btn-size" title="PequeÃ±o (400x300)">ğŸ“± 400x300</button>
                  <button id="mediumCanvas" class="btn-size tool-active" title="Mediano (600x400)">ğŸ’» 600x400</button>
                  <button id="largeCanvas" class="btn-size" title="Grande (800x600)">ğŸ–¥ï¸ 800x600</button>
                  <button id="wideCanvas" class="btn-size" title="PanorÃ¡mico (800x400)">ğŸ“º 800x400</button>
                  <button id="squareCanvas" class="btn-size" title="Cuadrado (600x600)">â¬œ 600x600</button>
                  <button id="tallCanvas" class="btn-size" title="Vertical (400x800)">ğŸ“± 400x800</button>
                  <button id="ultraWideCanvas" class="btn-size" title="Ultra Ancho (1000x400)">ğŸ“º 1000x400</button>
                  <button id="customCanvas" class="btn-size" title="Personalizado (lÃ­mite Firebase)">âš™ï¸ Custom</button>
                </div>
              </div>
              

              
              <div class="control-group">
                <span class="control-label" title="Fondos de imagen">ğŸŒ„</span>
                <div class="d-flex gap-1 flex-wrap align-items-center">
                  <input type="file" id="bgUpload" accept=".png,.jpg,.jpeg,.gif" class="file-input" title="Subir fondo personalizado" style="width: 120px;">
                  <button id="setBgBtn" class="btn-upload" title="Aplicar fondo subido" disabled>ğŸ–¼ï¸ Aplicar</button>
                  <button id="clearBgBtn" class="btn-tool-sm" title="Quitar fondo">âŒ Quitar</button>
                </div>
                <div class="mt-1" style="font-size: 0.7em; color: var(--text-secondary); text-align: center;">
                  ğŸ“¸ PNG/JPG en canvas â€¢ ğŸ¬ GIF como fondo visual animado<br>
                  <strong style="color: var(--primary);">âœ¨ Dibuja encima del GIF animado</strong><br>
                  <span style="color: #ffc107;">âš ï¸ GIFs >800KB no se guardan en Firebase (solo locales)</span>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Stickers PNG personalizados">ğŸ·ï¸</span>
                <div class="d-flex gap-1 flex-wrap align-items-center">
                  <input type="file" id="stickerUpload" accept=".png,.jpg,.jpeg,.gif" class="file-input" title="Subir sticker personalizado" style="width: 120px;">
                  <button id="placeStickerBtn" class="btn-upload" title="Colocar sticker subido" disabled>ğŸ“Œ Colocar</button>
                </div>
                <div class="mt-1" style="font-size: 0.7em; color: var(--text-secondary); text-align: center;">
                  ğŸ–¼ï¸ PNG/JPG en canvas â€¢ ğŸ¦ GIF como elemento animado<br>
                  <strong style="color: var(--primary);">âœ¨ GIFs totalmente animados y arrastrables</strong><br>
                  <span style="color: #ffc107;">âš ï¸ GIFs >800KB no se guardan en Firebase (solo locales)</span>
                </div>
              </div>
            </div>
            
            <div class="control-row">
              <div class="control-group">
                <span class="control-label" title="Filtros de imagen">ğŸ¨</span>
                <div class="d-flex gap-1">
                  <button id="blurBtn" class="btn-filter" title="Filtro blur">ğŸŒ«ï¸ Blur</button>
                  <button id="pixelBtn" class="btn-filter" title="Filtro pixel art">ğŸ–¼ï¸ Pixel</button>
                  <button id="vintageBtn" class="btn-filter" title="Filtro vintage">ğŸ¨ Vintage</button>
                  <button id="oilBtn" class="btn-filter" title="Efecto Ã³leo">ğŸ–¼ï¸ Ã“leo</button>
                  <button id="charcoalBtn" class="btn-filter" title="Carboncillo">âš« CarbÃ³n</button>
                  <button id="clearFilterBtn" class="btn-filter" title="Quitar filtros">âŒ Quitar</button>
                </div>
              </div>
              
              <div class="control-group">
                <span class="control-label" title="Utilidades">ğŸ”</span>
                <div class="d-flex gap-1">
                  <button id="redoBtn" class="btn-action" title="Rehacer (Ctrl+Y)">â†· Rehacer</button>
                  <button id="zoomBtn" class="btn-action" title="Zoom in/out">ğŸ” Zoom</button>
                  <button id="exportPNG" class="btn-export" title="Descargar PNG">ğŸ’¾ Exportar</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Fila 3: InformaciÃ³n del Usuario -->
          <div class="user-row mt-3">
            <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
              <div class="input-group">
                <span class="input-icon" title="Nombre del artista">ğŸ‘¤</span>
                <input type="text" id="authorName" placeholder="Tu nombre" class="input-field" title="Escribe tu nombre">
                <button id="useProfileName" class="btn-tool-sm" title="Usar nombre del perfil" style="margin-left: 5px;">ğŸ‘¤</button>
              </div>
              <div class="input-group">
                <span class="input-icon" title="CategorÃ­a del dibujo">ğŸ·ï¸</span>
                <select id="categorySelect" class="select-field" title="Selecciona una categorÃ­a">
                  <option value="Arte">ğŸ¨ Arte</option>
                  <option value="Meme">ğŸ˜‚ Meme</option>
                  <option value="Divertido">ğŸ‰ Divertido</option>
                  <option value="Abstracto">ğŸŒŒ Abstracto</option>
                  <option value="Otro">âœ¨ Otro</option>
                </select>
              </div>
              <button id="saveBtn" class="btn-save" title="Guardar dibujo en la galerÃ­a">
                <span id="saveText">ğŸš€ Guardar</span>
                <span id="saveLoader" style="display: none;">â³ Guardando...</span>
              </button>
            </div>
          </div>
          
          <div class="text-center mt-3">
            <div id="unsavedIndicator" style="display: none; color: #ffc107; margin-bottom: 10px; font-size: 0.8em;">
              âš ï¸ Tienes cambios sin guardar
            </div>
            <div class="d-flex justify-content-center gap-2 flex-wrap">
              <a href="../index.html" class="btn-back">ğŸ  Volver al Lab</a>
              <a href="guestbook-betaarea.html" class="btn-back" style="border: 2px solid var(--beta-color, #00ff88); color: var(--beta-color, #00ff88); animation: betaPulse 2s infinite;">ğŸ§ª Beta Area</a>
              <button id="fullscreenBtn" class="btn-back" style="border: none; background: transparent;">ğŸ“± Pantalla completa</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- GalerÃ­a de dibujos -->
    <hr style="border-color: var(--primary);">
    <div class="text-center mb-4">
      <h2 style="color: var(--primary); margin-bottom: 15px;">ğŸ›ï¸ GalerÃ­a Interactiva</h2>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">
        ğŸŒ GalerÃ­a pÃºblica con <strong style="color: var(--primary);">rankings en tiempo real</strong>, sistema de likes y comentarios<br>
        <small>ğŸ”„ ActualizaciÃ³n automÃ¡tica con Firebase â€¢ ğŸ“Š EstadÃ­sticas avanzadas â€¢ ğŸ† Top rankings</small>
      </p>
      
      <!-- Indicadores de caracterÃ­sticas -->
      <div class="d-flex justify-content-center gap-3 flex-wrap mb-4" style="font-size: 0.9em;">
        <span style="background: var(--bg-light); padding: 6px 12px; border-radius: 15px; border: 1px solid var(--primary);">
          ğŸ† <strong style="color: var(--primary);">Rankings</strong>
        </span>
        <span style="background: var(--bg-light); padding: 6px 12px; border-radius: 15px; border: 1px solid var(--primary);">
          â¤ï¸ <strong style="color: var(--primary);">Likes</strong>
        </span>
        <span style="background: var(--bg-light); padding: 6px 12px; border-radius: 15px; border: 1px solid var(--primary);">
          ğŸ’¬ <strong style="color: var(--primary);">Comentarios</strong>
        </span>
        <span style="background: var(--bg-light); padding: 6px 12px; border-radius: 15px; border: 1px solid var(--primary);">
          ğŸ“Š <strong style="color: var(--primary);">EstadÃ­sticas</strong>
        </span>
      </div>
    </div>
    
    <!-- Controles de filtrado y paginaciÃ³n -->
    <div class="row justify-content-center mb-4">
      <div class="col-md-10">
        <div style="background: var(--bg-light); border-radius: 15px; padding: 20px; border: 1px solid var(--primary);">
          <div class="d-flex justify-content-center gap-2 flex-wrap mb-3">
            <div class="input-group" style="width: 200px;">
              <span class="input-group-text" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--primary);">ğŸ”</span>
              <input type="text" id="searchAuthor" placeholder="Buscar por autor" class="form-control" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--text-primary);">
            </div>
            <div class="input-group" style="width: 180px;">
              <span class="input-group-text" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--primary);">ğŸ·ï¸</span>
              <select id="filterCategory" class="form-select" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--text-primary);">
                <option value="">Todas las categorÃ­as</option>
                <option value="Arte">ğŸ¨ Arte</option>
                <option value="Meme">ğŸ˜‚ Meme</option>
                <option value="Divertido">ğŸ‰ Divertido</option>
                <option value="Abstracto">ğŸŒŒ Abstracto</option>
                <option value="Otro">âœ¨ Otro</option>
              </select>
            </div>
            <button id="clearFilters" class="btn btn-outline-secondary">âŒ Limpiar</button>
          </div>
          
          <div class="d-flex justify-content-center align-items-center gap-3">
            <button id="prevPage" class="btn btn-outline-primary" disabled>
              <i class="bi bi-chevron-left"></i> Anterior
            </button>
            <span id="pageInfo" style="color: var(--text-primary); padding: 8px 16px; background: var(--bg-dark); border-radius: 20px; border: 1px solid var(--primary); font-weight: bold;">
              PÃ¡gina 1
            </span>
            <button id="nextPage" class="btn btn-outline-primary">
              Siguiente <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    
    <div id="gallery" class="row">
      <div class="col-12 text-center" style="color: var(--text-secondary);">
        <div class="spinner-border" role="status" style="color: var(--primary);">
          <span class="visually-hidden">Cargando dibujos...</span>
        </div>
        <p class="mt-2">Cargando galerÃ­a con sistema de rankings...</p>
      </div>
    </div>
    
    <!-- Apartado de Sugerencias -->
    <hr style="border-color: var(--primary);">
    <div class="text-center mb-4">
      <h2 style="color: var(--primary); margin-bottom: 15px;">ğŸ’¡ Sugerencias y Feedback</h2>
      <p style="color: var(--text-secondary); margin-bottom: 20px;">
        ğŸš€ AyÃºdanos a mejorar el guestbook con tus ideas, reportes de bugs y sugerencias<br>
        <small>ğŸ“ Todas las sugerencias son revisadas â€¢ ğŸ”„ Actualizaciones constantes â€¢ ğŸ† Tu feedback importa</small>
      </p>
    </div>
    
    <!-- Formulario de Sugerencias -->
    <div class="row justify-content-center mb-4">
      <div class="col-md-8">
        <div style="background: var(--bg-light); border-radius: 15px; padding: 25px; border: 1px solid var(--primary);">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label style="color: var(--text-primary); margin-bottom: 8px; font-weight: bold;">ğŸ‘¤ Tu Nombre (Opcional)</label>
                <input type="text" id="suggestionAuthor" placeholder="AnÃ³nimo" class="form-control" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--text-primary);">
              </div>
              
              <div class="mb-3">
                <label style="color: var(--text-primary); margin-bottom: 8px; font-weight: bold;">ğŸ·ï¸ Tipo de Sugerencia</label>
                <select id="suggestionType" class="form-select" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--text-primary);">
                  <option value="Mejora">âœ¨ Mejora/Nueva FunciÃ³n</option>
                  <option value="Bug">ğŸ› Reporte de Bug</option>
                  <option value="UI/UX">ğŸ¨ Interfaz/DiseÃ±o</option>
                  <option value="Performance">âš¡ Rendimiento</option>
                  <option value="Otro">ğŸ’¬ Otro</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label style="color: var(--text-primary); margin-bottom: 8px; font-weight: bold;">ğŸ“¸ Imagen (Opcional)</label>
                <input type="file" id="suggestionImage" accept=".png,.jpg,.jpeg,.gif" class="form-control" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--text-primary);">
                <small style="color: var(--text-secondary);">Sube PNG/JPG/GIF si es necesario</small>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="mb-3">
                <label style="color: var(--text-primary); margin-bottom: 8px; font-weight: bold;">ğŸ“ Tu Sugerencia</label>
                <textarea id="suggestionText" rows="8" placeholder="Describe tu sugerencia, idea o problema..." class="form-control" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--text-primary); resize: vertical;"></textarea>
                <div class="mt-2" style="font-size: 0.8em; color: var(--text-secondary); padding: 8px; background: rgba(40, 167, 69, 0.1); border-radius: 6px; border-left: 3px solid #28a745;">
                  âœ… <strong>Bug corregido:</strong> "Deshacer una acciÃ³n afecta la opacidad del resto de trazos" - Â¡Sigue reportando bugs!
                </div>
              </div>
              
              <button id="submitSuggestion" class="btn w-100" style="background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold;">
                <span id="suggestionBtnText">ğŸš€ Enviar Sugerencia</span>
                <span id="suggestionLoader" style="display: none;">â³ Enviando...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- GalerÃ­a de Sugerencias -->
    <div class="row justify-content-center mb-4">
      <div class="col-md-10">
        <div style="background: var(--bg-light); border-radius: 15px; padding: 20px; border: 1px solid var(--primary);">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 style="color: var(--primary); margin: 0;">ğŸ“‹ Sugerencias Recientes</h4>
            <button id="adminBtn" class="btn btn-sm btn-outline-warning" onclick="toggleAdminMode()">ğŸ”‘ Admin</button>
          </div>
          
          <div class="d-flex justify-content-center gap-2 flex-wrap mb-3">
            <div class="input-group" style="width: 200px;">
              <span class="input-group-text" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--primary);">ğŸ”</span>
              <input type="text" id="searchSuggestions" placeholder="Buscar sugerencias" class="form-control" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--text-primary);">
            </div>
            <div class="input-group" style="width: 180px;">
              <span class="input-group-text" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--primary);">ğŸ·ï¸</span>
              <select id="filterSuggestionType" class="form-select" style="background: var(--bg-dark); border: 1px solid var(--primary); color: var(--text-primary);">
                <option value="">Todos los tipos</option>
                <option value="Mejora">âœ¨ Mejoras</option>
                <option value="Bug">ğŸ› Bugs</option>
                <option value="UI/UX">ğŸ¨ UI/UX</option>
                <option value="Performance">âš¡ Performance</option>
                <option value="Otro">ğŸ’¬ Otro</option>
              </select>
            </div>
            <button id="clearSuggestionFilters" class="btn btn-outline-secondary">âŒ Limpiar</button>
          </div>
          
          <div id="suggestionsGallery" class="row">
            <div class="col-12 text-center" style="color: var(--text-secondary);">
              <div class="spinner-border" role="status" style="color: var(--primary);">
                <span class="visually-hidden">Cargando sugerencias...</span>
              </div>
              <p class="mt-2">Cargando sugerencias de la comunidad...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, updateDoc, doc, getDoc, deleteDoc, where, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ConfiguraciÃ³n Firebase (pÃºblica para GitHub Pages)
    const firebaseConfig = {
      apiKey: "AIzaSyCZk8rs_Vq9ZGgOEiP3_P6zUvZoM1QQOAM",
      authDomain: "fenix-guestbook.firebaseapp.com",
      projectId: "fenix-guestbook",
      storageBucket: "fenix-guestbook.firebasestorage.app",
      messagingSenderId: "90606615201",
      appId: "1:90606615201:web:7126a42ca59b57bdc58ee0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Verificar conexiÃ³n a Firebase
    async function testFirebaseConnection() {
      try {
        const testQuery = query(collection(db, 'dibujos'), orderBy('timestamp', 'desc'));
        console.log('âœ… ConexiÃ³n a Firebase exitosa');
        return true;
      } catch (error) {
        console.error('âŒ Error de conexiÃ³n a Firebase:', error);
        if (error.code === 'permission-denied') {
          console.error('Las reglas de Firestore no permiten acceso desde este dominio');
        }
        return false;
      }
    }
    
    // Probar conexiÃ³n al cargar
    testFirebaseConnection();

    // Canvas setup
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let currentColor = '#000000';
    let currentSize = 3;
    let currentOpacity = 1;
    let isEraser = false;
    let strokeCount = 0;
    let drawingHistory = [];
    let historyStep = -1;
    
    // Variables para stickers
    let stickers = [];
    let selectedSticker = null;
    let isDragging = false;
    let currentStickerImage = null;

    // Configurar canvas
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    // Ajustar canvas inicial en mÃ³vil
    function adjustCanvasForMobile() {
      const container = canvas.parentElement;
      
      if (window.innerWidth <= 768) {
        const containerWidth = window.innerWidth - 50;
        const maxHeight = window.innerHeight * 0.4;
        
        if (canvas.width > containerWidth) {
          const scale = containerWidth / canvas.width;
          canvas.style.width = containerWidth + 'px';
          canvas.style.height = (canvas.height * scale) + 'px';
          
          if (canvas.height * scale > maxHeight) {
            const heightScale = maxHeight / canvas.height;
            canvas.style.width = (canvas.width * heightScale) + 'px';
            canvas.style.height = maxHeight + 'px';
          }
        }
      } else {
        canvas.style.width = canvas.width + 'px';
        canvas.style.height = canvas.height + 'px';
      }
      
      // Ajustar el contenedor al tamaÃ±o del canvas
      setTimeout(() => {
        container.style.width = (canvas.offsetWidth + 10) + 'px';
        container.style.height = (canvas.offsetHeight + 10) + 'px';
      }, 100);
    }
    
    // Ajustar en carga y cambio de orientaciÃ³n
    adjustCanvasForMobile();
    window.addEventListener('resize', adjustCanvasForMobile);
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        adjustCanvasForMobile();
        // Mostrar tip de orientaciÃ³n
        if (window.innerWidth <= 768) {
          const tip = document.createElement('div');
          tip.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            font-size: 0.8em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
          `;
          tip.textContent = window.innerHeight < window.innerWidth ? 
            'ğŸ¨ Â¡MÃ¡s espacio para dibujar!' : 
            'ğŸ’¡ Gira para mÃ¡s espacio';
          document.body.appendChild(tip);
          setTimeout(() => tip.remove(), 2000);
        }
      }, 100);
    });
    
    // Toggle advanced controls
    document.getElementById('toggleAdvanced').addEventListener('click', () => {
      const advanced = document.getElementById('advancedControls');
      const btn = document.getElementById('toggleAdvanced');
      if (advanced.style.display === 'none') {
        advanced.style.display = 'block';
        btn.innerHTML = 'âš™ï¸ Menos opciones';
      } else {
        advanced.style.display = 'none';
        btn.innerHTML = 'âš™ï¸ MÃ¡s opciones';
      }
    });
    
    // Guardar estado inicial
    saveState();
    
    function saveState() {
      historyStep++;
      if (historyStep < drawingHistory.length) {
        drawingHistory.length = historyStep;
      }
      
      // Crear un canvas temporal solo con el dibujo base (sin stickers)
      const baseCanvas = document.createElement('canvas');
      baseCanvas.width = canvas.width;
      baseCanvas.height = canvas.height;
      const baseCtx = baseCanvas.getContext('2d');
      
      // Copiar canvas actual
      baseCtx.drawImage(canvas, 0, 0);
      
      // Remover stickers del canvas base
      stickers.forEach(sticker => {
        if (sticker && sticker.image) {
          baseCtx.globalCompositeOperation = 'destination-out';
          baseCtx.fillRect(sticker.x, sticker.y, sticker.width, sticker.height);
        }
      });
      
      // Guardar solo el dibujo base
      drawingHistory.push(baseCanvas.toDataURL());
    }



    // Eventos de dibujo - mouse para PC
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events para mÃ³vil - convertir a eventos mouse
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (e.touches && e.touches.length > 0) {
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY,
          bubbles: true
        });
        canvas.dispatchEvent(mouseEvent);
      }
    }, { passive: false });
    
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (e.touches && e.touches.length > 0) {
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY,
          bubbles: true
        });
        canvas.dispatchEvent(mouseEvent);
      }
    }, { passive: false });
    
    canvas.addEventListener('touchend', (e) => {
      e.preventDefault();
      if (e.changedTouches && e.changedTouches.length > 0) {
        const touch = e.changedTouches[0];
        const mouseEvent = new MouseEvent('mouseup', {
          clientX: touch.clientX,
          clientY: touch.clientY,
          bubbles: true
        });
        canvas.dispatchEvent(mouseEvent);
      }
    }, { passive: false });
    

    
    // Prevenir scroll y zoom en mÃ³vil
    document.body.addEventListener('touchstart', e => {
      if (e.target === canvas || canvas.contains(e.target)) {
        e.preventDefault();
      }
    }, { passive: false });
    
    document.body.addEventListener('touchend', e => {
      if (e.target === canvas || canvas.contains(e.target)) {
        e.preventDefault();
      }
    }, { passive: false });
    
    document.body.addEventListener('touchmove', e => {
      if (e.target === canvas || canvas.contains(e.target)) {
        e.preventDefault();
      }
    }, { passive: false });
    
    // Prevenir zoom con pellizco
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('gesturechange', e => e.preventDefault());
    document.addEventListener('gestureend', e => e.preventDefault());

    function startDrawing(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      
      if (currentTool === 'stickerMove') {
        console.log('Intentando agarrar sticker en:', x, y);
        console.log('Stickers disponibles:', stickers.length);
        selectedSticker = findStickerAt(x, y);
        if (selectedSticker) {
          console.log('Sticker seleccionado:', selectedSticker);
          isDragging = true;
          canvas.style.cursor = 'grabbing';
          // Prevenir scroll en mÃ³vil durante arrastre
          if (window.innerWidth <= 768) {
            e.preventDefault();
            document.body.style.overflow = 'hidden';
          }
        } else {
          console.log('No se encontrÃ³ sticker');
        }
        return;
      }
      
      isDrawing = true;
      
      if (currentTool === 'select') {
        isSelecting = true;
        selectionStart = { x, y };
        return;
      }
      
      if (currentTool === 'brush' || currentTool === 'spray' || currentTool === 'eraser') {
        ctx.beginPath();
        ctx.moveTo(x, y);
      } else if (['circle', 'rect', 'line'].includes(currentTool)) {
        isShapeDrawing = true;
        shapeStartX = x;
        shapeStartY = y;
      } else if (currentTool === 'text') {
        const text = prompt('Escribe tu texto:');
        if (text) {
          ctx.font = `${currentSize * 3}px Arial`;
          ctx.fillStyle = currentColor;
          ctx.fillText(text, x, y);
          saveState();
        }
      }
    }

    function draw(e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      
      if (currentTool === 'stickerMove' && isDragging && selectedSticker) {
        // Centrar el sticker en el punto de toque
        const centerOffsetX = (selectedSticker.width || 60) / 2;
        const centerOffsetY = (selectedSticker.height || 60) / 2;
        selectedSticker.x = x - centerOffsetX;
        selectedSticker.y = y - centerOffsetY;
        
        // Mantener dentro del canvas
        selectedSticker.x = Math.max(0, Math.min(canvas.width - (selectedSticker.width || 60), selectedSticker.x));
        selectedSticker.y = Math.max(0, Math.min(canvas.height - (selectedSticker.height || 60), selectedSticker.y));
        
        // Redibujar inmediatamente para mejor respuesta visual
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Restaurar dibujo base
        if (drawingHistory.length > 0) {
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0);
            
            // Dibujar todos los stickers
            stickers.forEach(sticker => {
              if (sticker && sticker.image) {
                ctx.drawImage(sticker.image, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
              }
            });
          };
          img.src = drawingHistory[drawingHistory.length - 1];
        } else {
          // Solo dibujar stickers
          stickers.forEach(sticker => {
            if (sticker && sticker.image) {
              ctx.drawImage(sticker.image, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
            }
          });
        }
        
        // Prevenir scroll en mÃ³vil
        if (window.innerWidth <= 768) {
          e.preventDefault();
        }
        return;
      }
      
      if (!isDrawing) return;
      
      if (currentTool === 'select' && isSelecting) {
        selectionEnd = { x, y };
        drawSelection();
        return;
      }
      
      ctx.lineWidth = currentSize;
      
      if (currentTool === 'brush' || currentTool === 'eraser') {
        if (currentTool === 'eraser') {
          ctx.globalCompositeOperation = 'destination-out';
          ctx.globalAlpha = 1;
        } else {
          ctx.globalCompositeOperation = 'source-over';
          ctx.strokeStyle = currentColor;
          ctx.globalAlpha = currentOpacity;
          
          // Aplicar efectos especiales
          if (neonGlow) {
            ctx.shadowColor = currentColor;
            ctx.shadowBlur = 10;
          }
          
          if (watercolorMode) {
            ctx.globalAlpha = currentOpacity * 0.3;
            ctx.lineWidth = currentSize * (1 + Math.random() * 0.5);
          }
        }
        
        ctx.lineTo(x, y);
        ctx.stroke();
        
        // Dibujo simÃ©trico
        if (symmetryMode && currentTool === 'brush') {
          ctx.save();
          if (symmetryAxis === 'vertical') {
            ctx.scale(-1, 1);
            ctx.translate(-canvas.width, 0);
          } else {
            ctx.scale(1, -1);
            ctx.translate(0, -canvas.height);
          }
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.restore();
        }
        
        strokeCount++;
        updateUnsavedIndicator();
        
        if (Math.random() < 0.2) createSparkle(e.clientX, e.clientY);
        
        if (window.innerWidth <= 768) {
          canvas.style.boxShadow = '0 0 10px var(--primary)';
          setTimeout(() => canvas.style.boxShadow = '', 100);
        }
      } else if (currentTool === 'spray') {
        drawSpray(x, y);
      } else if (currentTool === 'bucket') {
        bucketFill(x, y);
      } else if (currentTool === 'eyedropper') {
        pickColor(x, y);
      } else if (currentTool === 'gradient') {
        drawGradient(x, y);
      } else if (currentTool === 'pattern') {
        drawPattern(x, y);
      } else if (currentTool === 'clone') {
        drawClone(x, y);
      }
    }
    
    function drawSpray(x, y) {
      ctx.globalCompositeOperation = 'source-over';
      ctx.fillStyle = currentColor;
      for (let i = 0; i < sprayDensity; i++) {
        const offsetX = (Math.random() - 0.5) * sprayRadius;
        const offsetY = (Math.random() - 0.5) * sprayRadius;
        ctx.fillRect(x + offsetX, y + offsetY, 1, 1);
      }
    }

    function stopDrawing(e) {
      if (currentTool === 'stickerMove' && isDragging) {
        isDragging = false;
        selectedSticker = null;
        canvas.style.cursor = 'grab';
        // Restaurar scroll en mÃ³vil
        if (window.innerWidth <= 768) {
          document.body.style.overflow = 'auto';
        }
        saveState();
        return;
      }
      
      if (isDrawing || isShapeDrawing) {
        if (currentTool === 'select' && isSelecting) {
          isSelecting = false;
        } else if (isShapeDrawing && e) {
          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;
          const endX = (e.clientX - rect.left) * scaleX;
          const endY = (e.clientY - rect.top) * scaleY;
          drawShape(shapeStartX, shapeStartY, endX, endY);
          isShapeDrawing = false;
        }
        isDrawing = false;
        if (currentTool !== 'select') saveState();
      }
    }
    
    function drawShape(startX, startY, endX, endY) {
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = currentSize;
      ctx.globalCompositeOperation = 'source-over';
      
      // Limitar formas dentro del canvas
      startX = Math.max(0, Math.min(canvas.width, startX));
      startY = Math.max(0, Math.min(canvas.height, startY));
      endX = Math.max(0, Math.min(canvas.width, endX));
      endY = Math.max(0, Math.min(canvas.height, endY));
      
      if (currentTool === 'circle') {
        const radius = Math.min(
          Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)),
          Math.min(startX, startY, canvas.width - startX, canvas.height - startY)
        );
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
      } else if (currentTool === 'rect') {
        ctx.strokeRect(startX, startY, endX - startX, endY - startY);
      } else if (currentTool === 'line') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.stroke();
      }
    }


    
    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z':
            e.preventDefault();
            if (e.shiftKey) {
              document.getElementById('redoBtn').click();
            } else {
              document.getElementById('undoBtn').click();
            }
            break;
          case 'y':
            e.preventDefault();
            document.getElementById('redoBtn').click();
            break;
        }
      }
      
      // Atajos rÃ¡pidos
      switch(e.key) {
        case 'b': setTool('brush'); break;
        case 's': setTool('spray'); break;
        case 'c': setTool('circle'); break;
        case 'r': setTool('rect'); break;
        case 'l': setTool('line'); break;
        case 't': setTool('text'); break;
        case 'e': setTool('eraser'); break;
        case 'f': setTool('bucket'); break;
        case 'i': setTool('eyedropper'); break;
        case 'h': setTool('stickerMove'); break;
        case 'g': setTool('gradient'); break;
        case 'p': setTool('pattern'); break;
        case 'y': toggleSymmetry(); break;
        case 'n': toggleNeon(); break;
        case 'w': toggleWatercolor(); break;
        case 'r': toggleRuler(); break;
        case 'v': togglePerspective(); break;
        case 'k': setTool('clone'); break;
      }
    });

    // Controles de color
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelector('.color-btn.active')?.classList.remove('active');
        btn.classList.add('active');
        currentColor = btn.dataset.color;
        isEraser = false;
        document.getElementById('eraserBtn').classList.remove('btn-secondary');
        document.getElementById('eraserBtn').classList.add('btn-outline-secondary');
      });
    });
    
    // Color personalizado
    document.getElementById('customColor').addEventListener('change', (e) => {
      currentColor = e.target.value;
      document.querySelector('.color-btn.active')?.classList.remove('active');
      setTool('brush'); // Cambiar a pincel automÃ¡ticamente
      
      // Actualizar display visual
      const customColorBtn = document.getElementById('customColor');
      customColorBtn.style.border = '2px solid var(--primary)';
      customColorBtn.style.boxShadow = '0 0 10px var(--primary)';
      
      // Remover highlight despuÃ©s de 2 segundos
      setTimeout(() => {
        customColorBtn.style.border = '1px solid var(--primary)';
        customColorBtn.style.boxShadow = 'none';
      }, 2000);
    });
    
    // Variables para herramientas
    let currentTool = 'brush';
    let pngMode = 'background';
    let stickerSize = 100;
    let isShapeDrawing = false;
    let shapeStartX, shapeStartY;
    let zoomLevel = 1;
    let panX = 0, panY = 0;
    let isSelecting = false;
    let selectionStart = { x: 0, y: 0 };
    let selectionEnd = { x: 0, y: 0 };
    let copiedData = null;
    
    // ConfiguraciÃ³n de spray
    let sprayDensity = 20;
    let sprayRadius = 20;
    
    // Variables para herramientas avanzadas
    let gradientStart = null;
    let gradientEnd = null;
    let currentPattern = 'dots';
    let symmetryMode = false;
    let symmetryAxis = 'vertical';
    let neonGlow = false;
    let watercolorMode = false;
    
    // Variables para herramientas tÃ©cnicas
    let rulerMode = false;
    let perspectiveMode = false;
    let perspectivePoints = [];
    let cloneMode = false;
    let cloneSource = null;
    let histogramVisible = false;
    


    document.getElementById('brushSize').addEventListener('input', (e) => {
      currentSize = e.target.value;
      document.getElementById('sizeDisplay').textContent = currentSize + 'px';
    });
    
    document.getElementById('opacitySlider').addEventListener('input', (e) => {
      currentOpacity = e.target.value / 100;
      document.getElementById('opacityDisplay').textContent = e.target.value + '%';
    });

    // Herramientas
    function setTool(tool) {
      currentTool = tool;
      
      if (tool === 'stickerMove') {
        canvas.style.cursor = 'grab';
      } else {
        canvas.style.cursor = 'crosshair';
      }
      
      document.querySelectorAll('.tool-active').forEach(btn => {
        btn.classList.remove('tool-active');
      });
      const toolBtn = document.getElementById(tool + 'Btn');
      if (toolBtn) {
        toolBtn.classList.add('tool-active');
      }
    }
    
    document.getElementById('brushBtn').addEventListener('click', () => setTool('brush'));
    document.getElementById('stickerMoveBtn').addEventListener('click', () => setTool('stickerMove'));
    document.getElementById('sprayBtn').addEventListener('click', () => setTool('spray'));
    document.getElementById('selectBtn').addEventListener('click', () => setTool('select'));
    document.getElementById('circleBtn').addEventListener('click', () => setTool('circle'));
    document.getElementById('lineBtn').addEventListener('click', () => setTool('line'));
    document.getElementById('textBtn').addEventListener('click', () => setTool('text'));
    document.getElementById('eraserBtn').addEventListener('click', () => setTool('eraser'));
    document.getElementById('bucketBtn').addEventListener('click', () => setTool('bucket'));
    document.getElementById('eyedropperBtn').addEventListener('click', () => setTool('eyedropper'));
    
    // Herramientas avanzadas
    document.getElementById('gradientBtn').addEventListener('click', () => setTool('gradient'));
    document.getElementById('patternBtn').addEventListener('click', () => setTool('pattern'));
    document.getElementById('symmetryBtn').addEventListener('click', () => toggleSymmetry());
    document.getElementById('neonBtn').addEventListener('click', () => toggleNeon());
    document.getElementById('watercolorBtn').addEventListener('click', () => toggleWatercolor());
    
    // Herramientas tÃ©cnicas
    document.getElementById('rulerBtn').addEventListener('click', () => toggleRuler());
    document.getElementById('perspectiveBtn').addEventListener('click', () => togglePerspective());
    document.getElementById('cloneBtn').addEventListener('click', () => setTool('clone'));
    document.getElementById('histogramBtn').addEventListener('click', () => toggleHistogram());
    
    // Brush presets
    document.getElementById('presetFine').addEventListener('click', () => {
      currentSize = 1;
      currentOpacity = 0.8;
      document.getElementById('brushSize').value = 1;
      document.getElementById('opacitySlider').value = 80;
      document.getElementById('sizeDisplay').textContent = '1px';
      document.getElementById('opacityDisplay').textContent = '80%';
      setTool('brush');
    });
    
    document.getElementById('presetThick').addEventListener('click', () => {
      currentSize = 15;
      currentOpacity = 1;
      document.getElementById('brushSize').value = 15;
      document.getElementById('opacitySlider').value = 100;
      document.getElementById('sizeDisplay').textContent = '15px';
      document.getElementById('opacityDisplay').textContent = '100%';
      setTool('brush');
    });
    
    document.getElementById('presetArt').addEventListener('click', () => {
      currentSize = 8;
      currentOpacity = 0.6;
      document.getElementById('brushSize').value = 8;
      document.getElementById('opacitySlider').value = 60;
      document.getElementById('sizeDisplay').textContent = '8px';
      document.getElementById('opacityDisplay').textContent = '60%';
      setTool('brush');
    });
    
    // Canvas size controls
    document.getElementById('smallCanvas').addEventListener('click', () => resizeCanvas(400, 300));
    document.getElementById('mediumCanvas').addEventListener('click', () => resizeCanvas(600, 400));
    document.getElementById('largeCanvas').addEventListener('click', () => resizeCanvas(800, 600));
    document.getElementById('wideCanvas').addEventListener('click', () => resizeCanvas(800, 400));
    document.getElementById('squareCanvas').addEventListener('click', () => resizeCanvas(600, 600));
    document.getElementById('tallCanvas').addEventListener('click', () => resizeCanvas(400, 800));
    document.getElementById('ultraWideCanvas').addEventListener('click', () => resizeCanvas(1000, 400));
    document.getElementById('customCanvas').addEventListener('click', () => {
      const modal = document.createElement('div');
      modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 99999; display: flex; align-items: center; justify-content: center;`;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `background: var(--bg-light); padding: 30px; border-radius: 15px; border: 2px solid var(--primary); max-width: 400px; width: 90%;`;
      
      dialog.innerHTML = `
        <h4 style="color: var(--primary); margin-bottom: 20px; text-align: center;">âš™ï¸ Canvas Personalizado</h4>
        <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; font-size: 0.8em; color: var(--text-secondary); text-align: center;">
          âš ï¸ <strong>LÃ­mite Firebase:</strong> Canvas grandes se comprimen automÃ¡ticamente para cumplir el lÃ­mite de 800KB
        </div>
        <div style="margin-bottom: 15px;">
          <label style="color: var(--text-primary); display: block; margin-bottom: 5px;">ğŸ“ Ancho (px):</label>
          <input type="number" id="customWidth" value="600" min="50" style="width: 100%; padding: 8px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); border-radius: 5px;">
        </div>
        <div style="margin-bottom: 20px;">
          <label style="color: var(--text-primary); display: block; margin-bottom: 5px;">ğŸ“ Alto (px):</label>
          <input type="number" id="customHeight" value="400" min="50" style="width: 100%; padding: 8px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); border-radius: 5px;">
        </div>
        <div style="margin-bottom: 20px; padding: 10px; background: var(--bg-dark); border-radius: 8px; font-size: 0.8em; color: var(--text-secondary);">
          ğŸ“‹ <strong>Presets rÃ¡pidos:</strong><br>
          <button onclick="document.getElementById('customWidth').value=1920; document.getElementById('customHeight').value=1080;" style="margin: 2px; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 0.7em;">HD</button>
          <button onclick="document.getElementById('customWidth').value=2560; document.getElementById('customHeight').value=1440;" style="margin: 2px; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 0.7em;">2K</button>
          <button onclick="document.getElementById('customWidth').value=3840; document.getElementById('customHeight').value=2160;" style="margin: 2px; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 0.7em;">4K</button>
          <button onclick="document.getElementById('customWidth').value=1200; document.getElementById('customHeight').value=600;" style="margin: 2px; padding: 4px 8px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 0.7em;">Banner</button>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button id="applyCustom" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">âœ… Aplicar</button>
          <button id="cancelCustom" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer;">âŒ Cancelar</button>
        </div>
      `;
      
      modal.appendChild(dialog);
      document.body.appendChild(modal);
      
      document.getElementById('applyCustom').onclick = () => {
        const width = Math.max(parseInt(document.getElementById('customWidth').value) || 600, 50);
        const height = Math.max(parseInt(document.getElementById('customHeight').value) || 400, 50);
        
        // Advertir sobre canvas muy grandes
        const totalPixels = width * height;
        if (totalPixels > 2000000) {
          if (!confirm(`âš ï¸ Canvas muy grande (${width}x${height})\n\nSe comprimirÃ¡ automÃ¡ticamente al guardar en Firebase.\nÂ¿Continuar?`)) {
            return;
          }
        }
        
        resizeCanvas(width, height);
        modal.remove();
      };
      
      document.getElementById('cancelCustom').onclick = () => modal.remove();
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    });
    
    function resizeCanvas(width, height) {
      if (!isCanvasEmpty() && !confirm('Â¿Cambiar tamaÃ±o del canvas? Se perderÃ¡ el dibujo actual.')) {
        return;
      }
      
      // Guardar imagen actual si existe
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      tempCtx.drawImage(canvas, 0, 0);
      
      // Cambiar tamaÃ±o
      canvas.width = width;
      canvas.height = height;
      
      // Restaurar configuraciÃ³n del contexto
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.globalCompositeOperation = 'source-over';
      ctx.globalAlpha = 1;
      
      // Redibujar imagen escalada si no estaba vacÃ­a
      if (!isCanvasEmpty()) {
        const scale = Math.min(width / tempCanvas.width, height / tempCanvas.height);
        const scaledWidth = tempCanvas.width * scale;
        const scaledHeight = tempCanvas.height * scale;
        const x = (width - scaledWidth) / 2;
        const y = (height - scaledHeight) / 2;
        ctx.drawImage(tempCanvas, x, y, scaledWidth, scaledHeight);
      }
      
      // Actualizar botones
      document.querySelectorAll('[id$="Canvas"]').forEach(btn => {
        btn.classList.remove('tool-active');
      });
      if (event && event.target) {
        event.target.classList.add('tool-active');
      } else {
        // Para canvas custom, marcar el botÃ³n correspondiente
        const customBtn = document.getElementById('customCanvas');
        if (customBtn) customBtn.classList.add('tool-active');
      }
      
      // Actualizar contenedor GIF si existe
      const gifBackground = document.getElementById('gifBackground');
      if (gifBackground.style.display === 'block') {
        gifBackground.style.width = width + 'px';
        gifBackground.style.height = height + 'px';
      }
      
      // Actualizar contenedor de stickers GIF
      const gifStickersContainer = document.getElementById('gifStickersContainer');
      gifStickersContainer.style.width = width + 'px';
      gifStickersContainer.style.height = height + 'px';
      
      // Ajustar contenedor y canvas
      adjustCanvasForMobile();
      saveState();
    }
    
    // Selection and copy/paste
    function drawSelection() {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(canvas, 0, 0);
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(tempCanvas, 0, 0);
      
      ctx.strokeStyle = '#ff0000';
      ctx.lineWidth = 1;
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(
        selectionStart.x,
        selectionStart.y,
        selectionEnd.x - selectionStart.x,
        selectionEnd.y - selectionStart.y
      );
      ctx.setLineDash([]);
    }
    

    
    // Theme selector
    document.getElementById('themeSelector').addEventListener('change', (e) => {
      const theme = e.target.value;
      if (theme === 'default') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
      localStorage.setItem('selectedTheme', theme);
    });
    
    // Export functions
    document.getElementById('exportPNG').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `dibujo-${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
    
    // Simplified export - only PNG for main button
    document.getElementById('exportPNG').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `dibujo-${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });
    
    // Set initial theme
    const savedTheme = localStorage.getItem('selectedTheme') || 'default';
    document.getElementById('themeSelector').value = savedTheme;
    
    // Prevenir abandonar pÃ¡gina con trabajo sin guardar
    let hasUnsavedWork = false;
    
    function markAsUnsaved() {
      hasUnsavedWork = true;
    }
    
    function markAsSaved() {
      hasUnsavedWork = false;
    }
    
    // Detectar cambios en canvas
    const originalSaveState = saveState;
    saveState = function() {
      originalSaveState();
      if (historyStep > 0) {
        markAsUnsaved();
        updateUnsavedIndicator();
      }
    };
    
    function updateUnsavedIndicator() {
      const indicator = document.getElementById('unsavedIndicator');
      if (hasUnsavedWork && !isCanvasEmpty()) {
        indicator.style.display = 'block';
      } else {
        indicator.style.display = 'none';
      }
    }
    
    // Bucket fill function
    function bucketFill(startX, startY) {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const startPos = (Math.floor(startY) * canvas.width + Math.floor(startX)) * 4;
      const startR = data[startPos];
      const startG = data[startPos + 1];
      const startB = data[startPos + 2];
      const startA = data[startPos + 3];
      
      const fillColor = hexToRgb(currentColor);
      if (!fillColor) return;
      
      const stack = [[Math.floor(startX), Math.floor(startY)]];
      const visited = new Set();
      
      while (stack.length > 0) {
        const [x, y] = stack.pop();
        const key = `${x},${y}`;
        
        if (visited.has(key) || x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
        visited.add(key);
        
        const pos = (y * canvas.width + x) * 4;
        const r = data[pos];
        const g = data[pos + 1];
        const b = data[pos + 2];
        const a = data[pos + 3];
        
        if (r === startR && g === startG && b === startB && a === startA) {
          data[pos] = fillColor.r;
          data[pos + 1] = fillColor.g;
          data[pos + 2] = fillColor.b;
          data[pos + 3] = 255;
          
          stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
        }
      }
      
      ctx.putImageData(imageData, 0, 0);
      saveState();
    }
    
    // Eyedropper function
    function pickColor(x, y) {
      const imageData = ctx.getImageData(Math.floor(x), Math.floor(y), 1, 1);
      const data = imageData.data;
      const r = data[0];
      const g = data[1];
      const b = data[2];
      
      const hex = `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
      currentColor = hex;
      document.getElementById('customColor').value = hex;
      document.querySelector('.color-btn.active')?.classList.remove('active');
      setTool('brush');
    }
    
    // Helper function
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }
    
    // Funciones de herramientas avanzadas
    function drawGradient(x, y) {
      if (!gradientStart) {
        gradientStart = { x, y };
        return;
      }
      
      const gradient = ctx.createLinearGradient(gradientStart.x, gradientStart.y, x, y);
      gradient.addColorStop(0, currentColor);
      gradient.addColorStop(1, '#ffffff');
      
      ctx.strokeStyle = gradient;
      ctx.lineWidth = currentSize * 3;
      ctx.beginPath();
      ctx.moveTo(gradientStart.x, gradientStart.y);
      ctx.lineTo(x, y);
      ctx.stroke();
      
      gradientStart = null;
      saveState();
    }
    
    function drawPattern(x, y) {
      const patternCanvas = document.createElement('canvas');
      const patternCtx = patternCanvas.getContext('2d');
      patternCanvas.width = 20;
      patternCanvas.height = 20;
      
      patternCtx.fillStyle = currentColor;
      
      if (currentPattern === 'dots') {
        patternCtx.beginPath();
        patternCtx.arc(10, 10, 3, 0, Math.PI * 2);
        patternCtx.fill();
      } else if (currentPattern === 'lines') {
        for (let i = 0; i < 20; i += 4) {
          patternCtx.fillRect(i, 0, 2, 20);
        }
      }
      
      const pattern = ctx.createPattern(patternCanvas, 'repeat');
      ctx.fillStyle = pattern;
      ctx.beginPath();
      ctx.arc(x, y, currentSize * 2, 0, Math.PI * 2);
      ctx.fill();
    }
    
    function toggleSymmetry() {
      symmetryMode = !symmetryMode;
      const btn = document.getElementById('symmetryBtn');
      if (symmetryMode) {
        btn.classList.add('tool-active');
        btn.innerHTML = 'âš™ï¸ ON';
      } else {
        btn.classList.remove('tool-active');
        btn.innerHTML = 'âš™ï¸ SimetrÃ­a';
      }
    }
    
    function toggleNeon() {
      neonGlow = !neonGlow;
      const btn = document.getElementById('neonBtn');
      if (neonGlow) {
        btn.classList.add('tool-active');
        btn.innerHTML = 'ğŸ’¡ ON';
        ctx.shadowColor = currentColor;
        ctx.shadowBlur = 10;
      } else {
        btn.classList.remove('tool-active');
        btn.innerHTML = 'ğŸ’¡ NeÃ³n';
        ctx.shadowBlur = 0;
      }
    }
    
    function toggleWatercolor() {
      watercolorMode = !watercolorMode;
      const btn = document.getElementById('watercolorBtn');
      if (watercolorMode) {
        btn.classList.add('tool-active');
        btn.innerHTML = 'ğŸ¨ ON';
      } else {
        btn.classList.remove('tool-active');
        btn.innerHTML = 'ğŸ¨ Acuarela';
      }
    }
    
    function applyOilPaintingEffect() {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        const factor = Math.floor(avg / 32) * 32;
        data[i] = Math.min(255, data[i] + factor * 0.1);
        data[i + 1] = Math.min(255, data[i + 1] + factor * 0.1);
        data[i + 2] = Math.min(255, data[i + 2] + factor * 0.1);
      }
      
      ctx.putImageData(imageData, 0, 0);
      saveState();
    }
    
    function applyCharcoalEffect() {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      
      for (let i = 0; i < data.length; i += 4) {
        const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;
        const charcoal = gray < 128 ? gray * 0.5 : 255 - (255 - gray) * 0.3;
        data[i] = data[i + 1] = data[i + 2] = charcoal;
      }
      
      ctx.putImageData(imageData, 0, 0);
      saveState();
    }
    
    // Herramientas tÃ©cnicas
    function toggleRuler() {
      rulerMode = !rulerMode;
      const btn = document.getElementById('rulerBtn');
      if (rulerMode) {
        btn.classList.add('tool-active');
        btn.innerHTML = 'ğŸ“ ON';
        drawRulerGuides();
      } else {
        btn.classList.remove('tool-active');
        btn.innerHTML = 'ğŸ“ Regla';
        clearGuides();
      }
    }
    
    function togglePerspective() {
      perspectiveMode = !perspectiveMode;
      const btn = document.getElementById('perspectiveBtn');
      if (perspectiveMode) {
        btn.classList.add('tool-active');
        btn.innerHTML = 'ğŸ“Š ON';
        perspectivePoints = [];
      } else {
        btn.classList.remove('tool-active');
        btn.innerHTML = 'ğŸ“Š Perspectiva';
        clearGuides();
      }
    }
    
    function drawClone(x, y) {
      if (!cloneSource) {
        cloneSource = { x, y };
        return;
      }
      
      const sourceData = ctx.getImageData(cloneSource.x - 10, cloneSource.y - 10, 20, 20);
      ctx.putImageData(sourceData, x - 10, y - 10);
      saveState();
    }
    
    function toggleHistogram() {
      histogramVisible = !histogramVisible;
      const btn = document.getElementById('histogramBtn');
      if (histogramVisible) {
        btn.classList.add('tool-active');
        btn.innerHTML = 'ğŸ“ˆ ON';
        showHistogram();
      } else {
        btn.classList.remove('tool-active');
        btn.innerHTML = 'ğŸ“ˆ Histograma';
        hideHistogram();
      }
    }
    
    function drawRulerGuides() {
      const overlay = document.createElement('div');
      overlay.id = 'rulerOverlay';
      overlay.style.cssText = `
        position: absolute;
        top: 10px;
        left: 10px;
        width: ${canvas.width}px;
        height: ${canvas.height}px;
        pointer-events: none;
        z-index: 5;
      `;
      
      // LÃ­neas de guÃ­a cada 50px
      for (let i = 0; i < canvas.width; i += 50) {
        const line = document.createElement('div');
        line.style.cssText = `
          position: absolute;
          left: ${i}px;
          top: 0;
          width: 1px;
          height: 100%;
          background: rgba(255, 107, 53, 0.3);
        `;
        overlay.appendChild(line);
      }
      
      for (let i = 0; i < canvas.height; i += 50) {
        const line = document.createElement('div');
        line.style.cssText = `
          position: absolute;
          left: 0;
          top: ${i}px;
          width: 100%;
          height: 1px;
          background: rgba(255, 107, 53, 0.3);
        `;
        overlay.appendChild(line);
      }
      
      canvas.parentElement.appendChild(overlay);
    }
    
    function clearGuides() {
      const overlay = document.getElementById('rulerOverlay');
      if (overlay) overlay.remove();
    }
    
    function showHistogram() {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const histogram = { r: new Array(256).fill(0), g: new Array(256).fill(0), b: new Array(256).fill(0) };
      
      for (let i = 0; i < data.length; i += 4) {
        histogram.r[data[i]]++;
        histogram.g[data[i + 1]]++;
        histogram.b[data[i + 2]]++;
      }
      
      const modal = document.createElement('div');
      modal.id = 'histogramModal';
      modal.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        width: 300px;
        height: 200px;
        background: var(--bg-light);
        border: 2px solid var(--primary);
        border-radius: 10px;
        padding: 10px;
        z-index: 1000;
      `;
      
      const maxValue = Math.max(...histogram.r, ...histogram.g, ...histogram.b);
      const canvas = document.createElement('canvas');
      canvas.width = 256;
      canvas.height = 150;
      const ctx = canvas.getContext('2d');
      
      // Dibujar histograma
      for (let i = 0; i < 256; i++) {
        const rHeight = (histogram.r[i] / maxValue) * 150;
        const gHeight = (histogram.g[i] / maxValue) * 150;
        const bHeight = (histogram.b[i] / maxValue) * 150;
        
        ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.fillRect(i, 150 - rHeight, 1, rHeight);
        ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
        ctx.fillRect(i, 150 - gHeight, 1, gHeight);
        ctx.fillStyle = 'rgba(0, 0, 255, 0.5)';
        ctx.fillRect(i, 150 - bHeight, 1, bHeight);
      }
      
      modal.innerHTML = `<h6 style="color: var(--primary); margin: 0 0 10px 0;">ğŸ“ˆ Histograma RGB</h6>`;
      modal.appendChild(canvas);
      document.body.appendChild(modal);
    }
    
    function hideHistogram() {
      const modal = document.getElementById('histogramModal');
      if (modal) modal.remove();
    }
    
    // Sistema de stickers mejorado para mÃ³vil
    function findStickerAt(x, y) {
      for (let i = stickers.length - 1; i >= 0; i--) {
        const sticker = stickers[i];
        if (!sticker) continue;
        
        const width = sticker.width || 60;
        const height = sticker.height || 60;
        // Margen mÃ¡s amplio para mÃ³vil
        const margin = window.innerWidth <= 768 ? 30 : 20;
        
        // Ãrea de detecciÃ³n mÃ¡s generosa
        if (x >= sticker.x - margin && x <= sticker.x + width + margin &&
            y >= sticker.y - margin && y <= sticker.y + height + margin) {
          console.log('Sticker encontrado:', sticker);
          return sticker;
        }
      }
      console.log('No se encontrÃ³ sticker en:', x, y);
      return null;
    }
    
    function drawAllStickers() {
      stickers.forEach(sticker => {
        if (sticker && sticker.image && !sticker.isGif) {
          // Solo dibujar stickers estÃ¡ticos en canvas
          ctx.drawImage(sticker.image, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
        }
      });
    }
    
    function createGifStickerElement(sticker) {
      const container = document.getElementById('gifStickersContainer');
      const gifElement = document.createElement('img');
      
      gifElement.src = sticker.image.src;
      gifElement.style.cssText = `
        position: absolute;
        left: ${sticker.x}px;
        top: ${sticker.y}px;
        width: ${sticker.width}px;
        height: ${sticker.height}px;
        pointer-events: auto;
        cursor: grab;
        z-index: 10;
      `;
      
      gifElement.dataset.stickerId = sticker.id;
      
      // Hacer el elemento arrastrable
      gifElement.addEventListener('mousedown', (e) => {
        if (currentTool === 'stickerMove') {
          e.preventDefault();
          startDragGifSticker(gifElement, sticker, e);
        }
      });
      
      container.appendChild(gifElement);
    }
    
    function startDragGifSticker(element, sticker, e) {
      const rect = canvas.getBoundingClientRect();
      const offsetX = e.clientX - rect.left - sticker.x;
      const offsetY = e.clientY - rect.top - sticker.y;
      
      function onMouseMove(e) {
        const newX = e.clientX - rect.left - offsetX;
        const newY = e.clientY - rect.top - offsetY;
        
        // Mantener dentro del canvas
        sticker.x = Math.max(0, Math.min(canvas.width - sticker.width, newX));
        sticker.y = Math.max(0, Math.min(canvas.height - sticker.height, newY));
        
        element.style.left = sticker.x + 'px';
        element.style.top = sticker.y + 'px';
      }
      
      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        saveState();
      }
      
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }
    
    function redrawWithStickers() {
      drawAllStickers();
    }
    

    
    // Prevenir salida accidental
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedWork && !isCanvasEmpty()) {
        e.preventDefault();
        e.returnValue = 'Â¿Seguro que quieres salir? Tienes cambios sin guardar.';
        return 'Â¿Seguro que quieres salir? Tienes cambios sin guardar.';
      }
    });
    
    // TambiÃ©n prevenir navegaciÃ³n con botones del navegador
    window.addEventListener('pagehide', (e) => {
      if (hasUnsavedWork && !isCanvasEmpty()) {
        e.preventDefault();
      }
    });
    
    // Sistema de fondos con imÃ¡genes
    let currentBackgroundImage = null;
    let isBackgroundGif = false;
    
    function setBackgroundImage(image) {
      currentBackgroundImage = image;
      
      // Si es GIF, usar fondo visual animado
      if (isBackgroundGif) {
        setVisualGifBackground(image.src);
      } else {
        // Para imÃ¡genes estÃ¡ticas, dibujar en canvas
        hideVisualGifBackground();
        
        // Guardar el dibujo actual
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(canvas, 0, 0);
        
        // Limpiar canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Calcular dimensiones para mantener proporciÃ³n y llenar canvas
        const canvasRatio = canvas.width / canvas.height;
        const imageRatio = image.width / image.height;
        
        let drawWidth, drawHeight, drawX, drawY;
        
        if (imageRatio > canvasRatio) {
          // Imagen mÃ¡s ancha - ajustar por altura
          drawHeight = canvas.height;
          drawWidth = drawHeight * imageRatio;
          drawX = (canvas.width - drawWidth) / 2;
          drawY = 0;
        } else {
          // Imagen mÃ¡s alta - ajustar por ancho
          drawWidth = canvas.width;
          drawHeight = drawWidth / imageRatio;
          drawX = 0;
          drawY = (canvas.height - drawHeight) / 2;
        }
        
        // Dibujar imagen de fondo adaptada al canvas
        ctx.drawImage(image, drawX, drawY, drawWidth, drawHeight);
        
        // Restaurar el dibujo encima del fondo
        ctx.drawImage(tempCanvas, 0, 0);
      }
      
      saveState();
    }
    
    function setVisualGifBackground(gifSrc) {
      const gifBackground = document.getElementById('gifBackground');
      const gifImg = document.getElementById('gifBackgroundImg');
      
      gifImg.src = gifSrc;
      gifBackground.style.display = 'block';
      
      // Ajustar el contenedor GIF al tamaÃ±o actual del canvas
      gifBackground.style.width = canvas.width + 'px';
      gifBackground.style.height = canvas.height + 'px';
      
      // Hacer el canvas semi-transparente para que se vea el GIF
      canvas.style.background = 'rgba(255, 255, 255, 0.1)';
    }
    
    function hideVisualGifBackground() {
      const gifBackground = document.getElementById('gifBackground');
      gifBackground.style.display = 'none';
      canvas.style.background = 'white';
    }
    
    function clearBackground() {
      // Guardar el dibujo actual
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(canvas, 0, 0);
      
      // Limpiar canvas completamente
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Solo restaurar el dibujo (sin fondo)
      ctx.globalCompositeOperation = 'source-over';
      ctx.drawImage(tempCanvas, 0, 0);
      
      currentBackgroundImage = null;
      isBackgroundGif = false;
      saveState();
    }
    
    // Event listeners para fondos
    document.getElementById('bgUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/jpg' || file.type === 'image/gif')) {
        // Verificar tamaÃ±o de archivo (mÃ¡x 3MB para evitar problemas)
        if (file.size > 3 * 1024 * 1024) {
          alert('ğŸš« Archivo muy grande. MÃ¡ximo 3MB permitido.');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = async (event) => {
          const imageData = event.target.result;
          
          // Solo moderar si no es GIF
          if (file.type !== 'image/gif') {
            const flags = await analyzeImageContent(imageData);
            if (flags.excessiveRed || flags.suspiciousContent) {
              alert('ğŸš« Imagen rechazada: Contenido potencialmente inapropiado detectado');
              e.target.value = '';
              return;
            }
          }
          
          const img = new Image();
          img.onload = () => {
            currentBackgroundImage = img;
            document.getElementById('setBgBtn').disabled = false;
            
            if (file.type === 'image/gif') {
              isBackgroundGif = true;
              document.getElementById('setBgBtn').innerHTML = 'ğŸ¬ GIF Listo';
              document.getElementById('setBgBtn').style.background = '#28a745';
              document.getElementById('setBgBtn').style.color = 'white';
            } else {
              isBackgroundGif = false;
              document.getElementById('setBgBtn').innerHTML = 'ğŸ–¼ï¸ Listo';
            }
          };
          img.src = imageData;
        };
        reader.readAsDataURL(file);
      }
    });
    
    document.getElementById('setBgBtn').addEventListener('click', () => {
      if (currentBackgroundImage) {
        setBackgroundImage(currentBackgroundImage);
        
        if (isBackgroundGif) {
          document.getElementById('setBgBtn').innerHTML = 'ğŸ¬ GIF Aplicado';
          document.getElementById('setBgBtn').style.background = '#28a745';
          document.getElementById('setBgBtn').style.color = 'white';
        } else {
          document.getElementById('setBgBtn').innerHTML = 'âœ… Aplicado';
        }
        
        setTimeout(() => {
          document.getElementById('setBgBtn').innerHTML = 'ğŸ–¼ï¸ Aplicar';
          document.getElementById('setBgBtn').style.background = '';
          document.getElementById('setBgBtn').style.color = '';
        }, 3000);
      }
    });
    
    document.getElementById('clearBgBtn').addEventListener('click', () => {
      if (confirm('Â¿Quitar el fondo de imagen?')) {
        clearBackground();
      }
    });
    
    // Sistema de stickers PNG personalizados
    
    document.getElementById('stickerUpload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/jpg' || file.type === 'image/gif')) {
        // Verificar tamaÃ±o de archivo (mÃ¡x 2MB para stickers)
        if (file.size > 2 * 1024 * 1024) {
          alert('ğŸš« Sticker muy grande. MÃ¡ximo 2MB permitido.');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = async (event) => {
          const imageData = event.target.result;
          
          // Solo moderar si no es GIF (los GIFs son mÃ¡s complejos de analizar)
          if (file.type !== 'image/gif') {
            const flags = await analyzeImageContent(imageData);
            if (flags.excessiveRed || flags.suspiciousContent) {
              alert('ğŸš« Sticker rechazado: Contenido potencialmente inapropiado detectado');
              e.target.value = '';
              return;
            }
          }
          
          const img = new Image();
          img.onload = () => {
            currentStickerImage = img;
            const btn = document.getElementById('placeStickerBtn');
            btn.disabled = false;
            
            // Mostrar preview si es GIF
            if (file.type === 'image/gif') {
              btn.innerHTML = 'ğŸ“Œ GIF Listo';
              btn.style.background = '#28a745';
              btn.style.color = 'white';
              console.log('GIF sticker cargado:', img.src.substring(0, 50) + '...');
            } else {
              btn.innerHTML = 'ğŸ“Œ Listo';
              btn.style.background = '';
              btn.style.color = '';
            }
          };
          img.src = imageData;
        };
        reader.readAsDataURL(file);
      }
    });
    
    document.getElementById('placeStickerBtn').addEventListener('click', () => {
      if (!currentStickerImage) {
        console.log('No hay imagen de sticker cargada');
        return;
      }
      
      console.log('BotÃ³n de sticker clickeado, imagen:', currentStickerImage);
      canvas.style.cursor = 'copy';
      
      const placeSticker = (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        
        console.log('Colocando sticker en:', x, y);
        
        // Crear sticker directamente
        const sticker = {
          id: Date.now(),
          image: currentStickerImage,
          x: x - 30, // Centrar
          y: y - 30, // Centrar
          width: 60,
          height: 60,
          isGif: currentStickerImage.src && currentStickerImage.src.includes('data:image/gif')
        };
        
        stickers.push(sticker);
        console.log('Sticker aÃ±adido:', sticker);
        
        // Si es GIF, crear elemento HTML animado
        if (sticker.isGif) {
          createGifStickerElement(sticker);
        } else {
          // Para imÃ¡genes estÃ¡ticas, dibujar en canvas
          ctx.drawImage(currentStickerImage, sticker.x, sticker.y, sticker.width, sticker.height);
        }
        
        canvas.style.cursor = 'crosshair';
        canvas.removeEventListener('click', placeSticker);
        saveState();
      };
      
      canvas.addEventListener('click', placeSticker, { once: true });
    });
    
    // FunciÃ³n para redibujar canvas con capas separadas
    function redrawCanvasWithLayers() {
      // Limpiar canvas principal
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Restaurar dibujo base desde historial
      if (drawingHistory.length > 0) {
        const img = new Image();
        img.onload = () => {
          ctx.drawImage(img, 0, 0);
          
          // Redibujar todos los stickers encima
          stickers.forEach(sticker => {
            if (sticker && sticker.image) {
              // Para GIFs, crear nueva instancia para mantener animaciÃ³n
              if (sticker.isGif && sticker.image.src) {
                const gifImg = new Image();
                gifImg.onload = () => {
                  ctx.drawImage(gifImg, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
                };
                gifImg.src = sticker.image.src;
              } else {
                ctx.drawImage(sticker.image, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
              }
            }
          });
        };
        img.src = drawingHistory[drawingHistory.length - 1];
      } else {
        // Si no hay historial, solo dibujar stickers
        stickers.forEach(sticker => {
          if (sticker && sticker.image) {
            if (sticker.isGif && sticker.image.src) {
              const gifImg = new Image();
              gifImg.onload = () => {
                ctx.drawImage(gifImg, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
              };
              gifImg.src = sticker.image.src;
            } else {
              ctx.drawImage(sticker.image, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
            }
          }
        });
      }
    }
    
    // Zoom
    document.getElementById('zoomBtn').addEventListener('click', () => {
      zoomLevel = zoomLevel === 1 ? 2 : 1;
      canvas.style.transform = `scale(${zoomLevel})`;
      document.getElementById('zoomBtn').textContent = zoomLevel === 1 ? 'ğŸ” Zoom' : 'ğŸ” Zoom Out';
    });
    
    // Pantalla completa para mÃ³vil
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      if (document.fullscreenElement) {
        document.exitFullscreen();
        document.getElementById('fullscreenBtn').innerHTML = 'ğŸ“± Pantalla completa';
      } else {
        document.documentElement.requestFullscreen().then(() => {
          document.getElementById('fullscreenBtn').innerHTML = 'ğŸ“± Salir pantalla completa';
          // Ocultar barra de direcciones en mÃ³vil
          if (window.innerHeight < window.innerWidth) {
            canvas.style.maxHeight = '70vh';
          }
        }).catch(() => {
          alert('No se pudo activar pantalla completa');
        });
      }
    });
    
    // Detectar salida de pantalla completa
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        document.getElementById('fullscreenBtn').innerHTML = 'ğŸ“± Pantalla completa';
        canvas.style.maxHeight = '';
      }
    });
    
    // Filtros
    document.getElementById('blurBtn').addEventListener('click', () => {
      ctx.filter = ctx.filter === 'blur(2px)' ? 'none' : 'blur(2px)';
    });
    
    document.getElementById('pixelBtn').addEventListener('click', () => {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 16) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        data[i] = data[i + 1] = data[i + 2] = avg > 128 ? 255 : 0;
      }
      ctx.putImageData(imageData, 0, 0);
      saveState();
    });
    
    document.getElementById('vintageBtn').addEventListener('click', () => {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, data[i] * 1.2 + 30);     // R
        data[i + 1] = Math.min(255, data[i + 1] * 1.1);  // G
        data[i + 2] = Math.min(255, data[i + 2] * 0.8);  // B
      }
      ctx.putImageData(imageData, 0, 0);
      saveState();
    });
    
    document.getElementById('oilBtn').addEventListener('click', () => {
      applyOilPaintingEffect();
    });
    
    document.getElementById('charcoalBtn').addEventListener('click', () => {
      applyCharcoalEffect();
    });
    
    document.getElementById('clearFilterBtn').addEventListener('click', () => {
      ctx.filter = 'none';
    });
    
    // Deshacer/Rehacer
    document.getElementById('undoBtn').addEventListener('click', () => {
      if (historyStep > 0) {
        historyStep--;
        restoreState();
      }
    });
    
    document.getElementById('redoBtn').addEventListener('click', () => {
      if (historyStep < drawingHistory.length - 1) {
        historyStep++;
        restoreState();
      }
    });
    
    function restoreState() {
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Restaurar TODAS las propiedades del contexto
        ctx.globalCompositeOperation = 'source-over';
        ctx.globalAlpha = currentOpacity; // Usar la opacidad actual, no forzar a 1
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = currentSize;
        
        ctx.drawImage(img, 0, 0);
        
        // Restaurar fondo GIF si existe
        if (isBackgroundGif && currentBackgroundImage) {
          startBackgroundGifAnimation();
        }
        
        // Redibujar stickers si existen (con soporte para GIFs)
        stickers.forEach(sticker => {
          if (sticker && sticker.image) {
            if (sticker.isGif && sticker.image.src) {
              // Para GIFs, crear nueva instancia
              const gifImg = new Image();
              gifImg.onload = () => {
                ctx.drawImage(gifImg, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
              };
              gifImg.src = sticker.image.src;
            } else {
              ctx.drawImage(sticker.image, sticker.x, sticker.y, sticker.width || 60, sticker.height || 60);
            }
          }
        });
      };
      img.src = drawingHistory[historyStep];
    }
    
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('Â¿Limpiar todo el dibujo?')) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        stickers = []; // Limpiar stickers tambiÃ©n
        
        // Limpiar stickers GIF del DOM
        const gifContainer = document.getElementById('gifStickersContainer');
        gifContainer.innerHTML = '';
        
        console.log('Canvas y stickers limpiados');
        markAsSaved();
        saveState();
      }
    });

    // Cooldown de 5 minutos
    function checkCooldown() {
      const lastSave = localStorage.getItem('lastDrawingSave');
      if (lastSave) {
        const timeDiff = Date.now() - parseInt(lastSave);
        const cooldownTime = 5 * 60 * 1000; // 5 minutos
        if (timeDiff < cooldownTime) {
          const remaining = Math.ceil((cooldownTime - timeDiff) / 60000);
          return remaining;
        }
      }
      return 0;
    }
    
    // Sistema de moderaciÃ³n
    function analyzeImageContent(imageData) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          tempCanvas.width = img.width;
          tempCanvas.height = img.height;
          tempCtx.drawImage(img, 0, 0);
          
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          
          // AnÃ¡lisis bÃ¡sico de contenido
          let redPixels = 0, totalPixels = data.length / 4;
          let suspiciousPatterns = 0;
          
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i + 1], b = data[i + 2];
            
            // Detectar exceso de rojo (posible gore)
            if (r > 200 && g < 100 && b < 100) redPixels++;
            
            // Detectar patrones sospechosos de color carne
            if (r > 200 && g > 150 && b > 120 && r < 255 && g < 200 && b < 180) {
              suspiciousPatterns++;
            }
          }
          
          const redRatio = redPixels / totalPixels;
          const suspiciousRatio = suspiciousPatterns / totalPixels;
          
          // Flags de moderaciÃ³n
          const flags = {
            excessiveRed: redRatio > 0.3,
            suspiciousContent: suspiciousRatio > 0.4,
            tooSimple: totalPixels < 1000,
            needsReview: redRatio > 0.2 || suspiciousRatio > 0.3
          };
          
          resolve(flags);
        };
        img.src = imageData;
      });
    }
    
    function moderateText(text) {
      const bannedWords = [
        'gore', 'sangre', 'muerte', 'matar', 'suicidio', 'nazi', 'hitler',
        'porno', 'sexo', 'desnudo', 'violacion', 'drogas', 'cocaina',
        'terrorista', 'bomba', 'arma', 'pistola', 'cuchillo'
      ];
      
      const lowerText = text.toLowerCase();
      let flags = { hasBannedWords: false, bannedWordsFound: [] };
      
      for (const word of bannedWords) {
        if (lowerText.includes(word)) {
          flags.hasBannedWords = true;
          flags.bannedWordsFound.push(word);
        }
      }
      
      return flags;
    }
    
    // FunciÃ³n para comprimir imÃ¡genes
    function compressImage(dataUrl, maxSizeKB = 800) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Calcular nuevo tamaÃ±o manteniendo proporciÃ³n
          let { width, height } = img;
          const maxDimension = 800;
          
          if (width > maxDimension || height > maxDimension) {
            if (width > height) {
              height = (height * maxDimension) / width;
              width = maxDimension;
            } else {
              width = (width * maxDimension) / height;
              height = maxDimension;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          
          // Dibujar imagen redimensionada
          ctx.drawImage(img, 0, 0, width, height);
          
          // Comprimir con calidad variable (empezar con mejor calidad para GIFs)
          let quality = 0.85;
          let compressed = canvas.toDataURL('image/jpeg', quality);
          
          // Reducir calidad gradualmente hasta alcanzar el tamaÃ±o objetivo
          while (compressed.length > maxSizeKB * 1024 * 1.37 && quality > 0.2) {
            quality -= 0.05; // ReducciÃ³n mÃ¡s gradual
            compressed = canvas.toDataURL('image/jpeg', quality);
          }
          
          resolve(compressed);
        };
        img.src = dataUrl;
      });
    }
    
    // FunciÃ³n para comprimir GIFs manteniendo animaciÃ³n usando gif.js
    async function compressGifForFirebase(gifDataUrl) {
      if (!gifDataUrl) return null;
      
      try {
        // Convertir dataURL a blob
        const response = await fetch(gifDataUrl);
        const blob = await response.blob();
        
        // Si el GIF es pequeÃ±o, devolverlo sin comprimir
        if (blob.size < 800000) {
          return gifDataUrl;
        }
        
        // Usar gif.js para comprimir manteniendo animaciÃ³n
        return new Promise((resolve) => {
          const gif = new GIF({
            workers: 2,
            quality: 20, // Baja calidad para comprimir mÃ¡s
            width: 200,  // Reducir tamaÃ±o
            height: 150,
            workerScript: 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'
          });
          
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 150;
            
            // Dibujar frame Ãºnico (para GIFs simples)
            ctx.drawImage(img, 0, 0, 200, 150);
            gif.addFrame(canvas, { delay: 200 });
            
            gif.on('finished', (compressedBlob) => {
              const reader = new FileReader();
              reader.onload = () => {
                const compressed = reader.result;
                console.log(`GIF comprimido: ${gifDataUrl.length} â†’ ${compressed.length} bytes`);
                resolve(compressed);
              };
              reader.readAsDataURL(compressedBlob);
            });
            
            gif.render();
          };
          
          img.onerror = () => {
            console.log('Error cargando GIF, usando fallback');
            resolve(gifDataUrl); // Devolver original si falla
          };
          
          img.src = gifDataUrl;
        });
      } catch (error) {
        console.error('Error comprimiendo GIF:', error);
        return gifDataUrl;
      }
    }
    
    // Guardar dibujo con moderaciÃ³n
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const saveBtn = document.getElementById('saveBtn');
      const saveText = document.getElementById('saveText');
      const saveLoader = document.getElementById('saveLoader');
      
      const cooldown = checkCooldown();
      if (cooldown > 0) {
        alert(`â° Espera ${cooldown} minuto(s) antes de subir otro dibujo`);
        return;
      }
      
      if (isCanvasEmpty()) {
        alert('Â¡Dibuja algo primero!');
        return;
      }
      
      // Show loading state
      saveBtn.disabled = true;
      saveText.style.display = 'none';
      saveLoader.style.display = 'inline';
      
      let imageData = canvas.toDataURL();
      const author = document.getElementById('authorName').value || 'AnÃ³nimo';
      const category = document.getElementById('categorySelect').value;
      
      // Comprimir imagen si es muy grande
      if (imageData.length > 500000) { // Si es mayor a ~500KB
        console.log('Comprimiendo imagen...');
        imageData = await compressImage(imageData, 600);
      }
      
      // ModeraciÃ³n de contenido
      const imageFlags = await analyzeImageContent(imageData);
      const textFlags = moderateText(author);
      
      // Verificar flags de moderaciÃ³n
      if (imageFlags.excessiveRed) {
        alert('ğŸš« Contenido rechazado: Detectado exceso de color rojo sospechoso');
        saveBtn.disabled = false;
        saveText.style.display = 'inline';
        saveLoader.style.display = 'none';
        return;
      }
      
      if (imageFlags.suspiciousContent) {
        alert('ğŸš« Contenido rechazado: Detectado contenido potencialmente inapropiado');
        saveBtn.disabled = false;
        saveText.style.display = 'inline';
        saveLoader.style.display = 'none';
        return;
      }
      
      if (textFlags.hasBannedWords) {
        alert(`ğŸš« Nombre rechazado: Contiene palabras no permitidas`);
        saveBtn.disabled = false;
        saveText.style.display = 'inline';
        saveLoader.style.display = 'none';
        return;
      }
      
      try {
        // Datos que coinciden exactamente con las reglas de Firestore
        const drawingData = {
          titulo: `Dibujo de ${author}`,
          imagenData: imageData,
          timestamp: Date.now(),
          autor: author,
          categoria: category || 'Arte',
          domain: 'thisisfenix.github.io',
          likes: 0,
          comments: [],
          strokes: strokeCount || 0,
          // Comprimir GIF de fondo si es muy grande (mantener animaciÃ³n pero reducir tamaÃ±o)
          backgroundGif: isBackgroundGif && currentBackgroundImage ? 
            (currentBackgroundImage.src.length > 900000 ? 
              await compressGifForFirebase(currentBackgroundImage.src) : 
              currentBackgroundImage.src) : null,
          // Guardar stickers GIF animados (estructura simplificada)
          gifStickers: stickers.filter(s => s && s.isGif && s.image && s.image.src).map(s => {
            return {
              src: String(s.image.src),
              x: Number(s.x) || 0,
              y: Number(s.y) || 0,
              width: Number(s.width) || 60,
              height: Number(s.height) || 60
            };
          }),
          moderation: {
            needsReview: imageFlags.needsReview,
            autoApproved: !imageFlags.needsReview,
            flags: imageFlags,
            reviewedBy: null,
            reviewedAt: null
          }
        };
        
        await addDoc(collection(db, 'dibujos'), drawingData);
        
        localStorage.setItem('lastDrawingSave', Date.now().toString());
        createConfetti();
        
        // Limpiar canvas y resetear estado
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.filter = 'none';
        ctx.globalAlpha = 1;
        document.getElementById('authorName').value = '';
        document.getElementById('categorySelect').value = 'Arte';
        strokeCount = 0;
        stickers = []; // Limpiar stickers despuÃ©s de guardar
        // Limpiar stickers GIF del DOM
        const gifContainer = document.getElementById('gifStickersContainer');
        gifContainer.innerHTML = '';
        hasUnsavedWork = false;
        updateUnsavedIndicator();
        saveState();
        
        // Actualizar perfil si el usuario coincide
        const authorName = author.trim();
        if (authorName && authorName.toLowerCase() === (currentProfile.username || '').toLowerCase()) {
          updateProfileStats();
        }
        
        // Guardar perfil del usuario en la base de perfiles
        if (authorName && currentProfile.username && authorName.toLowerCase() === currentProfile.username.toLowerCase()) {
          const savedProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
          savedProfiles[authorName.toLowerCase()] = {
            username: currentProfile.username,
            avatar: currentProfile.avatar,
            avatarType: currentProfile.avatarType,
            avatarImage: currentProfile.avatarImage
          };
          localStorage.setItem('userProfiles', JSON.stringify(savedProfiles));
        }
        
        setTimeout(() => {
          alert('Â¡Dibujo guardado!');
          document.getElementById('gallery').scrollIntoView({ behavior: 'smooth' });
        }, 1000);
      } catch (error) {
        console.error('Error completo:', error);
        if (error.code === 'permission-denied') {
          alert('âŒ Error de permisos. La base de datos no permite escritura desde este dominio.');
        } else if (error.code === 'unavailable') {
          alert('âŒ Servicio no disponible. Intenta mÃ¡s tarde.');
        } else {
          alert(`âŒ Error al guardar: ${error.message}`);
        }
      } finally {
        saveBtn.disabled = false;
        saveText.style.display = 'inline';
        saveLoader.style.display = 'none';
      }
    });

    function isCanvasEmpty() {
      const blank = document.createElement('canvas');
      blank.width = canvas.width;
      blank.height = canvas.height;
      return canvas.toDataURL() === blank.toDataURL();
    }

    // PaginaciÃ³n
    let currentPage = 1;
    const itemsPerPage = 12;
    let allDrawings = [];
    
    function renderPage(drawings, page) {
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      
      // Calcular top 3 para fijados
      const topLikes = [...allDrawings].sort((a, b) => (b.data.likes || 0) - (a.data.likes || 0));
      const top3Ids = topLikes.slice(0, 3).map(d => d.id);
      
      // Si estamos en la primera pÃ¡gina, mostrar fijados primero
      let pageDrawings;
      if (page === 1) {
        const top3Drawings = allDrawings.filter(d => top3Ids.includes(d.id));
        const otherDrawings = drawings.filter(d => !top3Ids.includes(d.id)).slice(0, itemsPerPage - top3Drawings.length);
        pageDrawings = [...top3Drawings, ...otherDrawings];
      } else {
        // En otras pÃ¡ginas, excluir los fijados y ajustar paginaciÃ³n
        const nonPinnedDrawings = drawings.filter(d => !top3Ids.includes(d.id));
        const adjustedStart = (page - 1) * itemsPerPage - 3; // Ajustar por los 3 fijados
        const adjustedEnd = adjustedStart + itemsPerPage;
        pageDrawings = nonPinnedDrawings.slice(adjustedStart, adjustedEnd);
      }
      
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      
      if (pageDrawings.length === 0) {
        gallery.innerHTML = `
          <div class="col-12 text-center" style="color: var(--text-secondary); padding: 3rem;">
            <i class="bi bi-palette" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <h4>No hay dibujos en esta pÃ¡gina</h4>
          </div>
        `;
        return;
      }
      
      pageDrawings.forEach((drawing) => {
        const data = drawing.data;
        const date = new Date(data.timestamp).toLocaleString('es-ES', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const likes = data.likes || 0;
        const category = data.categoria || 'Arte';
        
        // Determinar ranking y si estÃ¡ fijado
        const drawingRank = topLikes.findIndex(d => d.id === drawing.id) + 1;
        const isPinned = top3Ids.includes(drawing.id);
        let rankClass = '';
        if (drawingRank === 1) rankClass = 'rank-1';
        else if (drawingRank === 2) rankClass = 'rank-2';
        else if (drawingRank === 3) rankClass = 'rank-3';
        
        // Agregar indicador de fijado
        const pinnedIndicator = isPinned ? `
          <div class="pinned-indicator" style="position: absolute; top: 5px; left: 5px; background: linear-gradient(45deg, var(--primary), #ff8c42); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.7em; font-weight: bold; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);">
            ğŸ“Œ FIJADO
          </div>
        ` : '';
        
        const cardExtraClass = isPinned ? ' pinned' : '';
        
        gallery.innerHTML += `
          <div class="col-md-4 col-sm-6 mb-3 drawing-item" data-author="${data.autor.toLowerCase()}" data-category="${category}">
            <div class="drawing-card ${rankClass}${cardExtraClass}" style="position: relative;">
              ${pinnedIndicator}
              ${data.backgroundGif || data.gifStickers ? `
                <div style="position: relative; width: 100%; height: 200px; background: white; border-radius: 4px; overflow: hidden;">
                  ${data.backgroundGif ? `<img src="${data.backgroundGif}" style="position: absolute; width: 100%; height: 100%; object-fit: contain; z-index: 1; image-rendering: auto;" alt="Fondo GIF animado" loading="lazy">` : ''}
                  <img src="${data.imagenData}" style="position: absolute; width: 100%; height: 100%; object-fit: contain; z-index: 2; ${data.backgroundGif ? 'mix-blend-mode: multiply; opacity: 0.9;' : ''}" alt="Dibujo de ${data.autor}" loading="lazy">
                  ${data.gifStickers ? data.gifStickers.map(sticker => `
                    <img src="${sticker.src}" style="position: absolute; left: ${(sticker.x / 600) * 100}%; top: ${(sticker.y / 400) * 100}%; width: ${(sticker.width / 600) * 100}%; height: ${(sticker.height / 400) * 100}%; z-index: 3; image-rendering: auto;" alt="Sticker GIF" loading="lazy">
                  `).join('') : ''}
                </div>
              ` : `
                <img src="${data.imagenData}" class="drawing-img" alt="Dibujo de ${data.autor}" loading="lazy">
              `}
              <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <strong style="color: var(--primary);">ğŸ¨ ${data.autor}</strong>
                    ${drawingRank <= 3 ? `<span style="color: ${drawingRank === 1 ? '#FFD700' : drawingRank === 2 ? '#C0C0C0' : '#CD7F32'}; font-size: 0.8em; font-weight: bold;"> #${drawingRank}</span>` : ''}
                    <br><small style="color: var(--text-secondary);">${category}</small>
                  </div>
                  <small style="color: var(--text-secondary);">${date}</small>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-danger like-btn" data-id="${drawing.id}" data-likes="${likes}">
                      â¤ï¸ ${likes}
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="viewImage('${data.imagenData}', '${drawing.id}', '${data.backgroundGif || ''}', ${data.gifStickers ? JSON.stringify(data.gifStickers).replace(/"/g, '&quot;') : 'null'})" title="Ver comentarios">
                      ğŸ’¬ ${data.comments?.length || 0}
                    </button>
                  </div>
                  <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-info" onclick="viewImage('${data.imagenData}', '${drawing.id}', '${data.backgroundGif || ''}', ${data.gifStickers ? JSON.stringify(data.gifStickers).replace(/"/g, '&quot;') : 'null'})">ğŸ”</button>
                    <button class="btn btn-sm btn-outline-success" onclick="downloadImage('${data.imagenData}', '${data.autor}')">ğŸ’¾</button>
                    <button class="btn btn-sm btn-outline-warning" onclick="shareDrawing('${data.imagenData}', '${data.autor}')">ğŸ“¤</button>
                    <div class="drawing-admin-controls" id="drawing-admin-${drawing.id}" style="display: ${isAdminMode ? 'inline-flex' : 'none'};">
                      <button class="btn btn-sm btn-danger" onclick="deleteDrawing('${drawing.id}')" title="Eliminar dibujo">ğŸ—‘ï¸</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      // Update pagination controls (ajustar por fijados)
      const nonPinnedCount = allDrawings.length - 3;
      const totalPages = Math.ceil((nonPinnedCount + 3) / itemsPerPage);
      document.getElementById('pageInfo').textContent = `PÃ¡gina ${page} de ${totalPages}`;
      document.getElementById('prevPage').disabled = page === 1;
      document.getElementById('nextPage').disabled = page === totalPages;
      
      // Add like events - solo 1 like por usuario
      document.querySelectorAll('.like-btn').forEach(btn => {
        const docId = btn.dataset.id;
        const hasLiked = localStorage.getItem(`liked_${docId}`);
        
        if (hasLiked) {
          btn.classList.remove('btn-outline-danger');
          btn.classList.add('btn-danger');
          btn.disabled = true;
          btn.innerHTML = `â¤ï¸ ${btn.dataset.likes} (Votado)`;
        }
        
        btn.addEventListener('click', async () => {
          if (hasLiked) return;
          
          const currentLikes = parseInt(btn.dataset.likes) || 0;
          try {
            await updateDoc(doc(db, 'dibujos', docId), {
              likes: currentLikes + 1
            });
            localStorage.setItem(`liked_${docId}`, 'true');
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-danger');
            btn.disabled = true;
            btn.innerHTML = `â¤ï¸ ${currentLikes + 1} (Votado)`;
            
            // Actualizar dataset para otros botones del mismo elemento
            btn.dataset.likes = currentLikes + 1;
            
            // Actualizar otros botones del mismo dibujo
            document.querySelectorAll(`[data-id="${docId}"]`).forEach(otherBtn => {
              if (otherBtn !== btn) {
                otherBtn.dataset.likes = currentLikes + 1;
                if (otherBtn.classList.contains('like-btn')) {
                  otherBtn.innerHTML = `â¤ï¸ ${currentLikes + 1} (Votado)`;
                  otherBtn.classList.remove('btn-outline-danger');
                  otherBtn.classList.add('btn-danger');
                  otherBtn.disabled = true;
                }
              }
            });
          } catch (error) {
            console.error('Error al dar like:', error);
          }
        });
      });
    }
    
    // Pagination controls (ajustados para fijados)
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage(allDrawings, currentPage);
      }
    });
    
    document.getElementById('nextPage').addEventListener('click', () => {
      const nonPinnedCount = allDrawings.length - 3;
      const totalPages = Math.ceil((nonPinnedCount + 3) / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderPage(allDrawings, currentPage);
      }
    });
    
    // Cargar dibujos en tiempo real
    const q = query(collection(db, 'dibujos'), orderBy('timestamp', 'desc'));
    let isFirstLoad = true;
    
    onSnapshot(q, (snapshot) => {
      const previousCount = allDrawings.length;
      allDrawings = [];
      const suggestions = [];
      
      snapshot.forEach((doc) => {
        const data = doc.data();
        if (data.tipo_contenido === 'sugerencia') {
          suggestions.push({ id: doc.id, data: data });
        } else {
          allDrawings.push({ id: doc.id, data: data });
        }
      });
      
      // Actualizar sugerencias si no se cargaron desde su colecciÃ³n
      if (allSuggestions.length === 0 && suggestions.length > 0) {
        allSuggestions = suggestions;
        renderSuggestions(allSuggestions);
      }
      
      // Limpiar galerÃ­a
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      
      if (allDrawings.length === 0) {
        gallery.innerHTML = `
          <div class="col-12 text-center" style="color: var(--text-secondary); padding: 3rem;">
            <i class="bi bi-palette" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <h4>AÃºn no hay dibujos</h4>
            <p>Â¡SÃ© el primero en dejar tu huella artÃ­stica!</p>
          </div>
        `;
        return;
      }
      
      // Si hay un nuevo dibujo y no es la primera carga, ir a la primera pÃ¡gina
      if (!isFirstLoad && allDrawings.length > previousCount) {
        currentPage = 1;
      }
      
      // Mostrar Top 3 y contador ANTES de renderizar para no sobrescribir eventos
      showTopRanking(allDrawings);
      renderPage(allDrawings, currentPage);
      showCounter(allDrawings.length);
      
      // Actualizar estadÃ­sticas del perfil cuando cambien los datos
      setTimeout(() => {
        if (currentProfile.username) {
          updateProfileStats();
        }
      }, 1000);
      
      // Configurar filtros una sola vez
      if (isFirstLoad) {
        setupFilters();
        isFirstLoad = false;
      }
    });
    
    // Funciones auxiliares
    function setupFilters() {
      const searchAuthor = document.getElementById('searchAuthor');
      const filterCategory = document.getElementById('filterCategory');
      const clearFilters = document.getElementById('clearFilters');
      
      if (searchAuthor && filterCategory && clearFilters && !searchAuthor.hasEventListener) {
        function applyFilters() {
          const authorFilter = searchAuthor.value.toLowerCase();
          const categoryFilter = filterCategory.value;
          
          document.querySelectorAll('.drawing-item').forEach(item => {
            const author = item.dataset.author;
            const category = item.dataset.category;
            
            const matchesAuthor = !authorFilter || author.includes(authorFilter);
            const matchesCategory = !categoryFilter || category === categoryFilter;
            
            item.style.display = matchesAuthor && matchesCategory ? 'block' : 'none';
          });
        }
        
        searchAuthor.addEventListener('input', applyFilters);
        filterCategory.addEventListener('change', applyFilters);
        clearFilters.addEventListener('click', () => {
          searchAuthor.value = '';
          filterCategory.value = '';
          applyFilters();
        });
        
        searchAuthor.hasEventListener = true;
      }
    }
    
    function showTopRanking(drawings) {
      const gallery = document.getElementById('gallery');
      
      // Rankings mÃºltiples
      const topLikes = [...drawings].sort((a, b) => (b.data.likes || 0) - (a.data.likes || 0)).slice(0, 3);
      const topComments = [...drawings].sort((a, b) => (b.data.comments?.length || 0) - (a.data.comments?.length || 0)).slice(0, 3);
      const topStrokes = [...drawings].sort((a, b) => (b.data.strokes || 0) - (a.data.strokes || 0)).slice(0, 3);
      const recent = [...drawings].sort((a, b) => b.data.timestamp - a.data.timestamp).slice(0, 3);
      
      if (drawings.length >= 3) {
        const rankingsDiv = document.createElement('div');
        rankingsDiv.className = 'col-12 mb-4';
        rankingsDiv.innerHTML = `
          <div style="background: var(--bg-light); border-radius: 15px; padding: 20px; border: 2px solid var(--primary); margin-bottom: 30px;">
            <h4 style="color: var(--primary); margin-bottom: 20px; text-align: center;">ğŸ† Rankings de la GalerÃ­a</h4>
            
            <!-- Tabs de Rankings -->
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
              <button class="ranking-tab active" data-ranking="likes" style="padding: 8px 16px; border: 2px solid var(--primary); background: var(--primary); color: white; border-radius: 20px; cursor: pointer; font-size: 0.9em;">â¤ï¸ MÃ¡s Populares</button>
              <button class="ranking-tab" data-ranking="comments" style="padding: 8px 16px; border: 2px solid var(--primary); background: transparent; color: var(--primary); border-radius: 20px; cursor: pointer; font-size: 0.9em;">ğŸ’¬ MÃ¡s Comentados</button>
              <button class="ranking-tab" data-ranking="strokes" style="padding: 8px 16px; border: 2px solid var(--primary); background: transparent; color: var(--primary); border-radius: 20px; cursor: pointer; font-size: 0.9em;">ğŸ¨ MÃ¡s Detallados</button>
              <button class="ranking-tab" data-ranking="recent" style="padding: 8px 16px; border: 2px solid var(--primary); background: transparent; color: var(--primary); border-radius: 20px; cursor: pointer; font-size: 0.9em;">ğŸ†• Recientes</button>
            </div>
            
            <!-- Contenido de Rankings -->
            <div id="ranking-likes" class="ranking-content" style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
              ${topLikes.map((drawing, index) => createRankingCard(drawing, index, 'likes')).join('')}
            </div>
            
            <div id="ranking-comments" class="ranking-content" style="display: none; flex-wrap: wrap; justify-content: center; gap: 20px;">
              ${topComments.map((drawing, index) => createRankingCard(drawing, index, 'comments')).join('')}
            </div>
            
            <div id="ranking-strokes" class="ranking-content" style="display: none; flex-wrap: wrap; justify-content: center; gap: 20px;">
              ${topStrokes.map((drawing, index) => createRankingCard(drawing, index, 'strokes')).join('')}
            </div>
            
            <div id="ranking-recent" class="ranking-content" style="display: none; flex-wrap: wrap; justify-content: center; gap: 20px;">
              ${recent.map((drawing, index) => createRankingCard(drawing, index, 'recent')).join('')}
            </div>
            
            <!-- EstadÃ­sticas Generales -->
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--primary); text-align: center;">
              <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; font-size: 0.9em;">
                <span style="color: var(--text-secondary);">ğŸ“Š Total: <strong style="color: var(--primary);">${drawings.length}</strong></span>
                <span style="color: var(--text-secondary);">â¤ï¸ Likes: <strong style="color: var(--primary);">${drawings.reduce((sum, d) => sum + (d.data.likes || 0), 0)}</strong></span>
                <span style="color: var(--text-secondary);">ğŸ’¬ Comentarios: <strong style="color: var(--primary);">${drawings.reduce((sum, d) => sum + (d.data.comments?.length || 0), 0)}</strong></span>
                <span style="color: var(--text-secondary);">ğŸ¨ Trazos: <strong style="color: var(--primary);">${drawings.reduce((sum, d) => sum + (d.data.strokes || 0), 0)}</strong></span>
              </div>
            </div>
          </div>
        `;
        
        gallery.prepend(rankingsDiv);
        
        // Event listeners para tabs
        document.querySelectorAll('.ranking-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            // Remover active de todos los tabs
            document.querySelectorAll('.ranking-tab').forEach(t => {
              t.style.background = 'transparent';
              t.style.color = 'var(--primary)';
              t.classList.remove('active');
            });
            
            // Activar tab seleccionado
            tab.style.background = 'var(--primary)';
            tab.style.color = 'white';
            tab.classList.add('active');
            
            // Mostrar contenido correspondiente
            document.querySelectorAll('.ranking-content').forEach(content => {
              content.style.display = 'none';
            });
            
            const targetRanking = tab.dataset.ranking;
            const targetContent = document.getElementById(`ranking-${targetRanking}`);
            if (targetContent) {
              targetContent.style.display = 'flex';
            }
          });
        });
      }
    }
    
    function createRankingCard(drawing, index, type) {
      const colors = ['#FFD700', '#C0C0C0', '#CD7F32'];
      const color = colors[index] || '#666';
      
      let metric = '';
      let icon = '';
      
      switch(type) {
        case 'likes':
          metric = drawing.data.likes || 0;
          icon = 'â¤ï¸';
          break;
        case 'comments':
          metric = drawing.data.comments?.length || 0;
          icon = 'ğŸ’¬';
          break;
        case 'strokes':
          metric = drawing.data.strokes || 0;
          icon = 'ğŸ¨';
          break;
        case 'recent':
          const date = new Date(drawing.data.timestamp);
          metric = date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
          icon = 'ğŸ†•';
          break;
      }
      
      return `
        <div style="text-align: center; margin-bottom: 10px;">
          <div style="position: relative; display: inline-block; cursor: pointer; margin-bottom: 10px;" onclick="viewImage('${drawing.data.imagenData.replace(/'/g, "\\'")}'', '${drawing.id}', '${drawing.data.backgroundGif ? drawing.data.backgroundGif.replace(/'/g, "\\'"): ''}')">
            <img src="${drawing.data.imagenData}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 15px; border: 4px solid ${color}; box-shadow: 0 4px 15px rgba(0,0,0,0.3); background: white;">
            <div style="position: absolute; top: -8px; right: -8px; background: ${color}; color: ${index === 0 ? '#000' : '#fff'}; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1em; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
              ${index + 1}
            </div>
          </div>
          <div style="color: var(--text-primary); font-size: 0.9em; max-width: 100px;">
            <strong style="color: var(--primary);">${drawing.data.autor}</strong><br>
            <span style="color: ${color};">${icon} ${metric}</span>
          </div>
        </div>
      `;
    }
    
    function showCounter(totalDrawings) {
      const gallery = document.getElementById('gallery');
      
      // Calcular estadÃ­sticas avanzadas
      const totalLikes = allDrawings.reduce((sum, d) => sum + (d.data.likes || 0), 0);
      const totalComments = allDrawings.reduce((sum, d) => sum + (d.data.comments?.length || 0), 0);
      const totalStrokes = allDrawings.reduce((sum, d) => sum + (d.data.strokes || 0), 0);
      const avgLikes = totalDrawings > 0 ? (totalLikes / totalDrawings).toFixed(1) : 0;
      const avgStrokes = totalDrawings > 0 ? Math.round(totalStrokes / totalDrawings) : 0;
      
      // CategorÃ­as mÃ¡s populares
      const categories = {};
      allDrawings.forEach(d => {
        const cat = d.data.categoria || 'Arte';
        categories[cat] = (categories[cat] || 0) + 1;
      });
      const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
      
      // Dispositivos
      const devices = { mobile: 0, desktop: 0 };
      allDrawings.forEach(d => {
        const device = d.data.device || 'desktop';
        devices[device]++;
      });
      
      const counterDiv = document.createElement('div');
      counterDiv.className = 'col-12 text-center mt-4';
      counterDiv.innerHTML = `
        <div style="background: var(--bg-light); border-radius: 15px; padding: 25px; border: 1px solid var(--primary);">
          <!-- TÃ­tulo Principal -->
          <h5 style="color: var(--primary); margin: 0 0 20px 0; font-size: 1.3em;">ğŸ“Š EstadÃ­sticas de la GalerÃ­a</h5>
          
          <!-- EstadÃ­sticas Principales -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: var(--bg-dark); padding: 15px; border-radius: 10px; border: 1px solid var(--primary);">
              <div style="font-size: 1.5em; color: var(--primary);">ğŸ¨</div>
              <div style="font-size: 1.2em; font-weight: bold; color: var(--text-primary);">${totalDrawings}</div>
              <div style="font-size: 0.8em; color: var(--text-secondary);">Obras Totales</div>
            </div>
            
            <div style="background: var(--bg-dark); padding: 15px; border-radius: 10px; border: 1px solid var(--primary);">
              <div style="font-size: 1.5em; color: var(--primary);">â¤ï¸</div>
              <div style="font-size: 1.2em; font-weight: bold; color: var(--text-primary);">${totalLikes}</div>
              <div style="font-size: 0.8em; color: var(--text-secondary);">Likes Totales</div>
            </div>
            
            <div style="background: var(--bg-dark); padding: 15px; border-radius: 10px; border: 1px solid var(--primary);">
              <div style="font-size: 1.5em; color: var(--primary);">ğŸ’¬</div>
              <div style="font-size: 1.2em; font-weight: bold; color: var(--text-primary);">${totalComments}</div>
              <div style="font-size: 0.8em; color: var(--text-secondary);">Comentarios</div>
            </div>
            
            <div style="background: var(--bg-dark); padding: 15px; border-radius: 10px; border: 1px solid var(--primary);">
              <div style="font-size: 1.5em; color: var(--primary);">ğŸ”¥</div>
              <div style="font-size: 1.2em; font-weight: bold; color: var(--text-primary);">${avgLikes}</div>
              <div style="font-size: 0.8em; color: var(--text-secondary);">Promedio Likes</div>
            </div>
          </div>
          
          <!-- EstadÃ­sticas Adicionales -->
          <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-bottom: 15px; font-size: 0.9em;">
            <span style="color: var(--text-secondary);">ğŸ“± MÃ³vil: <strong style="color: var(--primary);">${devices.mobile}</strong></span>
            <span style="color: var(--text-secondary);">ğŸ’» Desktop: <strong style="color: var(--primary);">${devices.desktop}</strong></span>
            <span style="color: var(--text-secondary);">ğŸ¨ Trazos Promedio: <strong style="color: var(--primary);">${avgStrokes}</strong></span>
            ${topCategory ? `<span style="color: var(--text-secondary);">ğŸ·ï¸ Top CategorÃ­a: <strong style="color: var(--primary);">${topCategory[0]} (${topCategory[1]})</strong></span>` : ''}
          </div>
          
          <!-- Atajos de Teclado -->
          <div style="border-top: 1px solid var(--primary); padding-top: 15px;">
            <p style="color: var(--text-secondary); margin: 5px 0; font-size: 0.9em;">âŒ¨ï¸ <strong>Atajos:</strong> B=Pincel, S=Spray, C=CÃ­rculo, L=LÃ­nea, T=Texto, E=Borrador, H=Mano</p>
            <small style="color: var(--text-secondary); font-size: 0.8em;">Ctrl+Z=Deshacer, Ctrl+Y=Rehacer, F=Relleno, I=Cuentagotas</small>
          </div>
          
          <!-- Sistema de Fijados -->
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--primary); font-size: 0.85em; color: var(--text-secondary); text-align: center;">
            <p style="margin: 0 0 5px 0;">ğŸ“Œ <strong style="color: var(--primary);">Sistema de Fijados:</strong> Los 3 dibujos con mÃ¡s likes aparecen fijados en la primera pÃ¡gina</p>
            <small style="color: var(--text-secondary);">Los fijados se actualizan automÃ¡ticamente segÃºn el ranking de popularidad</small>
          </div>
          
          <!-- InformaciÃ³n del Proyecto -->
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--primary); font-size: 0.8em; color: var(--text-secondary);">
            <p style="margin: 0;">ğŸ”¬ <strong>FenixLaboratory</strong> - Experimento de arte colaborativo</p>
            <p style="margin: 5px 0 0 0;">Creado por <strong style="color: var(--primary);">@ThisIsFenix</strong> | Powered by Firebase & Canvas API</p>
          </div>
        </div>
      `;
      gallery.appendChild(counterDiv);
    }
    
    // Animaciones
    function createSparkle(x, y) {
      const sparkle = document.createElement('div');
      sparkle.className = 'sparkle';
      sparkle.style.left = x + 'px';
      sparkle.style.top = y + 'px';
      document.body.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 600);
    }
    
    function createConfetti() {
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.style.position = 'fixed';
          confetti.style.left = Math.random() * window.innerWidth + 'px';
          confetti.style.top = '-10px';
          confetti.style.width = '8px';
          confetti.style.height = '8px';
          confetti.style.background = ['#ff6b35', '#00ff88', '#ff6b9d', '#00ff00'][Math.floor(Math.random() * 4)];
          confetti.style.borderRadius = '50%';
          confetti.style.pointerEvents = 'none';
          confetti.style.zIndex = '9999';
          document.body.appendChild(confetti);
          
          const fall = confetti.animate([
            { transform: 'translateY(0px) rotate(0deg)', opacity: 1 },
            { transform: `translateY(${window.innerHeight + 100}px) rotate(360deg)`, opacity: 0 }
          ], { duration: 2000 });
          
          fall.onfinish = () => confetti.remove();
        }, i * 50);
      }
    }
    
    // Sistema de Perfiles
    let currentProfile = {
      username: '',
      avatar: 'ğŸ‘¤',
      avatarType: 'emoji',
      avatarImage: null,
      totalDrawings: 0,
      totalLikes: 0,
      totalComments: 0,
      joinDate: Date.now(),
      favoriteCategory: 'Arte',
      achievements: []
    };
    
    // Cargar perfil desde localStorage
    function loadProfile() {
      const saved = localStorage.getItem('userProfile');
      if (saved) {
        currentProfile = { ...currentProfile, ...JSON.parse(saved) };
      }
      updateProfileCircle();
    }
    
    // Guardar perfil en localStorage y Firebase
    async function saveProfile() {
      localStorage.setItem('userProfile', JSON.stringify(currentProfile));
      
      if (currentProfile.username) {
        try {
          // Verificar si ya existe un perfil con este username
          const existingQuery = query(
            collection(db, 'profiles'), 
            where('username', '==', currentProfile.username)
          );
          const existingDocs = await getDocs(existingQuery);
          
          const profileData = {
            username: currentProfile.username,
            avatar: currentProfile.avatar,
            avatarType: currentProfile.avatarType,
            avatarImage: currentProfile.avatarImage,
            totalDrawings: currentProfile.totalDrawings || 0,
            totalLikes: currentProfile.totalLikes || 0,
            achievements: currentProfile.achievements || [],
            domain: 'thisisfenix.github.io',
            joinDate: currentProfile.joinDate || Date.now(),
            lastUpdated: Date.now()
          };
          
          if (existingDocs.empty) {
            // Solo crear si no existe
            await addDoc(collection(db, 'profiles'), profileData);
            console.log('Perfil creado en Firebase');
          } else {
            // Actualizar el existente
            const docId = existingDocs.docs[0].id;
            await updateDoc(doc(db, 'profiles', docId), profileData);
            console.log('Perfil actualizado en Firebase');
          }
        } catch (error) {
          if (error.code !== 'permission-denied') {
            console.log('Error guardando perfil en Firebase:', error);
          }
        }
      }
    }
    
    // Actualizar cÃ­rculo de perfil
    function updateProfileCircle() {
      const circle = document.getElementById('profileCircle');
      if (circle) {
        if (currentProfile.avatarType === 'image' && currentProfile.avatarImage) {
          circle.style.backgroundImage = `url(${currentProfile.avatarImage})`;
          circle.style.backgroundSize = 'cover';
          circle.style.backgroundPosition = 'center';
          circle.textContent = '';
        } else {
          circle.style.backgroundImage = 'none';
          circle.textContent = currentProfile.avatar;
        }
        circle.title = currentProfile.username || 'Mi Perfil';
      }
    }
    
    // Actualizar estadÃ­sticas del perfil
    function updateProfileStats() {
      // Contar dibujos del usuario
      const userDrawings = allDrawings.filter(d => 
        d.data.autor.toLowerCase() === currentProfile.username.toLowerCase()
      );
      
      currentProfile.totalDrawings = userDrawings.length;
      currentProfile.totalLikes = userDrawings.reduce((sum, d) => sum + (d.data.likes || 0), 0);
      currentProfile.totalComments = userDrawings.reduce((sum, d) => sum + (d.data.comments?.length || 0), 0);
      
      // CategorÃ­a favorita
      const categories = {};
      userDrawings.forEach(d => {
        const cat = d.data.categoria || 'Arte';
        categories[cat] = (categories[cat] || 0) + 1;
      });
      const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0];
      if (topCategory) {
        currentProfile.favoriteCategory = topCategory[0];
      }
      
      // Logros
      currentProfile.achievements = [];
      if (currentProfile.totalDrawings >= 1) currentProfile.achievements.push('ğŸ¨ Primer Dibujo');
      if (currentProfile.totalDrawings >= 5) currentProfile.achievements.push('ğŸ–Œï¸ Artista Activo');
      if (currentProfile.totalDrawings >= 10) currentProfile.achievements.push('ğŸ† Maestro del Arte');
      if (currentProfile.totalLikes >= 10) currentProfile.achievements.push('â¤ï¸ Popular');
      if (currentProfile.totalLikes >= 50) currentProfile.achievements.push('â­ Estrella');
      if (currentProfile.totalComments >= 20) currentProfile.achievements.push('ğŸ’¬ Conversador');
      
      saveProfile();
    }
    
    // Mostrar modal de perfil
    function showProfileModal() {
      updateProfileStats();
      
      const modal = document.createElement('div');
      modal.className = 'profile-modal';
      
      const content = document.createElement('div');
      content.className = 'profile-content';
      
      // Obtener dibujos del usuario
      const userDrawings = allDrawings.filter(d => 
        d.data.autor.toLowerCase() === (currentProfile.username || '').toLowerCase()
      ).slice(0, 12);
      
      content.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div class="profile-avatar" id="profileAvatar" style="${currentProfile.avatarType === 'image' && currentProfile.avatarImage ? `background-image: url(${currentProfile.avatarImage}); background-size: cover; background-position: center;` : ''}">
            ${currentProfile.avatarType === 'emoji' ? currentProfile.avatar : ''}
          </div>
          <h3 style="color: var(--primary); margin: 0;">${currentProfile.username || 'Usuario AnÃ³nimo'}</h3>
          <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 0.9em;">
            Miembro desde ${new Date(currentProfile.joinDate).toLocaleDateString('es-ES')}
          </p>
        </div>
        
        <div class="profile-stats">
          <div class="stat-card">
            <div class="stat-number">${currentProfile.totalDrawings}</div>
            <div class="stat-label">Dibujos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${currentProfile.totalLikes}</div>
            <div class="stat-label">Likes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${currentProfile.totalComments}</div>
            <div class="stat-label">Comentarios</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${currentProfile.favoriteCategory}</div>
            <div class="stat-label">CategorÃ­a Fav.</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${JSON.parse(localStorage.getItem('following') || '[]').length}</div>
            <div class="stat-label">Siguiendo</div>
          </div>
        </div>
        
        ${JSON.parse(localStorage.getItem('following') || '[]').length > 0 ? `
          <div style="margin: 20px 0;">
            <h5 style="color: var(--primary); margin-bottom: 10px;">ğŸ‘¥ Siguiendo (${JSON.parse(localStorage.getItem('following') || '[]').length})</h5>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${JSON.parse(localStorage.getItem('following') || '[]').map(username => `
                <span onclick="showAuthorProfile('${username}')" style="background: var(--bg-dark); padding: 6px 12px; border-radius: 15px; font-size: 0.8em; border: 1px solid var(--primary); cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='var(--primary)'" onmouseout="this.style.background='var(--bg-dark)'">
                  ğŸ‘¤ ${username}
                </span>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${currentProfile.achievements.length > 0 ? `
          <div style="margin: 20px 0;">
            <h5 style="color: var(--primary); margin-bottom: 10px;">ğŸ† Logros</h5>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${currentProfile.achievements.map(achievement => `
                <span style="background: var(--bg-dark); padding: 6px 12px; border-radius: 15px; font-size: 0.8em; border: 1px solid var(--primary);">
                  ${achievement}
                </span>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${userDrawings.length > 0 ? `
          <div style="margin: 20px 0;">
            <h5 style="color: var(--primary); margin-bottom: 10px;">ğŸ¨ Mis Dibujos (${currentProfile.totalDrawings})</h5>
            <div class="user-drawings-grid">
              ${userDrawings.map(drawing => `
                <div class="user-drawing-item" onclick="viewImage('${drawing.data.imagenData.replace(/'/g, "\\'")}'', '${drawing.id}', '${drawing.data.backgroundGif ? drawing.data.backgroundGif.replace(/'/g, "\\'"): ''}')">
                  <img src="${drawing.data.imagenData}" class="user-drawing-img" alt="Dibujo">
                  <div class="user-drawing-info">
                    <div style="color: var(--primary); font-weight: bold;">â¤ï¸ ${drawing.data.likes || 0}</div>
                    <div style="color: var(--text-secondary); font-size: 0.7em;">${drawing.data.categoria}</div>
                  </div>
                </div>
              `).join('')}
            </div>
            ${currentProfile.totalDrawings > 12 ? `<p style="text-align: center; color: var(--text-secondary); font-size: 0.8em; margin-top: 10px;">... y ${currentProfile.totalDrawings - 12} mÃ¡s</p>` : ''}
          </div>
        ` : ''}
        
        <div style="border-top: 1px solid var(--primary); padding-top: 20px; margin-top: 20px;">
          <h5 style="color: var(--primary); margin-bottom: 15px;">âš™ï¸ ConfiguraciÃ³n</h5>
          
          <div style="margin-bottom: 15px;">
            <label style="color: var(--text-primary); display: block; margin-bottom: 5px;">ğŸ‘¤ Nombre de Usuario</label>
            <input type="text" id="profileUsername" value="${currentProfile.username}" placeholder="Tu nombre de usuario" style="width: 100%; padding: 8px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); border-radius: 5px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="color: var(--text-primary); display: block; margin-bottom: 5px;">ğŸ˜€ Avatar</label>
            
            <div style="margin-bottom: 10px;">
              <button id="useEmojiAvatar" style="padding: 6px 12px; margin-right: 10px; background: ${currentProfile.avatarType === 'emoji' ? 'var(--primary)' : 'var(--bg-dark)'}; color: white; border: 1px solid var(--primary); border-radius: 5px; cursor: pointer; font-size: 0.8em;">ğŸ“± Emoji</button>
              <button id="useImageAvatar" style="padding: 6px 12px; background: ${currentProfile.avatarType === 'image' ? 'var(--primary)' : 'var(--bg-dark)'}; color: white; border: 1px solid var(--primary); border-radius: 5px; cursor: pointer; font-size: 0.8em;">ğŸ–¼ï¸ Imagen</button>
            </div>
            
            <div id="emojiAvatars" style="display: ${currentProfile.avatarType === 'emoji' ? 'flex' : 'none'}; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
              ${['ğŸ‘¤', 'ğŸ˜€', 'ğŸ˜', 'ğŸ¤“', 'ğŸ¨', 'ğŸ–Œï¸', 'ğŸ­', 'ğŸ¦„', 'ğŸ±', 'ğŸ¶', 'ğŸ¦Š', 'ğŸ¼'].map(emoji => `
                <button class="avatar-btn" data-avatar="${emoji}" style="width: 40px; height: 40px; border: 2px solid ${currentProfile.avatar === emoji && currentProfile.avatarType === 'emoji' ? 'var(--primary)' : 'transparent'}; background: var(--bg-dark); border-radius: 50%; cursor: pointer; font-size: 1.2em;">
                  ${emoji}
                </button>
              `).join('')}
            </div>
            
            <div id="imageAvatarSection" style="display: ${currentProfile.avatarType === 'image' ? 'block' : 'none'};">
              <input type="file" id="avatarImageUpload" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); border-radius: 5px; margin-bottom: 10px;">
              <small style="color: var(--text-secondary); display: block;">Sube una imagen PNG/JPG (mÃ¡x 1MB)</small>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="saveProfile" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ’¾ Guardar</button>
            <button id="closeProfile" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer;">âŒ Cerrar</button>
          </div>
        </div>
      `;
      
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // Event listeners para avatares
      document.getElementById('useEmojiAvatar').addEventListener('click', () => {
        currentProfile.avatarType = 'emoji';
        document.getElementById('useEmojiAvatar').style.background = 'var(--primary)';
        document.getElementById('useImageAvatar').style.background = 'var(--bg-dark)';
        document.getElementById('emojiAvatars').style.display = 'flex';
        document.getElementById('imageAvatarSection').style.display = 'none';
        updateProfileAvatar();
      });
      
      document.getElementById('useImageAvatar').addEventListener('click', () => {
        currentProfile.avatarType = 'image';
        document.getElementById('useImageAvatar').style.background = 'var(--primary)';
        document.getElementById('useEmojiAvatar').style.background = 'var(--bg-dark)';
        document.getElementById('emojiAvatars').style.display = 'none';
        document.getElementById('imageAvatarSection').style.display = 'block';
        updateProfileAvatar();
      });
      
      document.querySelectorAll('.avatar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.avatar-btn').forEach(b => b.style.border = '2px solid transparent');
          btn.style.border = '2px solid var(--primary)';
          currentProfile.avatar = btn.dataset.avatar;
          currentProfile.avatarType = 'emoji';
          updateProfileAvatar();
        });
      });
      
      document.getElementById('avatarImageUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          if (file.size > 1024 * 1024) {
            alert('ğŸš« Imagen muy grande. MÃ¡ximo 1MB.');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = (event) => {
            currentProfile.avatarImage = event.target.result;
            currentProfile.avatarType = 'image';
            updateProfileAvatar();
          };
          reader.readAsDataURL(file);
        }
      });
      
      function updateProfileAvatar() {
        const avatar = document.getElementById('profileAvatar');
        if (currentProfile.avatarType === 'image' && currentProfile.avatarImage) {
          avatar.style.backgroundImage = `url(${currentProfile.avatarImage})`;
          avatar.style.backgroundSize = 'cover';
          avatar.style.backgroundPosition = 'center';
          avatar.textContent = '';
        } else {
          avatar.style.backgroundImage = 'none';
          avatar.textContent = currentProfile.avatar;
        }
      }
      
      document.getElementById('saveProfile').addEventListener('click', async () => {
        const username = document.getElementById('profileUsername').value.trim();
        if (username) {
          currentProfile.username = username;
          await saveProfile();
          updateProfileCircle();
          alert('âœ… Perfil guardado');
          modal.remove();
        } else {
          alert('âš ï¸ Ingresa un nombre de usuario');
        }
      });
      
      document.getElementById('closeProfile').addEventListener('click', () => {
        modal.remove();
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
      
      // Inicializar vista de avatar
      updateProfileAvatar();
    }
    
    // Funciones para sistema de seguimiento
    async function getUserProfile(username) {
      // Buscar primero en localStorage
      const savedProfiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
      const localProfile = savedProfiles[username.toLowerCase()];
      
      if (localProfile) {
        return localProfile;
      }
      
      // Buscar en Firebase
      try {
        const profileQuery = query(collection(db, 'profiles'), where('username', '==', username));
        const querySnapshot = await getDocs(profileQuery);
        
        if (!querySnapshot.empty) {
          const profileData = querySnapshot.docs[0].data();
          // Guardar en localStorage para cache
          savedProfiles[username.toLowerCase()] = profileData;
          localStorage.setItem('userProfiles', JSON.stringify(savedProfiles));
          return profileData;
        }
      } catch (error) {
        console.log('Error cargando perfil desde Firebase:', error);
      }
      
      // Perfil por defecto si no se encuentra
      return {
        username: username,
        avatar: 'ğŸ‘¤',
        avatarType: 'emoji',
        avatarImage: null
      };
    }
    
    function isFollowing(username) {
      const following = JSON.parse(localStorage.getItem('following') || '[]');
      return following.includes(username.toLowerCase());
    }
    
    function toggleFollow(username, button) {
      const following = JSON.parse(localStorage.getItem('following') || '[]');
      const usernameLower = username.toLowerCase();
      
      if (following.includes(usernameLower)) {
        // Dejar de seguir
        const index = following.indexOf(usernameLower);
        following.splice(index, 1);
        button.innerHTML = '+ Seguir';
        button.style.background = 'var(--primary)';
      } else {
        // Seguir
        following.push(usernameLower);
        button.innerHTML = 'âœ“ Siguiendo';
        button.style.background = '#28a745';
      }
      
      localStorage.setItem('following', JSON.stringify(following));
    }
    
    // Mostrar perfil de otro usuario
    window.showAuthorProfile = async function(username) {
      const userDrawings = allDrawings.filter(d => 
        d.data.autor.toLowerCase() === username.toLowerCase()
      );
      
      const totalLikes = userDrawings.reduce((sum, d) => sum + (d.data.likes || 0), 0);
      const totalComments = userDrawings.reduce((sum, d) => sum + (d.data.comments?.length || 0), 0);
      
      const authorProfile = await getUserProfile(username);
      
      const modal = document.createElement('div');
      modal.className = 'profile-modal';
      
      const content = document.createElement('div');
      content.className = 'profile-content';
      
      content.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div class="profile-avatar" style="${authorProfile.avatarType === 'image' && authorProfile.avatarImage ? `background-image: url(${authorProfile.avatarImage}); background-size: cover; background-position: center;` : ''}">
            ${authorProfile.avatarType === 'emoji' ? authorProfile.avatar : ''}
          </div>
          <h3 style="color: var(--primary); margin: 0;">${username}</h3>
          <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 0.9em;">
            ${userDrawings.length} dibujos â€¢ ${totalLikes} likes
          </p>
        </div>
        
        <div class="profile-stats">
          <div class="stat-card">
            <div class="stat-number">${userDrawings.length}</div>
            <div class="stat-label">Dibujos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${totalLikes}</div>
            <div class="stat-label">Likes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${totalComments}</div>
            <div class="stat-label">Comentarios</div>
          </div>
        </div>
        
        ${userDrawings.length > 0 ? `
          <div style="margin: 20px 0;">
            <h5 style="color: var(--primary); margin-bottom: 10px;">ğŸ¨ Sus Dibujos</h5>
            <div class="user-drawings-grid">
              ${userDrawings.slice(0, 12).map(drawing => `
                <div class="user-drawing-item" onclick="viewImage('${drawing.data.imagenData.replace(/'/g, "\\'")}'', '${drawing.id}', '${drawing.data.backgroundGif ? drawing.data.backgroundGif.replace(/'/g, "\\'"): ''}'); document.querySelector('.profile-modal').remove();">
                  <img src="${drawing.data.imagenData}" class="user-drawing-img" alt="Dibujo">
                  <div class="user-drawing-info">
                    <div style="color: var(--primary); font-weight: bold;">â¤ï¸ ${drawing.data.likes || 0}</div>
                    <div style="color: var(--text-secondary); font-size: 0.7em;">${drawing.data.categoria}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : '<p style="text-align: center; color: var(--text-secondary);">Este usuario aÃºn no tiene dibujos</p>'}
        
        <div style="text-align: center; margin-top: 20px;">
          <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer;">âŒ Cerrar</button>
        </div>
      `;
      
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    };
    
    // Event listener para el cÃ­rculo de perfil
    document.getElementById('profileCircle').addEventListener('click', showProfileModal);
    
    // BotÃ³n para usar nombre del perfil
    document.getElementById('useProfileName').addEventListener('click', () => {
      if (currentProfile.username) {
        document.getElementById('authorName').value = currentProfile.username;
      } else {
        alert('âš ï¸ Configura tu perfil primero');
        showProfileModal();
      }
    });
    
    // Cargar perfil al iniciar
    loadProfile();
    
    // Funciones globales
    window.downloadImage = function(imageData, author) {
      const link = document.createElement('a');
      link.download = `dibujo-${author}-${Date.now()}.png`;
      link.href = imageData;
      link.click();
    };
    
    let isSharing = false;
    
    window.shareDrawing = function(imageData, author) {
      if (isSharing) return;
      
      if (navigator.share) {
        isSharing = true;
        navigator.share({
          title: `Dibujo de ${author} - FenixLaboratory`,
          text: `Â¡Mira este increÃ­ble dibujo de ${author}!`,
          url: window.location.href
        }).finally(() => {
          isSharing = false;
        });
      } else {
        const text = `Â¡Mira este increÃ­ble dibujo de ${author} en FenixLaboratory! ${window.location.href}`;
        navigator.clipboard.writeText(text).then(() => {
          alert('Â¡Enlace copiado al portapapeles!');
        });
      }
    };
    
    window.viewImage = async function(imageData, drawingId, backgroundGif = '', gifStickers = null) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed !important; 
        top: 0 !important; 
        left: 0 !important; 
        width: 100vw !important; 
        height: 100vh !important; 
        background: rgba(0,0,0,0.95) !important; 
        z-index: 99999 !important; 
        display: flex !important; 
        align-items: center !important; 
        justify-content: center !important; 
        backdrop-filter: blur(5px) !important;
      `;
      
      const container = document.createElement('div');
      container.style.cssText = `
        display: flex !important;
        flex-direction: column !important;
        max-width: 95vw !important;
        max-height: 95vh !important;
        background: rgba(0,0,0,0.8) !important;
        border-radius: 20px !important;
        overflow: hidden !important;
      `;
      
      // Obtener datos del dibujo para mostrar perfil del autor
      const drawingData = allDrawings.find(d => d.id === drawingId)?.data;
      const authorName = drawingData?.autor || 'Desconocido';
      
      // Header con perfil del autor
      const authorHeader = document.createElement('div');
      authorHeader.style.cssText = `
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        padding: 15px 20px !important;
        background: var(--bg-light) !important;
        border-bottom: 1px solid var(--primary) !important;
      `;
      
      // Buscar perfil del autor
      const authorProfile = await getUserProfile(authorName);
      
      authorHeader.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(45deg, var(--primary), #ff8c42); display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: white; border: 2px solid rgba(255,255,255,0.2); ${authorProfile.avatarType === 'image' && authorProfile.avatarImage ? `background-image: url(${authorProfile.avatarImage}); background-size: cover; background-position: center;` : ''}">
            ${authorProfile.avatarType === 'emoji' ? authorProfile.avatar : ''}
          </div>
          <div>
            <h4 style="color: var(--primary); margin: 0; font-size: 1.1em;">${authorName}</h4>
            <p style="color: var(--text-secondary); margin: 0; font-size: 0.8em;">${drawingData?.categoria || 'Arte'} â€¢ ${drawingData ? new Date(drawingData.timestamp).toLocaleDateString('es-ES') : ''}</p>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button id="followBtn-${drawingId}" style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 0.8em;">
            ${isFollowing(authorName) ? 'âœ“ Siguiendo' : '+ Seguir'}
          </button>
          <button onclick="showAuthorProfile('${authorName.replace(/'/g, "\\'")}'')" style="padding: 6px 12px; background: transparent; color: var(--primary); border: 1px solid var(--primary); border-radius: 15px; cursor: pointer; font-size: 0.8em;">
            ğŸ‘¤ Ver Perfil
          </button>
        </div>
      `;
      
      // Contenedor principal con imagen y comentarios
      const mainContainer = document.createElement('div');
      mainContainer.style.cssText = `
        display: flex !important;
        flex: 1 !important;
        overflow: hidden !important;
      `;
      
      // Crear contenedor de imagen con fondo GIF si existe
      const imageContainer = document.createElement('div');
      imageContainer.style.cssText = `
        position: relative !important;
        flex: 1 !important;
        max-width: 60vw !important; 
        background: white !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      `;
      
      // Si hay fondo GIF, agregarlo (MANTENER ANIMACIÃ“N COMPLETA)
      if (backgroundGif && backgroundGif !== 'null' && backgroundGif !== '') {
        console.log('Mostrando GIF animado en modal:', backgroundGif.substring(0, 50) + '...');
        const bgImg = document.createElement('img');
        bgImg.src = backgroundGif; // GIF original con animaciÃ³n completa
        bgImg.style.cssText = `
          position: absolute !important;
          width: 100% !important;
          height: 100% !important;
          object-fit: contain !important;
          z-index: 1 !important;
          image-rendering: auto !important;
          image-rendering: -webkit-optimize-contrast !important;
        `;
        
        // Asegurar que el GIF se cargue correctamente
        bgImg.onload = () => {
          console.log('GIF de fondo cargado exitosamente en modal');
        };
        
        bgImg.onerror = () => {
          console.error('Error cargando GIF de fondo en modal');
        };
        
        imageContainer.appendChild(bgImg);
      }
      
      const img = document.createElement('img');
      img.src = imageData; // Este es el dibujo (puede estar comprimido)
      img.style.cssText = `
        position: relative !important;
        max-width: 100% !important; 
        max-height: 100% !important; 
        object-fit: contain !important;
        z-index: 2 !important;
        ${backgroundGif && backgroundGif !== 'null' && backgroundGif !== '' ? 'mix-blend-mode: multiply !important;' : ''}
      `;
      
      imageContainer.appendChild(img);
      
      // Cargar stickers GIF desde Firebase
      loadGifStickersInModal(drawingId, imageContainer);
      
      const commentsPanel = document.createElement('div');
      commentsPanel.style.cssText = `
        width: 350px !important;
        background: var(--bg-light) !important;
        padding: 20px !important;
        overflow-y: auto !important;
        border-radius: 0 15px 15px 0 !important;
      `;
      
      const closeBtn = document.createElement('div');
      closeBtn.innerHTML = 'âœ•';
      closeBtn.style.cssText = `
        position: absolute !important;
        top: 20px !important;
        right: 30px !important;
        color: white !important;
        font-size: 30px !important;
        cursor: pointer !important;
        background: rgba(0,0,0,0.7) !important;
        border-radius: 50% !important;
        width: 50px !important;
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 100000 !important;
      `;
      
      // Cargar comentarios
      loadComments(drawingId, commentsPanel);
      
      // Event listener para seguir
      const followBtn = authorHeader.querySelector(`#followBtn-${drawingId}`);
      followBtn.addEventListener('click', () => {
        toggleFollow(authorName, followBtn);
      });
      
      mainContainer.appendChild(imageContainer);
      mainContainer.appendChild(commentsPanel);
      container.appendChild(authorHeader);
      container.appendChild(mainContainer);
      modal.appendChild(container);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target === closeBtn) {
          modal.remove();
        }
      });
      
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', escHandler);
        }
      });
    };
    
    // FunciÃ³n para cargar stickers GIF en el modal
    async function loadGifStickersInModal(drawingId, container) {
      try {
        const docRef = doc(db, 'dibujos', drawingId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          const gifStickers = data.gifStickers || [];
          
          // Crear stickers GIF animados en el modal
          gifStickers.forEach(sticker => {
            const stickerImg = document.createElement('img');
            stickerImg.src = sticker.src;
            stickerImg.style.cssText = `
              position: absolute !important;
              left: ${(sticker.x / 600) * 100}% !important;
              top: ${(sticker.y / 400) * 100}% !important;
              width: ${(sticker.width / 600) * 100}% !important;
              height: ${(sticker.height / 400) * 100}% !important;
              z-index: 3 !important;
              image-rendering: auto !important;
              pointer-events: none !important;
            `;
            container.appendChild(stickerImg);
          });
        }
      } catch (error) {
        console.error('Error cargando stickers GIF:', error);
      }
    }
    
    async function loadComments(drawingId, panel) {
      try {
        const docRef = doc(db, 'dibujos', drawingId);
        
        // Usar onSnapshot para actualizaciones en tiempo real
        const unsubscribe = onSnapshot(docRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            const comments = data.comments || [];
            
            // Solo actualizar si el contenido cambiÃ³
            const currentCount = panel.querySelector('h5')?.textContent.match(/\d+/)?.[0];
            if (currentCount && parseInt(currentCount) === comments.length) {
              return; // No actualizar si no hay cambios
            }
            
            panel.innerHTML = `
              <h5 style="color: var(--primary); margin-bottom: 15px;">ğŸ’¬ Comentarios (${comments.length})</h5>
              <div id="commentsList" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                ${comments.map(comment => `
                  <div style="background: var(--bg-dark); padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                    <strong style="color: var(--primary); font-size: 0.9em;">${comment.author}</strong>
                    <p style="color: var(--text-primary); margin: 5px 0 0 0; font-size: 0.9em;">${comment.text}</p>
                    <small style="color: var(--text-secondary);">${new Date(comment.timestamp).toLocaleString('es-ES')}</small>
                  </div>
                `).join('')}
              </div>
              <div style="border-top: 1px solid var(--primary); padding-top: 15px;">
                <input type="text" id="commentAuthor" placeholder="Nombre de usuario (opcional)" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); margin-bottom: 8px; font-size: 0.9em; user-select: text !important; -webkit-user-select: text !important;">
                <input type="text" id="commentInput" placeholder="Escribe un comentario..." style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); margin-bottom: 10px; user-select: text !important; -webkit-user-select: text !important;" onkeypress="if(event.key==='Enter') addComment('${drawingId}')">
                <button id="commentBtn-${drawingId}" onclick="addComment('${drawingId}')" style="width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">â¤ Comentar</button>
              </div>
            `;
          }
        });
        
        // Limpiar listener cuando se cierre el modal
        const modal = panel.closest('.modal');
        if (modal) {
          modal.addEventListener('remove', () => unsubscribe());
        }
      } catch (error) {
        console.error('Error cargando comentarios:', error);
      }
    }
    
    // Sistema de moderaciÃ³n mejorado
    function moderateContent(text) {
      const bannedWords = [
        'nazi', 'hitler', 'terrorista', 'suicidio', 'matar', 'muerte',
        'gore', 'sangre', 'porno', 'sexo', 'desnudo', 'violacion',
        'drogas', 'cocaina', 'bomba', 'arma', 'pistola', 'cuchillo'
      ];
      
      const lowerText = text.toLowerCase();
      let moderatedText = text;
      
      for (const word of bannedWords) {
        if (lowerText.includes(word)) {
          moderatedText = moderatedText.replace(new RegExp(word, 'gi'), '***');
        }
      }
      
      return moderatedText;
    }
    
    function isSpamComment(text, author) {
      if (text.length < 2 || text.length > 500) return true;
      if (/^[^a-zA-Z0-9Ã€-Ã¿\s]+$/.test(text)) return true;
      if ((text.match(/http/gi) || []).length > 1) return true;
      if (author.length > 50) return true;
      return false;
    }
    
    let isSubmittingComment = false;
    
    window.addComment = async function(drawingId) {
      if (isSubmittingComment) return;
      
      const input = document.getElementById('commentInput');
      const authorInput = document.getElementById('commentAuthor');
      const commentBtn = document.getElementById(`commentBtn-${drawingId}`);
      const commentText = input.value.trim();
      if (!commentText) return;
      
      const author = authorInput.value.trim() || 'AnÃ³nimo';
      
      if (isSpamComment(commentText, author)) {
        alert('ğŸš« Comentario rechazado: Detectado como spam');
        return;
      }
      
      isSubmittingComment = true;
      if (commentBtn) {
        commentBtn.disabled = true;
        commentBtn.innerHTML = 'â³ Enviando...';
      }
      
      const moderatedAuthor = moderateContent(author);
      const moderatedText = moderateContent(commentText);
      
      try {
        const docRef = doc(db, 'dibujos', drawingId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const currentComments = docSnap.data().comments || [];
          const commentId = Date.now() + Math.random();
          
          // Verificar si ya existe un comentario similar reciente
          const recentSimilar = currentComments.find(c => 
            c.text === moderatedText && 
            c.author === moderatedAuthor && 
            (Date.now() - c.timestamp) < 5000
          );
          
          if (recentSimilar) {
            alert('âš ï¸ Comentario duplicado detectado');
            return;
          }
          
          await updateDoc(docRef, {
            comments: [...currentComments, { 
              id: commentId,
              author: moderatedAuthor, 
              text: moderatedText, 
              timestamp: Date.now()
            }]
          });
          input.value = '';
          authorInput.value = '';
        }
      } catch (error) {
        console.error('Error al agregar comentario:', error);
        alert('âŒ Error al enviar comentario');
      } finally {
        isSubmittingComment = false;
        if (commentBtn) {
          commentBtn.disabled = false;
          commentBtn.innerHTML = 'â¤ Comentar';
        }
      }
    };
    
    // Sistema de Sugerencias
    let allSuggestions = [];
    let currentSuggestionImage = null;
    
    // Subir imagen para sugerencia con moderaciÃ³n
    document.getElementById('suggestionImage').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/jpg' || file.type === 'image/gif')) {
        // Verificar tamaÃ±o (mÃ¡x 3MB)
        if (file.size > 3 * 1024 * 1024) {
          alert('ğŸš« Imagen muy grande. MÃ¡ximo 3MB permitido.');
          e.target.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = async (event) => {
          const imageData = event.target.result;
          
          // Solo moderar si no es GIF (los GIFs son mÃ¡s complejos de analizar)
          if (file.type !== 'image/gif') {
            const flags = await analyzeImageContent(imageData);
            if (flags.excessiveRed || flags.suspiciousContent) {
              alert('ğŸš« Imagen rechazada: Contenido potencialmente inapropiado detectado');
              e.target.value = '';
              return;
            }
          }
          
          currentSuggestionImage = imageData;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Enviar sugerencia
    document.getElementById('submitSuggestion').addEventListener('click', async () => {
      const submitBtn = document.getElementById('submitSuggestion');
      const suggestionTextSpan = document.getElementById('suggestionBtnText');
      const suggestionLoader = document.getElementById('suggestionLoader');
      
      const author = document.getElementById('suggestionAuthor').value.trim() || 'AnÃ³nimo';
      const type = document.getElementById('suggestionType').value;
      const text = document.getElementById('suggestionText').value.trim();
      
      if (!text) {
        alert('Â¡Escribe tu sugerencia primero!');
        return;
      }
      
      // Show loading state
      submitBtn.disabled = true;
      suggestionTextSpan.style.display = 'none';
      suggestionLoader.style.display = 'inline';
      
      try {
        const suggestionData = {
          autor: moderateContent(author),
          tipo: type,
          texto: moderateContent(text),
          imagen: currentSuggestionImage || null,
          timestamp: Date.now(),
          domain: 'thisisfenix.github.io',
          likes: 0,
          status: 'Pendiente'
        };
        
        // Intentar guardar en 'sugerencias', si falla usar 'dibujos' con tipo especial
        try {
          await addDoc(collection(db, 'sugerencias'), suggestionData);
        } catch (error) {
          if (error.code === 'permission-denied') {
            // Fallback: guardar como dibujo especial
            suggestionData.tipo_contenido = 'sugerencia';
            suggestionData.imagenData = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+ğŸ’¡</dGV4dD48L3N2Zz4=';
            await addDoc(collection(db, 'dibujos'), suggestionData);
          } else {
            throw error;
          }
        }
        
        // Limpiar formulario
        document.getElementById('suggestionAuthor').value = '';
        document.getElementById('suggestionType').value = 'Mejora';
        document.getElementById('suggestionText').value = '';
        document.getElementById('suggestionImage').value = '';
        currentSuggestionImage = null;
        
        alert('Â¡Sugerencia enviada! Gracias por tu feedback.');
        
      } catch (error) {
        console.error('Error al enviar sugerencia:', error);
        alert('âŒ Error al enviar sugerencia. IntÃ©ntalo mÃ¡s tarde.');
      } finally {
        submitBtn.disabled = false;
        suggestionTextSpan.style.display = 'inline';
        suggestionLoader.style.display = 'none';
      }
    });
    
    // Cargar sugerencias en tiempo real (con manejo de errores)
    try {
      const suggestionsQuery = query(collection(db, 'sugerencias'), orderBy('timestamp', 'desc'));
      
      onSnapshot(suggestionsQuery, (snapshot) => {
        allSuggestions = [];
        snapshot.forEach((doc) => {
          allSuggestions.push({ id: doc.id, data: doc.data() });
        });
        
        renderSuggestions(allSuggestions);
      }, (error) => {
        console.log('Sugerencias no disponibles:', error.code);
        renderSuggestions([]);
      });
    } catch (error) {
      console.log('Error al cargar sugerencias:', error.code);
      renderSuggestions([]);
    }
    
    function renderSuggestions(suggestions) {
      const gallery = document.getElementById('suggestionsGallery');
      gallery.innerHTML = '';
      
      if (suggestions.length === 0) {
        gallery.innerHTML = `
          <div class="col-12 text-center" style="color: var(--text-secondary); padding: 2rem;">
            <i class="bi bi-lightbulb" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <h5>Sistema de sugerencias en desarrollo</h5>
            <p>Las sugerencias se guardarÃ¡n temporalmente como dibujos especiales</p>
          </div>
        `;
        return;
      }
      
      suggestions.slice(0, 12).forEach((suggestion) => {
        const data = suggestion.data;
        const date = new Date(data.timestamp).toLocaleString('es-ES', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const typeIcons = {
          'Mejora': 'âœ¨',
          'Bug': 'ğŸ›',
          'UI/UX': 'ğŸ¨',
          'Performance': 'âš¡',
          'Otro': 'ğŸ’¬'
        };
        
        const statusColors = {
          'Pendiente': '#ffc107',
          'En Progreso': '#17a2b8',
          'Completado': '#28a745',
          'Rechazado': '#dc3545'
        };
        
        gallery.innerHTML += `
          <div class="col-md-6 col-lg-4 mb-3 suggestion-item" data-author="${data.autor.toLowerCase()}" data-type="${data.tipo}">
            <div style="background: var(--bg-dark); border: 1px solid var(--primary); border-radius: 10px; padding: 15px; height: 100%;">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <span style="background: var(--primary); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                    ${typeIcons[data.tipo]} ${data.tipo}
                  </span>
                </div>
                <small style="color: var(--text-secondary);">${date}</small>
              </div>
              
              <div class="mb-2">
                <strong style="color: var(--primary); font-size: 0.9em;">ğŸ‘¤ ${data.autor}</strong>
              </div>
              
              <p style="color: var(--text-primary); font-size: 0.9em; margin-bottom: 10px; line-height: 1.4;">
                ${data.texto.length > 100 ? data.texto.substring(0, 100) + '...' : data.texto}
              </p>
              
              ${data.imagen ? `
                <div class="mb-2">
                  <img src="${data.imagen}" style="width: 100%; max-height: 120px; object-fit: cover; border-radius: 6px; cursor: pointer;" onclick="viewSuggestionImage('${data.imagen}')">
                </div>
              ` : ''}
              
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <span style="background: ${statusColors[data.status] || statusColors['Pendiente']}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7em;">
                    ${data.status || 'Pendiente'}
                  </span>
                </div>
                <div class="d-flex gap-1 flex-wrap">
                  <button class="btn btn-sm btn-outline-primary suggestion-like-btn" data-id="${suggestion.id}" data-likes="${data.likes || 0}">
                    ğŸ‘ ${data.likes || 0}
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="viewSuggestionComments('${suggestion.id}')" title="Ver comentarios">
                    ğŸ’¬ ${data.comments?.length || 0}
                  </button>
                  <div class="owner-controls" id="owner-${suggestion.id}" style="display: ${isAdminMode ? 'flex' : 'none'}; gap: 2px;">
                    <button class="btn btn-sm btn-success" onclick="approveSuggestion('${suggestion.id}')" title="Aprobar">âœ“</button>
                    <button class="btn btn-sm btn-warning" onclick="rejectSuggestion('${suggestion.id}')" title="Rechazar">âœ—</button>
                    <button class="btn btn-sm btn-info" onclick="markInProgress('${suggestion.id}')" title="En progreso">ğŸ”„</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      // Add like events para sugerencias
      document.querySelectorAll('.suggestion-like-btn').forEach(btn => {
        const docId = btn.dataset.id;
        const hasLiked = localStorage.getItem(`suggestion_liked_${docId}`);
        
        if (hasLiked) {
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-primary');
          btn.disabled = true;
          btn.innerHTML = `ğŸ‘ ${btn.dataset.likes} (Votado)`;
        }
        
        btn.addEventListener('click', async () => {
          if (hasLiked) return;
          
          const currentLikes = parseInt(btn.dataset.likes) || 0;
          try {
            // Intentar actualizar en sugerencias, si falla usar dibujos
            try {
              await updateDoc(doc(db, 'sugerencias', docId), {
                likes: currentLikes + 1
              });
            } catch (error) {
              if (error.code === 'permission-denied') {
                await updateDoc(doc(db, 'dibujos', docId), {
                  likes: currentLikes + 1
                });
              } else {
                throw error;
              }
            }
            localStorage.setItem(`suggestion_liked_${docId}`, 'true');
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
            btn.disabled = true;
            btn.innerHTML = `ğŸ‘ ${currentLikes + 1} (Votado)`;
            
            // Actualizar dataset para otros botones del mismo elemento
            btn.dataset.likes = currentLikes + 1;
            
            // Actualizar otros botones de la misma sugerencia
            document.querySelectorAll(`[data-id="${docId}"]`).forEach(otherBtn => {
              if (otherBtn !== btn) {
                otherBtn.dataset.likes = currentLikes + 1;
                if (otherBtn.classList.contains('suggestion-like-btn')) {
                  otherBtn.innerHTML = `ğŸ‘ ${currentLikes + 1} (Votado)`;
                  otherBtn.classList.remove('btn-outline-primary');
                  otherBtn.classList.add('btn-primary');
                  otherBtn.disabled = true;
                }
              }
            });
          } catch (error) {
            console.error('Error al dar like a sugerencia:', error);
          }
        });
      });
    }
    
    // Filtros para sugerencias
    document.getElementById('searchSuggestions').addEventListener('input', filterSuggestions);
    document.getElementById('filterSuggestionType').addEventListener('change', filterSuggestions);
    document.getElementById('clearSuggestionFilters').addEventListener('click', () => {
      document.getElementById('searchSuggestions').value = '';
      document.getElementById('filterSuggestionType').value = '';
      filterSuggestions();
    });
    
    function filterSuggestions() {
      const searchTerm = document.getElementById('searchSuggestions').value.toLowerCase();
      const typeFilter = document.getElementById('filterSuggestionType').value;
      
      document.querySelectorAll('.suggestion-item').forEach(item => {
        const author = item.dataset.author;
        const type = item.dataset.type;
        const text = item.textContent.toLowerCase();
        
        const matchesSearch = !searchTerm || author.includes(searchTerm) || text.includes(searchTerm);
        const matchesType = !typeFilter || type === typeFilter;
        
        item.style.display = matchesSearch && matchesType ? 'block' : 'none';
      });
    }
    
    // Ver imagen de sugerencia
    window.viewSuggestionImage = function(imageData) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed !important; 
        top: 0 !important; 
        left: 0 !important; 
        width: 100vw !important; 
        height: 100vh !important; 
        background: rgba(0,0,0,0.9) !important; 
        z-index: 99999 !important; 
        display: flex !important; 
        align-items: center !important; 
        justify-content: center !important;
      `;
      
      const img = document.createElement('img');
      img.src = imageData;
      img.style.cssText = `
        max-width: 90vw !important; 
        max-height: 90vh !important; 
        border-radius: 10px !important;
        object-fit: contain !important;
      `;
      
      const closeBtn = document.createElement('div');
      closeBtn.innerHTML = 'âœ•';
      closeBtn.style.cssText = `
        position: absolute !important;
        top: 20px !important;
        right: 30px !important;
        color: white !important;
        font-size: 30px !important;
        cursor: pointer !important;
        background: rgba(0,0,0,0.7) !important;
        border-radius: 50% !important;
        width: 50px !important;
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      `;
      
      modal.appendChild(img);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target === closeBtn) {
          modal.remove();
        }
      });
    };
    
    // Sistema de autenticaciÃ³n de admin con Firebase Rules
    let isAdminMode = false;
    
    window.toggleAdminMode = async function() {
      if (isAdminMode) {
        // Salir del modo admin
        isAdminMode = false;
        document.getElementById('adminBtn').innerHTML = 'ğŸ”‘ Admin';
        document.getElementById('adminBtn').className = 'btn btn-sm btn-outline-warning';
        
        // Ocultar controles de admin para sugerencias
        document.querySelectorAll('.owner-controls').forEach(control => {
          control.style.display = 'none';
        });
        
        // Ocultar controles de admin para dibujos
        document.querySelectorAll('.drawing-admin-controls').forEach(control => {
          control.style.display = 'none';
        });
        
        alert('ğŸš« Modo admin desactivado');
      } else {
        // Entrar al modo admin
        const password = prompt('ğŸ”‘ Ingresa la contraseÃ±a de admin:');
        if (password === null) return;
        
        try {
          // Intentar crear documento de autenticaciÃ³n
          // Las reglas de Firebase validarÃ¡n la contraseÃ±a
          const authDoc = {
            adminPassword: password,
            timestamp: Date.now(),
            domain: 'thisisfenix.github.io'
          };
          
          await addDoc(collection(db, 'admin_auth'), authDoc);
          
          // Si llegamos aquÃ­, la contraseÃ±a es correcta
          isAdminMode = true;
          document.getElementById('adminBtn').innerHTML = 'ğŸš« Salir Admin';
          document.getElementById('adminBtn').className = 'btn btn-sm btn-danger';
          
          // Mostrar controles de admin para sugerencias
          document.querySelectorAll('.owner-controls').forEach(control => {
            control.style.display = 'flex';
          });
          
          // Mostrar controles de admin para dibujos
          document.querySelectorAll('.drawing-admin-controls').forEach(control => {
            control.style.display = 'inline-flex';
          });
          
          // Asegurar que los botones se muestren despuÃ©s de cargar contenido
          setTimeout(() => {
            document.querySelectorAll('.drawing-admin-controls').forEach(control => {
              control.style.display = 'inline-flex';
            });
            document.querySelectorAll('.owner-controls').forEach(control => {
              control.style.display = 'flex';
            });
          }, 1000);
          
          alert('âœ“ Modo admin activado');
          
        } catch (error) {
          if (error.code === 'permission-denied') {
            alert('âŒ ContraseÃ±a incorrecta');
          } else {
            console.error('Error de autenticaciÃ³n:', error);
            alert('âŒ Error de conexiÃ³n');
          }
        }
      }
    };
    
    // Funciones de moderaciÃ³n (solo funcionan en modo admin)
    window.approveSuggestion = async function(suggestionId) {
      if (!isAdminMode) {
        alert('âŒ Necesitas estar en modo admin');
        return;
      }
      
      if (!confirm('âœ“ Â¿Aprobar esta sugerencia?')) return;
      
      try {
        await updateDoc(doc(db, 'sugerencias', suggestionId), {
          status: 'Completado',
          reviewedBy: 'Admin',
          reviewedAt: Date.now()
        });
        
        alert('âœ“ Sugerencia aprobada');
      } catch (error) {
        try {
          await updateDoc(doc(db, 'dibujos', suggestionId), {
            status: 'Completado',
            reviewedBy: 'Admin',
            reviewedAt: Date.now(),
            adminAction: true
          });
          
          alert('âœ“ Sugerencia aprobada');
        } catch (e) {
          alert('âŒ Error al aprobar sugerencia');
        }
      }
    };
    
    window.rejectSuggestion = async function(suggestionId) {
      if (!isAdminMode) {
        alert('âŒ Necesitas estar en modo admin');
        return;
      }
      
      if (!confirm('âœ— Â¿Rechazar esta sugerencia?')) return;
      
      try {
        await updateDoc(doc(db, 'sugerencias', suggestionId), {
          status: 'Rechazado',
          reviewedBy: 'Admin',
          reviewedAt: Date.now()
        });
        
        alert('âœ— Sugerencia rechazada');
      } catch (error) {
        try {
          await updateDoc(doc(db, 'dibujos', suggestionId), {
            status: 'Rechazado',
            reviewedBy: 'Admin',
            reviewedAt: Date.now()
          });
          
          alert('âœ— Sugerencia rechazada');
        } catch (e) {
          alert('âŒ Error al rechazar sugerencia');
        }
      }
    };
    
    window.markInProgress = async function(suggestionId) {
      if (!isAdminMode) {
        alert('âŒ Necesitas estar en modo admin');
        return;
      }
      
      if (!confirm('ğŸ”„ Â¿Marcar como en progreso?')) return;
      
      try {
        await updateDoc(doc(db, 'sugerencias', suggestionId), {
          status: 'En Progreso',
          reviewedBy: 'Admin',
          reviewedAt: Date.now()
        });
        
        alert('ğŸ”„ Marcado como en progreso');
      } catch (error) {
        try {
          await updateDoc(doc(db, 'dibujos', suggestionId), {
            status: 'En Progreso',
            reviewedBy: 'Admin',
            reviewedAt: Date.now()
          });
          
          alert('ğŸ”„ Marcado como en progreso');
        } catch (e) {
          alert('âŒ Error al actualizar estado');
        }
      }
    };
    
    // FunciÃ³n para eliminar dibujos (solo admin)
    window.deleteDrawing = async function(drawingId) {
      if (!isAdminMode) {
        alert('âŒ Necesitas estar en modo admin');
        return;
      }
      
      if (!confirm('ğŸ—‘ï¸ Â¿ELIMINAR este dibujo permanentemente?\n\nâš ï¸ Esta acciÃ³n NO se puede deshacer')) return;
      
      try {
        // Eliminar directamente (las reglas ya validan el dominio)
        await deleteDoc(doc(db, 'dibujos', drawingId));
        
        // Remover elemento del DOM
        const drawingElement = document.querySelector(`[data-id="${drawingId}"]`)?.closest('.drawing-item');
        if (drawingElement) {
          drawingElement.remove();
        }
        
        alert('ğŸ—‘ï¸ Dibujo eliminado exitosamente');
        
      } catch (error) {
        console.error('Error al eliminar:', error);
        if (error.code === 'permission-denied') {
          alert('âŒ No tienes permisos para eliminar dibujos');
        } else {
          alert('âŒ Error al eliminar dibujo');
        }
      }
    };
    
    // Ver comentarios de sugerencia
    window.viewSuggestionComments = function(suggestionId) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed !important; 
        top: 0 !important; 
        left: 0 !important; 
        width: 100vw !important; 
        height: 100vh !important; 
        background: rgba(0,0,0,0.95) !important; 
        z-index: 99999 !important; 
        display: flex !important; 
        align-items: center !important; 
        justify-content: center !important;
      `;
      
      const container = document.createElement('div');
      container.style.cssText = `
        width: 90vw !important;
        max-width: 600px !important;
        max-height: 90vh !important;
        background: var(--bg-light) !important;
        border-radius: 20px !important;
        padding: 20px !important;
        overflow-y: auto !important;
      `;
      
      const closeBtn = document.createElement('div');
      closeBtn.innerHTML = 'âœ•';
      closeBtn.style.cssText = `
        position: absolute !important;
        top: 20px !important;
        right: 30px !important;
        color: white !important;
        font-size: 30px !important;
        cursor: pointer !important;
        background: rgba(0,0,0,0.7) !important;
        border-radius: 50% !important;
        width: 50px !important;
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      `;
      
      loadSuggestionComments(suggestionId, container);
      
      modal.appendChild(container);
      modal.appendChild(closeBtn);
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target === closeBtn) {
          modal.remove();
        }
      });
    };
    
    // Cargar comentarios de sugerencias
    async function loadSuggestionComments(suggestionId, panel) {
      try {
        let docRef = doc(db, 'sugerencias', suggestionId);
        let docSnap;
        
        try {
          docSnap = await getDoc(docRef);
        } catch (error) {
          docRef = doc(db, 'dibujos', suggestionId);
          docSnap = await getDoc(docRef);
        }
        
        if (docSnap.exists()) {
          const data = docSnap.data();
          const comments = data.comments || [];
          
          panel.innerHTML = `
            <h5 style="color: var(--primary); margin-bottom: 15px;">ğŸ’¬ Comentarios (${comments.length})</h5>
            <div id="suggestionCommentsList" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
              ${comments.map(comment => `
                <div style="background: var(--bg-dark); padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                  <strong style="color: var(--primary); font-size: 0.9em;">${comment.author}</strong>
                  <p style="color: var(--text-primary); margin: 5px 0 0 0; font-size: 0.9em;">${comment.text}</p>
                  <small style="color: var(--text-secondary);">${new Date(comment.timestamp).toLocaleString('es-ES')}</small>
                </div>
              `).join('')}
            </div>
            <div style="border-top: 1px solid var(--primary); padding-top: 15px;">
              <input type="text" id="suggestionCommentAuthor" placeholder="Tu nombre (opcional)" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); margin-bottom: 8px;">
              <input type="text" id="suggestionCommentInput" placeholder="Escribe un comentario..." style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--primary); background: var(--bg-dark); color: var(--text-primary); margin-bottom: 10px;" onkeypress="if(event.key==='Enter') addSuggestionComment('${suggestionId}')">
              <button onclick="addSuggestionComment('${suggestionId}')" style="width: 100%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">â¤ Comentar</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    // AÃ±adir comentario a sugerencia
    window.addSuggestionComment = async function(suggestionId) {
      const input = document.getElementById('suggestionCommentInput');
      const authorInput = document.getElementById('suggestionCommentAuthor');
      const commentText = input.value.trim();
      if (!commentText) return;
      
      const author = authorInput.value.trim() || 'AnÃ³nimo';
      
      try {
        let docRef = doc(db, 'sugerencias', suggestionId);
        let docSnap;
        
        try {
          docSnap = await getDoc(docRef);
        } catch (error) {
          docRef = doc(db, 'dibujos', suggestionId);
          docSnap = await getDoc(docRef);
        }
        
        if (docSnap.exists()) {
          const currentComments = docSnap.data().comments || [];
          await updateDoc(docRef, {
            comments: [...currentComments, { 
              author: moderateContent(author), 
              text: moderateContent(commentText), 
              timestamp: Date.now()
            }]
          });
          input.value = '';
          authorInput.value = '';
          loadSuggestionComments(suggestionId, document.querySelector('.modal div'));
        }
      } catch (error) {
        console.error('Error:', error);
      }
    };
  </script>
  
  <!-- Updates System -->
  <script src="./updates.js"></script>
</body>
</html>