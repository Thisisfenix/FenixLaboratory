<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111b21">
  
  <title>Deadly Pursuer Chat - IA con Visi√≥n</title>
  <meta name="description" content="Chat con personajes de Deadly Pursuer usando IA. Soporte para im√°genes, personajes personalizados y conversaciones guardadas.">
  <meta name="keywords" content="Deadly Pursuer, chatbot, IA, Llama, Groq, WhatsApp, chat">
  <meta name="author" content="ThisIsFenix">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Deadly Pursuer Chat">
  <meta property="og:description" content="Chat con personajes de Deadly Pursuer usando IA con visi√≥n">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://thisisfenix.github.io/FenixLaboratory/public/assets/icons/AngelNormalIcon.png">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Deadly Pursuer Chat">
  <meta name="twitter:description" content="Chat con personajes de Deadly Pursuer usando IA">
  <meta name="twitter:creator" content="@AntiAnkush">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="../public/assets/icons/AngelNormalIcon.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: #111b21;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s, visibility 0.5s;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-logo {
      width: 80px;
      height: 80px;
      margin-bottom: 30px;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid #2a3942;
      border-top-color: #00a884;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: #8696a0;
      font-size: 0.9rem;
      margin-top: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0d1418;
      height: 100vh;
      height: 100dvh;
      display: flex;
      overflow: hidden;
      position: fixed;
      width: 100%;
      touch-action: pan-y;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
    }

    .achievements-sidebar {
      width: 280px;
      background: #1a2329;
      border-right: 1px solid #2a3942;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .achievements-sidebar.hidden {
      width: 0;
      border: none;
    }

    .achievements-header {
      background: #202c33;
      padding: 15px;
      color: #e9edef;
      font-weight: 500;
      border-bottom: 1px solid #2a3942;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .achievements-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .achievement-card {
      background: #1f2c34;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #ffd700;
      transition: all 0.2s;
    }

    .achievement-card.locked {
      opacity: 0.5;
      border-left-color: #8696a0;
    }

    .achievement-card:hover {
      background: #2a3942;
    }

    .achievement-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }

    .achievement-emoji {
      font-size: 1.2rem;
    }

    .achievement-name {
      color: #ffd700;
      font-weight: 500;
      font-size: 0.9rem;
    }

    .achievement-desc {
      color: #8696a0;
      font-size: 0.8rem;
      margin-bottom: 5px;
    }

    .achievement-progress {
      color: #00a884;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .toggle-achievements {
      background: none;
      border: none;
      color: #8696a0;
      cursor: pointer;
      font-size: 1rem;
      padding: 5px;
    }

    .toggle-achievements:hover {
      color: #e9edef;
    }

    .mini-sidebar {
      width: 60px;
      background: #202c33;
      border-right: 1px solid #2a3942;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
      gap: 5px;
    }

    .mini-sidebar-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      color: #8696a0;
      font-size: 1.3rem;
      position: relative;
    }

    .mini-sidebar-btn:hover {
      background: #2a3942;
      color: #e9edef;
    }

    .mini-sidebar-btn.active {
      background: #2a3942;
      color: #00a884;
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid #2a3942;
      transition: all 0.2s;
    }

    .profile-pic:hover {
      border-color: #00a884;
    }

    .spacer {
      flex: 1;
    }

    .coming-soon {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #00a884;
      color: white;
      font-size: 0.6rem;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: bold;
    }

    .achievement-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ffd700, #ffb347);
      color: #000;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
      z-index: 1000;
      animation: achievementSlide 0.5s ease-out;
      max-width: 300px;
      border: 2px solid #ffd700;
    }

    .achievement-notification.hide {
      animation: achievementSlideOut 0.5s ease-in forwards;
    }

    .achievement-title {
      font-weight: bold;
      font-size: 1rem;
      margin-bottom: 5px;
    }

    .achievement-desc {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    @keyframes achievementSlide {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes achievementSlideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .achievements-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .achievements-content {
      background: #202c33;
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      color: #e9edef;
    }

    .achievements-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #2a3942;
      padding-bottom: 10px;
    }

    .achievement-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: #1f2c34;
      border-radius: 8px;
      border-left: 4px solid #ffd700;
    }

    .achievement-item.locked {
      opacity: 0.5;
      border-left-color: #8696a0;
    }

    .achievement-icon {
      font-size: 1.5rem;
      margin-right: 15px;
    }

    .achievement-info h4 {
      margin: 0 0 5px 0;
      color: #ffd700;
    }

    .achievement-info p {
      margin: 0;
      font-size: 0.85rem;
      color: #8696a0;
    }

    .close-btn {
      background: none;
      border: none;
      color: #8696a0;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
    }

    .close-btn:hover {
      color: #e9edef;
    }

    .sidebar {
      width: 350px;
      background: #111b21;
      border-right: 1px solid #2a3942;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      background: #202c33;
      padding: 15px;
      color: #e9edef;
      font-weight: 500;
      border-bottom: 1px solid #2a3942;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
    }

    .chat-list::-webkit-scrollbar {
      width: 6px;
    }

    .chat-list::-webkit-scrollbar-thumb {
      background: #2a3942;
      border-radius: 10px;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #2a3942;
      transition: background 0.2s;
    }

    .chat-item:hover {
      background: #202c33;
    }

    .chat-item.active {
      background: #2a3942;
    }

    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      color: #e9edef;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .chat-preview {
      color: #8696a0;
      font-size: 0.85rem;
      margin-top: 2px;
    }

    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }

    .chat-time {
      color: #8696a0;
      font-size: 0.75rem;
    }

    .chat-status {
      color: #53bdeb;
      font-size: 1rem;
    }

    .chat-status.seen {
      color: #53bdeb;
    }

    .chat-status.unseen {
      color: #8696a0;
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0b141a;
    }

    .chat-header {
      background: #202c33;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid #2a3942;
    }

    .header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .header-info {
      flex: 1;
    }

    .header-name {
      color: #e9edef;
      font-size: 1rem;
      font-weight: 500;
    }

    .header-status {
      color: #8696a0;
      font-size: 0.8rem;
      margin-top: 2px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #0b141a;
      background-image: 
        repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.02) 10px, rgba(255,255,255,.02) 20px),
        repeating-linear-gradient(-45deg, transparent, transparent 10px, rgba(255,255,255,.02) 10px, rgba(255,255,255,.02) 20px);
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #2a3942;
      border-radius: 10px;
    }

    .message {
      max-width: 65%;
      padding: 8px 12px;
      border-radius: 8px;
      word-wrap: break-word;
      font-size: 0.95rem;
      line-height: 1.4;
      position: relative;
      animation: fadeIn 0.2s ease-out;
      display: flex;
      flex-direction: column;
    }

    .report-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: transparent;
      border: none;
      color: #8696a0;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .message.bot:hover .report-btn {
      opacity: 1;
    }

    .report-btn:hover {
      color: #f15c6d;
    }

    .message-time {
      font-size: 0.7rem;
      color: #8696a0;
      margin-top: 4px;
      align-self: flex-end;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .message-check {
      color: #53bdeb;
      font-size: 0.9rem;
    }

    .message-check.unseen {
      color: #8696a0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .message.user {
      background: #005c4b;
      color: #e9edef;
      align-self: flex-end;
      border-radius: 8px 8px 0 8px;
    }

    .message.bot {
      background: #1f2c34;
      color: #e9edef;
      align-self: flex-start;
      border-radius: 8px 8px 8px 0;
    }

    .message.typing {
      background: #1f2c34;
      align-self: flex-start;
      border-radius: 8px 8px 8px 0;
      padding: 12px;
    }

    .chat-input {
      display: flex;
      flex-direction: column;
      padding: 12px;
      background: #1f2c34;
      border-top: 1px solid #2a3942;
      gap: 8px;
    }

    .input-row {
      display: flex;
      gap: 12px;
    }

    .image-preview {
      max-width: 150px;
      max-height: 100px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .image-upload-btn {
      padding: 10px;
      background: transparent;
      border: none;
      color: #8696a0;
      cursor: pointer;
      font-size: 1.3rem;
      transition: all 0.2s;
    }

    .image-upload-btn:hover {
      color: #00a884;
    }

    .remove-image {
      background: #f15c6d;
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.75rem;
      margin-left: 8px;
    }

    .message img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .message img:hover {
      transform: scale(1.02);
    }

    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .image-modal.active {
      display: flex;
    }

    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    .chat-input input[type="text"] {
      flex: 1;
      padding: 10px 15px;
      background: #2a3942;
      border: none;
      border-radius: 20px;
      font-size: 0.95rem;
      color: #e9edef;
      outline: none;
    }

    .chat-input input[type="file"] {
      display: none;
    }

    .chat-input input[type="text"]::placeholder {
      color: #8696a0;
    }

    .chat-input button {
      padding: 10px;
      background: #00a884;
      color: white;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button:hover {
      background: #06cf9c;
    }

    .chat-input button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .typing-indicator {
      display: flex;
      gap: 5px;
      padding: 10px;
    }

    .typing-indicator span {
      width: 10px;
      height: 10px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
      30% { transform: translateY(-12px); opacity: 1; }
    }

    .retro-link {
      position: fixed;
      bottom: 15px;
      left: 15px;
      z-index: 10;
    }

    .retro-link a {
      background: #202c33;
      border: 1px solid #2a3942;
      color: #00a884;
      padding: 8px 15px;
      text-decoration: none;
      font-weight: 500;
      border-radius: 8px;
      transition: all 0.2s;
      font-size: 0.85rem;
    }

    .retro-link a:hover {
      background: #2a3942;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .terms-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }

    .terms-modal.active {
      display: flex;
    }

    .terms-content {
      background: #202c33;
      padding: 30px;
      border-radius: 15px;
      max-width: 450px;
      width: 90%;
      text-align: center;
    }

    .terms-title {
      color: #00a884;
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    .terms-text {
      color: #e9edef;
      line-height: 1.6;
      margin-bottom: 20px;
      text-align: left;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #2a3942;
      border-radius: 8px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      background: #3a4952;
    }

    .checkbox-item input {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .checkbox-item label {
      flex: 1;
      cursor: pointer;
      color: #e9edef;
      font-size: 0.9rem;
    }

    .terms-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .terms-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .terms-btn.accept {
      background: #00a884;
      color: white;
    }

    .terms-btn.accept:hover {
      background: #06cf9c;
    }

    .terms-btn.accept:disabled {
      background: #2a3942;
      color: #8696a0;
      cursor: not-allowed;
    }

    .terms-btn.view {
      background: #2a3942;
      color: #e9edef;
    }

    .terms-btn.view:hover {
      background: #3a4952;
    }

    .modal-content {
      background: #202c33;
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      color: #e9edef;
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #2a3942;
    }

    .setting-item {
      padding: 15px 0;
      border-bottom: 1px solid #2a3942;
    }

    .setting-label {
      color: #e9edef;
      font-size: 0.95rem;
      margin-bottom: 8px;
    }

    .setting-input {
      width: 100%;
      padding: 10px;
      background: #2a3942;
      border: none;
      border-radius: 5px;
      color: #e9edef;
      font-size: 0.9rem;
    }

    .setting-select {
      width: 100%;
      padding: 10px;
      background: #2a3942;
      border: none;
      border-radius: 5px;
      color: #e9edef;
      font-size: 0.9rem;
    }

    .setting-btn {
      width: 100%;
      padding: 12px;
      background: #00a884;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      margin-top: 10px;
    }

    .setting-btn:hover {
      background: #06cf9c;
    }

    .setting-btn.danger {
      background: #f15c6d;
    }

    .setting-btn.danger:hover {
      background: #ff6b7a;
    }

    .close-modal {
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
      color: #8696a0;
    }

    .close-modal:hover {
      color: #e9edef;
    }

    .custom-char-item {
      background: #2a3942;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .custom-char-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    .custom-char-info {
      flex: 1;
      color: #e9edef;
    }

    .custom-char-name {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .custom-char-desc {
      font-size: 0.85rem;
      color: #8696a0;
    }

    .delete-char-btn {
      background: #f15c6d;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .delete-char-btn:hover {
      background: #ff6b7a;
    }

    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 100;
      background: #202c33;
      border: none;
      color: #e9edef;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }

    .mobile-overlay.active {
      display: block;
    }

    @media (max-width: 768px) {
      body {
        height: 100dvh;
      }

      .app-container {
        height: 100dvh;
      }

      .achievements-sidebar {
        display: none;
      }

      .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mini-sidebar {
        position: fixed;
        left: -60px;
        top: 0;
        height: 100vh;
        height: 100dvh;
        z-index: 100;
        transition: left 0.3s;
      }

      .mini-sidebar.mobile-open {
        left: 0;
      }

      .sidebar {
        position: fixed;
        left: -350px;
        top: 0;
        height: 100vh;
        height: 100dvh;
        z-index: 100;
        transition: left 0.3s;
        width: 280px;
      }

      .sidebar.mobile-open {
        left: 60px;
      }

      .chat-container {
        width: 100%;
      }

      .chat-header {
        padding-left: 70px;
        padding: 10px 15px 10px 70px;
      }

      .chat-messages {
        padding: 15px 10px;
      }

      .message {
        max-width: 85%;
        font-size: 0.9rem;
      }

      .chat-input {
        padding: 8px;
      }

      .input-row {
        gap: 8px;
      }

      .retro-link {
        display: none;
      }

      .modal-content {
        width: 95%;
        max-height: 90vh;
      }
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">
      <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="45" stroke="#00a884" stroke-width="3" fill="#202c33"/>
        <path d="M30 50 L45 65 L70 35" stroke="#00a884" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="loading-spinner"></div>
    <div class="loading-text">Deadly Pursuer Chat</div>
  </div>

  <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
  <div class="mobile-overlay" onclick="closeMobileMenu()"></div>
  <div class="app-container">
    <div class="achievements-sidebar hidden" id="achievementsSidebar">
      <div class="achievements-header">
        <span>üèÜ Logros</span>
        <button class="toggle-achievements" onclick="toggleAchievementsSidebar()" title="Ocultar panel">‚úï</button>
      </div>
      <div class="achievements-list" id="achievementsSidebarList">
        <div style="text-align: center; color: #8696a0; padding: 20px;">
          <div style="font-size: 2rem; margin-bottom: 10px;">üèÜ</div>
          <div>Cargando logros...</div>
        </div>
      </div>
    </div>
    <div class="mini-sidebar" id="miniSidebar">
      <div class="mini-sidebar-btn" title="Estados">
        üü¢
        <span class="coming-soon">Soon</span>
      </div>
      <div class="mini-sidebar-btn" title="Canales">
        üì¢
      </div>
      <div class="mini-sidebar-btn active" title="Chats">
        üí¨
      </div>
      <div class="mini-sidebar-btn" title="Archivados">
        üóÑÔ∏è
      </div>
      <div class="spacer"></div>
      <a href="chatbot-3d.html" class="mini-sidebar-btn" title="Modo Retro">
        üéÆ
      </a>
      <div class="mini-sidebar-btn" title="Configuraci√≥n">
        ‚öôÔ∏è
      </div>
      <div class="mini-sidebar-btn" onclick="toggleAchievementsSidebar()" title="Panel de logros">
        üèÜ
      </div>
      <input type="file" id="profilePicInput" accept="image/*" style="display: none;" />
      <label for="profilePicInput" title="Cambiar foto de perfil">
        <img src="https://via.placeholder.com/40/2a3942/8696a0?text=U" class="profile-pic" id="profilePic" />
      </label>
    </div>

    <div class="sidebar" id="mainSidebar" class="sidebar">
      <div class="sidebar-header" id="sidebarTitle">Deadly Pursuer Chats</div>
      <div class="chat-list" id="chatList">
        <div class="chat-item active" data-char="Angel">
          <img src="../public/assets/icons/AngelNormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Angel</div>
            <div class="chat-preview">Protector valiente</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">Ahora</div>
            <div class="chat-status seen">‚úì‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="Gissel">
          <img src="../public/assets/icons/GisselInactiveIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Gissel</div>
            <div class="chat-preview">Sociable y servicial</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">12:30</div>
            <div class="chat-status unseen">‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="iA777">
          <img src="../public/assets/icons/IA777NormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">iA777</div>
            <div class="chat-preview">Tranquilo y gracioso</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">Ayer</div>
            <div class="chat-status seen">‚úì‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="Iris">
          <img src="../public/assets/icons/IrisNormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Iris</div>
            <div class="chat-preview">Calmada pero hiperactiva</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">Ayer</div>
            <div class="chat-status seen">‚úì‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="Luna">
          <img src="../public/assets/icons/LunaNormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Luna</div>
            <div class="chat-preview">T√≠mida y curiosa</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">15:45</div>
            <div class="chat-status unseen">‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="Molly">
          <img src="../public/assets/icons/MollyNormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Molly</div>
            <div class="chat-preview">Asertiva y leal</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">10:20</div>
            <div class="chat-status seen">‚úì‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="RoasterBot">
          <img src="../placeholder/images.jpg" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">üî• RoasterBot</div>
            <div class="chat-preview">Experto en roasts</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">16:30</div>
            <div class="chat-status unseen">‚úì</div>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <img src="../public/assets/icons/AngelNormalIcon.png" class="header-avatar" id="headerAvatar">
        <div class="header-info">
          <div class="header-name" id="headerName">Angel</div>
          <div class="header-status">En l√≠nea</div>
        </div>
      </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="message bot">
        Hola. Soy Angel. Conf√≠a en m√≠, te proteger√©. ¬øEn qu√© necesitas ayuda?
      </div>
    </div>
    
    <div class="chat-input">
      <div id="imagePreviewContainer"></div>
      <div class="input-row">
        <input type="file" id="imageInput" accept="image/*" />
        <label for="imageInput" class="image-upload-btn">üì∑</label>
        <input type="text" id="messageInput" placeholder="Escribe un mensaje" />
        <button id="sendButton">‚û§</button>
      </div>
    </div>
  </div>

  </div>

  <div class="terms-modal" id="termsModal">
    <div class="terms-content">
      <div class="terms-title">‚ö†Ô∏è Antes de continuar</div>
      <div class="terms-text">
        Bienvenido a <strong>Deadly Pursuer Chat</strong>. Antes de usar el chatbot, confirma lo siguiente:
      </div>
      
      <div class="checkbox-item" onclick="toggleCheck('ageCheck')">
        <input type="checkbox" id="ageCheck" />
        <label for="ageCheck">Tengo 13 a√±os o m√°s</label>
      </div>
      
      <div class="checkbox-item" onclick="toggleCheck('termsCheck')">
        <input type="checkbox" id="termsCheck" />
        <label for="termsCheck">Acepto los t√©rminos y condiciones</label>
      </div>
      
      <div class="checkbox-item" onclick="toggleCheck('aiCheck')">
        <input type="checkbox" id="aiCheck" />
        <label for="aiCheck">Entiendo que las respuestas son generadas por IA</label>
      </div>
      
      <div class="terms-buttons">
        <button class="terms-btn view" onclick="viewTerms()">üìú Ver t√©rminos</button>
        <button class="terms-btn accept" id="acceptBtn" disabled onclick="acceptTerms()">‚úÖ Aceptar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        Configuraci√≥n
        <span class="close-modal" onclick="closeSettings()">&times;</span>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">üë§ Tu nombre</div>
        <input type="text" class="setting-input" id="userName" placeholder="¬øC√≥mo te llamas?" />
      </div>

      <div class="setting-item">
        <div class="setting-label">üîî Sonido de notificaci√≥n</div>
        <select class="setting-select" id="soundSelect">
          <option value="on">Activado</option>
          <option value="off">Desactivado</option>
        </select>
      </div>

      <div class="setting-item">
        <div class="setting-label">üí¨ Tama√±o de fuente</div>
        <select class="setting-select" id="fontSizeSelect">
          <option value="small">Peque√±o</option>
          <option value="medium">Mediano</option>
          <option value="large">Grande</option>
        </select>
      </div>

      <div class="setting-item">
        <button class="setting-btn" onclick="saveSettings()">üíæ Guardar cambios</button>
        <button class="setting-btn" onclick="openCustomPanel()">‚ú® Gestionar personajes personalizados</button>
        <button class="setting-btn" onclick="viewStats()">üìä Ver estad√≠sticas</button>
        <button class="setting-btn" onclick="openEasterEggs()">ü•ö Easter Eggs</button>
        <button class="setting-btn" onclick="openTechInfo()">ü§ñ Info T√©cnica IA</button>
        <button class="setting-btn danger" onclick="clearHistory()">üóëÔ∏è Borrar historial</button>
      </div>
    </div>
  </div>

  <div class="modal" id="customPanel">
    <div class="modal-content">
      <div class="modal-header">
        Personajes Personalizados
        <span class="close-modal" onclick="closeCustomPanel()">&times;</span>
      </div>
      
      <div class="setting-item">
        <button class="setting-btn" onclick="openCreateCharModal()">‚ûï Crear nuevo personaje</button>
      </div>

      <div id="customCharactersList"></div>
    </div>
  </div>

  <div class="modal" id="createCharModal">
    <div class="modal-content">
      <div class="modal-header">
        ‚ú® Crear Personaje
        <span class="close-modal" onclick="closeCreateCharModal()">&times;</span>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">üë§ Nombre del personaje</div>
        <input type="text" class="setting-input" id="charName" placeholder="Ej: Sakura" />
      </div>

      <div class="setting-item">
        <div class="setting-label">üí¨ Personalidad</div>
        <input type="text" class="setting-input" id="charPersonality" placeholder="Ej: Amigable, sarc√°stico, t√≠mido" />
      </div>

      <div class="setting-item">
        <div class="setting-label">üëã Mensaje de saludo</div>
        <input type="text" class="setting-input" id="charGreeting" placeholder="Ej: ¬°Hola! ¬øC√≥mo est√°s?" />
      </div>

      <div class="setting-item">
        <div class="setting-label">üñºÔ∏è Imagen del personaje (opcional)</div>
        <input type="file" id="charImageFile" accept="image/*" style="display: none;" />
        <label for="charImageFile" class="setting-btn" style="margin-top: 0;">üì∑ Subir imagen</label>
        <div id="charImagePreview"></div>
      </div>

      <div class="setting-item">
        <button class="setting-btn" onclick="saveNewCharacter()">‚úÖ Crear personaje</button>
      </div>
    </div>
  </div>

  <!-- Modal para ver im√°genes -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <img id="modalImage" />
  </div>

  <!-- Modal para Easter Eggs -->
  <div class="modal" id="easterEggsModal">
    <div class="modal-content">
      <div class="modal-header">
        ü•ö Easter Eggs Disponibles
        <span class="close-modal" onclick="closeEasterEggs()">&times;</span>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">Escribe estas palabras EXACTAS para activar im√°genes especiales:</div>
      </div>
      
      <div class="custom-char-item">
        <div style="font-size: 2rem;">üåæ</div>
        <div class="custom-char-info">
          <div class="custom-char-name">"molly anderson"</div>
          <div class="custom-char-desc">Molly Anderson en el campo</div>
        </div>
      </div>
      
      <div class="custom-char-item">
        <div style="font-size: 2rem;">üëÄ</div>
        <div class="custom-char-info">
          <div class="custom-char-name">"bfmp4"</div>
          <div class="custom-char-desc">Bfmp4 ha aparecido</div>
        </div>
      </div>
      
      <div class="custom-char-item">
        <div style="font-size: 2rem;">üéÆ</div>
        <div class="custom-char-info">
          <div class="custom-char-name">"abelitogamer"</div>
          <div class="custom-char-desc">Abelitogamer en acci√≥n</div>
        </div>
      </div>
      
      <div class="setting-item">
        <div style="color: #8696a0; font-size: 0.9rem; text-align: center;">
          üí° Escr√≠belas exactamente como aparecen aqu√≠<br>
          üñºÔ∏è Las im√°genes aparecer√°n autom√°ticamente con el mensaje
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Logros -->
  <div class="achievements-modal" id="achievementsModal">
    <div class="achievements-content">
      <div class="achievements-header">
        <h2>üèÜ Logros de Roasts</h2>
        <button class="close-btn" onclick="closeAchievements()">&times;</button>
      </div>
      <div id="achievementsList"></div>
    </div>
  </div>

  <!-- Modal para Info T√©cnica -->
  <div class="modal" id="techInfoModal">
    <div class="modal-content">
      <div class="modal-header">
        ü§ñ Configuraci√≥n T√©cnica de IA
        <span class="close-modal" onclick="closeTechInfo()">&times;</span>
      </div>
      
      <div class="setting-item">
        <div class="setting-label">üå°Ô∏è Temperatura = Creatividad | üìù Tokens = Longitud | ü§ù Velocidad = Ganancia de confianza</div>
      </div>
      
      <div class="custom-char-item">
        <img src="../public/assets/icons/AngelNormalIcon.png" class="custom-char-avatar">
        <div class="custom-char-info">
          <div class="custom-char-name">Angel</div>
          <div class="custom-char-desc">Creatividad: 0.9/1.0 ‚Ä¢ Tokens: 400 ‚Ä¢ Confianza: +10%</div>
        </div>
      </div>
      
      <div class="custom-char-item">
        <img src="../public/assets/icons/GisselInactiveIcon.png" class="custom-char-avatar">
        <div class="custom-char-info">
          <div class="custom-char-name">Gissel</div>
          <div class="custom-char-desc">Creatividad: 0.95/1.0 ‚Ä¢ Tokens: 450 ‚Ä¢ Confianza: +20%</div>
        </div>
      </div>
      
      <div class="custom-char-item">
        <img src="../public/assets/icons/IA777NormalIcon.png" class="custom-char-avatar">
        <div class="custom-char-info">
          <div class="custom-char-name">iA777</div>
          <div class="custom-char-desc">Creatividad: 0.85/1.0 ‚Ä¢ Tokens: 380 ‚Ä¢ Confianza: -10%</div>
        </div>
      </div>
      
      <div class="custom-char-item">
        <img src="../public/assets/icons/IrisNormalIcon.png" class="custom-char-avatar">
        <div class="custom-char-info">
          <div class="custom-char-name">Iris</div>
          <div class="custom-char-desc">Creatividad: 0.9/1.0 ‚Ä¢ Tokens: 400 ‚Ä¢ Confianza: Normal</div>
        </div>
      </div>
      
      <div class="custom-char-item">
        <img src="../public/assets/icons/LunaNormalIcon.png" class="custom-char-avatar">
        <div class="custom-char-info">
          <div class="custom-char-name">Luna</div>
          <div class="custom-char-desc">Creatividad: 0.95/1.0 ‚Ä¢ Tokens: 420 ‚Ä¢ Confianza: -20%</div>
        </div>
      </div>
      
      <div class="custom-char-item">
        <img src="../public/assets/icons/MollyNormalIcon.png" class="custom-char-avatar">
        <div class="custom-char-info">
          <div class="custom-char-name">Molly</div>
          <div class="custom-char-desc">Creatividad: 0.85/1.0 ‚Ä¢ Tokens: 380 ‚Ä¢ Confianza: -30%</div>
        </div>
      </div>
      
      <div class="setting-item">
        <div style="color: #8696a0; font-size: 0.9rem; text-align: center;">
          Powered by Groq + Llama 3.3 70B + Stable Diffusion XL
        </div>
      </div>
    </div>
  </div>

  <script src="updates.js"></script>
  <script src="legal.js"></script>
  <script>
    const WORKER_URL = 'https://fenix-chatbot.aleverafenix12345.workers.dev';
    
    // Generar userId √∫nico
    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = 'user_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
      localStorage.setItem('userId', userId);
    }
    
    const characterGreetings = {
      Angel: 'Hola. Soy Angel. Conf√≠a en m√≠, te proteger√©. ¬øEn qu√© necesitas ayuda?',
      Gissel: '¬°Hola! Soy Gissel~ ¬øC√≥mo est√°s? ¬øHay algo en lo que pueda ayudarte? Me gusta ayudar a las personas.',
      iA777: 'Hey... soy iA777. ¬øQu√© pasa? Espero que no sea nada complicado, ya tengo suficiente estr√©s.',
      Iris: 'Hola, soy Iris. ¬øC√≥mo est√°s? Espero que est√©s bien. ¬øEn qu√© puedo ayudarte?',
      Luna: 'H-hola... soy Luna. Um... ¬øen qu√© puedo ayudarte?',
      Molly: 'Hola. Soy Molly. ¬øQu√© necesitas? Si es importante, te ayudar√©.',
      RoasterBot: async function() {
        // Obtener historial del usuario para roasts personalizados
        let userHistory = '';
        try {
          const historyResponse = await fetch(`${WORKER_URL}/history?userId=${userId}&character=Angel`);
          const historyData = await historyResponse.json();
          if (historyData.history && historyData.history.length > 0) {
            const recentMessages = historyData.history.slice(-5).filter(msg => msg.sender === 'user').map(msg => msg.message).join(', ');
            userHistory = recentMessages ? ` Historial del usuario: "${recentMessages}"` : '';
          }
        } catch (e) {}
        
        const response = await fetch(`${WORKER_URL}/roast`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Timezone': Intl.DateTimeFormat().resolvedOptions().timeZone
          },
          body: JSON.stringify({ 
            message: `usuario entrando al chat.${userHistory}`,
            userId: userId
          })
        });
        const data = await response.json();
        
        // Extraer el roast correctamente
        const roastData = data.roast || data;
        const roastText = roastData.roast || roastData || 'Prep√°rate para ser roasteado.';
        
        return `‚ö†Ô∏è ADVERTENCIA: Este bot genera roasts brutales y ofensivos. No me hago responsable del da√±o emocional causado. Usar bajo tu propio riesgo.\n\n${roastText}\n\nüî• Si quieres que te rostee o me quieres ganar, adelante. Dame m√°s mensajes para roastear. ¬øA qui√©n vamos a trollear?`;
      }
    };

    // Chat Logic
    const messagesContainer = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const headerAvatar = document.getElementById('headerAvatar');
    const headerName = document.getElementById('headerName');
    
    let conversationId = null;
    let currentCharacter = 'Angel';
    let currentImage = null;

    const characterIcons = {
      Angel: '../public/assets/icons/AngelNormalIcon.png',
      Gissel: '../public/assets/icons/GisselInactiveIcon.png',
      iA777: '../public/assets/icons/IA777NormalIcon.png',
      Iris: '../public/assets/icons/IrisNormalIcon.png',
      Luna: '../public/assets/icons/LunaNormalIcon.png',
      Molly: '../public/assets/icons/MollyNormalIcon.png',
      RoasterBot: '../placeholder/images.jpg'
    };

    // Profile pic upload
    const profilePicInput = document.getElementById('profilePicInput');
    const profilePic = document.getElementById('profilePic');
    
    profilePicInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        profilePic.src = event.target.result;
        localStorage.setItem('profilePic', event.target.result);
      };
      reader.readAsDataURL(file);
    });

    // Load saved profile pic
    const savedPic = localStorage.getItem('profilePic');
    if (savedPic) {
      profilePic.src = savedPic;
    }

    // Mini sidebar navigation
    document.querySelectorAll('.mini-sidebar-btn').forEach((btn, index) => {
      btn.addEventListener('click', () => {
        if (btn.querySelector('.coming-soon')) {
          alert('üöÄ Pr√≥ximamente!');
          return;
        }
        
        // √çndice 1 = Canales
        if (index === 1) {
          showChannels();
          return;
        }
        // √çndice 2 = Chats
        if (index === 2) {
          showChats();
          return;
        }
        // √çndice 3 = Archivados
        if (index === 3) {
          showArchived();
          return;
        }
        // √çndice 5 = Configuraci√≥n
        if (index === 5) {
          openSettings();
          return;
        }
        
        document.querySelectorAll('.mini-sidebar-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    function showChannels() {
      document.querySelectorAll('.mini-sidebar-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.mini-sidebar-btn')[1].classList.add('active');
      
      document.getElementById('sidebarTitle').textContent = 'Canales';
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = `
        <div class="chat-item active" onclick="openUpdatesChannel()">
          <img src="https://via.placeholder.com/50/00a884/ffffff?text=U" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">üì¢ Updates</div>
            <div class="chat-preview">Actualizaciones del chatbot</div>
          </div>
        </div>
        <div class="chat-item" onclick="openLegalChannel()">
          <img src="https://via.placeholder.com/50/f15c6d/ffffff?text=‚öñÔ∏è" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">‚öñÔ∏è Legal</div>
            <div class="chat-preview">T√©rminos y Privacidad</div>
          </div>
        </div>
      `;
      
      openUpdatesChannel();
    }

    function showArchived() {
      document.querySelectorAll('.mini-sidebar-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.mini-sidebar-btn')[3].classList.add('active');
      
      document.getElementById('sidebarTitle').textContent = 'Archivados';
      const chatList = document.getElementById('chatList');
      
      const archived = JSON.parse(localStorage.getItem('archivedChars') || '[]');
      
      if (archived.length === 0) {
        chatList.innerHTML = `
          <div style="padding: 40px 20px; text-align: center; color: #8696a0;">
            <div style="font-size: 3rem; margin-bottom: 10px;">üì¶</div>
            <div>No hay personajes archivados</div>
            <div style="font-size: 0.85rem; margin-top: 10px;">Mant√©n presionado un chat para archivarlo</div>
          </div>
        `;
        return;
      }
      
      chatList.innerHTML = archived.map(char => `
        <div class="chat-item" data-char="${char.name}" oncontextmenu="unarchiveChar('${char.name}'); return false;">
          <img src="${char.avatar}" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">${char.name}</div>
            <div class="chat-preview">Archivado</div>
          </div>
          <div style="color: #8696a0; font-size: 0.85rem;">üì¶</div>
        </div>
      `).join('');
      
      initChatItems();
    }

    function showChats() {
      document.querySelectorAll('.mini-sidebar-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.mini-sidebar-btn')[2].classList.add('active');
      
      document.getElementById('sidebarTitle').textContent = 'Deadly Pursuer Chats';
      
      // Restaurar lista de chats sin recargar
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = `
        <div class="chat-item active" data-char="Angel">
          <img src="../public/assets/icons/AngelNormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Angel</div>
            <div class="chat-preview">Protector valiente</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">Ahora</div>
            <div class="chat-status seen">‚úì‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="Gissel">
          <img src="../public/assets/icons/GisselInactiveIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Gissel</div>
            <div class="chat-preview">Sociable y servicial</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">12:30</div>
            <div class="chat-status unseen">‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="iA777">
          <img src="../public/assets/icons/IA777NormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">iA777</div>
            <div class="chat-preview">Tranquilo y gracioso</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">Ayer</div>
            <div class="chat-status seen">‚úì‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="Iris">
          <img src="../public/assets/icons/IrisNormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Iris</div>
            <div class="chat-preview">Calmada pero hiperactiva</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">Ayer</div>
            <div class="chat-status seen">‚úì‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="Luna">
          <img src="../public/assets/icons/LunaNormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Luna</div>
            <div class="chat-preview">T√≠mida y curiosa</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">15:45</div>
            <div class="chat-status unseen">‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="Molly">
          <img src="../public/assets/icons/MollyNormalIcon.png" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">Molly</div>
            <div class="chat-preview">Asertiva y leal</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">10:20</div>
            <div class="chat-status seen">‚úì‚úì</div>
          </div>
        </div>
        <div class="chat-item" data-char="RoasterBot">
          <img src="../placeholder/images.jpg" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">üî• RoasterBot</div>
            <div class="chat-preview">Experto en roasts</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">16:30</div>
            <div class="chat-status unseen">‚úì</div>
          </div>
        </div>
      `;
      
      // Filtrar archivados
      const archived = JSON.parse(localStorage.getItem('archivedChars') || '[]');
      const archivedNames = archived.map(c => c.name);
      
      document.querySelectorAll('.chat-item').forEach(item => {
        if (archivedNames.includes(item.dataset.char)) {
          item.remove();
        }
      });
      
      // Re-agregar event listeners
      initChatItems();
      loadAllCustomCharacters();
      
      // Habilitar inputs
      messageInput.disabled = false;
      sendButton.disabled = false;
      imageInput.disabled = false;
      messageInput.placeholder = 'Escribe un mensaje';
      
      // Cargar Angel por defecto
      currentCharacter = 'Angel';
      headerAvatar.src = characterIcons.Angel;
      headerName.textContent = 'Angel';
      showTrustLevel('Angel');
      loadHistory('Angel');
    }

    function openUpdatesChannel() {
      headerAvatar.src = 'https://via.placeholder.com/40/00a884/ffffff?text=U';
      headerName.textContent = 'üì¢ Updates';
      document.querySelector('.header-status').textContent = 'Canal oficial';
      
      messagesContainer.innerHTML = getUpdatesHTML();
      
      // Deshabilitar input en canal
      messageInput.disabled = true;
      sendButton.disabled = true;
      imageInput.disabled = true;
      messageInput.placeholder = 'Los canales son solo lectura';
    }



    function initChatItems() {
      document.querySelectorAll('.chat-item').forEach(item => {
        let pressTimer;
        let longPressTriggered = false;
        
        // Desktop
        item.addEventListener('mousedown', () => {
          longPressTriggered = false;
          pressTimer = setTimeout(() => {
            longPressTriggered = true;
            const char = item.dataset.char;
            if (char && confirm(`¬øArchivar ${char}?`)) {
              archiveChar(char);
            }
          }, 800);
        });
        
        item.addEventListener('mouseup', () => clearTimeout(pressTimer));
        item.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        
        // M√≥vil
        item.addEventListener('touchstart', (e) => {
          longPressTriggered = false;
          pressTimer = setTimeout(() => {
            longPressTriggered = true;
            const char = item.dataset.char;
            if (char && confirm(`¬øArchivar ${char}?`)) {
              archiveChar(char);
            }
          }, 800);
        });
        
        item.addEventListener('touchend', () => clearTimeout(pressTimer));
        item.addEventListener('touchmove', () => clearTimeout(pressTimer));
        
        item.addEventListener('click', async (e) => {
          if (longPressTriggered) {
            e.preventDefault();
            return;
          }
          document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          currentCharacter = item.dataset.char;
          conversationId = null;
          
          headerAvatar.src = characterIcons[currentCharacter];
          headerName.textContent = currentCharacter;
          
          // Mostrar nivel de confianza
          showTrustLevel(currentCharacter);
          
          // Habilitar inputs
          messageInput.disabled = false;
          sendButton.disabled = false;
          imageInput.disabled = false;
          messageInput.placeholder = 'Escribe un mensaje';
          
          // Cargar historial
          if (currentCharacter === 'RoasterBot') {
            // Generar roast de bienvenida
            messagesContainer.innerHTML = '';
            const welcomeRoast = await characterGreetings.RoasterBot();
            messagesContainer.innerHTML = `<div class="message bot">${welcomeRoast}</div>`;
          } else {
            await loadHistory(currentCharacter);
          }
        });
      });
    }
    
    // Filtrar archivados al cargar
    (function filterArchivedOnLoad() {
      const archived = JSON.parse(localStorage.getItem('archivedChars') || '[]');
      const archivedNames = archived.map(c => c.name);
      
      document.querySelectorAll('.chat-item').forEach(item => {
        if (archivedNames.includes(item.dataset.char)) {
          item.remove();
        }
      });
    })();
    
    initChatItems();

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        currentImage = event.target.result;
        imagePreviewContainer.innerHTML = `
          <img src="${currentImage}" class="image-preview" />
          <button class="remove-image" onclick="removeImage()">‚ùå Quitar</button>
        `;
      };
      reader.readAsDataURL(file);
    });

    window.removeImage = () => {
      currentImage = null;
      imagePreviewContainer.innerHTML = '';
      imageInput.value = '';
    };

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message && !currentImage) return;

      // Rate limiting
      if (!checkRateLimit()) {
        alert('‚è±Ô∏è Espera un momento antes de enviar otro mensaje. L√≠mite: 10 mensajes por minuto.');
        return;
      }

      addMessage(message || '(imagen)', 'user', currentImage);
      messageInput.value = '';
      sendButton.disabled = true;

      const typingDiv = addTypingIndicator();

      try {
        // RoasterBot usa endpoint especial
        if (currentCharacter === 'RoasterBot') {
          // Obtener historial del usuario para roasts personalizados
          let userHistory = '';
          try {
            const historyResponse = await fetch(`${WORKER_URL}/history?userId=${userId}&character=RoasterBot`);
            const historyData = await historyResponse.json();
            if (historyData.history && historyData.history.length > 0) {
              const recentMessages = historyData.history.slice(-10).filter(msg => msg.sender === 'user').map(msg => msg.message).join(', ');
              userHistory = recentMessages ? ` Historial del usuario: "${recentMessages}"` : '';
            }
          } catch (e) {}
          
          const response = await fetch(`${WORKER_URL}/roast`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'X-Timezone': Intl.DateTimeFormat().resolvedOptions().timeZone
            },
            body: JSON.stringify({ 
              message: `${message}.${userHistory}`,
              userId: userId
            })
          });
          
          const data = await response.json();
          typingDiv.remove();
          
          console.log('Respuesta del RoasterBot:', data);
          
          // Acceder al roast anidado
          const roastData = data.roast || data;
          const roastText = roastData.roast || roastData || 'Error en la respuesta';
          const achievement = roastData.achievement || data.achievement;
          
          // Mostrar solo el roast puro
          addMessage(roastText, 'bot');
          
          // Mostrar logro como notificaci√≥n si se desbloque√≥
          if (achievement) {
            setTimeout(() => {
              showAchievementNotification(achievement);
            }, 1000);
          }
        } else {
          // Personajes normales
          const chars = JSON.parse(localStorage.getItem('customCharacters') || '[]');
          let customPersonality = null;
          
          const customChar = chars.find(c => c.name === currentCharacter);
          if (customChar) {
            customPersonality = customChar.personality;
            console.log('Enviando personalidad personalizada:', customPersonality);
          } else {
            console.log('Usando personaje predefinido:', currentCharacter);
          }

          const response = await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              message: message || '¬øQu√© ves en esta imagen?', 
              conversationId, 
              character: currentCharacter,
              image: currentImage,
              customPersonality,
              userId
            })
          });

          const data = await response.json();
          typingDiv.remove();
          
          // Manejar easter eggs e im√°genes generadas
          let imageToShow = null;
          if (data.easterEggImage) {
            imageToShow = data.easterEggImage;
          } else if (data.generatedImage) {
            imageToShow = data.generatedImage;
          }
          
          addMessage(data.response, 'bot', imageToShow);
          conversationId = data.conversationId;
        }
      } catch (error) {
        typingDiv.remove();
        addMessage('Error: No pude conectar con el servidor.', 'bot');
        console.error(error);
      }

      removeImage();
      sendButton.disabled = false;
      messageInput.focus();
    }

    function addMessage(text, type, image = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const now = new Date();
      const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
      
      if (image) {
        messageDiv.innerHTML = `<span>${text}<br><img src="${image}" onclick="openImageModal('${image}')" /></span><div class="message-time">${timeStr}${type === 'user' ? ' <span class="message-check seen">‚úì‚úì</span>' : ''}</div>`;
      } else {
        messageDiv.innerHTML = `<span>${text}</span><div class="message-time">${timeStr}${type === 'user' ? ' <span class="message-check seen">‚úì‚úì</span>' : ''}</div>`;
      }
      
      // Agregar bot√≥n de reporte solo a mensajes del bot
      if (type === 'bot') {
        const reportBtn = document.createElement('button');
        reportBtn.className = 'report-btn';
        reportBtn.innerHTML = 'üö©';
        reportBtn.title = 'Reportar contenido inapropiado';
        reportBtn.onclick = () => reportMessage(text);
        messageDiv.appendChild(reportBtn);
      }
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Actualizar hora en sidebar
      if (type === 'user' || type === 'bot') {
        updateChatTime(currentCharacter, timeStr);
      }
      
      // Actualizar nivel de confianza despu√©s de enviar mensaje
      if (type === 'user') {
        setTimeout(() => showTrustLevel(currentCharacter), 500);
      }
      
      // Analytics
      trackMessage(type);
      
      return messageDiv;
    }

    function updateChatTime(character, time) {
      const chatItem = document.querySelector(`.chat-item[data-char="${character}"]`);
      if (chatItem) {
        const timeEl = chatItem.querySelector('.chat-time');
        if (timeEl) timeEl.textContent = time;
      }
    }

    function addTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message typing';
      typingDiv.innerHTML = `
        <div class="typing-indicator">
          <span></span><span></span><span></span>
        </div>
      `;
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return typingDiv;
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Settings functions
    function openSettings() {
      document.getElementById('settingsModal').classList.add('active');
      loadSettings();
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    function loadSettings() {
      document.getElementById('userName').value = localStorage.getItem('userName') || '';
      document.getElementById('soundSelect').value = localStorage.getItem('sound') || 'on';
      document.getElementById('fontSizeSelect').value = localStorage.getItem('fontSize') || 'medium';
    }

    function saveSettings() {
      const userName = document.getElementById('userName').value;
      const sound = document.getElementById('soundSelect').value;
      const fontSize = document.getElementById('fontSizeSelect').value;

      localStorage.setItem('userName', userName);
      localStorage.setItem('sound', sound);
      localStorage.setItem('fontSize', fontSize);

      applySettings();
      trackEvent('settings_saved');
      alert('‚úÖ Configuraci√≥n guardada');
      closeSettings();
    }

    async function viewStats() {
      try {
        const response = await fetch(`${WORKER_URL}/stats?userId=${userId}`);
        const { stats } = await response.json();
        
        let statsText = `üìä Estad√≠sticas Avanzadas\n\n`;
        statsText += `üí¨ Total mensajes: ${stats.totalMessages}\n`;
        statsText += `üñºÔ∏è Total im√°genes: ${stats.totalImages}\n`;
        statsText += `üèÜ Personaje favorito: ${stats.mostActiveCharacter}\n`;
        statsText += `ü§ù Confianza promedio: ${stats.averageTrustLevel}%\n\n`;
        
        statsText += `üë• Por personaje:\n`;
        Object.entries(stats.characterStats).forEach(([char, data]) => {
          if (data.totalMessages > 0) {
            statsText += `‚Ä¢ ${char}: ${data.totalMessages} mensajes, ${data.trustText}\n`;
          }
        });
        
        const reports = JSON.parse(localStorage.getItem('reports') || '[]');
        statsText += `\nüö© Reportes enviados: ${reports.length}`;
        
        alert(statsText);
      } catch (error) {
        // Fallback a estad√≠sticas locales
        const stats = JSON.parse(localStorage.getItem('chatStats') || '{}');
        const reports = JSON.parse(localStorage.getItem('reports') || '[]');
        
        alert(`üìä Estad√≠sticas de uso\n\n` +
          `üìÖ Primera visita: ${new Date(stats.firstVisit).toLocaleDateString()}\n` +
          `üí¨ Total mensajes: ${stats.totalMessages || 0}\n` +
          `üë§ Tus mensajes: ${stats.userMessages || 0}\n` +
          `ü§ñ Respuestas del bot: ${stats.botMessages || 0}\n` +
          `üö© Reportes enviados: ${reports.length}\n` +
          `‚è∞ √öltima actividad: ${new Date(stats.lastActive).toLocaleString()}`);
      }
    }

    function applySettings() {
      const fontSize = localStorage.getItem('fontSize') || 'medium';

      // Aplicar tama√±o de fuente
      const sizes = { small: '0.85rem', medium: '0.95rem', large: '1.1rem' };
      document.querySelectorAll('.message').forEach(msg => {
        msg.style.fontSize = sizes[fontSize];
      });
    }

    async function clearHistory() {
      if (!confirm('¬øSeguro que quieres borrar todo el historial?')) return;
      
      try {
        await fetch(`${WORKER_URL}/history`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, character: currentCharacter })
        });
        
        messagesContainer.innerHTML = `
          <div class="message bot">${characterGreetings[currentCharacter]}</div>
        `;
        conversationId = null;
        alert('üóëÔ∏è Historial borrado');
      } catch (error) {
        alert('‚ùå Error al borrar historial');
      }
    }

    async function loadHistory(character) {
      try {
        const response = await fetch(`${WORKER_URL}/history?userId=${userId}&character=${character}`);
        const { history } = await response.json();
        
        messagesContainer.innerHTML = '';
        
        if (history.length === 0) {
          messagesContainer.innerHTML = `
            <div class="message bot">${characterGreetings[character]}</div>
          `;
          return;
        }
        
        history.forEach(msg => {
          const time = new Date(msg.timestamp).toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${msg.sender || msg.type}`;
          
          if (msg.image) {
            messageDiv.innerHTML = `<span>${msg.message || msg.text}<br><img src="${msg.image}" onclick="openImageModal('${msg.image}')" /></span><div class="message-time">${time}${(msg.sender === 'user' || msg.type === 'user') ? ' <span class="message-check seen">‚úì‚úì</span>' : ''}</div>`;
          } else {
            messageDiv.innerHTML = `<span>${msg.message || msg.text}</span><div class="message-time">${time}${(msg.sender === 'user' || msg.type === 'user') ? ' <span class="message-check seen">‚úì‚úì</span>' : ''}</div>`;
          }
          
          // Agregar bot√≥n de reporte a mensajes del bot
          if (msg.sender === 'bot' || msg.type === 'bot') {
            const reportBtn = document.createElement('button');
            reportBtn.className = 'report-btn';
            reportBtn.innerHTML = 'üö©';
            reportBtn.title = 'Reportar contenido inapropiado';
            reportBtn.onclick = () => reportMessage(msg.message || msg.text);
            messageDiv.appendChild(reportBtn);
          }
          
          messagesContainer.appendChild(messageDiv);
        });
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error('Error cargando historial:', error);
        messagesContainer.innerHTML = `
          <div class="message bot">${characterGreetings[character]}</div>
        `;
      }
    }

    // Aplicar configuraci√≥n al cargar
    applySettings();

    // Custom characters system
    function openCustomPanel() {
      document.getElementById('customPanel').classList.add('active');
      loadCustomCharacters();
    }

    function closeCustomPanel() {
      document.getElementById('customPanel').classList.remove('active');
    }

    function loadCustomCharacters() {
      const list = document.getElementById('customCharactersList');
      const chars = JSON.parse(localStorage.getItem('customCharacters') || '[]');
      
      list.innerHTML = '';
      chars.forEach((char, index) => {
        const item = document.createElement('div');
        item.className = 'custom-char-item';
        item.innerHTML = `
          <img src="${char.avatar}" class="custom-char-avatar" />
          <div class="custom-char-info">
            <div class="custom-char-name">${char.name}</div>
            <div class="custom-char-desc">${char.personality.substring(0, 50)}...</div>
          </div>
          <button class="delete-char-btn" onclick="deleteCharacter(${index})">üóëÔ∏è Eliminar</button>
        `;
        list.appendChild(item);
      });
    }

    let charImageData = null;

    document.getElementById('charImageFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        charImageData = event.target.result;
        document.getElementById('charImagePreview').innerHTML = `
          <img src="${charImageData}" style="max-width: 100px; border-radius: 50%; margin-top: 10px;" />
        `;
      };
      reader.readAsDataURL(file);
    });

    function openCreateCharModal() {
      document.getElementById('createCharModal').classList.add('active');
      document.getElementById('charName').value = '';
      document.getElementById('charPersonality').value = '';
      document.getElementById('charGreeting').value = '';
      document.getElementById('charImageFile').value = '';
      document.getElementById('charImagePreview').innerHTML = '';
      charImageData = null;
    }

    function closeCreateCharModal() {
      document.getElementById('createCharModal').classList.remove('active');
    }

    function saveNewCharacter() {
      const name = document.getElementById('charName').value.trim();
      const personality = document.getElementById('charPersonality').value.trim();
      const greeting = document.getElementById('charGreeting').value.trim();

      if (!name || !personality || !greeting) {
        alert('‚ö†Ô∏è Por favor completa todos los campos obligatorios');
        return;
      }

      const avatar = charImageData || 'https://via.placeholder.com/50/00a884/ffffff?text=' + name[0];

      const customChar = {
        name,
        personality: `Eres ${name}. Personalidad: ${personality}. Responde en espa√±ol de forma breve y natural.`,
        greeting,
        avatar
      };

      // Guardar en array
      const chars = JSON.parse(localStorage.getItem('customCharacters') || '[]');
      chars.push(customChar);
      localStorage.setItem('customCharacters', JSON.stringify(chars));
      
      // A√±adir a la lista
      characterGreetings[name] = greeting;
      characterIcons[name] = avatar;

      // Crear elemento en la lista
      const chatList = document.getElementById('chatList');
      const newItem = document.createElement('div');
      newItem.className = 'chat-item';
      newItem.dataset.char = name;
      newItem.innerHTML = `
        <img src="${avatar}" class="chat-avatar">
        <div class="chat-info">
          <div class="chat-name">${name}</div>
          <div class="chat-preview">Personalizado</div>
        </div>
      `;
      
      newItem.addEventListener('click', () => {
        document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
        newItem.classList.add('active');
        currentCharacter = name;
        conversationId = null;
        
        headerAvatar.src = avatar;
        headerName.textContent = name;
        
        messagesContainer.innerHTML = `
          <div class="message bot">${greeting}</div>
        `;
      });

      chatList.appendChild(newItem);
      
      closeCreateCharModal();
      alert('‚úÖ Personaje "' + name + '" creado!');
      loadCustomCharacters();
    }

    function deleteCharacter(index) {
      if (!confirm('¬øEliminar este personaje?')) return;
      
      const chars = JSON.parse(localStorage.getItem('customCharacters') || '[]');
      const deleted = chars.splice(index, 1)[0];
      localStorage.setItem('customCharacters', JSON.stringify(chars));
      
      // Remover de la lista de chats
      document.querySelectorAll('.chat-item').forEach(item => {
        if (item.dataset.char === deleted.name) {
          item.remove();
        }
      });
      
      loadCustomCharacters();
      alert('üóëÔ∏è Personaje eliminado');
    }

    // Cargar personajes personalizados al inicio
    function loadAllCustomCharacters() {
      const chars = JSON.parse(localStorage.getItem('customCharacters') || '[]');
      const archived = JSON.parse(localStorage.getItem('archivedChars') || '[]');
      const archivedNames = archived.map(c => c.name);
      const chatList = document.getElementById('chatList');
      
      chars.forEach(custom => {
        characterGreetings[custom.name] = custom.greeting;
        characterIcons[custom.name] = custom.avatar;
        
        // Saltar si est√° archivado
        if (archivedNames.includes(custom.name)) {
          return;
        }
        
        const newItem = document.createElement('div');
        newItem.className = 'chat-item';
        newItem.dataset.char = custom.name;
        newItem.innerHTML = `
          <img src="${custom.avatar}" class="chat-avatar">
          <div class="chat-info">
            <div class="chat-name">${custom.name}</div>
            <div class="chat-preview">Personalizado</div>
          </div>
        `;
        
        newItem.addEventListener('click', async () => {
          document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
          newItem.classList.add('active');
          currentCharacter = custom.name;
          conversationId = null;
          
          headerAvatar.src = custom.avatar;
          headerName.textContent = custom.name;
          showTrustLevel(custom.name);
          
          // Habilitar inputs
          messageInput.disabled = false;
          sendButton.disabled = false;
          imageInput.disabled = false;
          messageInput.placeholder = 'Escribe un mensaje';
          
          await loadHistory(custom.name);
        });

        chatList.appendChild(newItem);
      });
    }

    loadAllCustomCharacters();

    // Loading screen
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('loadingScreen').classList.add('hidden');
      }, 1500);
    });

    // Mobile menu functions
    function toggleMobileMenu() {
      const miniSidebar = document.getElementById('miniSidebar');
      const mainSidebar = document.getElementById('mainSidebar');
      const overlay = document.querySelector('.mobile-overlay');
      
      miniSidebar.classList.toggle('mobile-open');
      mainSidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('active');
    }

    function closeMobileMenu() {
      const miniSidebar = document.getElementById('miniSidebar');
      const mainSidebar = document.getElementById('mainSidebar');
      const overlay = document.querySelector('.mobile-overlay');
      
      miniSidebar.classList.remove('mobile-open');
      mainSidebar.classList.remove('mobile-open');
      overlay.classList.remove('active');
    }

    // Cerrar men√∫ al seleccionar chat en m√≥vil
    document.querySelectorAll('.chat-item').forEach(item => {
      item.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          closeMobileMenu();
        }
      });
    });

    function archiveChar(charName) {
      const archived = JSON.parse(localStorage.getItem('archivedChars') || '[]');
      
      const charInfo = {
        name: charName,
        avatar: characterIcons[charName] || 'https://via.placeholder.com/50/2a3942/8696a0?text=' + charName[0]
      };
      
      if (!archived.find(c => c.name === charName)) {
        archived.push(charInfo);
        localStorage.setItem('archivedChars', JSON.stringify(archived));
      }
      
      showChats();
      alert(`üì¶ ${charName} archivado`);
    }

    window.unarchiveChar = function(charName) {
      const archived = JSON.parse(localStorage.getItem('archivedChars') || '[]');
      const filtered = archived.filter(c => c.name !== charName);
      localStorage.setItem('archivedChars', JSON.stringify(filtered));
      
      showArchived();
      alert(`üì§ ${charName} desarchivado`);
    };

    // Rate limiting - 10 mensajes por minuto
    function checkRateLimit() {
      const now = Date.now();
      let messages = JSON.parse(localStorage.getItem('messageTimestamps') || '[]');
      
      // Filtrar mensajes del √∫ltimo minuto
      messages = messages.filter(t => now - t < 60000);
      
      if (messages.length >= 10) {
        return false;
      }
      
      messages.push(now);
      localStorage.setItem('messageTimestamps', JSON.stringify(messages));
      return true;
    }

    // Sistema de reportes
    function reportMessage(text) {
      const reason = prompt('¬øPor qu√© reportas este mensaje?\n\n1. Contenido ofensivo\n2. Informaci√≥n incorrecta\n3. Comportamiento inapropiado\n4. Otro\n\nEscribe el n√∫mero o describe el problema:');
      
      if (!reason) return;
      
      const report = {
        message: text,
        reason: reason,
        character: currentCharacter,
        timestamp: new Date().toISOString(),
        userId: userId
      };
      
      // Guardar reporte localmente
      const reports = JSON.parse(localStorage.getItem('reports') || '[]');
      reports.push(report);
      localStorage.setItem('reports', JSON.stringify(reports));
      
      // Enviar a servidor (opcional)
      fetch(`${WORKER_URL}/report`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(report)
      }).catch(() => {});
      
      alert('‚úÖ Reporte enviado. Gracias por ayudarnos a mejorar.');
      trackEvent('report_sent');
    }

    // Analytics b√°sico (an√≥nimo)
    function trackMessage(type) {
      const stats = JSON.parse(localStorage.getItem('chatStats') || '{}');
      stats.totalMessages = (stats.totalMessages || 0) + 1;
      stats[type + 'Messages'] = (stats[type + 'Messages'] || 0) + 1;
      stats.lastActive = new Date().toISOString();
      localStorage.setItem('chatStats', JSON.stringify(stats));
    }

    function trackEvent(eventName) {
      const stats = JSON.parse(localStorage.getItem('chatStats') || '{}');
      stats[eventName] = (stats[eventName] || 0) + 1;
      localStorage.setItem('chatStats', JSON.stringify(stats));
    }

    // Inicializar stats
    if (!localStorage.getItem('chatStats')) {
      localStorage.setItem('chatStats', JSON.stringify({
        firstVisit: new Date().toISOString(),
        totalMessages: 0,
        userMessages: 0,
        botMessages: 0
      }));
    }

    // Sistema de t√©rminos y condiciones
    function toggleCheck(id) {
      const checkbox = document.getElementById(id);
      checkbox.checked = !checkbox.checked;
      checkAllTerms();
    }

    function checkAllTerms() {
      const age = document.getElementById('ageCheck').checked;
      const terms = document.getElementById('termsCheck').checked;
      const ai = document.getElementById('aiCheck').checked;
      document.getElementById('acceptBtn').disabled = !(age && terms && ai);
    }

    function acceptTerms() {
      localStorage.setItem('termsAccepted', 'true');
      localStorage.setItem('termsAcceptedDate', new Date().toISOString());
      document.getElementById('termsModal').classList.remove('active');
    }

    function viewTerms() {
      showChannels();
      setTimeout(() => openLegalChannel(), 100);
      document.getElementById('termsModal').classList.remove('active');
    }

    // Mostrar modal si no ha aceptado t√©rminos
    window.addEventListener('load', () => {
      const accepted = localStorage.getItem('termsAccepted');
      if (!accepted) {
        setTimeout(() => {
          document.getElementById('termsModal').classList.add('active');
        }, 500);
      }
    });

    // Sistema de confianza
    function showTrustLevel(character) {
      try {
        const response = fetch(`${WORKER_URL}/history?userId=${userId}&character=${character}`);
        response.then(res => res.json()).then(data => {
          const history = data.history || [];
          const trustLevel = calculateTrustLevel(history, character);
          const trustText = getTrustText(trustLevel, character);
          
          const statusEl = document.querySelector('.header-status');
          statusEl.textContent = `En l√≠nea ‚Ä¢ ${trustText}`;
        }).catch(() => {
          document.querySelector('.header-status').textContent = 'En l√≠nea';
        });
      } catch (error) {
        document.querySelector('.header-status').textContent = 'En l√≠nea';
      }
    }

    function calculateTrustLevel(history, character) {
      if (!history.length) return 0;
      
      const userMessages = history.filter(msg => msg.sender === 'user' || msg.type === 'user').length;
      let trust = Math.min(userMessages * 2, 100);
      
      if (history.length > 20) trust += 10;
      if (history.length > 50) trust += 15;
      
      const multipliers = {
        Angel: 1.1, Gissel: 1.2, iA777: 0.9,
        Iris: 1.0, Luna: 0.8, Molly: 0.7
      };
      
      trust *= (multipliers[character] || 1.0);
      return Math.min(Math.floor(trust), 100);
    }

    function getTrustText(trustLevel, character) {
      const level = Math.floor(trustLevel / 20);
      const levels = {
        Angel: ['Desconocido', 'Conocido', 'Amigable', 'Compa√±ero', 'Amigo cercano', 'Hermano'],
        Gissel: ['Nueva persona', 'Conocida', 'Amiga', 'Buena amiga', 'Mejor amiga', 'Hermana del alma'],
        iA777: ['Desconocido', 'Conocido', 'Amigable', 'Amigo', 'Amigo cercano', 'Hermano'],
        Luna: ['Extra√±o', 'Conocido', 'Amigable', 'Amiga', 'Amiga √≠ntima', 'Hermana'],
        Molly: ['Desconocido', 'Conocido', 'Respetable', 'Amiga', 'Amiga cercana', 'Hermana'],
        Iris: ['Desconocida', 'Conocida', 'Amigable', 'Amiga', 'Amiga cercana', 'Hermana']
      };
      
      const defaultLevels = ['Desconocido', 'Conocido', 'Amigable', 'Amigo', 'Amigo cercano', 'Hermano/a'];
      const charLevels = levels[character] || defaultLevels;
      return charLevels[Math.min(level, 5)];
    }

    // Funciones para modal de im√°genes
    window.openImageModal = function(imageSrc) {
      document.getElementById('modalImage').src = imageSrc;
      document.getElementById('imageModal').classList.add('active');
    }

    window.closeImageModal = function() {
      document.getElementById('imageModal').classList.remove('active');
    }

    // Cerrar modal con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeImageModal();
      }
    });

    function openEasterEggs() {
      document.getElementById('easterEggsModal').classList.add('active');
    }

    function closeEasterEggs() {
      document.getElementById('easterEggsModal').classList.remove('active');
    }

    function openTechInfo() {
      document.getElementById('techInfoModal').classList.add('active');
    }

    function closeTechInfo() {
      document.getElementById('techInfoModal').classList.remove('active');
    }

    // Sistema de logros
    async function showAchievements() {
      document.getElementById('achievementsModal').style.display = 'flex';
      await loadAchievements();
    }

    function closeAchievements() {
      document.getElementById('achievementsModal').style.display = 'none';
    }

    function toggleAchievementsSidebar() {
      const sidebar = document.getElementById('achievementsSidebar');
      sidebar.classList.toggle('hidden');
      
      if (!sidebar.classList.contains('hidden')) {
        loadAchievementsSidebar();
      }
    }

    async function loadAchievementsSidebar() {
      const list = document.getElementById('achievementsSidebarList');
      
      try {
        const response = await fetch(`${WORKER_URL}/history?userId=${userId}&character=RoasterBot`);
        const data = await response.json();
        
        const roastCount = data.history ? 
          data.history.filter(msg => 
            msg.sender === 'bot' && 
            !msg.message.includes('ADVERTENCIA: Este bot genera roasts brutales')
          ).length : 0;
        
        const allAchievements = [
          { id: 'primera_victima', name: 'Primera V√≠ctima', emoji: 'üéØ', desc: 'Recibiste tu primer roast', required: 1 },
          { id: 'masoquista_novato', name: 'Masoquista Novato', emoji: 'üòà', desc: '3 roasts recibidos', required: 3 },
          { id: 'coleccionista_insultos', name: 'Coleccionista', emoji: 'üèÜ', desc: '5 roasts en tu colecci√≥n', required: 5 },
          { id: 'masoquista_experto', name: 'Masoquista Experto', emoji: 'üíÄ', desc: '10 roasts y sigues volviendo', required: 10 },
          { id: 'leyenda_del_sufrimiento', name: 'Leyenda del Sufrimiento', emoji: 'üëë', desc: 'Nadie sufre como t√∫', required: 15 }
        ];
        
        list.innerHTML = '';
        
        allAchievements.forEach(achievement => {
          const unlocked = roastCount >= achievement.required;
          const card = document.createElement('div');
          card.className = `achievement-card ${unlocked ? '' : 'locked'}`;
          card.innerHTML = `
            <div class="achievement-header">
              <span class="achievement-emoji">${achievement.emoji}</span>
              <span class="achievement-name">${achievement.name}</span>
            </div>
            <div class="achievement-desc">${achievement.desc}</div>
            <div class="achievement-progress">${unlocked ? '‚úì Desbloqueado' : `${roastCount}/${achievement.required}`}</div>
          `;
          list.appendChild(card);
        });
        
      } catch (error) {
        list.innerHTML = '<div style="text-align: center; color: #f15c6d; padding: 20px;">Error cargando logros</div>';
      }
    }

    async function loadAchievements() {
      try {
        const response = await fetch(`${WORKER_URL}/history?userId=${userId}&character=RoasterBot`);
        const data = await response.json();
        
        // Contar solo mensajes del bot (roasts recibidos), excluyendo el mensaje de bienvenida
        const roastCount = data.history ? 
          data.history.filter(msg => 
            msg.sender === 'bot' && 
            !msg.message.includes('ADVERTENCIA: Este bot genera roasts brutales')
          ).length : 0;
        
        console.log('Roasts recibidos:', roastCount);
        
        const allAchievements = [
          { id: 'primera_victima', name: 'üéØ Primera V√≠ctima', desc: 'Recibiste tu primer roast', required: 1 },
          { id: 'masoquista_novato', name: 'üòà Masoquista Novato', desc: '3 roasts recibidos', required: 3 },
          { id: 'coleccionista_insultos', name: 'üèÜ Coleccionista de Insultos', desc: '5 roasts en tu colecci√≥n', required: 5 },
          { id: 'masoquista_experto', name: 'üíÄ Masoquista Experto', desc: '10 roasts y sigues volviendo', required: 10 },
          { id: 'leyenda_del_sufrimiento', name: 'üëë Leyenda del Sufrimiento', desc: 'Nadie sufre como t√∫', required: 15 }
        ];
        
        const achievementsList = document.getElementById('achievementsList');
        achievementsList.innerHTML = '';
        
        allAchievements.forEach(achievement => {
          const unlocked = roastCount >= achievement.required;
          const item = document.createElement('div');
          item.className = `achievement-item ${unlocked ? '' : 'locked'}`;
          item.innerHTML = `
            <div class="achievement-icon">${achievement.name.split(' ')[0]}</div>
            <div class="achievement-info">
              <h4>${achievement.name}</h4>
              <p>${achievement.desc} ${unlocked ? '‚úì Desbloqueado' : `(${roastCount}/${achievement.required})`}</p>
            </div>
          `;
          achievementsList.appendChild(item);
        });
        
      } catch (error) {
        console.error('Error cargando logros:', error);
        document.getElementById('achievementsList').innerHTML = '<p style="text-align: center; color: #8696a0;">Error cargando logros</p>';
      }
    }

    function showAchievementNotification(achievement) {
      console.log('Mostrando logro:', achievement);
      
      const notification = document.createElement('div');
      notification.className = 'achievement-notification';
      notification.innerHTML = `
        <div class="achievement-title">üèÜ ¬°LOGRO DESBLOQUEADO!</div>
        <div class="achievement-desc">${achievement.name}: ${achievement.desc}</div>
      `;
      
      document.body.appendChild(notification);
      
      // Actualizar panel lateral si est√° visible
      const sidebar = document.getElementById('achievementsSidebar');
      if (!sidebar.classList.contains('hidden')) {
        setTimeout(() => loadAchievementsSidebar(), 1000);
      }
      
      // Reproducir sonido si est√° habilitado
      const sound = localStorage.getItem('sound') || 'on';
      if (sound === 'on') {
        try {
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
          audio.volume = 0.3;
          audio.play().catch(() => {});
        } catch (e) {}
      }
      
      setTimeout(() => {
        notification.classList.add('hide');
        setTimeout(() => notification.remove(), 500);
      }, 5000);
    }

    // Capturar errores en m√≥viles
    const isMobile = window.innerWidth <= 768;
    
    window.addEventListener('error', (e) => {
      if (isMobile) {
        alert(`‚ö†Ô∏è ERROR DETECTADO\n\n${e.message}\n\nArchivo: ${e.filename}\nL√≠nea: ${e.lineno}\n\nReporta esto en Discord a @thisisankush`);
      }
    });

    window.addEventListener('unhandledrejection', (e) => {
      if (isMobile) {
        alert(`‚ö†Ô∏è ERROR DE CONEXI√ìN\n\n${e.reason}\n\nReporta esto en Discord a @thisisankush`);
      }
    });
  </script>
</body>
</html>
